# PROMPTS OUTPUT â€” JayGanga Books

> This file stores all prompts generated by Manager AI for the coding agent.
>
> **Commands:**
> - `pocketbasejp` - Generate PocketBase VPS setup prompt âœ…
> - `startjp` - Start generating prompts from PROJECT_REPORT.md âœ…
> - `nextjp` - Generate the next prompt in sequence

---

## Project Analysis

**App**: JayGanga Books
**Stack**: Flutter + PocketBase
**Platform**: Android only (no iOS for now)
**PocketBase URL**: `https://api.jayganga.com`
**Auth**: Google OAuth only (no email/password)

### Entities (17 Collections)

| # | Collection | Type | Key Relations |
|---|-----------|------|---------------|
| 1 | `users` | Auth | â€” |
| 2 | `books` | Base | seller â†’ users |
| 3 | `bundle_items` | Base | bundle â†’ books |
| 4 | `chats` | Base | buyer â†’ users, seller â†’ users, book â†’ books |
| 5 | `messages` | Base | chat â†’ chats, sender â†’ users |
| 6 | `transactions` | Base | book â†’ books, buyer â†’ users, seller â†’ users |
| 7 | `reviews` | Base | transaction â†’ transactions, reviewer â†’ users, reviewee â†’ users |
| 8 | `wishlists` | Base | user â†’ users, book â†’ books |
| 9 | `reports` | Base | reporter â†’ users |
| 10 | `banners` | Base | â€” |
| 11 | `advertisements` | Base | â€” |
| 12 | `schools` | Base | â€” |
| 13 | `search_history` | Base | user â†’ users |
| 14 | `notifications` | Base | user â†’ users |
| 15 | `referrals` | Base | referrer â†’ users, referee â†’ users |
| 16 | `blocked_users` | Base | blocker â†’ users, blocked â†’ users |
| 17 | `app_config` | Base | â€” |

### Features Detected

| Feature | Phase | Status |
|---------|-------|--------|
| âœ… Google OAuth | PHASE_04 | Required |
| âœ… File Storage (camera-only photos) | PHASE_08 | Required |
| âœ… Realtime SSE (chat, typing, receipts) | PHASE_09 | Required |
| âœ… Server Hooks (auto-archive, badges, ban, rate limit) | PHASE_10 | Required |
| âœ… Push Notifications (FCM) | PHASE_12 | Required |
| âŒ Payments (Stripe) | PHASE_13 | SKIPPED |
| âœ… Offline / 72h Cache | PHASE_14 | Required |

### Phases Required (17 of 18)

| Phase | Name | Est. Prompts |
|-------|------|-------------|
| PHASE_00 | PocketBase VPS Setup | 1 âœ… (done) |
| PHASE_01 | Foundation | 4 |
| PHASE_02 | PocketBase Collections | 4 |
| PHASE_03 | API Rules | 1 |
| PHASE_04 | Authentication (Google OAuth) | 4 |
| PHASE_05 | Layout & Navigation | 4 |
| PHASE_06 | State Management | 2 |
| PHASE_07 | Core Features (CRUD) | 20 |
| PHASE_08 | File Storage | 2 |
| PHASE_09 | Realtime (SSE) â€” Chat | 3 |
| PHASE_10 | Server Hooks | 3 |
| PHASE_11 | UI Polish | 5 |
| PHASE_12 | Notifications (FCM) | 3 |
| PHASE_14 | Offline & Cache | 2 |
| PHASE_15 | Error Handling | 3 |
| PHASE_16 | Testing | 3 |
| PHASE_17 | Security Audit | 1 |
| PHASE_18 | Deployment | 5 |

**Total Prompts: ~70** (including Prompt 0 already done)

### Non-Standard Features (from NEW_RESEARCH.md)

These features need special implementation approaches â€” research findings are baked into prompts:

1. **Haversine Distance Filtering** â†’ Custom PocketBase endpoint + bounding-box pre-filter
2. **QR Code Offline Transaction** â†’ JWT-signed QR payload + local validation + deferred sync
3. **Realtime Chat + Typing + Receipts** â†’ SSE subscriptions + `chat_status` collection + `is_read`/`is_delivered` fields
4. **Camera-Only + Compression** â†’ `image_picker` camera-only + `flutter_image_compress` + EXIF check
5. **Gamification (Badges, Leaderboards, Referrals)** â†’ Server hooks + `cronAdd()` + JSON badge array
6. **Offline 72h Cache + Drafts** â†’ `hive` + `cached_network_image` + TTL metadata
7. **Deep Links + Force Update** â†’ Android App Links + `go_router` + `app_config` collection
8. **Smart Recommendations** â†’ Academic profile â†’ category matching via server hook

---

## Generated Prompts

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ PROMPT 0 â€” POCKETBASE VPS SETUP âœ… DONE
Phase: Pre-Foundation
Task: Deploy PocketBase to VPS + Assign Domain + SSL
Type: ğŸ”§ BACKEND (VPS Setup)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

> See above â€” already generated and completed.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ PROMPT 1 of 70
Phase: Foundation (PHASE_01)
Task: Create Flutter Project + Folder Structure
Type: ğŸ“± FRONTEND (Instructions Only)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ INSTRUCTION:
Create a new Flutter project called **JayGanga Books** with a clean, production-ready folder structure. This is an Android-only (for now) book marketplace app connecting to PocketBase backend at `https://api.jayganga.com`.

ğŸ“ CREATE:

**Step 1 â€” Create the project:**
```bash
flutter create --org com.jayganga --project-name books .
```

**Step 2 â€” Create the folder structure:**
Create ALL of these directories and placeholder files under `lib/`:

```
lib/
â”œâ”€â”€ main.dart                          (entry point â€” MODIFY)
â”œâ”€â”€ app.dart                           (MaterialApp widget â€” NEW)
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ env.dart                       (PocketBase URL + environment config)
â”‚   â”œâ”€â”€ theme.dart                     (light + dark theme)
â”‚   â”œâ”€â”€ router.dart                    (GoRouter setup â€” placeholder)
â”‚   â””â”€â”€ constants.dart                 (app-wide constants)
â”œâ”€â”€ screens/
â”‚   â”œâ”€â”€ splash/
â”‚   â”‚   â””â”€â”€ splash_screen.dart
â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â””â”€â”€ (future: login, onboarding)
â”‚   â”œâ”€â”€ home/
â”‚   â”‚   â””â”€â”€ (future: home_screen)
â”‚   â”œâ”€â”€ nearby/
â”‚   â”‚   â””â”€â”€ (future: nearby_books_screen)
â”‚   â”œâ”€â”€ search/
â”‚   â”‚   â””â”€â”€ (future: search_screen)
â”‚   â”œâ”€â”€ book/
â”‚   â”‚   â””â”€â”€ (future: book_detail_screen, listing_studio)
â”‚   â”œâ”€â”€ chat/
â”‚   â”‚   â””â”€â”€ (future: chat_list, chat_thread)
â”‚   â”œâ”€â”€ profile/
â”‚   â”‚   â””â”€â”€ (future: profile_screen, settings)
â”‚   â”œâ”€â”€ transaction/
â”‚   â”‚   â””â”€â”€ (future: qr_screen, review_screen)
â”‚   â””â”€â”€ shell/
â”‚       â””â”€â”€ (future: app_shell with bottom nav)
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ pocketbase_service.dart        (PocketBase client singleton â€” NEW)
â”‚   â””â”€â”€ (future: auth_service, book_service, chat_service, etc.)
â”œâ”€â”€ models/
â”‚   â””â”€â”€ (future: user_model, book_model, chat_model, etc.)
â”œâ”€â”€ providers/
â”‚   â””â”€â”€ (future: auth_provider, book_provider, etc.)
â”œâ”€â”€ widgets/
â”‚   â””â”€â”€ (future: book_card, shimmer_loader, login_gate, etc.)
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ helpers.dart                   (formatters, validators â€” NEW)
â”‚   â””â”€â”€ (future: haversine, qr_utils)
â””â”€â”€ l10n/
    â””â”€â”€ (future: English + Hindi ARB files)
```

**Step 3 â€” Write `lib/config/env.dart`:**
```dart
class Env {
  static const String pocketbaseUrl = String.fromEnvironment(
    'PB_URL',
    defaultValue: 'https://api.jayganga.com',
  );

  static const String appName = 'JayGanga Books';
  static const String appVersion = '1.0.0';
}
```

**Step 4 â€” Write `lib/services/pocketbase_service.dart`:**
Create a singleton PocketBase client with persistent auth store using `shared_preferences`. This is critical â€” the auth token must persist across app restarts.

Requirements:
- Import `pocketbase` package
- Import `shared_preferences`
- Create `AsyncAuthStore` backed by `SharedPreferences`
- Export a global `pb` instance initialized with `Env.pocketbaseUrl`
- Lazy initialization pattern (initialize on first use)
- Health check method: `Future<bool> isServerHealthy()` that calls `/api/health`

**Step 5 â€” Write `lib/config/constants.dart`:**
```dart
class AppConstants {
  // Radius options (in km)
  static const List<double> radiusOptions = [2.0, 5.0, 8.0, 10.0];
  static const double defaultRadius = 5.0;

  // Cache durations
  static const Duration cacheTTL = Duration(hours: 72);

  // Limits
  static const int maxListingsPerDay = 5;
  static const int maxPhotosPerListing = 3;
  static const int maxPhotoSizeKB = 500;
  static const int maxPhotoWidth = 1080;

  // QR
  static const Duration qrValidDuration = Duration(minutes: 10);

  // Pagination
  static const int pageSize = 15;

  // Offer
  static const Duration offerExpiryDuration = Duration(hours: 24);

  // Auto-archive
  static const int autoArchiveDays = 60;
}
```

**Step 6 â€” Write `lib/app.dart`:**
Create the root `MaterialApp` widget with:
- Title: "JayGanga Books"
- Theme mode: `ThemeMode.system` (default to system, manual toggle later)
- Placeholder light and dark themes (will be refined in PHASE_05)
- Home: `SplashScreen` (placeholder â€” just shows app name centered)
- `debugShowCheckedModeBanner: false`

**Step 7 â€” Update `lib/main.dart`:**
- Initialize Flutter bindings: `WidgetsFlutterBinding.ensureInitialized()`
- Initialize PocketBase service
- Run `App()` widget

**Step 8 â€” Write `lib/screens/splash/splash_screen.dart`:**
Create a simple splash screen:
- Centered app name "JAYGANGA" in bold typography
- "Books" underneath in lighter weight
- Background: subtle warm gradient
- After 2 seconds, navigate forward (for now, just stay â€” actual navigation comes in PHASE_05)

ğŸ“¦ DEPENDENCIES â€” Add these to `pubspec.yaml`:
```yaml
dependencies:
  flutter:
    sdk: flutter
  pocketbase: ^0.21.1
  shared_preferences: ^2.3.4
  provider: ^6.1.2
  go_router: ^14.8.1
  google_sign_in: ^6.2.2
  firebase_core: ^3.12.1
  firebase_messaging: ^15.2.4
  flutter_local_notifications: ^18.0.1
  cached_network_image: ^3.4.1
  image_picker: ^1.1.2
  flutter_image_compress: ^2.3.0
  connectivity_plus: ^6.1.4
  hive: ^2.2.3
  hive_flutter: ^1.1.0
  shimmer: ^3.0.0
  flutter_animate: ^4.5.2
  intl: ^0.19.0
  url_launcher: ^6.3.1
  path_provider: ^2.1.5
  google_fonts: ^6.2.1
  mobile_scanner: ^6.0.5
  qr_flutter: ^4.1.0
  geolocator: ^13.0.2
  geocoding: ^3.0.0
  flutter_rating_bar: ^4.0.1
  share_plus: ^10.1.4
  package_info_plus: ^8.3.0
```

> âš ï¸ **IMPORTANT**: After adding dependencies, run `flutter pub get` to install them. If any package version conflicts, resolve by using compatible versions. Check pub.dev for latest compatible versions.

ğŸ¨ STYLING:
- Not applicable in this prompt â€” theme comes in PHASE_05
- Splash screen: simple, clean, warm gradient background (#FFB74D â†’ #FF8A65 or similar warm tones)

â›” DO NOT:
- Do NOT create any actual screens beyond splash (those come in later prompts)
- Do NOT write any UI code beyond the splash placeholder
- Do NOT import packages you haven't added to pubspec.yaml
- Do NOT hardcode the PocketBase URL in services â€” always use `Env.pocketbaseUrl`
- Do NOT use `Navigator.push` â€” GoRouter will handle all navigation later
- Do NOT create model classes yet (PHASE_02)
- Do NOT set up Firebase yet (just add the dependency â€” config comes in PHASE_12)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”§ EXECUTE:
```bash
flutter create --org com.jayganga --project-name books .
flutter pub get
flutter analyze
```
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ… SELF-CHECK:
After completing this prompt, verify ALL of these:
1. Run `flutter analyze` â†’ 0 issues
2. Run `flutter run` â†’ App starts and shows splash screen
3. Verify folder structure matches the hierarchy above
4. Verify `pocketbase_service.dart` initializes without errors
5. Verify `env.dart` returns the correct PocketBase URL
6. Verify `constants.dart` has all values listed above
7. Recheck: Is EVERY requirement above implemented?
8. If ANY issue â†’ fix NOW before confirming

ğŸ‘¤ USER MANUAL STEPS:
None â€” coding agent handles everything.

ğŸ’¬ CONFIRM IN CHAT:
"Prompt 1 complete. Flutter project created with folder structure. PocketBase service configured for https://api.jayganga.com. Splash screen showing. flutter analyze: 0 issues. Zero errors."

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â­ï¸ NEXT: Prompt 2 â€” Create All PocketBase Collections
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ PROMPT 2 of 70
Phase: PocketBase Collections (PHASE_02)
Task: Create All Collections with Fields via PocketBase Admin API
Type: ğŸ”§ BACKEND (Code Provided by Manager AI)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ INSTRUCTION:
Create ALL 17 PocketBase collections for JayGanga Books by writing **local JavaScript migration files** in `pb_migrations/`. The coding agent writes `.js` files locally â†’ then deploys to VPS via `deploy.sh` (rsync + PocketBase restart). **Never edit the VPS database directly. Never use API calls to create collections. Code is Law.**

> **IMPORTANT:** Create collections in the order shown below. Collections with no relation dependencies first, then collections that reference others. Relations will be added in Prompt 3 â€” for NOW, create only basic fields (text, number, bool, select, file, json, date, email, url, editor). Skip relation fields in this prompt.
>
> **Architecture Rule:** All backend structure lives as `.js` files in `pb_migrations/` and `pb_hooks/`. One-Way Sync: Local â†’ VPS only. `deploy.sh` pushes via rsync + restarts PocketBase.

---

### Collection 1: `users` (Type: AUTH)

> PocketBase auto-creates `users` as an auth collection. Modify it to add custom fields.

| Field | Type | Options |
|-------|------|---------|
| `name` | text | required |
| `avatar` | file | maxSelect: 1, maxSize: 524288, mimeTypes: ["image/jpeg","image/png","image/webp"] |
| `phone` | text | required, min: 10, max: 15 |
| `user_type` | select | values: ["school_student","exam_aspirant","college_student"], required |
| `class_year` | text | â€” |
| `board` | select | values: ["CBSE","ICSE","State Board","IB","Other"] |
| `stream` | select | values: ["Science","Commerce","Arts","General"] |
| `exam_type` | select | values: ["JEE","NEET","Bank","SSC","UPSC","State PSC","Other"] |
| `coaching_institute` | text | â€” |
| `college_name` | text | â€” |
| `college_branch` | text | â€” |
| `college_semester` | text | â€” |
| `location_lat` | number | â€” |
| `location_lon` | number | â€” |
| `city` | text | â€” |
| `area` | text | â€” |
| `bio` | text | max: 500 |
| `badges` | json | â€” (array of badge IDs like ["helping_hand","top_seller"]) |
| `trust_score` | number | min: 0, max: 5 |
| `review_count` | number | min: 0 |
| `total_sales` | number | min: 0 |
| `total_purchases` | number | min: 0 |
| `referral_code` | text | unique |
| `fcm_token` | text | â€” |
| `is_banned` | bool | â€” |
| `ban_reason` | text | â€” |
| `last_active` | date | â€” |
| `onboarding_complete` | bool | â€” |
| `preferred_language` | select | values: ["en","hi"], default: "en" |
| `preferred_radius` | number | min: 1, max: 10 |
| `dark_mode` | select | values: ["system","light","dark"], default: "system" |
| `priority_until` | date | â€” (referral reward: priority listing expiry) |

---

### Collection 2: `schools` (Type: BASE)

| Field | Type | Options |
|-------|------|---------|
| `name` | text | required, unique |
| `city` | text | required |
| `area` | text | â€” |
| `type` | select | values: ["school","coaching","college"], required |
| `board` | select | values: ["CBSE","ICSE","State Board","IB","Other"] |
| `is_active` | bool | default: true |

---

### Collection 3: `books` (Type: BASE)

| Field | Type | Options |
|-------|------|---------|
| `title` | text | required, min: 2, max: 200 |
| `author` | text | required |
| `edition` | text | â€” |
| `publisher` | text | â€” |
| `description` | text | max: 1000 |
| `photos` | file | required, maxSelect: 3, maxSize: 524288, mimeTypes: ["image/jpeg","image/png","image/webp"] |
| `mrp` | number | min: 0 |
| `selling_price` | number | required, min: 0 |
| `condition` | select | values: ["like_new","good","fair"], required |
| `condition_tags` | select | values: ["highlighted","notes_margins","missing_cover","all_pages_intact","slight_yellowing","water_damage"], maxSelect: 6 |
| `category` | select | values: ["school","jee_engineering","neet_medical","bank_ssc","govt_upsc","college","other"], required |
| `class_year` | text | â€” |
| `board` | select | values: ["CBSE","ICSE","State Board","IB","Other"] |
| `stream` | select | values: ["Science","Commerce","Arts","General"] |
| `status` | select | values: ["active","reserved","sold","archived","draft"], required, default: "active" |
| `is_bundle` | bool | default: false |
| `bundle_name` | text | â€” |
| `bundle_total_mrp` | number | â€” |
| `handover_area` | text | â€” |
| `available_from` | date | â€” |
| `views_count` | number | min: 0 |
| `wishlist_count` | number | min: 0 |
| `location_lat` | number | â€” |
| `location_lon` | number | â€” |
| `is_priority` | bool | default: false (referral reward: priority listing) |
| `auto_archive_date` | date | â€” |

> **Note:** `seller` relation (â†’ users) and `school` relation (â†’ schools) will be added in Prompt 3.

---

### Collection 4: `bundle_items` (Type: BASE)

| Field | Type | Options |
|-------|------|---------|
| `item_title` | text | required |
| `item_author` | text | â€” |
| `item_condition` | select | values: ["like_new","good","fair"] |

> **Note:** `bundle` relation (â†’ books) added in Prompt 3.

---

### Collection 5: `chats` (Type: BASE)

| Field | Type | Options |
|-------|------|---------|
| `last_message` | text | â€” |
| `last_message_at` | date | â€” |
| `last_sender` | relation | users (1), non-cascade |
| `is_active` | bool | default: true |
| `is_deleted_by_buyer` | bool | default: false |
| `is_deleted_by_seller` | bool | default: false |
| `unread_count` | number | default: 0 |
| `offer_amount` | number | â€” |
| `offer_status` | select | values: ["none","pending","accepted","declined","expired"], default: "none" |
| `offer_expires_at` | date | â€” |
| `agreed_price` | number | â€” |

> **Note:** `buyer`, `seller`, `book` relations added in Prompt 3.

---

### Collection 6: `messages` (Type: BASE)

| Field | Type | Options |
|-------|------|---------|
| `content` | text | â€” |
| `type` | select | values: ["text","image","offer","system"], required |
| `image` | file | maxSelect: 1, maxSize: 524288, mimeTypes: ["image/jpeg","image/png","image/webp"] |
| `offer_amount` | number | â€” |
| `is_read` | bool | default: false |
| `is_delivered` | bool | default: false |

> **Note:** `chat`, `sender` relations added in Prompt 3.

---

### Collection 7: `transactions` (Type: BASE)

| Field | Type | Options |
|-------|------|---------|
| `amount` | number | required, min: 0 |
| `status` | select | values: ["initiated","confirmed","handover_pending","completed","disputed","reviewed","reversed"], required |
| `handover_token` | text | â€” |
| `token_expires_at` | date | â€” |
| `completed_at` | date | â€” |
| `is_offline_sync_pending` | bool | default: false |

> **Note:** `book`, `buyer`, `seller` relations added in Prompt 3.

---

### Collection 8: `reviews` (Type: BASE)

| Field | Type | Options |
|-------|------|---------|
| `rating` | number | required, min: 1, max: 5 |
| `comment` | text | max: 200 |
| `condition_accurate` | bool | â€” (was book condition as described?) |

> **Note:** `transaction`, `reviewer`, `reviewee` relations added in Prompt 3.

---

### Collection 9: `wishlists` (Type: BASE)

| Field | Type | Options |
|-------|------|---------|
| `price_at_save` | number | â€” (price when user wishlisted, for price-drop detection) |

> **Note:** `user`, `book` relations added in Prompt 3.

---

### Collection 10: `reports` (Type: BASE)

| Field | Type | Options |
|-------|------|---------|
| `type` | select | values: ["listing","user","bug"], required |
| `reason` | select | values: ["fake_listing","wrong_price","inappropriate","spam","harassment","other"], required |
| `description` | text | max: 500 |
| `screenshot` | file | maxSelect: 1, maxSize: 1048576 |
| `target_type` | text | â€” (e.g., "book", "user") |
| `target_id` | text | â€” (record ID of reported entity) |
| `status` | select | values: ["pending","reviewed","actioned","dismissed"], default: "pending" |
| `admin_notes` | text | â€” |

> **Note:** `reporter` relation added in Prompt 3.

---

### Collection 11: `banners` (Type: BASE)

| Field | Type | Options |
|-------|------|---------|
| `title` | text | required |
| `image` | file | required, maxSelect: 1, maxSize: 1048576, mimeTypes: ["image/jpeg","image/png","image/webp"] |
| `link` | url | â€” |
| `start_date` | date | required |
| `end_date` | date | required |
| `is_active` | bool | default: true |
| `sort_order` | number | â€” |

---

### Collection 12: `advertisements` (Type: BASE)

| Field | Type | Options |
|-------|------|---------|
| `business_name` | text | required |
| `logo` | file | maxSelect: 1, maxSize: 524288, mimeTypes: ["image/jpeg","image/png","image/webp"] |
| `tagline` | text | max: 100 |
| `link` | url | â€” |
| `phone` | text | â€” |
| `is_active` | bool | default: true |
| `sort_order` | number | â€” |

---

### Collection 13: `search_history` (Type: BASE)

| Field | Type | Options |
|-------|------|---------|
| `query` | text | required |

> **Note:** `user` relation added in Prompt 3. Capped at 5 entries per user (enforced via hook).

---

### Collection 14: `notifications` (Type: BASE)

| Field | Type | Options |
|-------|------|---------|
| `title` | text | required |
| `body` | text | required |
| `type` | select | values: ["chat","offer","price_drop","recommendation","referral","system","inactivity","seller_reminder"], required |
| `is_read` | bool | default: false |
| `data` | json | â€” (extra payload: target_type, target_id, etc.) |

> **Note:** `user` relation added in Prompt 3.

---

### Collection 15: `referrals` (Type: BASE)

| Field | Type | Options |
|-------|------|---------|
| `referral_code` | text | required |
| `status` | select | values: ["invited","registered","completed"], required |
| `reward_granted` | bool | default: false |

> **Note:** `referrer`, `referee` relations added in Prompt 3.

---

### Collection 16: `blocked_users` (Type: BASE)

> **Note:** `blocker`, `blocked` relations added in Prompt 3. This collection only has relation fields + system fields.

---

### Collection 17: `app_config` (Type: BASE)

| Field | Type | Options |
|-------|------|---------|
| `key` | text | required, unique |
| `value` | json | required |
| `description` | text | â€” |

> **Pre-seed these records after creation:**

| Key | Value | Description |
|-----|-------|-------------|
| `min_app_version` | `"1.0.0"` | Force update if below this |
| `latest_app_version` | `"1.0.0"` | Latest available version |
| `force_update` | `false` | Whether critical update is active |
| `maintenance_mode` | `false` | Kill switch for entire app |
| `banned_keywords` | `["assignment service","cheat sheet","answer key"]` | Listing keyword filter |
| `max_listings_per_day` | `5` | Rate limiter |
| `auto_archive_days` | `60` | Days before auto-archive |
| `offer_expiry_hours` | `24` | Hours before offer expires |
| `qr_valid_minutes` | `10` | QR code validity |

---

ğŸ“¦ USE:
- PocketBase v0.23+ migration API with `$app`
- Migration files in `pb_migrations/` folder (locally)
- Deploy to VPS via `deploy.sh` (rsync + restart)
- PocketBase URL: `https://api.jayganga.com`
- Each migration file uses `migrate()` function with `up()` and `down()`

â›” DO NOT:
- Do NOT create relation fields in this prompt â€” those come in Prompt 3
- Do NOT modify the `users` system fields (id, email, verified, etc.) â€” only ADD custom fields
- Do NOT use the legacy `dao` API â€” use PocketBase v0.23+ `$app` API
- Do NOT set API rules yet â€” those come in Prompt 4
- Do NOT leave any collection without proper field types (no `text` where `select` is needed)
- Do NOT forget to set required/unique constraints as specified above

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”§ EXECUTE:

**Step 1 â€” Create migration files locally:**

Create these files in `pb_migrations/` (inside your Flutter project root):

```
pb_migrations/
â”œâ”€â”€ 001_create_schools.js
â”œâ”€â”€ 002_create_users_custom_fields.js
â”œâ”€â”€ 003_create_books.js
â”œâ”€â”€ 004_create_bundle_items.js
â”œâ”€â”€ 005_create_chats.js
â”œâ”€â”€ 006_create_messages.js
â”œâ”€â”€ 007_create_transactions.js
â”œâ”€â”€ 008_create_reviews.js
â”œâ”€â”€ 009_create_wishlists.js
â”œâ”€â”€ 010_create_reports.js
â”œâ”€â”€ 011_create_banners.js
â”œâ”€â”€ 012_create_advertisements.js
â”œâ”€â”€ 013_create_search_history.js
â”œâ”€â”€ 014_create_notifications.js
â”œâ”€â”€ 015_create_referrals.js
â”œâ”€â”€ 016_create_blocked_users.js
â”œâ”€â”€ 017_create_app_config.js
â””â”€â”€ 018_seed_app_config.js
```

Each migration file follows this PocketBase v0.23+ pattern:
```javascript
// pb_migrations/001_create_schools.js
migrate((app) => {
  const collection = new Collection({
    name: "schools",
    type: "base",
    fields: [
      { name: "name", type: "text", required: true },
      { name: "city", type: "text", required: true },
      // ... all fields as specified above
    ],
  });
  app.save(collection);
}, (app) => {
  const collection = app.findCollectionByNameOrId("schools");
  app.delete(collection);
});
```

> **For the `users` collection** (002): Since PocketBase auto-creates `users`, use `app.findCollectionByNameOrId("users")` to GET the existing collection, then ADD your custom fields to it and `app.save(collection)`.

**Step 2 â€” Create deploy.sh (if not already created in Prompt 0):**
```bash
#!/bin/bash
# deploy.sh â€” One-command VPS deployment
VPS_USER="ubuntu"
VPS_HOST="65.2.186.236"
PB_DIR="/opt/pocketbase"

echo "ğŸ“¦ Deploying to VPS..."
rsync -avz --progress -e "ssh -i 'JayGanga Books (1).pem'" pb_migrations/ $VPS_USER@$VPS_HOST:$PB_DIR/pb_migrations/
rsync -avz --progress -e "ssh -i 'JayGanga Books (1).pem'" pb_hooks/ $VPS_USER@$VPS_HOST:$PB_DIR/pb_hooks/
ssh -i "JayGanga Books (1).pem" $VPS_USER@$VPS_HOST "systemctl restart pocketbase"
echo "âœ… Deploy complete!"
```

**Step 3 â€” Deploy:**
```bash
chmod +x deploy.sh
./deploy.sh
```

**Step 4 â€” Verify:**
```bash
curl https://api.jayganga.com/api/health
# Open https://api.jayganga.com/_/ and verify all 17 collections exist
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ… SELF-CHECK:
1. Verify ALL 17 collections exist in PocketBase Admin UI at `https://api.jayganga.com/_/`
2. Verify `users` collection has ALL custom fields listed above
3. Verify each collection has the correct field types (select values match, file constraints match)
4. Verify `app_config` has the 9 pre-seeded records
5. Verify `schools` collection is created with the correct field structure
6. Count total collections â€” must be exactly 17 (including `users`)
7. Recheck: Is EVERY collection and field from above created?
8. If ANY missing â†’ create NOW before confirming

ğŸ‘¤ USER MANUAL STEPS:
- Provide VPS IP address and SSH credentials to the coding agent for deploy.sh
- Verify collections in Admin UI at `https://api.jayganga.com/_/` after deployment

ğŸ’¬ CONFIRM IN CHAT:
"Prompt 2 complete. All 17 PocketBase collections created with correct fields. app_config seeded with 9 records. Verified in Admin UI. Zero errors."

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â­ï¸ NEXT: Prompt 3 â€” Define Relations Between Collections
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ PROMPT 3 of 70
Phase: PocketBase Collections (PHASE_02)
Task: Add All Relation Fields Between Collections
Type: ğŸ”§ BACKEND (Local Migration File)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ INSTRUCTION:
Create a **single local migration file** `pb_migrations/019_add_relations.js` that adds ALL relation fields to the existing collections. This file runs AFTER all 17 collections are created (migrations 001â€“018).

> **Architecture Rule:** Local `.js` migration file â†’ deploy via `deploy.sh` (rsync â†’ VPS â†’ restart PocketBase). Never edit the VPS database directly.

---

### Complete Relation Map (24 relation fields across 11 collections)

#### `users` collection (2 relations)

| Field | Target Collection | maxSelect | cascadeDelete | Notes |
|-------|-------------------|-----------|---------------|-------|
| `school` | `schools` | 1 | false | User's school/coaching/college |
| `referred_by` | `users` | 1 | false | Self-referencing: who referred this user |

---

#### `books` collection (2 relations)

| Field | Target Collection | maxSelect | cascadeDelete | Notes |
|-------|-------------------|-----------|---------------|-------|
| `seller` | `users` | 1 | false | Who listed this book |
| `school` | `schools` | 1 | false | School associated with this book |

---

#### `bundle_items` collection (1 relation)

| Field | Target Collection | maxSelect | cascadeDelete | Notes |
|-------|-------------------|-----------|---------------|-------|
| `bundle` | `books` | 1 | true | Parent bundle book â€” cascade delete items when bundle is deleted |

---

#### `chats` collection (3 relations)

| Field | Target Collection | maxSelect | cascadeDelete | Notes |
|-------|-------------------|-----------|---------------|-------|
| `buyer` | `users` | 1 | false | The buyer in this chat |
| `seller` | `users` | 1 | false | The seller in this chat |
| `book` | `books` | 1 | false | The book being discussed |

---

#### `messages` collection (2 relations)

| Field | Target Collection | maxSelect | cascadeDelete | Notes |
|-------|-------------------|-----------|---------------|-------|
| `chat` | `chats` | 1 | true | Parent chat â€” cascade delete messages when chat is deleted |
| `sender` | `users` | 1 | false | Who sent this message |

---

#### `transactions` collection (3 relations)

| Field | Target Collection | maxSelect | cascadeDelete | Notes |
|-------|-------------------|-----------|---------------|-------|
| `book` | `books` | 1 | false | The book being transacted |
| `buyer` | `users` | 1 | false | The buyer |
| `seller` | `users` | 1 | false | The seller |
| `chat` | `chats` | 1 | false | The chat this deal originated from |

---

#### `reviews` collection (3 relations)

| Field | Target Collection | maxSelect | cascadeDelete | Notes |
|-------|-------------------|-----------|---------------|-------|
| `transaction` | `transactions` | 1 | true | Parent transaction â€” cascade delete review if transaction reversed |
| `reviewer` | `users` | 1 | false | Who wrote the review |
| `reviewee` | `users` | 1 | false | Who is being reviewed |

---

#### `wishlists` collection (2 relations)

| Field | Target Collection | maxSelect | cascadeDelete | Notes |
|-------|-------------------|-----------|---------------|-------|
| `user` | `users` | 1 | true | Cascade delete wishlists when user is deleted |
| `book` | `books` | 1 | true | Cascade delete wishlist entry when book is deleted |

---

#### `reports` collection (1 relation)

| Field | Target Collection | maxSelect | cascadeDelete | Notes |
|-------|-------------------|-----------|---------------|-------|
| `reporter` | `users` | 1 | false | Who filed the report |

---

#### `search_history` collection (1 relation)

| Field | Target Collection | maxSelect | cascadeDelete | Notes |
|-------|-------------------|-----------|---------------|-------|
| `user` | `users` | 1 | true | Cascade delete search history when user is deleted |

---

#### `notifications` collection (1 relation)

| Field | Target Collection | maxSelect | cascadeDelete | Notes |
|-------|-------------------|-----------|---------------|-------|
| `user` | `users` | 1 | true | Cascade delete notifications when user is deleted |

---

#### `referrals` collection (2 relations)

| Field | Target Collection | maxSelect | cascadeDelete | Notes |
|-------|-------------------|-----------|---------------|-------|
| `referrer` | `users` | 1 | false | Who sent the referral |
| `referee` | `users` | 1 | false | Who accepted the referral |

---

#### `blocked_users` collection (2 relations)

| Field | Target Collection | maxSelect | cascadeDelete | Notes |
|-------|-------------------|-----------|---------------|-------|
| `blocker` | `users` | 1 | true | Cascade delete when user is deleted |
| `blocked` | `users` | 1 | true | Cascade delete when blocked user is deleted |

---

ğŸ“ CREATE:

**File:** `pb_migrations/019_add_relations.js`

Pattern for adding a relation to an existing collection (PocketBase v0.23+):
```javascript
// pb_migrations/019_add_relations.js
migrate((app) => {
  // --- books: add seller + school ---
  const books = app.findCollectionByNameOrId("books");
  books.fields.add({
    name: "seller",
    type: "relation",
    required: true,
    options: {
      collectionId: app.findCollectionByNameOrId("users").id,
      cascadeDelete: false,
      maxSelect: 1,
      minSelect: 0,
    },
  });
  books.fields.add({
    name: "school",
    type: "relation",
    options: {
      collectionId: app.findCollectionByNameOrId("schools").id,
      cascadeDelete: false,
      maxSelect: 1,
      minSelect: 0,
    },
  });
  app.save(books);

  // Repeat same pattern for ALL collections listed above
  // ... users, bundle_items, chats, messages, transactions,
  //     reviews, wishlists, reports, search_history,
  //     notifications, referrals, blocked_users
}, (app) => {
  // down() â€” remove all relation fields (reverse order)
  // For each collection: find it, remove the relation field, save
});
```

> **CRITICAL:** The coding agent must write out ALL 24 relation fields in this single file. The comment `// Repeat same pattern` above is just to show the pattern â€” the actual file must have every single relation explicitly coded.

---

ğŸ“¦ USE:
- PocketBase v0.23+ migration API with `$app`
- `app.findCollectionByNameOrId()` to get collection reference
- `collection.fields.add()` to add relation fields
- Deploy via `deploy.sh` (rsync â†’ VPS â†’ restart)

â›” DO NOT:
- Do NOT create new collections â€” they already exist from Prompt 2
- Do NOT modify non-relation fields â€” only ADD relation fields
- Do NOT use hardcoded collection IDs â€” always use `findCollectionByNameOrId()`
- Do NOT forget `cascadeDelete` settings as specified in the table above
- Do NOT skip the `down()` function â€” it must reverse ALL additions
- Do NOT use the legacy `dao` API

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”§ EXECUTE:

**Step 1:** Create `pb_migrations/019_add_relations.js` locally with all 24 relations
**Step 2:** Run `./deploy.sh` to push to VPS
**Step 3:** Verify in Admin UI that all relation fields appear on each collection

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ… SELF-CHECK:
1. Count relation fields: must be exactly **24** across 11 collections
2. Open each collection in Admin UI â†’ verify relation fields point to the correct target collection
3. Verify `cascadeDelete` is TRUE for: bundle_itemsâ†’bundle, messagesâ†’chat, reviewsâ†’transaction, wishlistsâ†’user, wishlistsâ†’book, search_historyâ†’user, notificationsâ†’user, blocked_usersâ†’blocker, blocked_usersâ†’blocked
4. Verify `cascadeDelete` is FALSE for all other relations
5. Verify `maxSelect: 1` on ALL relations (no multi-select relations in this app)
6. Verify `seller` on `books` is **required** â€” all other relations are optional
7. Test: create a test record in `books` â†’ verify you can assign a `seller` from `users` dropdown
8. If ANY relation is missing â†’ add NOW before confirming

ğŸ‘¤ USER MANUAL STEPS:
- Verify relations in Admin UI at `https://api.jayganga.com/_/` after deployment

ğŸ’¬ CONFIRM IN CHAT:
"Prompt 3 complete. All 24 relation fields added across 11 collections. cascadeDelete rules verified. All relations pointing to correct target collections. Zero errors."

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â­ï¸ NEXT: Prompt 4 â€” API Rules for All Collections
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ PROMPT 4 of 70
Phase: API Rules (PHASE_03)
Task: Set Security Rules for All 17 Collections
Type: ğŸ”§ BACKEND (Local Migration File)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ INSTRUCTION:
Create a **single local migration file** `pb_migrations/020_set_api_rules.js` that sets ALL API rules (listRule, viewRule, createRule, updateRule, deleteRule) for every collection.

> **Architecture Rule:** Local `.js` migration file â†’ deploy via `deploy.sh` (rsync â†’ VPS â†’ restart PocketBase). Never edit the VPS database directly.

> **PocketBase Rule Syntax:**
> - `""` (empty string) = **Public** â€” anyone can access, including guests
> - `null` = **Admin only** â€” no client access at all
> - `"@request.auth.id != ''"` = **Any authenticated user**
> - `"@request.auth.id = fieldName"` = **Owner only** â€” e.g., `"@request.auth.id = seller"`

---

### Complete API Rules for All 17 Collections

#### 1. `users` (Auth Collection)

| Rule | Value | Reason |
|------|-------|--------|
| listRule | `""` | Public â€” needed for trust scores, seller info on book cards |
| viewRule | `""` | Public â€” anyone can view a user profile |
| createRule | `""` | Public â€” PocketBase handles auth creation |
| updateRule | `"@request.auth.id = id"` | Owner only â€” edit own profile |
| deleteRule | `"@request.auth.id = id"` | Owner only â€” delete own account |

---

#### 2. `schools`

| Rule | Value | Reason |
|------|-------|--------|
| listRule | `""` | Public â€” needed for onboarding dropdown |
| viewRule | `""` | Public |
| createRule | `null` | Admin only â€” managed via Admin Panel |
| updateRule | `null` | Admin only |
| deleteRule | `null` | Admin only |

---

#### 3. `books`

| Rule | Value | Reason |
|------|-------|--------|
| listRule | `""` | Public â€” guests can browse listings |
| viewRule | `""` | Public â€” guests can view product details |
| createRule | `"@request.auth.id != ''"` | Any logged-in user can list a book |
| updateRule | `"@request.auth.id = seller"` | Only the seller can edit their listing |
| deleteRule | `"@request.auth.id = seller"` | Only the seller can delete their listing |

---

#### 4. `bundle_items`

| Rule | Value | Reason |
|------|-------|--------|
| listRule | `""` | Public â€” visible with bundle details |
| viewRule | `""` | Public |
| createRule | `"@request.auth.id != ''"` | Logged-in users (bundle ownership checked via hook) |
| updateRule | `"@request.auth.id = bundle.seller"` | Only bundle's seller can edit items |
| deleteRule | `"@request.auth.id = bundle.seller"` | Only bundle's seller can delete items |

---

#### 5. `chats`

| Rule | Value | Reason |
|------|-------|--------|
| listRule | `"@request.auth.id = buyer \|\| @request.auth.id = seller"` | Only chat participants |
| viewRule | `"@request.auth.id = buyer \|\| @request.auth.id = seller"` | Only chat participants |
| createRule | `"@request.auth.id != ''"` | Any logged-in user can start a chat |
| updateRule | `"@request.auth.id = buyer \|\| @request.auth.id = seller"` | Either participant (for offer accept/decline) |
| deleteRule | `"@request.auth.id = buyer \|\| @request.auth.id = seller"` | Either participant can delete chat |

---

#### 6. `messages`

| Rule | Value | Reason |
|------|-------|--------|
| listRule | `"@request.auth.id = chat.buyer \|\| @request.auth.id = chat.seller"` | Only chat participants see messages |
| viewRule | `"@request.auth.id = chat.buyer \|\| @request.auth.id = chat.seller"` | Only chat participants |
| createRule | `"@request.auth.id != '' && (@request.auth.id = chat.buyer \|\| @request.auth.id = chat.seller)"` | Must be a participant in the chat |
| updateRule | `"@request.auth.id = chat.buyer \|\| @request.auth.id = chat.seller"` | Either participant (for read receipts: is_read, is_delivered) |
| deleteRule | `null` | No message deletion â€” preserve chat history for disputes |

---

#### 7. `transactions`

| Rule | Value | Reason |
|------|-------|--------|
| listRule | `"@request.auth.id = buyer \|\| @request.auth.id = seller"` | Only transaction parties |
| viewRule | `"@request.auth.id = buyer \|\| @request.auth.id = seller"` | Only transaction parties |
| createRule | `"@request.auth.id != ''"` | Any logged-in user can initiate |
| updateRule | `"@request.auth.id = buyer \|\| @request.auth.id = seller"` | Either party (for QR scan confirmation) |
| deleteRule | `null` | Never delete transactions |

---

#### 8. `reviews`

| Rule | Value | Reason |
|------|-------|--------|
| listRule | `""` | Public â€” trust scores and reviews visible to all |
| viewRule | `""` | Public |
| createRule | `"@request.auth.id != ''"` | Any logged-in user (after QR handshake, validated via hook) |
| updateRule | `"@request.auth.id = reviewer"` | Only reviewer can edit their review |
| deleteRule | `null` | No review deletion â€” preserves trust system integrity |

---

#### 9. `wishlists`

| Rule | Value | Reason |
|------|-------|--------|
| listRule | `"@request.auth.id = user"` | Only own wishlists |
| viewRule | `"@request.auth.id = user"` | Only own wishlists |
| createRule | `"@request.auth.id != ''"` | Any logged-in user |
| updateRule | `null` | No updating â€” add or remove only |
| deleteRule | `"@request.auth.id = user"` | Only owner can remove from wishlist |

---

#### 10. `reports`

| Rule | Value | Reason |
|------|-------|--------|
| listRule | `null` | Admin only â€” users can't see reports |
| viewRule | `null` | Admin only |
| createRule | `"@request.auth.id != ''"` | Any logged-in user can submit a report |
| updateRule | `null` | Admin only â€” for status changes |
| deleteRule | `null` | Admin only |

---

#### 11. `banners`

| Rule | Value | Reason |
|------|-------|--------|
| listRule | `""` | Public â€” Home Screen carousel |
| viewRule | `""` | Public |
| createRule | `null` | Admin only â€” Banner Management |
| updateRule | `null` | Admin only |
| deleteRule | `null` | Admin only |

---

#### 12. `advertisements`

| Rule | Value | Reason |
|------|-------|--------|
| listRule | `""` | Public â€” Home Screen ad strip |
| viewRule | `""` | Public |
| createRule | `null` | Admin only â€” Ad Management |
| updateRule | `null` | Admin only |
| deleteRule | `null` | Admin only |

---

#### 13. `search_history`

| Rule | Value | Reason |
|------|-------|--------|
| listRule | `"@request.auth.id = user"` | Only own search history |
| viewRule | `"@request.auth.id = user"` | Only own |
| createRule | `"@request.auth.id != ''"` | Logged-in users |
| updateRule | `null` | No updating searches |
| deleteRule | `"@request.auth.id = user"` | Owner can clear history |

---

#### 14. `notifications`

| Rule | Value | Reason |
|------|-------|--------|
| listRule | `"@request.auth.id = user"` | Only own notifications |
| viewRule | `"@request.auth.id = user"` | Only own |
| createRule | `null` | Server/hooks only â€” never client-created |
| updateRule | `"@request.auth.id = user"` | Owner can mark as read |
| deleteRule | `"@request.auth.id = user"` | Owner can dismiss notifications |

---

#### 15. `referrals`

| Rule | Value | Reason |
|------|-------|--------|
| listRule | `"@request.auth.id = referrer \|\| @request.auth.id = referee"` | Only involved parties |
| viewRule | `"@request.auth.id = referrer \|\| @request.auth.id = referee"` | Only involved parties |
| createRule | `"@request.auth.id != ''"` | Logged-in users |
| updateRule | `null` | Server/hooks manage status changes |
| deleteRule | `null` | Never delete referrals |

---

#### 16. `blocked_users`

| Rule | Value | Reason |
|------|-------|--------|
| listRule | `"@request.auth.id = blocker"` | Only blocker sees their block list |
| viewRule | `"@request.auth.id = blocker"` | Only blocker |
| createRule | `"@request.auth.id != ''"` | Logged-in users can block |
| updateRule | `null` | No updating â€” block or unblock only |
| deleteRule | `"@request.auth.id = blocker"` | Only blocker can unblock |

---

#### 17. `app_config`

| Rule | Value | Reason |
|------|-------|--------|
| listRule | `""` | Public â€” force update check, maintenance mode |
| viewRule | `""` | Public |
| createRule | `null` | Admin only |
| updateRule | `null` | Admin only |
| deleteRule | `null` | Admin only |

---

ğŸ“ CREATE:

**File:** `pb_migrations/020_set_api_rules.js`

Pattern (PocketBase v0.23+):
```javascript
// pb_migrations/020_set_api_rules.js
migrate((app) => {
  // --- users ---
  const users = app.findCollectionByNameOrId("users");
  users.listRule = "";
  users.viewRule = "";
  users.createRule = "";
  users.updateRule = "@request.auth.id = id";
  users.deleteRule = "@request.auth.id = id";
  app.save(users);

  // --- schools ---
  const schools = app.findCollectionByNameOrId("schools");
  schools.listRule = "";
  schools.viewRule = "";
  schools.createRule = null;
  schools.updateRule = null;
  schools.deleteRule = null;
  app.save(schools);

  // --- books ---
  const books = app.findCollectionByNameOrId("books");
  books.listRule = "";
  books.viewRule = "";
  books.createRule = "@request.auth.id != ''";
  books.updateRule = "@request.auth.id = seller";
  books.deleteRule = "@request.auth.id = seller";
  app.save(books);

  // ... REPEAT for ALL remaining 14 collections
  //     using EXACT rule values from the tables above
}, (app) => {
  // down() â€” reset all rules to null (locked down)
});
```

> **CRITICAL:** The coding agent must write out rules for ALL 17 collections. The `// ... REPEAT` above is just to show the pattern â€” the actual file must have every collection explicitly.

---

ğŸ“¦ USE:
- PocketBase v0.23+ migration API
- `app.findCollectionByNameOrId()` to get each collection
- Set `.listRule`, `.viewRule`, `.createRule`, `.updateRule`, `.deleteRule` directly
- Deploy via `deploy.sh` (rsync â†’ VPS â†’ restart)

â›” DO NOT:
- Do NOT leave any collection without rules â€” ALL 17 must be configured
- Do NOT use `""` (public) for sensitive collections (chats, messages, notifications, etc.)
- Do NOT use `null` for guest-accessible content (books, banners, schools, etc.)
- Do NOT forget the `||` syntax for dual-party checks (buyer || seller)
- Do NOT modify any collection fields â€” only set rules
- Do NOT use the legacy `dao` API
- Do NOT allow client-side creation of notifications â€” that's server/hooks only

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”§ EXECUTE:

**Step 1:** Create `pb_migrations/020_set_api_rules.js` locally with ALL 17 collections
**Step 2:** Run `./deploy.sh` to push to VPS
**Step 3:** Test access patterns (see Self-Check below)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ… SELF-CHECK:
1. Verify ALL 17 collections have rules set (no collection should show "Only Admins can manage" unless intended)
2. **Guest test:** `curl https://api.jayganga.com/api/collections/books/records` â†’ should return books (200 OK)
3. **Guest test:** `curl https://api.jayganga.com/api/collections/chats/records` â†’ should return 403 Forbidden
4. **Guest test:** `curl https://api.jayganga.com/api/collections/banners/records` â†’ should return banners (200 OK)
5. **Guest test:** `curl https://api.jayganga.com/api/collections/reports/records` â†’ should return 403 Forbidden
6. **Auth test:** Authenticated request to create a book â†’ should succeed
7. **Auth test:** Authenticated request to update someone else's book â†’ should fail (403)
8. **Auth test:** Authenticated request to create a notification â†’ should fail (null createRule)
9. Verify `app_config` is publicly readable (force update check needs no auth)
10. If ANY rule is wrong â†’ fix NOW before confirming

ğŸ‘¤ USER MANUAL STEPS:
- Verify rules in Admin UI at `https://api.jayganga.com/_/` â†’ click each collection â†’ check "API Rules" tab
- Run the curl tests above from your terminal to confirm

ğŸ’¬ CONFIRM IN CHAT:
"Prompt 4 complete. API rules set for all 17 collections. Guest browsing works (books, banners, schools). Sensitive data locked (chats, messages, reports). Owner-only edits enforced. Zero errors."

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â­ï¸ NEXT: Prompt 5 â€” Dart Model Classes for All Collections
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ PROMPT 5 of 70
Phase: PocketBase Collections (PHASE_02)
Task: Create Typed Dart Model Classes for All 17 Collections
Type: ğŸ“± FRONTEND (Dart Files in lib/models/)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ INSTRUCTION:
Create **17 Dart model files** in `lib/models/` â€” one per PocketBase collection. Each model must have:
- All fields matching the PocketBase collection schema (from Prompts 2 & 3)
- `factory fromJson(Map<String, dynamic> json)` constructor
- `Map<String, dynamic> toJson()` method
- Proper Dart types with **null safety** (nullable `?` for optional fields)
- `const` constructor where possible
- `toString()` override for debugging
- `copyWith()` method for immutable updates

> **Architecture:** Models are pure data classes â€” NO business logic, NO PocketBase imports, NO API calls. They simply serialize/deserialize JSON.

---

ğŸ“ CREATE (17 files):

### File 1: `lib/models/user_model.dart`

```dart
class UserModel {
  final String id;
  final String email;
  final String name;
  final String? avatar;
  final String phone;
  final String? userType;       // "school_student" | "exam_aspirant" | "college_student"
  final String? classYear;
  final String? board;          // "CBSE" | "ICSE" | "State Board" | "IB" | "Other"
  final String? stream;         // "Science" | "Commerce" | "Arts" | "General"
  final String? examType;       // "JEE" | "NEET" | "Bank" | "SSC" | "UPSC" | "State PSC" | "Other"
  final String? coachingInstitute;
  final String? collegeName;
  final String? collegeBranch;
  final String? collegeSemester;
  final String? school;         // relation ID â†’ schools
  final double? locationLat;
  final double? locationLon;
  final String? city;
  final String? area;
  final String? bio;
  final List<String> badges;    // ["helping_hand", "top_seller", ...]
  final double trustScore;
  final int reviewCount;
  final int totalSales;
  final int totalPurchases;
  final String? referralCode;
  final String? referredBy;     // relation ID â†’ users
  final String? fcmToken;
  final bool isBanned;
  final String? banReason;
  final DateTime? lastActive;
  final bool onboardingComplete;
  final String preferredLanguage; // "en" | "hi"
  final int preferredRadius;
  final String darkMode;        // "system" | "light" | "dark"
  final DateTime? priorityUntil;
  final DateTime created;
  final DateTime updated;

  // const constructor, fromJson, toJson, copyWith, toString
}
```

> **CRITICAL:** The coding agent must write the FULL implementation of `fromJson`, `toJson`, `copyWith`, and `toString` for this class. The above is the **field specification** only â€” do NOT leave stubs.

---

### File 2: `lib/models/school_model.dart`

| Field | Dart Type | PB Field |
|-------|-----------|----------|
| `id` | `String` | system |
| `name` | `String` | name |
| `city` | `String` | city |
| `area` | `String?` | area |
| `type` | `String` | type ("school", "coaching", "college") |
| `board` | `String?` | board |
| `isActive` | `bool` | is_active |
| `created` | `DateTime` | system |
| `updated` | `DateTime` | system |

---

### File 3: `lib/models/book_model.dart`

| Field | Dart Type | PB Field |
|-------|-----------|----------|
| `id` | `String` | system |
| `title` | `String` | title |
| `author` | `String` | author |
| `edition` | `String?` | edition |
| `publisher` | `String?` | publisher |
| `description` | `String?` | description |
| `photos` | `List<String>` | photos (file names) |
| `mrp` | `double?` | mrp |
| `sellingPrice` | `double` | selling_price |
| `condition` | `String` | condition ("like_new", "good", "fair") |
| `conditionTags` | `List<String>` | condition_tags |
| `category` | `String` | category |
| `classYear` | `String?` | class_year |
| `board` | `String?` | board |
| `stream` | `String?` | stream |
| `status` | `String` | status ("active", "reserved", "sold", "archived", "draft") |
| `isBundle` | `bool` | is_bundle |
| `bundleName` | `String?` | bundle_name |
| `bundleTotalMrp` | `double?` | bundle_total_mrp |
| `handoverArea` | `String?` | handover_area |
| `availableFrom` | `DateTime?` | available_from |
| `viewsCount` | `int` | views_count |
| `wishlistCount` | `int` | wishlist_count |
| `locationLat` | `double?` | location_lat |
| `locationLon` | `double?` | location_lon |
| `isPriority` | `bool` | is_priority |
| `autoArchiveDate` | `DateTime?` | auto_archive_date |
| `seller` | `String` | seller (relation ID â†’ users) |
| `school` | `String?` | school (relation ID â†’ schools) |
| `created` | `DateTime` | system |
| `updated` | `DateTime` | system |

> **Helper getter:** `bool get isFree => sellingPrice == 0;`
> **Helper getter:** `int? get discountPercent => mrp != null && mrp! > 0 ? ((1 - sellingPrice / mrp!) * 100).round() : null;`

---

### File 4: `lib/models/bundle_item_model.dart`

| Field | Dart Type | PB Field |
|-------|-----------|----------|
| `id` | `String` | system |
| `bundle` | `String` | bundle (relation ID â†’ books) |
| `itemTitle` | `String` | item_title |
| `itemAuthor` | `String?` | item_author |
| `itemCondition` | `String?` | item_condition |
| `created` | `DateTime` | system |
| `updated` | `DateTime` | system |

---

### File 5: `lib/models/chat_model.dart`

| Field | Dart Type | PB Field |
|-------|-----------|----------|
| `id` | `String` | system |
| `buyer` | `String` | buyer (relation ID â†’ users) |
| `seller` | `String` | seller (relation ID â†’ users) |
| `book` | `String` | book (relation ID â†’ books) |
| `lastMessage` | `String?` | last_message |
| `lastMessageAt` | `DateTime?` | last_message_at |
| `isActive` | `bool` | is_active |
| `offerAmount` | `double?` | offer_amount |
| `offerStatus` | `String` | offer_status ("none", "pending", "accepted", "declined", "expired") |
| `offerExpiresAt` | `DateTime?` | offer_expires_at |
| `created` | `DateTime` | system |
| `updated` | `DateTime` | system |

---

### File 6: `lib/models/message_model.dart`

| Field | Dart Type | PB Field |
|-------|-----------|----------|
| `id` | `String` | system |
| `chat` | `String` | chat (relation ID â†’ chats) |
| `sender` | `String` | sender (relation ID â†’ users) |
| `content` | `String?` | content |
| `type` | `String` | type ("text", "image", "offer", "system") |
| `image` | `String?` | image (file name) |
| `offerAmount` | `double?` | offer_amount |
| `isRead` | `bool` | is_read |
| `isDelivered` | `bool` | is_delivered |
| `created` | `DateTime` | system |
| `updated` | `DateTime` | system |

---

### File 7: `lib/models/transaction_model.dart`

| Field | Dart Type | PB Field |
|-------|-----------|----------|
| `id` | `String` | system |
| `book` | `String` | book (relation ID â†’ books) |
| `buyer` | `String` | buyer (relation ID â†’ users) |
| `seller` | `String` | seller (relation ID â†’ users) |
| `amount` | `double` | amount |
| `status` | `String` | status ("pending", "completed", "disputed", "reversed") |
| `qrToken` | `String?` | qr_token |
| `qrGeneratedAt` | `DateTime?` | qr_generated_at |
| `completedAt` | `DateTime?` | completed_at |
| `isOfflineSyncPending` | `bool` | is_offline_sync_pending |
| `created` | `DateTime` | system |
| `updated` | `DateTime` | system |

---

### File 8: `lib/models/review_model.dart`

| Field | Dart Type | PB Field |
|-------|-----------|----------|
| `id` | `String` | system |
| `transaction` | `String` | transaction (relation ID) |
| `reviewer` | `String` | reviewer (relation ID â†’ users) |
| `reviewee` | `String` | reviewee (relation ID â†’ users) |
| `rating` | `int` | rating (1â€“5) |
| `comment` | `String?` | comment |
| `conditionAccurate` | `bool?` | condition_accurate |
| `created` | `DateTime` | system |
| `updated` | `DateTime` | system |

---

### File 9: `lib/models/wishlist_model.dart`

| Field | Dart Type | PB Field |
|-------|-----------|----------|
| `id` | `String` | system |
| `user` | `String` | user (relation ID â†’ users) |
| `book` | `String` | book (relation ID â†’ books) |
| `priceAtSave` | `double?` | price_at_save |
| `created` | `DateTime` | system |
| `updated` | `DateTime` | system |

---

### File 10: `lib/models/report_model.dart`

| Field | Dart Type | PB Field |
|-------|-----------|----------|
| `id` | `String` | system |
| `reporter` | `String` | reporter (relation ID â†’ users) |
| `type` | `String` | type ("listing", "user", "bug") |
| `reason` | `String` | reason |
| `description` | `String?` | description |
| `screenshot` | `String?` | screenshot (file name) |
| `targetType` | `String?` | target_type |
| `targetId` | `String?` | target_id |
| `status` | `String` | status ("pending", "reviewed", "actioned", "dismissed") |
| `adminNotes` | `String?` | admin_notes |
| `created` | `DateTime` | system |
| `updated` | `DateTime` | system |

---

### File 11: `lib/models/banner_model.dart`

| Field | Dart Type | PB Field |
|-------|-----------|----------|
| `id` | `String` | system |
| `title` | `String` | title |
| `image` | `String` | image (file name) |
| `link` | `String?` | link |
| `startDate` | `DateTime` | start_date |
| `endDate` | `DateTime` | end_date |
| `isActive` | `bool` | is_active |
| `sortOrder` | `int?` | sort_order |
| `created` | `DateTime` | system |
| `updated` | `DateTime` | system |

> **Helper getter:** `bool get isCurrentlyActive => isActive && DateTime.now().isAfter(startDate) && DateTime.now().isBefore(endDate);`

---

### File 12: `lib/models/advertisement_model.dart`

| Field | Dart Type | PB Field |
|-------|-----------|----------|
| `id` | `String` | system |
| `businessName` | `String` | business_name |
| `logo` | `String?` | logo (file name) |
| `tagline` | `String?` | tagline |
| `link` | `String?` | link |
| `phone` | `String?` | phone |
| `isActive` | `bool` | is_active |
| `sortOrder` | `int?` | sort_order |
| `created` | `DateTime` | system |
| `updated` | `DateTime` | system |

---

### File 13: `lib/models/search_history_model.dart`

| Field | Dart Type | PB Field |
|-------|-----------|----------|
| `id` | `String` | system |
| `user` | `String` | user (relation ID â†’ users) |
| `query` | `String` | query |
| `created` | `DateTime` | system |
| `updated` | `DateTime` | system |

---

### File 14: `lib/models/notification_model.dart`

| Field | Dart Type | PB Field |
|-------|-----------|----------|
| `id` | `String` | system |
| `user` | `String` | user (relation ID â†’ users) |
| `title` | `String` | title |
| `body` | `String` | body |
| `type` | `String` | type ("chat", "offer", "price_drop", "recommendation", "referral", "system", "inactivity", "seller_reminder") |
| `isRead` | `bool` | is_read |
| `data` | `Map<String, dynamic>?` | data (JSON) |
| `created` | `DateTime` | system |
| `updated` | `DateTime` | system |

---

### File 15: `lib/models/referral_model.dart`

| Field | Dart Type | PB Field |
|-------|-----------|----------|
| `id` | `String` | system |
| `referrer` | `String` | referrer (relation ID â†’ users) |
| `referee` | `String` | referee (relation ID â†’ users) |
| `referralCode` | `String` | referral_code |
| `status` | `String` | status ("invited", "registered", "completed") |
| `rewardGranted` | `bool` | reward_granted |
| `created` | `DateTime` | system |
| `updated` | `DateTime` | system |

---

### File 16: `lib/models/blocked_user_model.dart`

| Field | Dart Type | PB Field |
|-------|-----------|----------|
| `id` | `String` | system |
| `blocker` | `String` | blocker (relation ID â†’ users) |
| `blocked` | `String` | blocked (relation ID â†’ users) |
| `created` | `DateTime` | system |
| `updated` | `DateTime` | system |

---

### File 17: `lib/models/app_config_model.dart`

| Field | Dart Type | PB Field |
|-------|-----------|----------|
| `id` | `String` | system |
| `key` | `String` | key |
| `value` | `dynamic` | value (JSON â€” can be String, bool, int, List) |
| `description` | `String?` | description |
| `created` | `DateTime` | system |
| `updated` | `DateTime` | system |

---

### JSON Serialization Rules:

```dart
// fromJson pattern:
factory ModelName.fromJson(Map<String, dynamic> json) {
  return ModelName(
    id: json['id'] as String,
    name: json['name'] as String,
    // For DateTime:
    created: DateTime.parse(json['created'] as String),
    // For nullable DateTime:
    lastActive: json['last_active'] != null && json['last_active'] != ''
        ? DateTime.parse(json['last_active'] as String)
        : null,
    // For List<String> from JSON array:
    badges: (json['badges'] as List<dynamic>?)?.cast<String>() ?? [],
    // For double from number:
    trustScore: (json['trust_score'] as num?)?.toDouble() ?? 0.0,
    // For int:
    reviewCount: json['review_count'] as int? ?? 0,
    // For bool:
    isBanned: json['is_banned'] as bool? ?? false,
  );
}

// toJson pattern (only include writable fields â€” NOT id, created, updated):
Map<String, dynamic> toJson() {
  return {
    'name': name,
    'phone': phone,
    // For nullable: include only if not null
    if (bio != null) 'bio': bio,
    // For DateTime:
    if (lastActive != null) 'last_active': lastActive!.toIso8601String(),
    // For List:
    'badges': badges,
  };
}
```

---

ğŸ“¦ USE:
- Pure Dart â€” no external packages needed for models
- Snake_case JSON keys matching PocketBase field names
- CamelCase Dart field names
- `DateTime.parse()` for date fields
- `as num` then `.toDouble()` for number fields (PocketBase may send int or double)

â›” DO NOT:
- Do NOT import PocketBase SDK in model files â€” models are pure data classes
- Do NOT add business logic to models (no API calls, no state management)
- Do NOT include `id`, `created`, `updated` in `toJson()` â€” these are server-managed
- Do NOT use `dynamic` for typed fields â€” use proper Dart types
- Do NOT forget null safety (`?`) for optional PocketBase fields
- Do NOT hardcode relation IDs â€” they are always `String` (PocketBase record IDs)
- Do NOT skip `copyWith()` â€” needed for immutable state updates

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”§ EXECUTE:

**Step 1:** Create all 17 files in `lib/models/`
**Step 2:** Run `flutter analyze` â€” must show 0 issues
**Step 3:** Verify each model compiles and has fromJson/toJson/copyWith

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ… SELF-CHECK:
1. Count model files â€” must be exactly **17** in `lib/models/`
2. Every model has: `fromJson()`, `toJson()`, `copyWith()`, `toString()`
3. All field names use **camelCase** in Dart, **snake_case** in JSON keys
4. All `DateTime` fields use `DateTime.parse()` in fromJson
5. All `List<String>` fields have fallback `?? []`
6. All number fields use `(json['field'] as num?)?.toDouble()` pattern
7. `toJson()` does NOT include `id`, `created`, `updated`
8. `flutter analyze` returns **0 issues**
9. If ANY model is incomplete â†’ finish NOW before confirming

ğŸ’¬ CONFIRM IN CHAT:
"Prompt 5 complete. All 17 Dart model classes created in lib/models/. fromJson/toJson/copyWith implemented. flutter analyze: 0 issues. Zero errors."

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â­ï¸ NEXT: Prompt 6 â€” Google OAuth Authentication (PocketBase + Flutter)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ PROMPT 6 of 70
Phase: Authentication (PHASE_04)
Task: Google OAuth â€” PocketBase Config + Flutter Login Flow
Type: ğŸ”§ BACKEND + ğŸ“± FRONTEND
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ INSTRUCTION:
Implement **Google OAuth** as the **sole authentication method** for JayGanga Books. No email/password. No forgot password. No email verification. Just Google Sign-In.

> **Flow:** User taps "Continue with Google" â†’ Google sign-in popup â†’ PocketBase creates/authenticates user â†’ auth token stored in `AsyncAuthStore` (SharedPreferences) â†’ user redirected to Home Screen.

---

### PART A: PocketBase Google OAuth Provider (Backend)

ğŸ“ CREATE: `pb_migrations/021_enable_google_oauth.js`

```javascript
// pb_migrations/021_enable_google_oauth.js
migrate((app) => {
  const users = app.findCollectionByNameOrId("users");

  // Enable Google OAuth provider
  users.oauth2 = {
    enabled: true,
    providers: [
      {
        name: "google",
        clientId: "GOOGLE_CLIENT_ID",       // âš ï¸ USER must replace
        clientSecret: "GOOGLE_CLIENT_SECRET", // âš ï¸ USER must replace
        displayName: "Google",
      },
    ],
  };

  app.save(users);
}, (app) => {
  const users = app.findCollectionByNameOrId("users");
  users.oauth2 = { enabled: false, providers: [] };
  app.save(users);
});
```

> **âš ï¸ IMPORTANT:** The `clientId` and `clientSecret` values must be provided by the USER after completing the Google Cloud Console setup (see USER MANUAL STEPS below). Use placeholder strings that are obvious â€” the user will replace them before deploying.

---

### PART B: Flutter Auth Service (Frontend)

ğŸ“ CREATE: `lib/services/auth_service.dart`

This service handles the entire Google OAuth flow using PocketBase SDK.

```dart
// Key methods required:
class AuthService {
  // PocketBase instance from pocketbase_service.dart
  
  /// Check if user is currently authenticated
  bool get isLoggedIn;
  
  /// Get current authenticated user as UserModel
  UserModel? get currentUser;
  
  /// Google Sign-In â†’ PocketBase OAuth
  /// 1. Call pb.collection('users').authWithOAuth2('google', ...)
  /// 2. On success: user is auto-created in PocketBase if first login
  /// 3. Store auth token in AsyncAuthStore (already persisted via SharedPreferences)
  /// 4. Return UserModel
  Future<UserModel> signInWithGoogle();
  
  /// Sign out
  /// 1. Clear PocketBase auth store
  /// 2. Clear any cached user data
  Future<void> signOut();
  
  /// Check if auth token is still valid
  /// If expired â†’ clear auth store â†’ redirect to splash
  Future<bool> isTokenValid();
  
  /// Check if current user is banned
  /// If banned â†’ sign out â†’ show "Account suspended" message
  Future<bool> isUserBanned();
  
  /// Get fresh user data from server
  Future<UserModel> refreshCurrentUser();
}
```

**PocketBase OAuth2 Flow (Dart SDK):**
```dart
// The PocketBase Dart SDK handles the OAuth redirect internally
// For Flutter mobile, use the built-in browser flow:
final authData = await pb.collection('users').authWithOAuth2('google', (url) async {
  // Open the OAuth URL in the system browser or webview
  await launchUrl(url, mode: LaunchMode.externalApplication);
});

// authData.record contains the user record
// authData.token contains the auth token
// Auth store is automatically updated
```

> **CRITICAL:** Use `url_launcher` package to open the OAuth URL. The PocketBase SDK callback-based OAuth flow handles the redirect URI automatically.

---

### PART C: Login Gate Widget (Frontend)

ğŸ“ CREATE: `lib/widgets/login_gate.dart`

A reusable **bottom sheet** that slides up whenever a guest taps a login-required action.

```dart
// Usage anywhere in the app:
// LoginGate.show(context, onSuccess: () { /* action after login */ });

class LoginGate {
  /// Shows bottom sheet with "Sign in to continue" message
  /// and "Continue with Google" button
  /// 
  /// After successful login:
  /// 1. Bottom sheet dismisses
  /// 2. onSuccess callback fires
  /// 3. User stays on the SAME screen (no context lost)
  static Future<bool> show(BuildContext context, {VoidCallback? onSuccess});
}
```

**Design requirements:**
- Bottom sheet with rounded top corners
- "Sign in to continue" title text
- App logo (small)
- "Continue with Google" button with Google logo icon
- Loading state while auth is in progress
- Error state with retry option
- Dismiss by swiping down (cancels login)

---

### PART D: Auth State Check (Frontend)

ğŸ“ MODIFY: `lib/app.dart`

Add auth state check to the app initialization:

```dart
// On app start:
// 1. Check if auth token exists in SharedPreferences
// 2. If yes â†’ verify token is still valid via PocketBase health check
// 3. If valid â†’ check if user is banned
// 4. If banned â†’ sign out + show banned message
// 5. If valid + not banned â†’ proceed to Home Screen
// 6. If no token or invalid â†’ show Splash Screen (guest mode)
```

---

ğŸ“¦ USE:
- `pocketbase` Dart SDK â€” `authWithOAuth2('google', ...)`
- `url_launcher` â€” open OAuth URL in system browser
- `google_sign_in` package â€” for native Google Sign-In on Android
- `shared_preferences` â€” auth token persistence (already in pocketbase_service.dart)
- PocketBase `AsyncAuthStore` â€” manages token lifecycle
- Deploy migration via `deploy.sh` (rsync â†’ VPS â†’ restart)

â›” DO NOT:
- Do NOT implement email/password login â€” Google OAuth only
- Do NOT implement forgot password or email verification
- Do NOT store auth tokens manually â€” PocketBase SDK + AsyncAuthStore handles this
- Do NOT show login screen as a full page â€” use LoginGate bottom sheet
- Do NOT redirect away from current screen after login â€” return to same context
- Do NOT hardcode Google Client ID/Secret in Dart code â€” those go in the PocketBase migration file only
- Do NOT use the legacy `dao` API

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”§ EXECUTE:

**Step 1:** Create `pb_migrations/021_enable_google_oauth.js` with placeholder client ID/secret
**Step 2:** Create `lib/services/auth_service.dart` with full Google OAuth flow
**Step 3:** Create `lib/widgets/login_gate.dart` bottom sheet widget
**Step 4:** Modify `lib/app.dart` to check auth state on startup
**Step 5:** Run `flutter analyze` â€” 0 issues
**Step 6:** Deploy migration via `./deploy.sh`

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ… SELF-CHECK:
1. Auth service has `signInWithGoogle()`, `signOut()`, `isTokenValid()`, `isUserBanned()`
2. LoginGate shows as bottom sheet (NOT full screen)
3. After login, user returns to the SAME screen they were on
4. Auth token persists across app restarts (SharedPreferences)
5. Banned user check works â€” signs out and shows message
6. `flutter analyze` returns 0 issues
7. Migration file has placeholder client ID with clear `âš ï¸ USER must replace` comment

ğŸ‘¤ USER MANUAL STEPS:
**âš ï¸ YOU (the user) must do these steps yourself â€” the coding agent cannot do them:**

**Step 1 â€” Create Google Cloud Project:**
1. Go to [Google Cloud Console](https://console.cloud.google.com/)
2. Create a new project â†’ name it "JayGanga Books"
3. Note the **Project ID**

**Step 2 â€” Configure OAuth Consent Screen:**
1. Go to **APIs & Services â†’ OAuth consent screen**
2. Select **External** â†’ Create
3. App name: "JayGanga Books"
4. User support email: your email
5. Authorized domains: `jayganga.com`
6. Save and continue through all steps

**Step 3 â€” Create OAuth Credentials:**
1. Go to **APIs & Services â†’ Credentials**
2. Click **+ CREATE CREDENTIALS â†’ OAuth client ID**
3. Application type: **Web application** (yes, Web â€” PocketBase uses this)
4. Name: "PocketBase OAuth"
5. Authorized redirect URIs: `https://api.jayganga.com/api/oauth2-redirect`
6. Click **Create**
7. Copy the **Client ID** and **Client Secret** â† ğŸ”‘ THESE ARE THE KEYS

**Step 4 â€” Create Android OAuth Credentials (for Flutter):**
1. Click **+ CREATE CREDENTIALS â†’ OAuth client ID** again
2. Application type: **Android**
3. Package name: `com.jayganga.books`
4. SHA-1 fingerprint: Run this command in your terminal:
   ```bash
   keytool -list -v -keystore ~/.android/debug.keystore -alias androiddebugkey -storepass android -keypass android
   ```
   Copy the SHA1 value (e.g., `AB:CD:EF:12:34:...`)
5. Click **Create**

**Step 5 â€” Put Keys in Migration File:**
1. Open `pb_migrations/021_enable_google_oauth.js`
2. Replace `GOOGLE_CLIENT_ID` with the **Web** Client ID from Step 3
3. Replace `GOOGLE_CLIENT_SECRET` with the **Web** Client Secret from Step 3
4. Run `./deploy.sh` to push to VPS

**Step 6 â€” Verify in PocketBase Admin:**
1. Go to `https://api.jayganga.com/_/`
2. Click **users** collection â†’ **API Rules** â†’ **Auth options**
3. Confirm Google OAuth provider is listed and enabled

> **Keys you need to provide to the coding agent:**
> - ğŸ”‘ Web OAuth Client ID (for PocketBase)
> - ğŸ”‘ Web OAuth Client Secret (for PocketBase)
> - ğŸ”‘ Android SHA-1 fingerprint (for google_sign_in package)

ğŸ’¬ CONFIRM IN CHAT:
"Prompt 6 complete. Google OAuth configured in PocketBase migration. Auth service created. LoginGate bottom sheet implemented. Auth state check on app startup. flutter analyze: 0 issues. Zero errors."

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â­ï¸ NEXT: Prompt 7 â€” User Onboarding Flow (Registration Steps)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ PROMPT 7 of 70
Phase: Authentication (PHASE_04)
Task: User Onboarding â€” 5-Step Registration Flow After Google Sign-In
Type: ğŸ“± FRONTEND (Flutter Screens)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ INSTRUCTION:
Build the **5-step onboarding wizard** that runs immediately after a user's **first** Google Sign-In. This flow collects the user's mobile number, location, academic profile, and notification permission â€” then marks `onboarding_complete: true` in PocketBase.

> **Trigger:** After `authWithOAuth2('google')` returns, check `user.onboardingComplete`. If `false` â†’ launch onboarding. If `true` â†’ skip to Home Screen.
>
> **Guest-First Rule:** Users who tap "Explore Books" from the splash never see this flow. It only runs after Google sign-in.

---

### Screen Structure

ğŸ“ CREATE: `lib/screens/auth/onboarding_screen.dart`

A **PageView wizard** with a progress indicator (Step 1 of 5) at the top and Next/Back navigation.

---

### Step 1 â€” Mobile Number

ğŸ“ CREATE: `lib/screens/auth/steps/mobile_number_step.dart`

| Element | Details |
|---------|---------|
| **Title** | "Enter your mobile number" |
| **Subtitle** | "This is private. Never shown publicly. Used only for account recovery." |
| **Input** | Text field with `+91` prefix (auto-filled, non-editable). 10-digit numeric keyboard only. |
| **Validation** | Exactly 10 digits. Inline error: *"Enter a valid 10-digit mobile number."* |
| **Duplicate Check** | Query PocketBase: `pb.collection('users').getList(filter: 'phone = "+91XXXXXXXXXX"')`. If found AND it's not the current user â†’ error: *"This number is already linked to another account. Use a different number or contact support."* |
| **Button** | "Continue" â€” disabled until 10 digits entered |
| **Save** | Update `users` record: `phone` field |
| **Skip** | âŒ NOT skippable â€” phone is mandatory |

---

### Step 2 â€” Location Permission

ğŸ“ CREATE: `lib/screens/auth/steps/location_step.dart`

| Element | Details |
|---------|---------|
| **Title** | "Set your location" |
| **Subtitle** | "We use your approximate location to show books near you." |
| **Primary Action** | "Enable Location" button â†’ triggers system location permission dialog |
| **If Allowed** | Use `geolocator` to get lat/lon â†’ use `geocoding` to reverse-geocode into City + Area. Show detected location: *"ğŸ“ Boring Road, Patna"* with a "Change" link. |
| **If Denied** | Show manual **city/area picker** (searchable dropdown). Subtle info banner: *"Enable location for better results."* |
| **Manual Picker** | Searchable text field for Area/City name. User types â†’ suggestions appear (from a local list of major Indian cities OR freeform text). |
| **Save** | Update `users` record: `location_lat`, `location_lon`, `city`, `area`, `preferred_radius: 5` (default) |
| **Skip** | âŒ NOT skippable â€” location is needed for the app to work |

---

### Step 3 â€” Academic Profile

ğŸ“ CREATE: `lib/screens/auth/steps/academic_profile_step.dart`

| Element | Details |
|---------|---------|
| **Title** | "Tell us about yourself" |
| **Subtitle** | "This helps us recommend the right books for you. It's private." |
| **Radio Group** | "I am a:" â†’ 3 options: *School Student* / *Exam Aspirant* / *College Student* |

**If "School Student" selected:**
| Field | Type | Details |
|-------|------|---------|
| School Name | Searchable dropdown | Queries `schools` collection (type = "school"). User can type to filter. |
| Class | Select | Options: "1" through "12" |
| Board | Select | CBSE / ICSE / State Board / IB / Other |

**If "Exam Aspirant" selected:**
| Field | Type | Details |
|-------|------|---------|
| Exam | Select | JEE / NEET / Bank / SSC / UPSC / State PSC / Other |
| Coaching Institute | Searchable dropdown (optional) | Queries `schools` collection (type = "coaching") |

**If "College Student" selected:**
| Field | Type | Details |
|-------|------|---------|
| College Name | Searchable dropdown | Queries `schools` collection (type = "college") |
| Branch | Text field | e.g., "Computer Science", "Mechanical" |
| Year/Semester | Text field | e.g., "3rd Year", "5th Sem" |

| **Save** | Update `users` record: `user_type`, `class_year`, `board`, `stream`, `exam_type`, `coaching_institute`, `college_name`, `college_branch`, `college_semester`, `school` (relation ID) |
| **Skip** | âœ… Skippable â€” "Skip for now" link at bottom. Recommendations section on Home will show CTA instead. |

---

### Step 4 â€” Notification Permission

ğŸ“ CREATE: `lib/screens/auth/steps/notification_step.dart`

| Element | Details |
|---------|---------|
| **Title** | "Stay updated" |
| **Subtitle** | "Get notified about new messages, price drops, and book recommendations." |
| **Illustration** | Bell icon with notification card examples |
| **Button** | "Enable Notifications" â†’ triggers system notification permission dialog (Android 13+) |
| **Android 12 and below** | Auto-skip this step (notifications enabled by default) |
| **If Allowed** | Register FCM token via `firebase_messaging` â†’ save `fcm_token` to user record |
| **If Denied** | Continue without. No persistent nag. |
| **Skip** | âœ… Skippable â€” "Maybe Later" link |

---

### Step 5 â€” Terms & Consent

ğŸ“ CREATE: `lib/screens/auth/steps/terms_step.dart`

| Element | Details |
|---------|---------|
| **Title** | "Almost done!" |
| **Content** | Summary card showing: Name (from Google), Area, Academic type |
| **Checkbox** | *"I agree to the [Terms & Conditions] and [Privacy Policy]"* â€” links open in-app webview. Checkbox is **unchecked by default**. |
| **Button** | "Get Started" â€” disabled until checkbox is checked |
| **Action** | Update user: `onboarding_complete: true` â†’ Navigate to Home Screen |

---

### Navigation Logic

```
Google Sign-In Success
  â””â†’ Is onboarding_complete == true?
       â”œâ†’ YES â†’ Navigate to Home Screen
       â””â†’ NO â†’ Launch Onboarding PageView
             Step 1: Mobile Number (mandatory)
             Step 2: Location (mandatory)
             Step 3: Academic Profile (skippable)
             Step 4: Notifications (skippable, auto-skip on Android â‰¤12)
             Step 5: Terms & Consent (mandatory)
             â””â†’ onboarding_complete = true â†’ Home Screen
```

### Progress Indicator

- Linear progress bar at the top (fills as user advances)
- "Step X of 5" text below the progress bar
- Back button (â†) on steps 2â€“5 to go back
- No back button on Step 1 (first step after Google sign-in)

### Error Handling

- If PocketBase update fails during any step â†’ show snackbar: *"Something went wrong. Please try again."* + Retry button
- If network drops â†’ allow user to continue but queue updates for when online (draft to Hive)
- If user kills app mid-onboarding â†’ next launch checks `onboarding_complete` â†’ resumes onboarding

---

### Referral Code Check (Bonus)

After Google Sign-In but BEFORE onboarding starts:
1. Check if the app was opened via a **referral deep link** (e.g., `jayganga.app/ref/ABC123`)
2. If yes â†’ set `referred_by` on the user record to the referrer's user ID
3. Create a `referrals` record with status `"registered"`

> This is silent â€” user doesn't see anything about referrals during onboarding.

---

ğŸ“¦ USE:
- `geolocator` â€” get device location
- `geocoding` â€” reverse geocode lat/lon â†’ city/area
- `firebase_messaging` â€” get FCM token
- `pocketbase` SDK â€” update user record
- `go_router` â€” navigation after onboarding
- `provider` â€” auth state management
- School/coaching/college dropdowns query `schools` collection via PocketBase SDK

â›” DO NOT:
- Do NOT show onboarding to returning users (check `onboarding_complete`)
- Do NOT make academic profile mandatory â€” it's skippable
- Do NOT request "precise" location â€” use approximate/coarse location only
- Do NOT show phone number publicly anywhere in the app â€” ever
- Do NOT auto-check the Terms checkbox â€” user must manually check it
- Do NOT use email/password anywhere â€” Google OAuth is the only auth method
- Do NOT skip the duplicate phone number check â€” prevent multi-account abuse

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”§ EXECUTE:

**Step 1:** Create `lib/screens/auth/onboarding_screen.dart` (PageView container)
**Step 2:** Create 5 step widget files in `lib/screens/auth/steps/`
**Step 3:** Wire up navigation: Google Sign-In â†’ onboarding check â†’ PageView or Home
**Step 4:** Run `flutter analyze` â€” 0 issues
**Step 5:** Visually test: verify all 5 steps render, validate, and save correctly

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ… SELF-CHECK:
1. All 5 steps created and render properly
2. Mobile number validation works (10 digits, no less, no more)
3. Duplicate phone check works â€” shows error for existing number
4. Location permission flow works â€” both allow and deny paths
5. Academic profile shows correct sub-fields based on user type selection
6. Schools dropdown queries PocketBase `schools` collection
7. Notification permission only shows on Android 13+
8. Terms checkbox is unchecked by default, button disabled until checked
9. `onboarding_complete` is set to `true` on final step
10. Back button works on steps 2â€“5, no back on step 1
11. App kill mid-onboarding â†’ resumes on next launch
12. `flutter analyze` returns 0 issues

ğŸ‘¤ USER MANUAL STEPS:
- None â€” this is purely frontend code

ğŸ’¬ CONFIRM IN CHAT:
"Prompt 7 complete. 5-step onboarding wizard created. Mobile number, location, academic profile, notifications, terms. Validation and error states implemented. onboarding_complete flag set on completion. flutter analyze: 0 issues. Zero errors."

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â­ï¸ NEXT: Prompt 8 â€” Splash Screen + Auth Router (GoRouter Setup)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ PROMPT 8 of 70
Phase: Navigation & App Shell (PHASE_05)
Task: Splash Screen + GoRouter with Auth Guards + Bottom Navigation Shell
Type: ğŸ“± FRONTEND (Flutter)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ INSTRUCTION:
Set up the entire app navigation using **GoRouter** with auth-based redirects, a splash screen, bottom navigation shell, and deep link support. This is the navigation backbone â€” every future screen plugs into this router.

---

### PART A: Splash Screen

ğŸ“ MODIFY: `lib/screens/splash/splash_screen.dart` (already scaffolded in Prompt 1)

| Element | Details |
|---------|---------|
| **Logo** | App logo centered on screen with fade-in animation (800ms) |
| **App Name** | "JayGanga Books" text below logo, fade in after logo |
| **Tagline** | *"Buy & Sell Used Books Near You"* â€” subtle fade in |
| **Background** | App's primary color gradient or clean white |
| **Duration** | Show for **2 seconds**, then auto-navigate |
| **Loading** | During the 2s, run these checks silently: |

**Splash Checks (run in parallel):**
1. Check if auth token exists in `AsyncAuthStore`
2. If token exists â†’ verify it's still valid (quick PocketBase health check)
3. If valid â†’ fetch user record â†’ check `is_banned`
4. Check `app_config` for `force_update` and `maintenance_mode`

**After 2 seconds, route to:**
```
Token exists + valid + not banned + onboarding complete â†’ /home
Token exists + valid + not banned + onboarding NOT complete â†’ /onboarding
Token exists + valid + banned â†’ /banned (show banned screen)
Token expired or invalid â†’ /home (guest mode)
No token â†’ /home (guest mode)
Force update required â†’ /force-update
Maintenance mode â†’ /maintenance
```

---

### PART B: GoRouter Configuration

ğŸ“ CREATE: `lib/router/app_router.dart`

**Complete Route Table:**

```
/                         â†’ SplashScreen (initial)
/home                     â†’ ShellRoute (Bottom Nav) â†’ HomeScreen (default tab)
/home/search              â†’ SearchScreen (tab 2)
/home/sell                â†’ SellBookScreen (tab 3) â† AUTH REQUIRED
/home/chats               â†’ ChatListScreen (tab 4) â† AUTH REQUIRED
/home/profile             â†’ ProfileScreen (tab 5) â† AUTH REQUIRED
/book/:id                 â†’ BookDetailScreen
/book/:id/edit            â†’ EditBookScreen â† AUTH REQUIRED
/seller/:id               â†’ SellerProfileScreen
/chat/:chatId             â†’ ChatDetailScreen â† AUTH REQUIRED
/transaction/:id          â†’ TransactionDetailScreen â† AUTH REQUIRED
/transaction/:id/qr       â†’ QRCodeScreen â† AUTH REQUIRED
/transaction/:id/scan     â†’ QRScanScreen â† AUTH REQUIRED
/transaction/:id/review   â†’ ReviewScreen â† AUTH REQUIRED
/notifications            â†’ NotificationsScreen â† AUTH REQUIRED
/settings                 â†’ SettingsScreen â† AUTH REQUIRED
/settings/profile-edit    â†’ ProfileEditScreen â† AUTH REQUIRED
/settings/blocked-users   â†’ BlockedUsersScreen â† AUTH REQUIRED
/wishlists                â†’ WishlistScreen â† AUTH REQUIRED
/report                   â†’ ReportScreen â† AUTH REQUIRED
/onboarding               â†’ OnboardingScreen â† AUTH REQUIRED
/banned                   â†’ BannedScreen
/force-update             â†’ ForceUpdateScreen
/maintenance              â†’ MaintenanceScreen
```

---

### PART C: Auth Guard (Redirect Logic)

```dart
// Inside GoRouter redirect:
redirect: (context, state) {
  final authService = context.read<AuthService>();
  final isLoggedIn = authService.isLoggedIn;
  final isAuthRoute = _authRequiredPaths.contains(state.matchedLocation);
  
  // If route requires auth AND user is NOT logged in
  // â†’ Don't redirect! Let them see the page. 
  //   But the page itself should use LoginGate for actions.
  //
  // EXCEPTION: /onboarding requires actual auth
  if (state.matchedLocation == '/onboarding' && !isLoggedIn) {
    return '/home';
  }
  
  // If user IS logged in but hasn't completed onboarding
  if (isLoggedIn && !authService.currentUser!.onboardingComplete 
      && state.matchedLocation != '/onboarding') {
    return '/onboarding';
  }
  
  return null; // No redirect needed
}
```

> **CRITICAL:** Most "AUTH REQUIRED" routes don't actually redirect to login. Instead, the **screen content** uses `LoginGate.show()` to prompt login when the user tries an action. The only hard redirect is `/onboarding` (must be logged in to onboard).

**Guest-Accessible Screens (no login needed to VIEW):**
- `/home` â€” browse books
- `/home/search` â€” search books
- `/book/:id` â€” view book details
- `/seller/:id` â€” view seller profile
- `/force-update`, `/maintenance`, `/banned`

**Login Gate Screens (guest can VIEW but login required to ACT):**
- `/home/sell` â€” shows "Sell a Book" form, taps LoginGate before submitting
- `/home/chats` â€” shows empty state with "Sign in to start chatting" CTA
- `/home/profile` â€” shows "Sign in to see your profile" CTA

---

### PART D: Bottom Navigation Shell

ğŸ“ CREATE: `lib/screens/shell/app_shell.dart`

5-tab bottom navigation bar using `ShellRoute`:

| Tab | Icon | Label | Route | Auth? |
|-----|------|-------|-------|-------|
| 1 | ğŸ  `Icons.home_outlined` | Home | `/home` | No |
| 2 | ğŸ” `Icons.search` | Search | `/home/search` | No |
| 3 | â• `Icons.add_circle` (raised/FAB style) | Sell | `/home/sell` | LoginGate |
| 4 | ğŸ’¬ `Icons.chat_bubble_outline` | Chats | `/home/chats` | LoginGate |
| 5 | ğŸ‘¤ `Icons.person_outline` | Profile | `/home/profile` | LoginGate |

**Design Requirements:**
- Material 3 `NavigationBar` widget
- Active tab: filled icon + colored label
- Inactive tab: outlined icon + muted label
- Center "Sell" button is visually elevated (slightly larger, prominent color)
- Unread message badge on Chat tab (if logged in and has unread chats)
- Smooth transitions between tabs (no page rebuild)
- Persist tab state when navigating to sub-routes and back

---

### PART E: Deep Link Support

ğŸ“ MODIFY: `lib/router/app_router.dart`

Register deep link patterns for:

| Deep Link | Route |
|-----------|-------|
| `jayganga.app/book/<id>` | `/book/:id` |
| `jayganga.app/seller/<id>` | `/seller/:id` |
| `jayganga.app/ref/<code>` | `/home` (with referral code stored in memory) |

> For now, just register the routes. Actual deep link configuration (Android intent filters) will come in a later prompt.

---

ğŸ“¦ USE:
- `go_router` â€” routing and navigation
- `provider` â€” `AuthService` access in redirect
- `pocketbase` SDK â€” auth check, user record fetch
- Material 3 `NavigationBar` â€” bottom navigation
- `badges` package (or custom) â€” unread count on Chat tab

â›” DO NOT:
- Do NOT use `Navigator.push()` anywhere in the app â€” always use `context.go()` or `context.push()`
- Do NOT redirect guests away from browsing screens (Home, Search, Book Detail)
- Do NOT create placeholder screens yet â€” just import stub files that show "Coming Soon" text
- Do NOT use `StatefulShellRoute.indexedStack` without preserving tab state
- Do NOT skip the splash screen checks â€” they catch banned users, force updates, and maintenance mode
- Do NOT put the GoRouter instance in a widget â€” declare it as a top-level `final` or `Provider`

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”§ EXECUTE:

**Step 1:** Finalize `lib/screens/splash/splash_screen.dart` with logo animation + auth checks
**Step 2:** Create `lib/router/app_router.dart` with full route table + redirect logic
**Step 3:** Create `lib/screens/shell/app_shell.dart` with 5-tab bottom nav
**Step 4:** Create stub screens for `/banned`, `/force-update`, `/maintenance` (simple text screens)
**Step 5:** Wire up `MaterialApp.router()` in `lib/app.dart` with the GoRouter
**Step 6:** Run `flutter analyze` â€” 0 issues
**Step 7:** Hot restart â†’ verify splash shows for 2s â†’ routes to Home (guest mode)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ… SELF-CHECK:
1. Splash screen shows for exactly 2 seconds with fade-in logo
2. Splash routes correctly: guest â†’ `/home`, logged in â†’ `/home` or `/onboarding`
3. All routes in the table above are registered (even if targets are stub screens)
4. Bottom navigation has 5 tabs, "Sell" tab is visually elevated
5. Tapping tabs switches content without rebuilding other tabs
6. Auth redirect only hard-redirects for `/onboarding` â€” all other auth screens use LoginGate
7. `context.go('/book/test123')` navigates to BookDetail stub screen
8. Back button from sub-routes returns to correct tab
9. `flutter analyze` returns 0 issues
10. No `Navigator.push` calls exist anywhere in the codebase

ğŸ‘¤ USER MANUAL STEPS:
- None â€” purely frontend code

ğŸ’¬ CONFIRM IN CHAT:
"Prompt 8 complete. Splash screen with auth checks, GoRouter with full route table, 5-tab bottom navigation shell, auth redirect logic, deep link routes registered. flutter analyze: 0 issues. Zero errors."

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â­ï¸ NEXT: Prompt 9 â€” Home Screen Layout (Banner + Ads + Book Grid)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ PROMPT 9 of 70
Phase: Home Screen (PHASE_06)
Task: Home Screen â€” Full Layout with Banner, Ads, Filters, and Book Grid
Type: ğŸ“± FRONTEND (Flutter)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ INSTRUCTION:
Build the **Home Screen** â€” the app's primary screen. This is what both guests and logged-in users see. It's a scrollable vertical layout with 4 major sections: Top App Bar, Banner Carousel, Advertisement Strip, and Books Grid.

> **Guest-First:** Everything on this screen works WITHOUT login. Login is only needed for actions (wishlist, chat, sell).

---

### PART A: Top App Bar

ğŸ“ CREATE: `lib/screens/home/home_screen.dart`

| Element | Details |
|---------|---------|
| **Left** | App logo (small) + "JayGanga Books" text |
| **Right â€” Icon 1** | ğŸ”” Notification bell. If logged in + unread â†’ show red dot badge. Tap â†’ `/notifications`. If guest â†’ `LoginGate.show()` |
| **Right â€” Icon 2** | â¤ï¸ Wishlist heart icon. Tap â†’ `/wishlists`. If guest â†’ `LoginGate.show()` |
| **Bottom** | Location bar: *"ğŸ“ Boring Road, Patna Â· 5 km"* â€” tap to change radius or location. Shows "Set Location" if no location set. |

---

### PART B: Banner Carousel

ğŸ“ CREATE: `lib/widgets/home/banner_carousel.dart`

| Element | Details |
|---------|---------|
| **Data Source** | PocketBase: `pb.collection('banners').getList(filter: 'is_active = true && start_date <= "NOW" && end_date >= "NOW"', sort: 'sort_order')` |
| **Layout** | Full-width horizontal PageView, auto-scrolls every 4 seconds |
| **Each Card** | Image fills card. Rounded corners (12px). Tap â†’ opens `link` URL (if set) in in-app browser |
| **Indicators** | Dot indicators below carousel (current dot = filled, others = outline) |
| **Empty State** | If no active banners â†’ hide entire section (no space, no skeleton) |
| **Shimmer** | While loading â†’ show shimmer placeholder (full-width rectangle) |
| **Height** | 180px on phones, adaptive |

---

### PART C: Advertisement Strip

ğŸ“ CREATE: `lib/widgets/home/ad_strip.dart`

| Element | Details |
|---------|---------|
| **Data Source** | PocketBase: `pb.collection('advertisements').getList(filter: 'is_active = true', sort: 'sort_order')` |
| **Layout** | Slim horizontal scrollable strip (single row). Height: ~70px |
| **Each Card** | Small logo + business name + tagline. Tap â†’ `url_launcher` to open phone dialer (if `phone`) or external link (if `link`) |
| **Empty State** | If no active ads â†’ hide entire section completely |
| **Shimmer** | While loading â†’ show 3 small shimmer cards |

---

### PART D: Filter Chips

ğŸ“ CREATE: `lib/widgets/home/filter_chips_bar.dart`

Horizontal scrollable row of filter chips below the ad strip:

| Chip | Filter Applied |
|------|----------------|
| "All" | No filter (default, selected) |
| "Near Me" | `distance <= user.preferred_radius` (requires location) |
| "Free" | `selling_price = 0` |
| "My School" | `school = user.school` (requires login + school set) |
| "Class 6" through "Class 12" (dynamic) | `class_year = "X"` |
| "CBSE" / "ICSE" / "State Board" | `board = "X"` |
| "JEE" / "NEET" | `category = "competitive_exam" && exam_type = "X"` |

**Behavior:**
- Single-select (only one chip active at a time)
- Active chip: filled with primary color, white text
- Inactive chip: outlined, muted text
- "My School" chip only visible if user is logged in AND has school set
- Selecting a chip re-fetches the book list with the filter applied
- "Near Me" chip uses the user's saved `location_lat`, `location_lon`, `preferred_radius`

---

### PART E: Books Grid

ğŸ“ CREATE: `lib/widgets/home/book_grid.dart`
ğŸ“ CREATE: `lib/widgets/shared/book_card.dart` (reusable across app)

**Data Source:**
```dart
pb.collection('books').getList(
  page: currentPage,
  perPage: 20,
  filter: 'status = "active"',  // + any active chip filter
  sort: '-is_priority,-created',  // Priority books first, then newest
  expand: 'seller,school',
);
```

**Grid Layout:**
- 2 columns on phones
- 3 columns on tablets
- `SliverGrid` inside a `CustomScrollView` (for smooth scrolling with banner/ads above)

**Each Book Card:**

| Element | Details |
|---------|---------|
| **Image** | First photo from `photos` array. Rounded top corners. Aspect ratio 4:3. Placeholder if no image. |
| **Price** | `â‚¹{sellingPrice}` bold. If `mrp` exists â†’ show ~~â‚¹MRP~~ strikethrough + discount % badge ("40% off") in green |
| **Free Badge** | If `sellingPrice == 0` â†’ show "FREE" badge in green instead of price |
| **Title** | Book title, max 2 lines, ellipsis overflow |
| **Condition** | Colored chip: "Like New" (green) / "Good" (blue) / "Fair" (orange) |
| **Location** | *"ğŸ“ Boring Road Â· 2 km away"* â€” distance from user's location |
| **Priority Badge** | If `is_priority == true` â†’ small âš¡ "Featured" badge top-right corner |
| **Wishlist Button** | â¤ï¸ icon top-right. If logged in â†’ toggle wishlist. If guest â†’ `LoginGate.show()` |
| **Tap Action** | Navigate to `/book/:id` |

**Pagination:**
- Infinite scroll â€” when user scrolls near bottom, load next page
- Show loading spinner at bottom while fetching next page
- Show "No more books" text when all loaded
- Pull-to-refresh from top â†’ reload entire list + banners + ads

**Empty State (no books):**
- Illustration: empty bookshelf
- Title: *"No books here yet"*
- Subtitle: *"Be the first to list a book in your area!"*
- CTA button: *"Sell a Book"* â†’ `/home/sell`

**Error State:**
- Illustration: cloud with X
- Title: *"Couldn't load books"*
- Subtitle: *"Check your internet and try again."*
- CTA button: *"Retry"*

---

### PART F: Recommendation Section (Logged-In Users Only)

ğŸ“ CREATE: `lib/widgets/home/recommendations_section.dart`

| Element | Details |
|---------|---------|
| **Visibility** | Only shown if user is logged in AND has `user_type` set (academic profile completed) |
| **Title** | "Recommended for You" with "See All" link |
| **Data Source** | Books matching user's `board`, `class_year`, `stream`, or `exam_type` â€” sorted by proximity |
| **Layout** | Horizontal scrollable row of `BookCard` widgets (3â€“5 cards visible) |
| **Empty State** | If no matching books â†’ hide section. If academic profile not set â†’ show inline CTA: *"Complete your profile to get personalized recommendations"* â†’ tap opens Profile Edit |

---

### Screen Assembly Order (Top to Bottom):

```
CustomScrollView (
  SliverAppBar (Top App Bar â€” PART A)
  SliverToBoxAdapter (Banner Carousel â€” PART B)
  SliverToBoxAdapter (Ad Strip â€” PART C)
  SliverToBoxAdapter (Filter Chips â€” PART D)
  SliverToBoxAdapter (Recommendations â€” PART F, if visible)
  SliverPadding (
    SliverGrid (Books Grid â€” PART E)
  )
  SliverToBoxAdapter (Loading / No More / Error footer)
)
```

---

ğŸ“¦ USE:
- `pocketbase` SDK â€” fetch banners, ads, books with expand
- `cached_network_image` â€” book cover images with caching
- `shimmer` package â€” loading placeholders
- `flutter_staggered_grid_view` or `SliverGrid` â€” responsive grid
- `url_launcher` â€” open ad links/phone dialer
- `provider` â€” auth state, location state, filter state
- `geolocator` â€” distance calculation for "Near Me" filter and card distance display

â›” DO NOT:
- Do NOT require login to view the Home Screen â€” it's fully guest-accessible
- Do NOT show "Login" prompts on the screen itself â€” only via `LoginGate` on specific actions
- Do NOT load all books at once â€” use pagination (20 per page)
- Do NOT show placeholder images for banners/ads â€” if none exist, hide the section
- Do NOT hardcode filter values â€” build chips dynamically based on available data
- Do NOT forget the `expand: 'seller,school'` on book queries â€” needed for seller name and school name on cards
- Do NOT use `ListView` for the main scroll â€” use `CustomScrollView` with Slivers for smooth scrolling
- Do NOT show recommendation section to guests â€” they haven't set academic profile

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”§ EXECUTE:

**Step 1:** Create `lib/screens/home/home_screen.dart` with CustomScrollView layout
**Step 2:** Create `lib/widgets/home/banner_carousel.dart`
**Step 3:** Create `lib/widgets/home/ad_strip.dart`
**Step 4:** Create `lib/widgets/home/filter_chips_bar.dart`
**Step 5:** Create `lib/widgets/shared/book_card.dart` (reusable)
**Step 6:** Create `lib/widgets/home/book_grid.dart` with pagination
**Step 7:** Create `lib/widgets/home/recommendations_section.dart`
**Step 8:** Run `flutter analyze` â€” 0 issues
**Step 9:** Visually test: verify all sections render, filters work, pagination loads

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ… SELF-CHECK:
1. All 6 sections render in correct order (AppBar, Banner, Ads, Filters, Recommendations, Grid)
2. Banner carousel auto-scrolls every 4 seconds with dot indicators
3. Ad strip scrolls horizontally, taps open dialer/link
4. Filter chips are single-select, re-fetch book list on change
5. Book cards show: image, price (with discount), title, condition chip, location, wishlist button
6. Free books show "FREE" badge instead of â‚¹0
7. Priority books show âš¡ "Featured" badge and appear first
8. Infinite scroll pagination works â€” loads 20 books at a time
9. Pull-to-refresh reloads all sections
10. Empty state shows for no books with "Sell a Book" CTA
11. Shimmer loading shows while data fetches
12. Guest mode: everything visible, wishlist/notification taps trigger LoginGate
13. `flutter analyze` returns 0 issues

ğŸ‘¤ USER MANUAL STEPS:
- Add test banners and ads via PocketBase Admin UI to verify carousel/strip rendering

ğŸ’¬ CONFIRM IN CHAT:
"Prompt 9 complete. Home Screen built with banner carousel, ad strip, filter chips, recommendations, and paginated book grid. Pull-to-refresh working. Shimmer loading states. Guest mode fully functional. flutter analyze: 0 issues. Zero errors."

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â­ï¸ NEXT: Prompt 10 â€” Book Detail Screen
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ PROMPT 10 of 70
Phase: Book Listing (PHASE_07)
Task: Book Detail Screen â€” Full Product Page
Type: ğŸ“± FRONTEND + ğŸ”§ BACKEND (View Count Hook)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ INSTRUCTION:
Build the **Book Detail Screen** (`/book/:id`) â€” the full product page showing all book information, seller details, and action buttons. This is the most important conversion screen (browse â†’ chat â†’ buy).

> **Guest-Accessible:** Anyone can VIEW book details. Login required only for Chat, Wishlist, and Report actions.

---

### PART A: Image Gallery

ğŸ“ CREATE: `lib/screens/book/book_detail_screen.dart`

| Element | Details |
|---------|---------|
| **Layout** | Full-width image gallery at the top, swipeable (PageView) |
| **Indicators** | "1/4" counter badge bottom-right + dot indicators |
| **Pinch to Zoom** | Enable pinch-to-zoom on images via `InteractiveViewer` |
| **Full Screen** | Tap image â†’ open full-screen gallery (dark background, swipeable, zoomable) |
| **No Image** | If `photos` is empty â†’ show placeholder illustration with book icon |
| **Height** | 300px on phones, aspect ratio maintained |
| **Image URL** | `${pbUrl}/api/files/books/${bookId}/${photoFileName}` |

---

### PART B: Price & Status Section

| Element | Details |
|---------|---------|
| **Price** | Large bold `â‚¹{sellingPrice}`. If `mrp` exists â†’ show ~~â‚¹MRP~~ strikethrough next to it |
| **Discount Badge** | If MRP exists â†’ green badge: *"40% off"* |
| **Free Badge** | If `sellingPrice == 0` â†’ large green "FREE" badge instead of price |
| **Condition** | Colored chip: "Like New" (green) / "Good" (blue) / "Fair" (orange) + condition tags as small chips below |
| **Status** | If `status == "reserved"` â†’ show orange banner: *"âš ï¸ This book is currently reserved"* |
| **Status** | If `status == "sold"` â†’ show red banner: *"âŒ This book has been sold"* + disable all action buttons |
| **Priority** | If `is_priority == true` â†’ small âš¡ "Featured Listing" label |
| **Posted** | *"Posted 3 days ago"* â€” relative time from `created` |
| **Views** | ğŸ‘ï¸ *"124 views"* â€” from `views_count` |

---

### PART C: Book Details Card

| Element | Details |
|---------|---------|
| **Title** | Book title â€” full, no truncation |
| **Author** | By {author} |
| **Edition** | Edition: {edition} (if available) |
| **Publisher** | Publisher: {publisher} (if available) |
| **Category** | Category chip: e.g., "NCERT Textbook", "Competitive Exam" |
| **Class/Board** | *"Class 10 Â· CBSE"* (if applicable) |
| **Stream** | *"Science"* (if applicable) |
| **Description** | Full description text â€” expandable "Read more" if > 3 lines |
| **Handover Area** | *"ğŸ“ Preferred handover: Boring Road, Patna"* |
| **Available From** | *"Available from: Feb 20, 2026"* (if `available_from` is in the future) |

---

### PART D: Bundle Section (Conditional)

ğŸ“ CREATE: `lib/widgets/book/bundle_items_list.dart`

| Element | Details |
|---------|---------|
| **Visibility** | Only show if `is_bundle == true` |
| **Header** | *"ğŸ“¦ Bundle: {bundleName} ({N} books)"* |
| **Data Source** | `pb.collection('bundle_items').getList(filter: 'bundle = "${bookId}"')` |
| **Each Item** | Row: item title, author, condition chip |
| **Total MRP** | *"Total MRP: â‚¹{bundleTotalMrp}"* at bottom |

---

### PART E: Seller Info Card

ğŸ“ CREATE: `lib/widgets/book/seller_card.dart`

| Element | Details |
|---------|---------|
| **Layout** | Horizontal card with avatar, name, trust badge |
| **Avatar** | User avatar (or Google profile pic) with initial fallback |
| **Name** | Seller's display name |
| **Trust Score** | â­ {trustScore}/5 Â· *"{reviewCount} reviews"* |
| **Badges** | Show earned badges: ğŸ¤ "Helping Hand", ğŸ† "Top Seller", etc. |
| **Member Since** | *"Member since Jan 2026"* |
| **Active Listings** | *"12 books listed"* â€” count of seller's active books |
| **Tap Action** | Navigate to `/seller/:sellerId` |
| **Own Listing Check** | If `seller.id == currentUser.id` â†’ show "Your Listing" label, hide Chat button, show Edit button instead |

---

### PART F: Action Buttons (Sticky Bottom Bar)

ğŸ“ CREATE: `lib/widgets/book/book_action_bar.dart`

Sticky bottom bar with 2 primary actions:

| Button | Details |
|--------|---------|
| **"Chat with Seller"** | Primary filled button. Tap â†’ check if chat exists between buyer + seller for this book. If yes â†’ navigate to existing `/chat/:chatId`. If no â†’ create new chat record â†’ navigate to `/chat/:chatId`. If guest â†’ `LoginGate.show()`. If own listing â†’ hidden. If sold â†’ disabled. |
| **"â¤ï¸ Wishlist"** | Icon button. Toggle. Filled = in wishlist, outline = not. If guest â†’ `LoginGate.show()`. Save `price_at_save` when adding. |

**Additional actions (overflow menu or small icon row above the bar):**
| Action | Details |
|--------|---------|
| **Share** | Share button â†’ generates share text: *"Check out '{title}' for â‚¹{price} on JayGanga Books! {deepLink}"* via `share_plus` package |
| **Report** | Flag icon â†’ if guest â†’ `LoginGate.show()`. If logged in â†’ show report bottom sheet (select reason: "Inappropriate", "Scam", "Duplicate", "Other" + optional description). Creates `reports` record with `type: "listing"`, `target_type: "books"`, `target_id: bookId` |
| **Edit** | Only visible if `seller.id == currentUser.id` â†’ navigate to `/book/:id/edit` |

---

### PART G: Similar Books Section

ğŸ“ CREATE: `lib/widgets/book/similar_books_section.dart`

| Element | Details |
|---------|---------|
| **Title** | *"Similar Books"* |
| **Data Source** | Books with same `category` + `board` + `class_year`, excluding current book, limit 10, sorted by proximity |
| **Layout** | Horizontal scrollable row of `BookCard` widgets (reuse from Prompt 9) |
| **Empty State** | If no similar books â†’ hide section entirely |

---

### PART H: View Count Increment (Backend Hook)

ğŸ“ CREATE: `pb_hooks/view_counter.pb.js`

```javascript
// Increment views_count when a book detail is viewed
// Use a custom API endpoint: GET /api/books/:id/view
routerAdd("GET", "/api/books/{id}/view", (e) => {
  const id = e.request.pathValue("id");
  const book = e.app.findRecordById("books", id);
  book.set("views_count", book.getInt("views_count") + 1);
  e.app.save(book);
  return e.json(200, { views: book.getInt("views_count") });
});
```

**Flutter side:** Call `GET /api/books/{id}/view` once when BookDetailScreen opens (debounced â€” don't count refreshes within 30 seconds).

---

### Screen Assembly Order (Top to Bottom):

```
SingleChildScrollView (
  Image Gallery â€” PART A
  Price & Status â€” PART B
  Divider
  Book Details Card â€” PART C
  Bundle Section â€” PART D (if is_bundle)
  Divider
  Seller Info Card â€” PART E
  Divider
  Similar Books â€” PART G
  SizedBox (80px bottom padding for sticky bar)
)
Sticky Bottom: Action Bar â€” PART F
```

---

ğŸ“¦ USE:
- `pocketbase` SDK â€” fetch book, bundle items, similar books, create chat
- `cached_network_image` â€” book images with caching
- `share_plus` â€” share book link
- `url_launcher` â€” deep link generation
- `intl` â€” relative time formatting ("3 days ago")
- `provider` â€” auth state, wishlist state
- Custom PocketBase hook for view count

â›” DO NOT:
- Do NOT require login to VIEW book details â€” guest-accessible
- Do NOT show "Chat with Seller" on user's own listing â€” show "Edit" instead
- Do NOT allow actions on sold books â€” disable chat and wishlist
- Do NOT increment view count on every refresh â€” debounce to 30 seconds
- Do NOT load bundle items if `is_bundle == false` â€” skip the query entirely
- Do NOT forget to handle reserved/sold status banners
- Do NOT use the legacy `dao` API in the hook

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”§ EXECUTE:

**Step 1:** Create `lib/screens/book/book_detail_screen.dart` with all sections
**Step 2:** Create `lib/widgets/book/bundle_items_list.dart`
**Step 3:** Create `lib/widgets/book/seller_card.dart`
**Step 4:** Create `lib/widgets/book/book_action_bar.dart`
**Step 5:** Create `lib/widgets/book/similar_books_section.dart`
**Step 6:** Create `pb_hooks/view_counter.pb.js`
**Step 7:** Run `flutter analyze` â€” 0 issues
**Step 8:** Deploy hook via `./deploy.sh`
**Step 9:** Visually test all states: normal, free, bundle, reserved, sold, own listing

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ… SELF-CHECK:
1. Image gallery swipes between photos with counter badge
2. Pinch-to-zoom works on images
3. Price shows discount % when MRP exists
4. Free books show "FREE" badge instead of â‚¹0
5. Condition chips show correct colors
6. Bundle section shows all items when `is_bundle == true`
7. Seller card shows trust score, badges, and navigates to seller profile
8. "Chat with Seller" creates/reuses chat correctly
9. Own listing shows "Edit" instead of "Chat"
10. Sold books disable all action buttons + show red banner
11. Share generates correct text with deep link
12. Report creates record with correct type and target
13. View count increments on first load, not on refresh
14. Similar books section shows relevant books
15. `flutter analyze` returns 0 issues

ğŸ‘¤ USER MANUAL STEPS:
- Create a test book via PocketBase Admin to verify the detail screen renders properly

ğŸ’¬ CONFIRM IN CHAT:
"Prompt 10 complete. Book Detail Screen with image gallery, price/discount, seller card, bundle items, action bar (chat/wishlist/share/report), similar books, view count hook. All states handled (normal, free, bundle, reserved, sold, own listing). flutter analyze: 0 issues. Zero errors."

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â­ï¸ NEXT: Prompt 11 â€” Sell Book Screen (Create Listing Form)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ PROMPT 11 of 70
Phase: Book Listing (PHASE_07)
Task: Sell Book â€” Create Listing Form with Photo Upload + Bundle + Draft
Type: ğŸ“± FRONTEND (Flutter)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ INSTRUCTION:
Build the **Sell Book Screen** (`/home/sell`) â€” a scrollable form that lets users create a new book listing. Includes photo upload, book details, pricing, condition rating, bundle option, and draft saving.

> **Auth Required:** If guest â†’ `LoginGate.show()` before showing the form. If onboarding not complete â†’ redirect to `/onboarding`.

---

### PART A: Photo Upload Section

ğŸ“ CREATE: `lib/screens/sell/sell_book_screen.dart`
ğŸ“ CREATE: `lib/widgets/sell/photo_picker.dart`

| Element | Details |
|---------|---------|
| **Layout** | Horizontal scrollable row of photo slots. First slot = "+" add button. |
| **Max Photos** | 5 photos maximum |
| **Source** | Bottom sheet: "Camera" or "Gallery" option |
| **Preview** | Thumbnails with "X" remove button on each |
| **Reorder** | Long-press to drag and reorder photos (first photo = cover image on cards) |
| **Compression** | Before upload: compress images to max 800px width, JPEG quality 80% via `flutter_image_compress` |
| **Validation** | At least 1 photo required. Show error: *"Add at least one photo of your book"* |
| **File Size** | Max 5MB per photo after compression. If over â†’ re-compress at lower quality |

---

### PART B: Book Details Fields

| Field | Type | Required | Details |
|-------|------|----------|---------|
| **Title** | Text input | âœ… | Max 200 chars. *"Enter the book title as printed on the cover"* |
| **Author** | Text input | âœ… | Max 100 chars |
| **Edition** | Text input | âŒ | e.g., "3rd Edition, 2024" |
| **Publisher** | Text input | âŒ | e.g., "S. Chand", "Arihant" |
| **Description** | Multiline text | âŒ | Max 1000 chars. Placeholder: *"Describe the book's condition, any highlights or markings, and why you're selling it"* |

---

### PART C: Category & Academic Fields

| Field | Type | Required | Details |
|-------|------|----------|---------|
| **Category** | Select dropdown | âœ… | Options: "NCERT Textbook", "Reference Book", "Competitive Exam", "Novel/Fiction", "Non-Fiction", "Notes/Handwritten", "Other" |
| **Class** | Select dropdown | âŒ | Options: "1" through "12" + "College". Visible when category is textbook/reference |
| **Board** | Select dropdown | âŒ | CBSE / ICSE / State Board / IB / Other. Visible when Class is 1â€“12 |
| **Stream** | Select dropdown | âŒ | Science / Commerce / Arts / General. Visible when Class is 11 or 12 |
| **Exam Type** | Select dropdown | âŒ | JEE / NEET / Bank / SSC / UPSC / State PSC / Other. Visible when category = "Competitive Exam" |

> **Smart Defaults:** Pre-fill Category, Class, Board, and Stream from the user's academic profile (if set during onboarding). User can still change them.

---

### PART D: Condition Rating

| Field | Type | Required | Details |
|-------|------|----------|---------|
| **Condition** | 3-option selector | âœ… | Cards (not dropdown): "Like New" (green) / "Good" (blue) / "Fair" (orange). Each card has a short description |
| **Condition Tags** | Multi-select chips | âŒ | Options: "No markings", "Highlighted", "Written notes", "Dog-eared", "Cover worn", "Pages intact", "Binding loose", "Water damage". Visible based on condition selected |

**"Like New"** description: *"No marks, highlights, or wear. Looks unread."*
**"Good"** description: *"Minor marks or highlights. Fully usable."*
**"Fair"** description: *"Noticeable wear, highlights, or notes. Still readable."*

---

### PART E: Pricing

| Field | Type | Required | Details |
|-------|------|----------|---------|
| **MRP** | Number input | âŒ | Original printed price. Prefix "â‚¹". If entered â†’ show discount % preview |
| **Selling Price** | Number input | âœ… | Prefix "â‚¹". Can be 0 (free). Inline validation: warn if > MRP |
| **Free Toggle** | Switch | âŒ | "Give away for free" toggle. If ON â†’ sets selling price to 0, hides price field |

**Price Helper:**
- If MRP entered â†’ show live preview: *"Buyers will see: ~~â‚¹500~~ â‚¹200 (60% off)"*
- If selling price = 0 â†’ show: *"Buyers will see: FREE ğŸ‰"*
- If selling price > MRP â†’ inline warning: *"Selling price is higher than MRP"* (still allowed, just a warning)

---

### PART F: Bundle Option

ğŸ“ CREATE: `lib/widgets/sell/bundle_form.dart`

| Field | Type | Details |
|-------|------|---------|
| **Bundle Toggle** | Switch | *"Selling multiple books as a bundle?"* |
| **Bundle Name** | Text input | Visible when toggle is ON. e.g., "Class 10 CBSE Complete Set" |
| **Bundle Items** | Dynamic list | Add/remove rows. Each row: Title (required) + Author (optional) + Condition (optional) |
| **Add Item Button** | "+" button | Adds a new empty row. Min 2 items for a bundle. |
| **Bundle Total MRP** | Number input | Optional. Total MRP of all books in the bundle |

> When bundle toggle is ON, set `is_bundle: true` on the book record. Create `bundle_items` records for each item.

---

### PART G: Location & Availability

| Field | Type | Required | Details |
|-------|------|----------|---------|
| **Handover Area** | Text input | âŒ | Pre-filled from user's `area` if available. *"Where do you prefer to meet?"* |
| **Available From** | Date picker | âŒ | Default: today. If set in future â†’ book shows "Available from {date}" |
| **School** | Searchable dropdown | âŒ | Pre-filled from user's school. Queries `schools` collection. Helps students from same school find books |

---

### PART H: Draft Saving

ğŸ“ CREATE: `lib/services/draft_service.dart`

| Feature | Details |
|---------|---------|
| **Auto-Save** | Every 30 seconds, save form state to **Hive** (local DB). Key = `sell_draft` |
| **Resume Draft** | On screen open â†’ check if draft exists. If yes â†’ show dialog: *"You have an unsaved draft. Resume or discard?"* |
| **Clear Draft** | On successful publish â†’ delete draft from Hive |
| **What's Saved** | All text fields, selected options, photo file paths (not uploaded yet). Photos are NOT uploaded until publish |

---

### PART I: Submit / Publish

| Element | Details |
|---------|---------|
| **Button** | Sticky bottom: "Publish Listing" â€” primary filled button |
| **Validation** | Before submit, validate: at least 1 photo, title, author, category, condition, selling price (or free toggle ON) |
| **Validation Error** | Scroll to first invalid field, highlight it in red, show error text below field |
| **Upload Flow** | 1. Show full-screen loading overlay with progress: "Uploading photos (2/5)..." â†’ "Creating listing..." |
| **Photo Upload** | Upload photos as `FormData` files to the PocketBase `books` record |
| **Bundle Items** | If bundle â†’ after book record is created, create `bundle_items` records with `bundle: bookId` |
| **Success** | Dismiss loading â†’ show success bottom sheet: *"ğŸ‰ Your book is live!"* with "View Listing" and "Sell Another" buttons |
| **Error** | Dismiss loading â†’ show error snackbar with retry. Draft is preserved so nothing is lost |

---

ğŸ“¦ USE:
- `pocketbase` SDK â€” create book record, upload photos, create bundle items
- `image_picker` â€” camera/gallery photo selection
- `flutter_image_compress` â€” resize and compress photos
- `hive_flutter` â€” draft persistence
- `provider` â€” form state management
- `intl` â€” date picker formatting

â›” DO NOT:
- Do NOT upload photos until "Publish" is tapped â€” keep them local until then
- Do NOT allow more than 5 photos
- Do NOT allow submit without at least 1 photo + title + author + category + condition + price
- Do NOT skip image compression â€” raw camera photos can be 10MB+
- Do NOT forget to set `seller: currentUser.id` on the book record
- Do NOT forget to set `status: "active"` on the new book record
- Do NOT forget to set `location_lat`, `location_lon` from user's saved location
- Do NOT discard draft on validation error â€” only on successful publish
- Do NOT create bundle_items if bundle toggle is OFF

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”§ EXECUTE:

**Step 1:** Create `lib/screens/sell/sell_book_screen.dart` with scrollable form
**Step 2:** Create `lib/widgets/sell/photo_picker.dart` with camera/gallery/reorder
**Step 3:** Create `lib/widgets/sell/bundle_form.dart` with dynamic item rows
**Step 4:** Create `lib/services/draft_service.dart` with Hive auto-save
**Step 5:** Wire up form validation, photo upload, and book creation
**Step 6:** Run `flutter analyze` â€” 0 issues
**Step 7:** Test: fill form â†’ publish â†’ verify book appears in Home Screen grid

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ… SELF-CHECK:
1. Photo picker opens camera/gallery, shows thumbnails, allows reorder
2. Max 5 photos enforced â€” "+" button disappears after 5
3. Image compression works â€” output files are < 5MB
4. Category/class/board/stream fields show/hide dynamically based on selection
5. Smart defaults pre-fill from user's academic profile
6. Condition cards are visually distinct with correct colors
7. Price helper shows live discount preview
8. Free toggle sets price to 0 and hides price field
9. Bundle toggle shows/hides bundle form
10. Bundle requires minimum 2 items
11. Draft auto-saves every 30 seconds
12. Resume draft dialog shows on re-opening with saved data
13. Validation highlights first invalid field and scrolls to it
14. Upload shows progress overlay
15. Success creates book record with all fields + photos + bundle items
16. `flutter analyze` returns 0 issues

ğŸ‘¤ USER MANUAL STEPS:
- None â€” purely frontend code

ğŸ’¬ CONFIRM IN CHAT:
"Prompt 11 complete. Sell Book Screen with photo upload (5 max, compression), full form with dynamic category fields, condition rating, pricing with live preview, bundle support, draft auto-save to Hive, publish with upload progress. flutter analyze: 0 issues. Zero errors."

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â­ï¸ NEXT: Prompt 12 â€” Edit Book + Manage Listings Screen
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ PROMPT 12 of 70
Phase: Book Listing (PHASE_07)
Task: Edit Book Screen + Manage My Listings (Active/Sold/Reserved tabs)
Type: ğŸ“± FRONTEND (Flutter)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ INSTRUCTION:
Build two connected screens: **Edit Book** (modify an existing listing) and **Manage Listings** (view all your books by status with bulk actions).

> **Auth Required:** Both screens require login. Only the book's seller can access Edit.

---

### PART A: Edit Book Screen

ğŸ“ CREATE: `lib/screens/book/edit_book_screen.dart`

**Reuses the Sell Book form** from Prompt 11 with these differences:

| Difference | Details |
|------------|---------|
| **Pre-fill** | All fields pre-filled from existing book record. Photos pre-loaded as thumbnails |
| **Photo Management** | Existing photos shown as thumbnails. User can: remove existing photos (marks for deletion), add new photos (same picker), reorder all photos |
| **Form Title** | "Edit Listing" instead of "Sell a Book" |
| **Button** | "Save Changes" instead of "Publish Listing" |
| **Draft** | No auto-draft for edit â€” changes are explicit saves only |
| **Bundle Edit** | If `is_bundle`: show existing items, allow add/remove/edit items. If toggling bundle OFF â†’ confirm dialog: *"Remove all bundle items?"* â†’ deletes `bundle_items` records |
| **Status Change** | Dropdown at top: "Active" â†’ "Reserved" â†’ "Sold". Changing status shows confirmation |

**Status Change Behavior:**
| From â†’ To | Confirmation | Action |
|-----------|-------------|--------|
| Active â†’ Reserved | *"Mark as reserved? Buyers can still view but can't start new chats."* | Sets `status: "reserved"` |
| Active â†’ Sold | *"Mark as sold? This listing will move to your sold items."* | Sets `status: "sold"`, `sold_at: DateTime.now()` |
| Reserved â†’ Active | None needed | Sets `status: "active"` |
| Reserved â†’ Sold | *"Confirm sale?"* | Sets `status: "sold"`, `sold_at: DateTime.now()` |
| Sold â†’ Active | *"Relist this book? It will appear as a new active listing."* | Sets `status: "active"`, clears `sold_at` |

**Photo Update Logic:**
```
1. Identify which existing photos were removed â†’ delete from PocketBase record
2. Identify which new photos were added â†’ compress + upload
3. Update photo order on the record
4. Save all other field changes
```

**Permission Check:**
- On screen load, verify `book.seller == currentUser.id`
- If not the owner â†’ redirect to `/book/:id` with snackbar: *"You can only edit your own listings"*

---

### PART B: Manage My Listings Screen

ğŸ“ CREATE: `lib/screens/profile/manage_listings_screen.dart`

Accessible from Profile tab â†’ "My Listings" row.

**Tab Layout (3 tabs):**

| Tab | Filter | Badge |
|-----|--------|-------|
| **Active** | `status = "active"` | Count of active listings |
| **Reserved** | `status = "reserved"` | Count of reserved |
| **Sold** | `status = "sold"` | Count of sold |

**Each Tab â€” Book List:**

Uses `ListView` with `BookCard` (reuse from Prompt 9) â€” but in list mode (horizontal card, not grid).

ğŸ“ CREATE: `lib/widgets/shared/book_list_tile.dart`

| Element | Details |
|---------|---------|
| **Layout** | Horizontal card: thumbnail (left) + details (right) |
| **Thumbnail** | First photo, 80x80px, rounded corners |
| **Title** | Book title, 1 line |
| **Price** | â‚¹{sellingPrice} or "FREE" |
| **Status** | Colored chip matching status |
| **Date** | Active: *"Listed 5 days ago"* / Sold: *"Sold on Feb 10"* |
| **Views** | ğŸ‘ï¸ {views_count} views |
| **Tap Action** | Navigate to `/book/:id/edit` |

**Swipe Actions (per item):**

| Swipe Direction | Action | Details |
|-----------------|--------|---------|
| Swipe Left | **Delete** | Red background. Confirmation: *"Delete this listing? This can't be undone."* â†’ delete book record + photos + bundle items |
| Swipe Right (Active) | **Mark Sold** | Green background. Quick action â†’ sets `status: "sold"` |
| Swipe Right (Sold) | **Relist** | Blue background. Quick action â†’ sets `status: "active"`, clears `sold_at` |

**Empty States per Tab:**

| Tab | Empty State |
|-----|-------------|
| Active | *"No active listings. Tap '+' to sell a book!"* with CTA â†’ `/home/sell` |
| Reserved | *"No reserved books right now."* |
| Sold | *"You haven't sold anything yet. Your sold books will appear here."* |

**Sorting:**
- Active tab: sorted by `created` (newest first)
- Reserved tab: sorted by `updated` (most recently reserved first)
- Sold tab: sorted by `sold_at` (most recently sold first)

---

### PART C: Delete Book Logic

ğŸ“ CREATE: `lib/services/book_service.dart`

```dart
Future<void> deleteBook(String bookId) async {
  // 1. Delete all bundle_items where bundle == bookId
  // 2. Delete all wishlists referencing this book
  // 3. Delete the book record (cascades photos deletion in PocketBase)
  // 4. Refresh the listings list
}
```

> PocketBase handles file deletion when a record is deleted. But related records (bundle_items, wishlists) need explicit cleanup unless cascade is set.

---

ğŸ“¦ USE:
- `pocketbase` SDK â€” fetch, update, delete book records
- Form from Prompt 11 (refactored as reusable `BookForm` widget)
- `flutter_slidable` â€” swipe actions on list tiles
- `provider` â€” book list state, refresh on changes
- `cached_network_image` â€” thumbnails

â›” DO NOT:
- Do NOT allow editing books that belong to other users
- Do NOT delete books without confirmation dialog
- Do NOT allow "Sold â†’ Reserved" transition â€” it's Sold â†’ Active â†’ Reserved
- Do NOT forget to delete bundle_items when deleting a bundle book
- Do NOT reupload unchanged photos â€” only upload new ones and delete removed ones
- Do NOT show Manage Listings to guests â€” redirect to LoginGate

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”§ EXECUTE:

**Step 1:** Refactor Sell Book form from Prompt 11 into reusable `BookForm` widget
**Step 2:** Create `lib/screens/book/edit_book_screen.dart` using `BookForm` in edit mode
**Step 3:** Create `lib/screens/profile/manage_listings_screen.dart` with 3 tabs
**Step 4:** Create `lib/widgets/shared/book_list_tile.dart`
**Step 5:** Create `lib/services/book_service.dart` with delete + status change methods
**Step 6:** Wire up swipe actions with `flutter_slidable`
**Step 7:** Run `flutter analyze` â€” 0 issues
**Step 8:** Test: edit existing book â†’ save â†’ verify changes. Delete â†’ verify cleanup. Status transitions â†’ verify all paths

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ… SELF-CHECK:
1. Edit screen pre-fills all fields from existing book record
2. Photos: can remove existing, add new, reorder â€” only changed photos are uploaded
3. Status dropdown works with correct confirmations for each transition
4. Manage Listings shows 3 tabs with correct counts
5. Book list tiles show thumbnail, title, price, status, views, date
6. Swipe left to delete works with confirmation dialog
7. Swipe right to mark sold / relist works
8. Delete removes book + bundle_items + wishlists
9. Empty states show for each tab
10. Permission check prevents editing other users' books
11. `flutter analyze` returns 0 issues

ğŸ‘¤ USER MANUAL STEPS:
- None â€” purely frontend code

ğŸ’¬ CONFIRM IN CHAT:
"Prompt 12 complete. Edit Book Screen with pre-filled form, photo management, status transitions. Manage Listings with 3 tabs (Active/Reserved/Sold), swipe actions, delete with cleanup. BookForm refactored as reusable widget. flutter analyze: 0 issues. Zero errors."

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â­ï¸ NEXT: Prompt 13 â€” Search Screen (Full-Text Search + Filters)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ PROMPT 13 of 70
Phase: Search & Discovery (PHASE_08)
Task: Search Screen â€” Full-Text Search + Filter Drawer + Sort + History
Type: ğŸ“± FRONTEND (Flutter)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ INSTRUCTION:
Build the **Search Screen** (`/home/search`) â€” second tab in the bottom navigation. Provides instant search with filters, sort options, search history, and trending searches.

> **Guest-Accessible:** Search works without login. No LoginGate needed.

---

### PART A: Search Bar

ğŸ“ CREATE: `lib/screens/search/search_screen.dart`

| Element | Details |
|---------|---------|
| **Search Input** | Auto-focused text field at top. Hint: *"Search books, authors, subjects..."* |
| **Debounce** | Search triggers 400ms after user stops typing (no "Search" button) |
| **Clear Button** | "X" icon inside field to clear text. Appears when text is entered |
| **Voice Search** | ğŸ™ï¸ Microphone icon â€” tap to start speech-to-text via `speech_to_text` package. Result fills search bar |
| **Back Button** | â† back arrow to return to previous screen |

**Search Query:**
```dart
pb.collection('books').getList(
  page: currentPage,
  perPage: 20,
  filter: 'status = "active" && (title ~ "${query}" || author ~ "${query}" || description ~ "${query}")',
  sort: sortOption,
  expand: 'seller,school',
);
```

> `~` is PocketBase's "contains" operator for partial text matching.

---

### PART B: Pre-Search View (Before Typing)

When the search bar is empty / no query typed yet:

| Section | Details |
|---------|---------|
| **Recent Searches** | Last 10 searches stored in Hive. Each item: text + "X" to remove. "Clear All" link top-right. Tap â†’ fills search bar and triggers search |
| **Trending Searches** | Hardcoded initially (can be dynamic later): "NCERT Class 10", "HC Verma", "RD Sharma", "NEET Biology", "Arihant JEE". Tap â†’ fills search bar |
| **Popular Categories** | Grid of tappable chips: "NCERT", "JEE/NEET", "CBSE Class 10", "CBSE Class 12", "Novels", "Free Books". Tap â†’ applies category filter + triggers search |

---

### PART C: Search Results

| Element | Details |
|---------|---------|
| **Results Count** | *"42 books found"* â€” shown above results |
| **Layout Toggle** | Grid (2-col) / List toggle button top-right. Default: Grid. Persist choice in Hive |
| **Grid Mode** | Reuse `BookCard` from Prompt 9 (2 columns) |
| **List Mode** | Reuse `BookListTile` from Prompt 12 |
| **Pagination** | Infinite scroll, 20 per page, loading spinner at bottom |
| **No Results** | Illustration + *"No books match your search"* + *"Try different keywords or remove filters"* |

---

### PART D: Filter Bottom Sheet

ğŸ“ CREATE: `lib/widgets/search/filter_sheet.dart`

Triggered by "Filter" icon button next to the search bar. Opens as a bottom sheet.

| Filter | Type | Options |
|--------|------|---------|
| **Category** | Multi-select chips | NCERT, Reference, Competitive Exam, Novel, Non-Fiction, Notes, Other |
| **Board** | Multi-select chips | CBSE, ICSE, State Board, IB |
| **Class** | Multi-select chips | 1â€“12, College |
| **Condition** | Multi-select chips | Like New, Good, Fair |
| **Price Range** | Range slider | â‚¹0 to â‚¹5000 (or "Free only" toggle) |
| **Distance** | Slider | 1 km to 50 km (requires location). Label: *"Within {X} km"* |

**Bottom:**
- "Reset All" text button (left) â€” clears all filters
- "Show {N} Results" filled button (right) â€” closes sheet and applies filters
- Live count updates as user changes filters (query runs in background)

**Active Filters Badge:**
- Filter icon in search bar shows badge count when filters are active (e.g., "3")
- Below search bar: horizontal row of active filter chips with "X" to remove individually

---

### PART E: Sort Options

ğŸ“ CREATE: `lib/widgets/search/sort_sheet.dart`

Triggered by "Sort" icon button. Opens as a small bottom sheet.

| Option | Sort Value |
|--------|-----------|
| **Relevance** (default) | No explicit sort â€” PocketBase's default text match ranking |
| **Price: Low to High** | `+selling_price` |
| **Price: High to Low** | `-selling_price` |
| **Newest First** | `-created` |
| **Distance** | Client-side sort by distance from user's location |

Active sort option shows a checkmark. Selected option persists until changed.

---

### PART F: Search History Service

ğŸ“ CREATE: `lib/services/search_history_service.dart`

| Feature | Details |
|---------|---------|
| **Storage** | Hive box: `search_history` |
| **Max Items** | 10 recent searches (FIFO â€” oldest removed when limit reached) |
| **Save** | Save on search submit (not on every keystroke) |
| **No Duplicates** | If same query exists, move it to top |
| **Clear** | "Clear All" removes all history |
| **Remove Single** | "X" on individual item removes just that one |

---

ğŸ“¦ USE:
- `pocketbase` SDK â€” search with filters and pagination
- `speech_to_text` â€” voice search input
- `hive_flutter` â€” search history + layout preference
- `provider` â€” search state, filter state, sort state
- Reuse `BookCard` from Prompt 9 and `BookListTile` from Prompt 12

â›” DO NOT:
- Do NOT search on every keystroke â€” debounce 400ms
- Do NOT require login for search â€” fully guest-accessible
- Do NOT store more than 10 recent searches
- Do NOT forget to sanitize search input to prevent PocketBase filter injection
- Do NOT show the filter badge count when no filters are active
- Do NOT forget infinite scroll pagination on results
- Do NOT make voice search mandatory â€” gracefully handle when speech permission is denied

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”§ EXECUTE:

**Step 1:** Create `lib/screens/search/search_screen.dart` with search bar + debounce
**Step 2:** Implement pre-search view (recent, trending, popular categories)
**Step 3:** Create `lib/widgets/search/filter_sheet.dart` with all filter options
**Step 4:** Create `lib/widgets/search/sort_sheet.dart` with sort options
**Step 5:** Create `lib/services/search_history_service.dart` with Hive
**Step 6:** Wire up results display (grid/list toggle, pagination)
**Step 7:** Add voice search with `speech_to_text`
**Step 8:** Run `flutter analyze` â€” 0 issues
**Step 9:** Test: type query â†’ results appear, apply filters â†’ results refine, sort â†’ order changes

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ… SELF-CHECK:
1. Search bar auto-focuses and shows keyboard
2. Debounce fires 400ms after typing stops
3. Results show in grid mode by default, toggle to list works
4. Pre-search view shows recent searches, trending, popular categories
5. Recent searches save to Hive (max 10, no duplicates)
6. Filter sheet opens, all 6 filters render correctly
7. Filter badge shows count of active filters
8. Active filter chips show below search bar with "X" remove
9. Sort options change result order
10. "No results" empty state shows with helpful text
11. Voice search works (or gracefully degrades if permission denied)
12. Pagination loads next page on scroll
13. Input is sanitized â€” special characters don't break the query
14. `flutter analyze` returns 0 issues

ğŸ‘¤ USER MANUAL STEPS:
- None â€” purely frontend code

ğŸ’¬ CONFIRM IN CHAT:
"Prompt 13 complete. Search Screen with debounced full-text search, filter bottom sheet (6 filters), sort options (5 modes), search history (Hive, max 10), trending searches, voice search, grid/list toggle, infinite scroll. flutter analyze: 0 issues. Zero errors."

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â­ï¸ NEXT: Prompt 14 â€” Chat System â€” Real-Time Messaging
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ PROMPT 14 of 70
Phase: Chat & Communication (PHASE_09)
Task: Chat System â€” Chat List + Real-Time Messaging + Offers + Image Sharing
Type: ğŸ“± FRONTEND + ğŸ”§ BACKEND (PocketBase Hooks)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ INSTRUCTION:
Build the complete **Chat System** â€” chat list (tab 4), real-time messaging with PocketBase SSE subscriptions, quick replies, offer/counter-offer flow, image sharing, read receipts, and block/report.

> **Auth Required:** Chat is only available to logged-in users. Guests see "Sign in to start chatting" CTA.

---

### PART A: Chat List Screen

ğŸ“ CREATE: `lib/screens/chat/chat_list_screen.dart`

| Element | Details |
|---------|---------|
| **Tab 4** | Bottom nav "Chats" tab |
| **Guest View** | If not logged in â†’ illustration + *"Sign in to start chatting"* + "Sign In" CTA button â†’ `LoginGate.show()` |
| **Data Source** | `pb.collection('chats').getList(filter: '(buyer = "${userId}" \|\| seller = "${userId}") && is_deleted_by_buyer != true && is_deleted_by_seller != true', sort: '-last_message_at', expand: 'buyer,seller,book')` |
| **Real-Time** | Subscribe: `pb.collection('chats').subscribe('*', callback)` â€” updates list when new messages arrive |

**Each Chat Row:**

ğŸ“ CREATE: `lib/widgets/chat/chat_list_tile.dart`

| Element | Details |
|---------|---------|
| **Avatar** | Other user's profile picture (or initials fallback) |
| **Name** | Other user's display name |
| **Book Title** | Small subtitle: *"About: {bookTitle}"* |
| **Book Thumbnail** | Tiny book cover image (40x40) on right side |
| **Last Message** | Preview text (1 line, truncated). If image â†’ *"ğŸ“· Photo"*. If offer â†’ *"ğŸ’° Offer: â‚¹{amount}"* |
| **Time** | Relative: "2m", "1h", "Yesterday", "Feb 10" |
| **Unread Badge** | Blue dot or count badge if there are unread messages |
| **Tap** | Navigate to `/chat/:chatId` |

**Swipe Actions:**
| Swipe | Action |
|-------|--------|
| Left | **Delete Chat** â€” confirm dialog. Sets `is_deleted_by_buyer` or `is_deleted_by_seller` (soft delete â€” other user still sees it) |

**Empty State:**
*"No conversations yet. Start chatting by tapping 'Chat with Seller' on any book."*

---

### PART B: Chat Detail Screen (Messaging)

ğŸ“ CREATE: `lib/screens/chat/chat_detail_screen.dart`

**Top App Bar:**
| Element | Details |
|---------|---------|
| **Back** | â† back to chat list |
| **Avatar + Name** | Other user's avatar and name â€” tap â†’ navigate to `/seller/:id` |
| **Book Info** | Small book title + *"â‚¹{price}"*. Tap â†’ navigate to `/book/:id` |
| **Menu** | â‹® overflow menu: "View Book", "View Profile", "Block User", "Report User" |

**Messages Area:**
- Reverse `ListView` (newest at bottom, scroll up for history)
- Messages grouped by date: *"Today"*, *"Yesterday"*, *"Feb 10, 2026"*
- Lazy load older messages on scroll-up (pagination, 50 per page)

**Message Bubbles:**

ğŸ“ CREATE: `lib/widgets/chat/message_bubble.dart`

| Element | Details |
|---------|---------|
| **Sent (right)** | Primary color background, white text, rounded corners (top-left, top-right, bottom-left) |
| **Received (left)** | Light grey background, dark text, rounded corners (top-left, top-right, bottom-right) |
| **Timestamp** | Small muted text below message: "2:34 PM" |
| **Read Receipt** | Sent messages: single tick (âœ“) = sent, double tick (âœ“âœ“) = read. Blue double tick when read. |
| **Image Message** | Thumbnail (rounded, tappable â†’ full-screen view). Max width: 250px |
| **Offer Message** | Special card bubble: *"ğŸ’° Offered â‚¹{amount}"* with Accept/Decline buttons (for receiver) |
| **System Message** | Centered, muted text: *"Chat started"*, *"Offer accepted"*, *"User blocked"* |

---

### PART C: Message Input Bar

ğŸ“ CREATE: `lib/widgets/chat/message_input_bar.dart`

| Element | Details |
|---------|---------|
| **Text Input** | Multiline text field, max 500 chars. Hint: *"Type a message..."* |
| **Send Button** | Blue send arrow â†’ disabled when field is empty |
| **Image Button** | ğŸ“· Camera icon â†’ pick image from gallery or camera â†’ compress â†’ send as image message |
| **Offer Button** | ğŸ’° "Make Offer" button â†’ opens offer bottom sheet |

**Quick Reply Suggestions:**
When chat is first opened (no messages yet), show tappable chips:
- *"Hi, is this book still available?"*
- *"Can you reduce the price?"*
- *"Where can we meet for handover?"*
- *"Is the condition as described?"*

Tapping a chip fills the input and auto-sends.

---

### PART D: Real-Time with PocketBase SSE

ğŸ“ CREATE: `lib/services/chat_service.dart`

```dart
// Subscribe to messages for a specific chat
pb.collection('messages').subscribe('*', (e) {
  if (e.record?.get('chat') == currentChatId) {
    // Add message to local list
    // Update UI
    // Mark as read if chat is currently open
  }
}, filter: 'chat = "$currentChatId"');

// Subscribe to chat list updates (for unread count, last message)
pb.collection('chats').subscribe('*', (e) {
  // Update chat list with new last_message, last_message_at
  // Update unread count badge
});
```

**Key Behaviors:**
- New message from other user â†’ append to message list + scroll to bottom (if already at bottom)
- If user scrolled up â†’ show "New message â†“" floating button instead of auto-scrolling
- When user opens a chat â†’ mark all messages as `is_read: true` for that chat
- Unsubscribe from SSE when navigating away from chat screen

---

### PART E: Offer / Counter-Offer System

ğŸ“ CREATE: `lib/widgets/chat/offer_sheet.dart`

| Element | Details |
|---------|---------|
| **Trigger** | "Make Offer" button in input bar |
| **Input** | Number field: *"Enter your offer price"*, prefix "â‚¹" |
| **Context** | Shows: book title, listed price, and *"Seller's asking price: â‚¹{price}"* |
| **Send** | Creates a `messages` record with `type: "offer"`, `offer_amount: value` |
| **Display** | Offer appears as a special card bubble in the chat |

**Offer Response (for seller/receiver):**
- Accept â†’ creates system message *"âœ… Offer of â‚¹{amount} accepted"* + updates `chats.agreed_price`
- Decline â†’ creates system message *"âŒ Offer of â‚¹{amount} declined"*
- Counter â†’ opens offer sheet pre-filled with a different amount â†’ sends as new offer

> Only the latest offer can be accepted/declined. Previous offers are auto-expired.

---

### PART F: Read Receipts Backend Hook

ğŸ“ CREATE: `pb_hooks/chat_hooks.pb.js`

```javascript
// When a message is created, update the chat's last_message fields
onRecordAfterCreateSuccess("messages", (e) => {
  const msg = e.record;
  const chat = e.app.findRecordById("chats", msg.get("chat"));
  chat.set("last_message", msg.get("content") || (msg.get("type") === "offer" ? "ğŸ’° Offer" : "ğŸ“· Photo"));
  chat.set("last_message_at", msg.get("created"));
  chat.set("last_sender", msg.get("sender"));
  e.app.save(chat);
});

// When messages are marked as read, update unread count
onRecordAfterUpdateSuccess("messages", (e) => {
  const msg = e.record;
  if (msg.get("is_read") && msg.original.get("is_read") !== msg.get("is_read")) {
    // Message was just marked as read â€” recalculate unread count
    const chat = e.app.findRecordById("chats", msg.get("chat"));
    const unread = e.app.findRecordsByFilter(
      "messages",
      `chat = "${chat.id}" && sender != "${msg.get("receiver")}" && is_read = false`
    );
    chat.set("unread_count", unread.length);
    e.app.save(chat);
  }
});
```

---

### PART G: Block User Flow

| Step | Details |
|------|---------|
| 1 | User taps "Block User" from chat menu |
| 2 | Confirmation: *"Block {name}? You won't receive messages from them and they won't see your listings."* |
| 3 | Creates a `blocked_users` record: `blocker: currentUser, blocked: otherUser` |
| 4 | Hides the chat from list |
| 5 | Backend API rule: blocked users' books are filtered out from search/home |

---

ğŸ“¦ USE:
- `pocketbase` SDK â€” CRUD messages, chats, SSE subscriptions
- `image_picker` + `flutter_image_compress` â€” image messages
- `cached_network_image` â€” message images, avatars
- `intl` â€” timestamp formatting
- `provider` â€” chat state, unread count state
- PocketBase hooks for read receipts + chat metadata updates

â›” DO NOT:
- Do NOT use WebSockets â€” PocketBase uses SSE (Server-Sent Events) for real-time
- Do NOT poll for messages â€” use SSE subscriptions only
- Do NOT hard-delete chats â€” soft delete with `is_deleted_by_buyer`/`is_deleted_by_seller`
- Do NOT allow messaging on sold books â€” show *"This book has been sold"* + disable input
- Do NOT forget to unsubscribe from SSE when leaving chat screen
- Do NOT send push notifications from the Flutter app â€” that's handled server-side (later prompt)
- Do NOT allow sending empty messages
- Do NOT allow more than 1 image per message (send as separate messages)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”§ EXECUTE:

**Step 1:** Create `lib/screens/chat/chat_list_screen.dart` with real-time list
**Step 2:** Create `lib/screens/chat/chat_detail_screen.dart` with message bubbles
**Step 3:** Create `lib/widgets/chat/message_bubble.dart` (text, image, offer, system variants)
**Step 4:** Create `lib/widgets/chat/message_input_bar.dart` with quick replies
**Step 5:** Create `lib/widgets/chat/offer_sheet.dart` with offer/counter-offer flow
**Step 6:** Create `lib/services/chat_service.dart` with SSE subscriptions
**Step 7:** Create `pb_hooks/chat_hooks.pb.js` for read receipts + last_message sync
**Step 8:** Deploy hooks via `./deploy.sh`
**Step 9:** Run `flutter analyze` â€” 0 issues
**Step 10:** Test: send message â†’ appears in real-time, send image, make offer, accept/decline

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ… SELF-CHECK:
1. Chat list shows all conversations sorted by most recent
2. SSE subscription updates list in real-time (no polling)
3. Unread badge shows on chat tab and individual chat rows
4. Message bubbles render correctly: text, image, offer, system
5. Quick reply chips show on first open (no messages yet)
6. Read receipts update: single tick â†’ double tick â†’ blue double tick
7. "Make Offer" creates offer bubble with Accept/Decline/Counter
8. Image messages compress and upload correctly
9. "New message â†“" button shows when scrolled up
10. Soft delete hides chat for one user only
11. Block user hides chat + filters their books
12. Input disabled for sold books
13. Hooks update chat metadata on new message
14. `flutter analyze` returns 0 issues

ğŸ‘¤ USER MANUAL STEPS:
- None â€” code + hooks only. Deploy hooks via `./deploy.sh`

ğŸ’¬ CONFIRM IN CHAT:
"Prompt 14 complete. Chat System with real-time SSE messaging, chat list, message bubbles (text/image/offer/system), quick replies, offer/counter-offer flow, read receipts, block user, image sharing, PocketBase hooks for chat metadata. flutter analyze: 0 issues. Zero errors."

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â­ï¸ NEXT: Prompt 15 â€” Transaction Flow (QR Handover + Review)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ PROMPT 15 of 70
Phase: Transaction & Trust (PHASE_10)
Task: Transaction Flow â€” QR Handover + Status Machine + Review/Rating
Type: ğŸ“± FRONTEND + ğŸ”§ BACKEND (PocketBase Hooks)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ INSTRUCTION:
Build the complete **Transaction Flow** â€” from initiating a deal in chat to QR-based handover confirmation and post-sale review. This is the core trust mechanism of the app.

> **Auth Required:** All transaction screens require login. Both buyer and seller must be authenticated.

---

### Transaction Status Machine

```
initiated â†’ confirmed â†’ handover_pending â†’ completed â†’ reviewed
                                              â†“
                                           disputed
```

| Status | Who Triggers | What Happens |
|--------|-------------|--------------|
| `initiated` | System | Auto-created when seller accepts an offer in chat |
| `confirmed` | Buyer | Buyer confirms the deal â€” both parties committed |
| `handover_pending` | System | QR code generated, waiting for in-person handover |
| `completed` | System | QR scanned successfully â€” book handed over |
| `reviewed` | Buyer | Buyer submitted a review (terminal state) |
| `disputed` | Either party | One party reports a problem |

---

### PART A: Initiate Transaction (from Chat)

When seller taps "Accept Offer" in chat:
1. Create `transactions` record:
   - `book`: bookId
   - `buyer`: buyerId
   - `seller`: sellerId
   - `chat`: chatId
   - `agreed_price`: offer amount (or listed price if no offer)
   - `status`: "initiated"
2. Update book: `status: "reserved"`
3. System message in chat: *"âœ… Deal initiated! â‚¹{price} agreed. Buyer, please confirm to proceed."*
4. Button appears in chat for buyer: "Confirm Deal"

**Buyer confirms â†’ status changes to `confirmed` â†’ `handover_pending`:**
1. Update transaction: `status: "handover_pending"`
2. Generate QR code (see Part B)
3. System message: *"ğŸ“± QR code ready! Meet in person and scan to complete the handover."*

---

### PART B: QR Code Generation

ğŸ“ CREATE: `lib/screens/transaction/qr_code_screen.dart`

| Element | Details |
|---------|---------|
| **Route** | `/transaction/:id/qr` |
| **Who sees it** | Seller generates QR, shows it to buyer |
| **QR Content** | JSON: `{ "txn_id": "...", "token": "...", "expires": "..." }` |
| **Token** | Random UUID generated server-side, stored in `transactions.handover_token` |
| **Expiry** | Token valid for **24 hours** from generation. Show countdown timer. |
| **Display** | Large QR code centered on screen + transaction details below |
| **Details Below QR** | Book title, agreed price, buyer name, *"Show this to the buyer to scan"* |
| **Regenerate** | "Regenerate QR" button if expired â†’ generates new token, resets expiry |
| **Brightness** | Auto-increase screen brightness to max when QR is displayed |

**QR Generation Hook:**

ğŸ“ ADD TO: `pb_hooks/transaction_hooks.pb.js`

```javascript
// Generate handover token when transaction moves to handover_pending
onRecordAfterUpdateSuccess("transactions", (e) => {
  const txn = e.record;
  if (txn.get("status") === "handover_pending" && !txn.get("handover_token")) {
    const token = $security.randomString(32);
    txn.set("handover_token", token);
    txn.set("token_expires_at", new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString());
    e.app.save(txn);
  }
});
```

---

### PART C: QR Scanning (Buyer)

ğŸ“ CREATE: `lib/screens/transaction/qr_scan_screen.dart`

| Element | Details |
|---------|---------|
| **Route** | `/transaction/:id/scan` |
| **Who uses it** | Buyer scans the seller's QR |
| **Scanner** | Camera view with QR overlay frame. Uses `mobile_scanner` package |
| **Permission** | Request camera permission. If denied â†’ show manual token input fallback |
| **Manual Fallback** | Text field: *"Or enter the handover code manually"* â€” seller can share the token as text |
| **On Scan** | Send the scanned token to backend for verification |

**Verification API:**

ğŸ“ ADD TO: `pb_hooks/transaction_hooks.pb.js`

```javascript
// Verify QR handover token
routerAdd("POST", "/api/transactions/{id}/verify-handover", (e) => {
  const txnId = e.request.pathValue("id");
  const body = e.requestBody();
  const token = body.token;
  
  const txn = e.app.findRecordById("transactions", txnId);
  
  // Validate
  if (txn.get("status") !== "handover_pending") {
    return e.json(400, { error: "Transaction is not pending handover" });
  }
  if (txn.get("handover_token") !== token) {
    return e.json(400, { error: "Invalid handover code" });
  }
  if (new Date(txn.get("token_expires_at")) < new Date()) {
    return e.json(400, { error: "Handover code has expired. Ask the seller to regenerate." });
  }
  if (e.auth.id !== txn.get("buyer")) {
    return e.json(403, { error: "Only the buyer can scan the handover code" });
  }
  
  // Mark as completed
  txn.set("status", "completed");
  txn.set("completed_at", new Date().toISOString());
  txn.set("handover_token", ""); // Clear token
  e.app.save(txn);
  
  // Mark book as sold
  const book = e.app.findRecordById("books", txn.get("book"));
  book.set("status", "sold");
  book.set("sold_at", new Date().toISOString());
  e.app.save(book);
  
  return e.json(200, { message: "Handover confirmed!" });
});
```

**After successful scan:**
1. Show success animation (checkmark + confetti)
2. *"ğŸ‰ Handover complete! The book is now yours."*
3. Prompt: *"Leave a review for {sellerName}?"* â†’ "Write Review" / "Maybe Later"
4. System message in chat: *"âœ… Handover completed! Book delivered."*

---

### PART D: Transaction Detail Screen

ğŸ“ CREATE: `lib/screens/transaction/transaction_detail_screen.dart`

| Element | Details |
|---------|---------|
| **Route** | `/transaction/:id` |
| **Top** | Status badge (colored by status) + status timeline |
| **Book Card** | Book thumbnail + title + agreed price |
| **Parties** | Buyer avatar/name + Seller avatar/name |
| **Timeline** | Visual stepper showing: Initiated â†’ Confirmed â†’ Handover Pending â†’ Completed â†’ Reviewed |
| **Actions (Seller)** | "Show QR Code" button (if handover_pending) |
| **Actions (Buyer)** | "Scan QR Code" button (if handover_pending). "Write Review" button (if completed, not yet reviewed) |
| **Actions (Both)** | "Report Problem" button â†’ creates dispute |
| **Chat Link** | "Go to Chat" â†’ navigates to the related chat |

---

### PART E: Review / Rating System

ğŸ“ CREATE: `lib/screens/transaction/review_screen.dart`

| Element | Details |
|---------|---------|
| **Route** | `/transaction/:id/review` |
| **Who** | Buyer reviews the seller after completed transaction |
| **Star Rating** | 1â€“5 stars (tap or swipe). Required. |
| **Review Text** | Multiline text, max 500 chars. Optional. Placeholder: *"How was your experience with {sellerName}?"* |
| **Quick Tags** | Tappable chips (multi-select): "On Time", "Book as Described", "Friendly", "Fair Price", "Fast Response" |
| **Submit** | Creates `reviews` record: `reviewer: buyerId, reviewed_user: sellerId, transaction: txnId, rating, comment, tags` |
| **Confirmation** | *"Thank you for your review! ğŸŒŸ"* â†’ navigate back to transaction detail |
| **One Review Only** | Cannot review the same transaction twice. If reviewed â†’ show the review in read-only mode |

---

### PART F: Trust Score Update Hook

ğŸ“ ADD TO: `pb_hooks/transaction_hooks.pb.js`

```javascript
// After a review is created, update the seller's trust score
onRecordAfterCreateSuccess("reviews", (e) => {
  const review = e.record;
  const sellerId = review.get("reviewed_user");
  
  // Fetch all reviews for this seller
  const allReviews = e.app.findRecordsByFilter(
    "reviews",
    `reviewed_user = "${sellerId}"`
  );
  
  // Calculate average rating
  let totalRating = 0;
  for (const r of allReviews) {
    totalRating += r.getInt("rating");
  }
  const avgRating = totalRating / allReviews.length;
  
  // Update seller's trust score
  const seller = e.app.findRecordById("users", sellerId);
  seller.set("trust_score", Math.round(avgRating * 10) / 10); // e.g., 4.3
  seller.set("total_reviews", allReviews.length);
  e.app.save(seller);
  
  // Update transaction status
  const txn = e.app.findRecordById("transactions", review.get("transaction"));
  txn.set("status", "reviewed");
  e.app.save(txn);
});
```

---

### PART G: Dispute Flow

| Step | Details |
|------|---------|
| 1 | Either party taps "Report Problem" on transaction detail |
| 2 | Bottom sheet with reasons: "Book not as described", "Didn't show up", "Wrong book", "Other" |
| 3 | Creates `transactions` update: `status: "disputed"`, `dispute_reason` |
| 4 | Creates `reports` record: `type: "transaction"`, `target_type: "transactions"`, `target_id: txnId` |
| 5 | System message in chat: *"âš ï¸ A dispute has been raised for this transaction. Our team will review."* |
| 6 | Admin resolves disputes manually via PocketBase Admin UI |

---

ğŸ“¦ USE:
- `qr_flutter` â€” QR code generation display
- `mobile_scanner` â€” QR code scanning
- `pocketbase` SDK â€” transaction CRUD, review CRUD
- `confetti_widget` â€” success animation after handover
- `screen_brightness` â€” auto-brightness for QR display
- PocketBase hooks for token generation, trust score, auto-status updates

â›” DO NOT:
- Do NOT allow the seller to scan their own QR â€” only buyer scans
- Do NOT allow reviews before handover is complete
- Do NOT allow multiple reviews for the same transaction
- Do NOT expose the raw handover token in the UI â€” only in the QR code
- Do NOT forget to mark the book as "sold" after successful handover
- Do NOT skip the 24-hour expiry on QR tokens
- Do NOT use client-side token generation â€” always generate on server
- Do NOT allow disputes after a review has been submitted

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”§ EXECUTE:

**Step 1:** Create `lib/screens/transaction/qr_code_screen.dart`
**Step 2:** Create `lib/screens/transaction/qr_scan_screen.dart`
**Step 3:** Create `lib/screens/transaction/transaction_detail_screen.dart` with status timeline
**Step 4:** Create `lib/screens/transaction/review_screen.dart`
**Step 5:** Create `pb_hooks/transaction_hooks.pb.js` (token gen, verify handover, trust score update)
**Step 6:** Wire up transaction initiation from chat offer accept
**Step 7:** Deploy hooks via `./deploy.sh`
**Step 8:** Run `flutter analyze` â€” 0 issues
**Step 9:** Test full flow: offer accept â†’ initiate â†’ confirm â†’ QR generate â†’ scan â†’ complete â†’ review

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ… SELF-CHECK:
1. Transaction creates on offer accept with correct parties and price
2. Book status changes to "reserved" on initiation
3. QR code displays with countdown timer (24h expiry)
4. Screen brightness increases when QR is shown
5. QR scanning verifies token server-side â€” rejects invalid/expired tokens
6. Manual token fallback works when camera permission denied
7. Success animation + confetti shows after verified handover
8. Book status changes to "sold" after completion
9. Review screen shows stars, text, quick tags
10. Trust score recalculates after review submission
11. Dispute flow creates report + changes status
12. Status timeline renders correctly for each state
13. Cannot review twice, cannot dispute after review
14. `flutter analyze` returns 0 issues

ğŸ‘¤ USER MANUAL STEPS:
- None â€” deploy hooks via `./deploy.sh`

ğŸ’¬ CONFIRM IN CHAT:
"Prompt 15 complete. Transaction Flow with QR handover (generate + scan + verify), 6-step status machine, server-side token generation, review/rating system, trust score auto-update hook, dispute flow. flutter analyze: 0 issues. Zero errors."

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â­ï¸ NEXT: Prompt 16 â€” Profile Screen + Settings
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ PROMPT 16 of 70
Phase: Profile & Settings (PHASE_11)
Task: Profile Screen (Tab 5) + Seller Profile + Edit Profile + Settings
Type: ğŸ“± FRONTEND (Flutter)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ INSTRUCTION:
Build 4 connected screens: **My Profile** (tab 5), **Public Seller Profile** (viewable by others), **Edit Profile**, and **Settings**. These cover the user's personal space in the app.

---

### PART A: My Profile Screen (Tab 5)

ğŸ“ CREATE: `lib/screens/profile/profile_screen.dart`

**Guest View:**
If not logged in â†’ illustration + *"Sign in to see your profile"* + "Sign In" CTA â†’ `LoginGate.show()`

**Logged-In View:**

| Section | Details |
|---------|---------|
| **Header** | Large avatar (from Google profile pic), display name, email, trust score â­, member since date |
| **Edit Button** | Pencil icon â†’ navigate to `/settings/profile-edit` |
| **Stats Row** | 3 boxes: Active Listings (count) Â· Books Sold (count) Â· Trust Score (â­ X.X) |

**Menu Rows (tappable list):**

| Row | Icon | Label | Navigate To |
|-----|------|-------|-------------|
| 1 | ğŸ“š | My Listings | `manage_listings_screen` (Prompt 12) |
| 2 | ğŸ“¦ | My Transactions | `transactions_list_screen` |
| 3 | â¤ï¸ | My Wishlist | `/wishlists` |
| 4 | ğŸ“ | Academic Profile | Edit academic info (opens Step 3 of onboarding in edit mode) |
| 5 | ğŸ† | My Badges | Badge showcase screen |
| 6 | ğŸ‘¥ | Referrals | Referral dashboard |
| 7 | âš™ï¸ | Settings | `/settings` |

---

### PART B: Public Seller Profile Screen

ğŸ“ CREATE: `lib/screens/profile/seller_profile_screen.dart`

| Element | Details |
|---------|---------|
| **Route** | `/seller/:id` |
| **Header** | Avatar, display name, trust score â­, member since, verified badge (if Google-verified) |
| **Stats** | Books Sold Â· Active Listings Â· Avg Rating |
| **Badges Section** | Show all earned badges with icons and labels |
| **Reviews Tab** | List of reviews from buyers. Each: avatar, name, stars, comment, date, quick tags |
| **Active Listings Tab** | Grid of seller's active books (reuse `BookCard` from Prompt 9) |
| **Actions** | "Chat" button (if viewing someone else). "Report User" in overflow menu |
| **No Self-View** | If viewing own profile â†’ redirect to My Profile tab |

**Tab Layout:**
| Tab | Content |
|-----|---------|
| Listings | Seller's active books grid |
| Reviews | Reviews received, sorted by newest |

---

### PART C: Edit Profile Screen

ğŸ“ CREATE: `lib/screens/profile/edit_profile_screen.dart`

| Element | Details |
|---------|---------|
| **Route** | `/settings/profile-edit` |
| **Avatar** | Current avatar with "Change Photo" overlay. Opens image picker â†’ compress â†’ upload to user record |
| **Display Name** | Text field, pre-filled from Google. Editable. Max 50 chars |
| **Phone** | Text field, pre-filled. Editable with same validation as onboarding (10 digits, duplicate check) |
| **Location** | City + Area fields. Pre-filled. "Detect Location" button to re-detect via GPS |
| **Preferred Radius** | Slider: 1 km to 50 km. Default 5 km. Label: *"Show books within {X} km"* |
| **About Me** | Multiline text, max 200 chars. Optional. Shows on public seller profile |
| **Save** | "Save Changes" button â†’ update user record â†’ snackbar: *"Profile updated"* |

---

### PART D: Transactions List Screen

ğŸ“ CREATE: `lib/screens/profile/transactions_list_screen.dart`

| Element | Details |
|---------|---------|
| **Tabs** | "As Buyer" / "As Seller" |
| **Each Row** | Book thumbnail + title + other party's name + agreed price + status chip + date |
| **Status Colors** | initiated (grey), confirmed (blue), handover_pending (orange), completed (green), reviewed (purple), disputed (red) |
| **Tap** | Navigate to `/transaction/:id` |
| **Empty** | *"No transactions yet"* |

---

### PART E: Wishlist Screen

ğŸ“ CREATE: `lib/screens/profile/wishlist_screen.dart`

| Element | Details |
|---------|---------|
| **Route** | `/wishlists` |
| **Data Source** | `pb.collection('wishlists').getList(filter: 'user = "${userId}"', expand: 'book,book.seller', sort: '-created')` |
| **Layout** | List of `BookListTile` (reuse from Prompt 12) |
| **Price Drop Badge** | If current book price < `price_at_save` â†’ show green badge: *"ğŸ“‰ Price dropped! Was â‚¹{old}, now â‚¹{current}"* |
| **Swipe Left** | Remove from wishlist |
| **Empty** | *"Your wishlist is empty. Tap â¤ï¸ on any book to save it for later."* |

---

### PART F: Settings Screen

ğŸ“ CREATE: `lib/screens/settings/settings_screen.dart`

| Section | Rows |
|---------|------|
| **Account** | |
| | Profile Edit â†’ `/settings/profile-edit` |
| | Blocked Users â†’ `/settings/blocked-users` |
| **Preferences** | |
| | Notifications toggle (FCM on/off) |
| | Location Settings â†’ re-detect or change city/radius |
| | Theme â†’ System / Light / Dark (use `ThemeMode` with Provider) |
| | Language â†’ English only for now (greyed out, coming soon) |
| **About** | |
| | Terms & Conditions â†’ in-app webview |
| | Privacy Policy â†’ in-app webview |
| | Rate the App â†’ opens Play Store listing |
| | App Version â†’ *"v1.0.0 (build 1)"* from `package_info_plus` |
| **Danger Zone** | |
| | Logout â†’ confirm dialog â†’ `pb.authStore.clear()` â†’ navigate to splash |
| | Delete Account â†’ double confirm â†’ see Part G |

---

### PART G: Delete Account Flow

| Step | Details |
|------|---------|
| 1 | User taps "Delete Account" |
| 2 | First confirm: *"Are you sure? This will permanently delete your account, listings, and all data."* |
| 3 | Second confirm: *"Type DELETE to confirm"* â€” text input must match exactly |
| 4 | Call PocketBase: delete user record. Backend cascade handles related data cleanup |
| 5 | Clear local auth store, Hive data, caches |
| 6 | Navigate to splash screen |
| 7 | Show snackbar: *"Your account has been deleted."* |

---

### PART H: Blocked Users Screen

ğŸ“ CREATE: `lib/screens/settings/blocked_users_screen.dart`

| Element | Details |
|---------|---------|
| **Route** | `/settings/blocked-users` |
| **Data Source** | `pb.collection('blocked_users').getList(filter: 'blocker = "${userId}"', expand: 'blocked')` |
| **Each Row** | Avatar + name + "Unblock" button |
| **Unblock** | Confirm dialog â†’ delete `blocked_users` record |
| **Empty** | *"You haven't blocked anyone."* |

---

### PART I: Badge Showcase Screen

ğŸ“ CREATE: `lib/screens/profile/badges_screen.dart`

| Element | Details |
|---------|---------|
| **Data Source** | `pb.collection('badges').getList(filter: 'user = "${userId}"')` |
| **Each Badge** | Large icon + title + description + *"Earned on {date}"* |
| **Unearned Badges** | Show greyed-out versions of badges not yet earned, with requirements: *"Complete 5 sales to earn ğŸ† Top Seller"* |
| **Empty** | *"No badges yet. Start selling and chatting to earn badges!"* |

---

ğŸ“¦ USE:
- `pocketbase` SDK â€” user data, wishlists, transactions, badges, blocked users
- `cached_network_image` â€” avatars and thumbnails
- `image_picker` + `flutter_image_compress` â€” avatar photo change
- `package_info_plus` â€” app version display
- `provider` â€” theme mode, auth state
- `url_launcher` â€” Play Store link, terms/privacy URLs
- Reuse `BookCard`, `BookListTile` from earlier prompts

â›” DO NOT:
- Do NOT show My Profile content to guests â€” show sign-in CTA instead
- Do NOT show private info (phone, email) on public seller profile
- Do NOT allow deleting account without double confirmation + "DELETE" type check
- Do NOT forget to clear all local data on logout and account deletion
- Do NOT show "Chat" button on own seller profile
- Do NOT forget price drop detection on wishlist items

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”§ EXECUTE:

**Step 1:** Create `lib/screens/profile/profile_screen.dart` (My Profile tab 5)
**Step 2:** Create `lib/screens/profile/seller_profile_screen.dart` (public profile)
**Step 3:** Create `lib/screens/profile/edit_profile_screen.dart`
**Step 4:** Create `lib/screens/profile/transactions_list_screen.dart`
**Step 5:** Create `lib/screens/profile/wishlist_screen.dart` with price drop detection
**Step 6:** Create `lib/screens/settings/settings_screen.dart`
**Step 7:** Create `lib/screens/settings/blocked_users_screen.dart`
**Step 8:** Create `lib/screens/profile/badges_screen.dart`
**Step 9:** Run `flutter analyze` â€” 0 issues
**Step 10:** Test: profile renders, edit saves, logout clears, wishlist shows price drops

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ… SELF-CHECK:
1. My Profile shows stats (active listings, books sold, trust score)
2. Guest view shows sign-in CTA â€” no profile content leaked
3. Menu rows navigate to correct screens
4. Seller profile shows public info only (no phone, no email)
5. Seller profile tabs: Listings grid + Reviews list
6. Edit Profile saves all fields correctly
7. Avatar change compresses and uploads
8. Transactions list shows correct tabs (As Buyer / As Seller)
9. Wishlist shows price drop badge when applicable
10. Settings toggle theme correctly (System/Light/Dark)
11. Logout clears auth store + local data
12. Delete account requires double confirm + "DELETE" text
13. Blocked users list shows with unblock functionality
14. Badge showcase shows earned + unearned badges
15. `flutter analyze` returns 0 issues

ğŸ‘¤ USER MANUAL STEPS:
- None â€” purely frontend code

ğŸ’¬ CONFIRM IN CHAT:
"Prompt 16 complete. My Profile (tab 5), public Seller Profile with reviews/listings tabs, Edit Profile, Wishlist with price drops, Transactions list, Settings (theme/notifications/logout/delete), Blocked Users, Badge Showcase. flutter analyze: 0 issues. Zero errors."

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â­ï¸ NEXT: Prompt 17 â€” Notifications System (FCM + In-App)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ PROMPT 17 of 70
Phase: Notifications (PHASE_12)
Task: FCM Push Notifications + In-App Notification Center + Backend Triggers
Type: ğŸ“± FRONTEND + ğŸ”§ BACKEND (PocketBase Hooks)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ INSTRUCTION:
Build the full **Notification System** â€” Firebase Cloud Messaging setup, PocketBase hooks to trigger push notifications on key events, in-app notification center screen, notification preferences, and badge counts.

---

### PART A: FCM Setup in Flutter

ğŸ“ MODIFY: `lib/main.dart`
ğŸ“ CREATE: `lib/services/notification_service.dart`

| Element | Details |
|---------|---------|
| **Package** | `firebase_messaging` + `firebase_core` |
| **Init** | Initialize Firebase in `main()` before `runApp()` |
| **Permission** | Request notification permission on first app launch (iOS + Android 13+) |
| **Token** | Get FCM token â†’ save to user record: `pb.collection('users').update(userId, body: { 'fcm_token': token })` |
| **Token Refresh** | Listen for token refresh â†’ update user record with new token |
| **Foreground** | Show local notification via `flutter_local_notifications` when app is in foreground |
| **Background** | Handle background messages in `@pragma('vm:entry-point')` handler |
| **Tap Handler** | On notification tap â†’ navigate to relevant screen based on `data.type` field |

**Notification Tap Routing:**

| `data.type` | Navigate To |
|-------------|-------------|
| `new_message` | `/chat/:chatId` |
| `new_offer` | `/chat/:chatId` |
| `offer_accepted` | `/transaction/:txnId` |
| `offer_declined` | `/chat/:chatId` |
| `handover_ready` | `/transaction/:txnId` |
| `transaction_complete` | `/transaction/:txnId/review` |
| `new_review` | `/seller/:userId` (own profile reviews) |
| `price_drop` | `/book/:bookId` |
| `book_sold` | `/book/:bookId` |
| `badge_earned` | badges screen |

---

### PART B: PocketBase Notification Hooks

ğŸ“ CREATE: `pb_hooks/notification_hooks.pb.js`

Uses **PocketBase's built-in `$http.send()`** to call the FCM HTTP v1 API.

> **Important:** The FCM Server Key is stored as an environment variable or in a `settings` collection record.

**Helper Function:**
```javascript
function sendPushNotification(app, recipientId, title, body, data) {
  // 1. Get recipient's FCM token from users collection
  const user = app.findRecordById("users", recipientId);
  const fcmToken = user.get("fcm_token");
  if (!fcmToken) return; // User has no token (notifications disabled or not registered)
  
  // 2. Check user's notification preferences
  const prefs = user.get("notification_preferences") || {};
  if (prefs[data.type] === false) return; // User opted out of this notification type
  
  // 3. Create in-app notification record
  const notifCollection = app.findCollectionByNameOrId("notifications");
  const notif = new Record(notifCollection);
  notif.set("user", recipientId);
  notif.set("title", title);
  notif.set("body", body);
  notif.set("type", data.type);
  notif.set("data", JSON.stringify(data));
  notif.set("is_read", false);
  app.save(notif);
  
  // 4. Send FCM push via HTTP v1 API
  $http.send({
    url: "https://fcm.googleapis.com/v1/projects/YOUR_PROJECT_ID/messages:send",
    method: "POST",
    headers: {
      "Authorization": "Bearer " + getAccessToken(app),
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      message: {
        token: fcmToken,
        notification: { title, body },
        data: data,
        android: { priority: "high" }
      }
    })
  });
}
```

**Notification Triggers:**

```javascript
// 1. New Message â†’ notify recipient
onRecordAfterCreateSuccess("messages", (e) => {
  const msg = e.record;
  if (msg.get("type") === "text" || msg.get("type") === "image") {
    const chat = e.app.findRecordById("chats", msg.get("chat"));
    const recipientId = msg.get("sender") === chat.get("buyer") 
      ? chat.get("seller") : chat.get("buyer");
    const sender = e.app.findRecordById("users", msg.get("sender"));
    
    sendPushNotification(e.app, recipientId,
      sender.get("name"),
      msg.get("type") === "image" ? "ğŸ“· Sent a photo" : msg.get("content").substring(0, 100),
      { type: "new_message", chatId: chat.id }
    );
  }
});

// 2. New Offer â†’ notify seller
onRecordAfterCreateSuccess("messages", (e) => {
  const msg = e.record;
  if (msg.get("type") === "offer") {
    const chat = e.app.findRecordById("chats", msg.get("chat"));
    const book = e.app.findRecordById("books", chat.get("book"));
    
    sendPushNotification(e.app, chat.get("seller"),
      "ğŸ’° New Offer!",
      `â‚¹${msg.get("offer_amount")} offered for "${book.get("title")}"`,
      { type: "new_offer", chatId: chat.id }
    );
  }
});

// 3. Transaction status changes â†’ notify relevant party
onRecordAfterUpdateSuccess("transactions", (e) => {
  const txn = e.record;
  const oldStatus = e.record.original.get("status");
  const newStatus = txn.get("status");
  
  if (oldStatus === newStatus) return;
  
  const book = e.app.findRecordById("books", txn.get("book"));
  
  switch (newStatus) {
    case "handover_pending":
      sendPushNotification(e.app, txn.get("buyer"),
        "ğŸ“± QR Ready!",
        `Scan the seller's QR to complete handover for "${book.get("title")}"`,
        { type: "handover_ready", txnId: txn.id }
      );
      break;
    case "completed":
      sendPushNotification(e.app, txn.get("seller"),
        "âœ… Handover Complete!",
        `"${book.get("title")}" has been handed over successfully`,
        { type: "transaction_complete", txnId: txn.id }
      );
      break;
  }
});

// 4. New Review â†’ notify seller
onRecordAfterCreateSuccess("reviews", (e) => {
  const review = e.record;
  const reviewer = e.app.findRecordById("users", review.get("reviewer"));
  
  sendPushNotification(e.app, review.get("reviewed_user"),
    "â­ New Review!",
    `${reviewer.get("name")} gave you ${review.get("rating")} stars`,
    { type: "new_review", userId: review.get("reviewed_user") }
  );
});

// 5. Price Drop on wishlisted book â†’ notify wishlisters
onRecordAfterUpdateSuccess("books", (e) => {
  const book = e.record;
  const oldPrice = e.record.original.get("selling_price");
  const newPrice = book.get("selling_price");
  
  if (newPrice < oldPrice) {
    // Find all users who wishlisted this book
    const wishlists = e.app.findRecordsByFilter(
      "wishlists", `book = "${book.id}"`
    );
    for (const wl of wishlists) {
      sendPushNotification(e.app, wl.get("user"),
        "ğŸ“‰ Price Drop!",
        `"${book.get("title")}" dropped from â‚¹${oldPrice} to â‚¹${newPrice}`,
        { type: "price_drop", bookId: book.id }
      );
    }
  }
});
```

---

### PART C: In-App Notification Center

ğŸ“ CREATE: `lib/screens/notifications/notification_center_screen.dart`

| Element | Details |
|---------|---------|
| **Access** | Bell icon ğŸ”” in Home Screen app bar. Badge shows unread count |
| **Data Source** | `pb.collection('notifications').getList(filter: 'user = "${userId}"', sort: '-created', perPage: 30)` |
| **Layout** | List of notification cards |
| **Each Card** | Icon (by type) + title + body + relative time + unread dot |
| **Tap** | Mark as read + navigate based on `data.type` (same routing as push tap) |
| **Mark All Read** | "Mark all as read" button in app bar |
| **Pull to Refresh** | Refreshes notification list |
| **Empty** | *"All caught up! ğŸ‰ No new notifications."* |

**Notification Icons by Type:**

| Type | Icon | Color |
|------|------|-------|
| `new_message` | ğŸ’¬ | Blue |
| `new_offer` | ğŸ’° | Green |
| `offer_accepted` | âœ… | Green |
| `offer_declined` | âŒ | Red |
| `handover_ready` | ğŸ“± | Orange |
| `transaction_complete` | ğŸ‰ | Purple |
| `new_review` | â­ | Gold |
| `price_drop` | ğŸ“‰ | Green |
| `badge_earned` | ğŸ† | Gold |

---

### PART D: Notification Preferences

ğŸ“ MODIFY: Settings screen (Prompt 16)

Add a "Notification Settings" sub-screen:

| Toggle | Default | Description |
|--------|---------|-------------|
| **Messages** | ON | New chat messages |
| **Offers** | ON | New price offers |
| **Transactions** | ON | Transaction status updates |
| **Price Drops** | ON | Wishlisted book price changes |
| **Reviews** | ON | New reviews received |
| **Promotions** | OFF | App tips and announcements |

Store preferences in user record: `notification_preferences` (JSON field).

---

### PART E: Unread Badge Count

ğŸ“ CREATE: `lib/providers/notification_provider.dart`

| Feature | Details |
|---------|---------|
| **Global Count** | Count of unread notifications â€” shown on bell icon badge in app bar |
| **Chat Count** | Count of unread chats â€” shown on Chat tab badge |
| **Real-Time** | Subscribe to `notifications` collection for live updates: `pb.collection('notifications').subscribe('*', callback)` |
| **Clear on View** | When user opens notification center â†’ all visible notifications marked as read |

---

ğŸ“¦ USE:
- `firebase_core` + `firebase_messaging` â€” FCM setup
- `flutter_local_notifications` â€” foreground notification display
- `pocketbase` SDK â€” notification records, user FCM token
- `provider` â€” unread count state
- PocketBase hooks for all push triggers

â›” DO NOT:
- Do NOT send push notifications from the Flutter app â€” all pushes sent from PocketBase hooks
- Do NOT send notifications to the sender themselves (e.g., don't notify user about their own message)
- Do NOT send push if user has opted out of that notification type
- Do NOT send push if user has no FCM token
- Do NOT forget to handle notification tap routing for all types
- Do NOT forget Android 13+ notification permission request
- Do NOT poll for notifications â€” use SSE subscription for real-time count

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”§ EXECUTE:

**Step 1:** Add `firebase_core`, `firebase_messaging`, `flutter_local_notifications` to pubspec
**Step 2:** Create `lib/services/notification_service.dart` with FCM init, token save, foreground/background handlers
**Step 3:** Create `pb_hooks/notification_hooks.pb.js` with all 5 notification triggers
**Step 4:** Create `lib/screens/notifications/notification_center_screen.dart`
**Step 5:** Create `lib/providers/notification_provider.dart` with SSE subscription
**Step 6:** Add notification preferences sub-screen to Settings
**Step 7:** Wire up bell icon badge in Home app bar
**Step 8:** Deploy hooks via `./deploy.sh`
**Step 9:** Run `flutter analyze` â€” 0 issues
**Step 10:** Test: send message â†’ push appears, tap â†’ navigates to chat, mark all read works

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ… SELF-CHECK:
1. Firebase initializes without errors
2. FCM token saved to user record on login
3. Token refresh updates the record
4. Push notification shows when app is in foreground (local notification)
5. Push notification shows when app is in background
6. Tapping notification navigates to correct screen for each type
7. In-app notification center lists all notifications
8. Unread dot shows on unread notifications
9. Badge count on bell icon is accurate
10. "Mark all as read" clears all unread dots + resets badge count
11. Notification preferences toggles work â€” opted-out types don't send pushes
12. Price drop notification sent to all wishlisters
13. No notification sent to the sender themselves
14. `flutter analyze` returns 0 issues

ğŸ‘¤ USER MANUAL STEPS:
1. **Create Firebase project** at [console.firebase.google.com](https://console.firebase.google.com)
2. **Add Android app** with package name `com.jayganga.books` â†’ download `google-services.json` â†’ place in `android/app/`
3. **Enable Cloud Messaging API (V1)** in Google Cloud Console
4. **Generate service account key** for FCM HTTP v1 API â†’ store securely on VPS for PocketBase hooks
5. **Replace `YOUR_PROJECT_ID`** in notification hooks with actual Firebase project ID

ğŸ’¬ CONFIRM IN CHAT:
"Prompt 17 complete. Notification System with FCM push (5 trigger types), in-app notification center, notification preferences (6 toggles), unread badge counts with SSE real-time, PocketBase hooks for all triggers. flutter analyze: 0 issues. Zero errors."

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â­ï¸ NEXT: Prompt 18 â€” Referral System + Deep Links
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ PROMPT 18 of 70
Phase: Growth & Engagement (PHASE_13)
Task: Referral System + Deep Links (App Links + In-App Routing)
Type: ğŸ“± FRONTEND + ğŸ”§ BACKEND (PocketBase Hooks)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ INSTRUCTION:
Build the **Referral System** (unique codes, share links, rewards tracking) and **Deep Link** infrastructure (Android App Links, in-app deep link routing for books, sellers, and referral codes).

> **Domain:** `api.jayganga.com` for all deep links.

---

### PART A: Referral Code Generation

ğŸ“ ADD TO: `pb_hooks/referral_hooks.pb.js`

| Feature | Details |
|---------|---------|
| **Auto-Generate** | When a new user record is created (after onboarding), generate a unique 6-character alphanumeric referral code |
| **Format** | Uppercase: e.g., `JAY7K2`, `GNG9X4` |
| **Uniqueness** | Check against existing codes. Regenerate if collision. |
| **Store** | Save to `users.referral_code` field |

```javascript
onRecordAfterCreateSuccess("users", (e) => {
  const user = e.record;
  if (!user.get("referral_code")) {
    let code;
    let exists = true;
    while (exists) {
      code = $security.randomString(6).toUpperCase();
      try {
        e.app.findFirstRecordByFilter("users", `referral_code = "${code}"`);
      } catch {
        exists = false; // No collision
      }
    }
    user.set("referral_code", code);
    e.app.save(user);
  }
});
```

---

### PART B: Referral Share Flow

ğŸ“ CREATE: `lib/screens/profile/referral_screen.dart`

Accessible from Profile â†’ "Referrals" menu row.

| Element | Details |
|---------|---------|
| **Header** | *"Invite friends & earn rewards!"* with illustration |
| **Your Code** | Large display of user's referral code with "Copy" button |
| **Share Link** | `https://api.jayganga.com/ref/{CODE}` â€” "Share" button opens share sheet |
| **How It Works** | 3-step explainer: 1. Share your link â†’ 2. Friend signs up â†’ 3. Both of you earn a badge |

**Share Message:**
```
Hey! I'm using JayGanga Books to buy & sell used books near me. Join using my link and we both get rewards! ğŸ“š

https://api.jayganga.com/ref/{CODE}
```

**Stats Section:**

| Stat | Details |
|------|---------|
| **Total Referrals** | Count of users who signed up with your code |
| **Successful** | Count of referred users who completed at least 1 transaction |
| **Referral List** | List of referred users: avatar + name + join date + status (Joined / Active) |

---

### PART C: Referral Redemption (Backend)

ğŸ“ ADD TO: `pb_hooks/referral_hooks.pb.js`

When a new user signs up with a referral code (passed during onboarding):

```javascript
// After onboarding updates the user with referred_by code
onRecordAfterUpdateSuccess("users", (e) => {
  const user = e.record;
  const refCode = user.get("referred_by_code");
  
  if (refCode && !user.original.get("referred_by_code")) {
    // First time setting referral code
    try {
      const referrer = e.app.findFirstRecordByFilter("users", `referral_code = "${refCode}"`);
      
      // Don't allow self-referral
      if (referrer.id === user.id) return;
      
      // Set the relation
      user.set("referred_by", referrer.id);
      e.app.save(user);
      
      // Create referral record
      const refCollection = e.app.findCollectionByNameOrId("referrals");
      const ref = new Record(refCollection);
      ref.set("referrer", referrer.id);
      ref.set("referred_user", user.id);
      ref.set("code_used", refCode);
      ref.set("status", "joined");
      e.app.save(ref);
      
      // Award badge to referrer (if first referral)
      const existingRefs = e.app.findRecordsByFilter("referrals", `referrer = "${referrer.id}"`);
      if (existingRefs.length === 1) {
        // First referral â€” award "Connector" badge
        const badgeCollection = e.app.findCollectionByNameOrId("badges");
        const badge = new Record(badgeCollection);
        badge.set("user", referrer.id);
        badge.set("type", "connector");
        badge.set("title", "Connector");
        badge.set("description", "Referred your first friend!");
        e.app.save(badge);
      }
      
      // Notify referrer
      sendPushNotification(e.app, referrer.id,
        "ğŸ‘¥ New Referral!",
        `${user.get("name")} joined using your referral code!`,
        { type: "referral", userId: user.id }
      );
      
    } catch (err) {
      // Invalid referral code â€” silently ignore
    }
  }
});
```

---

### PART D: Deep Link Setup (Android App Links)

ğŸ“ MODIFY: `android/app/src/main/AndroidManifest.xml`

```xml
<intent-filter android:autoVerify="true">
  <action android:name="android.intent.action.VIEW" />
  <category android:name="android.intent.category.DEFAULT" />
  <category android:name="android.intent.category.BROWSABLE" />
  <data android:scheme="https" android:host="api.jayganga.com" />
</intent-filter>
```

ğŸ“ CREATE: Server-side `assetlinks.json` (for App Links verification)

File must be hosted at: `https://api.jayganga.com/.well-known/assetlinks.json`

```json
[{
  "relation": ["delegate_permission/common.handle_all_urls"],
  "target": {
    "namespace": "android_app",
    "package_name": "com.jayganga.books",
    "sha256_cert_fingerprints": ["YOUR_SHA256_FINGERPRINT"]
  }
}]
```

---

### PART E: Deep Link Routing in Flutter

ğŸ“ CREATE: `lib/services/deep_link_service.dart`

| URL Pattern | Route To | Details |
|-------------|----------|---------|
| `api.jayganga.com/book/{id}` | `/book/:id` | Opens book detail screen |
| `api.jayganga.com/seller/{id}` | `/seller/:id` | Opens seller profile |
| `api.jayganga.com/ref/{code}` | Splash â†’ Onboarding | Stores code, applies during sign-up |
| `api.jayganga.com/txn/{id}` | `/transaction/:id` | Opens transaction detail (auth required) |

**Deep Link Handling Flow:**

```dart
// In app initialization
void handleDeepLink(Uri uri) {
  final path = uri.pathSegments;
  
  if (path.first == 'ref' && path.length == 2) {
    // Store referral code locally (Hive)
    ReferralService.saveReferralCode(path[1]);
    // If not logged in â†’ after sign-up, apply the code
    // If already logged in â†’ ignore (can't self-refer)
    return;
  }
  
  if (path.first == 'book' && path.length == 2) {
    router.go('/book/${path[1]}');
    return;
  }
  
  if (path.first == 'seller' && path.length == 2) {
    router.go('/seller/${path[1]}');
    return;
  }
  
  if (path.first == 'txn' && path.length == 2) {
    // Requires auth â€” redirect to login if not authenticated
    router.go('/transaction/${path[1]}');
    return;
  }
}
```

**GoRouter Integration:**
- Register deep link routes in GoRouter (already set up in Prompt 8)
- Handle initial deep link on app cold start
- Handle deep links when app is already running (resumed from background)

---

### PART F: Share Book Deep Link

ğŸ“ MODIFY: Book Detail Screen (Prompt 10)

When user taps "Share" on a book:
```dart
final link = 'https://api.jayganga.com/book/${book.id}';
Share.share('Check out "${book.title}" on JayGanga Books! ğŸ“š\n$link');
```

When user taps "Share" on seller profile:
```dart
final link = 'https://api.jayganga.com/seller/${seller.id}';
Share.share('Check out ${seller.name}\'s books on JayGanga Books! ğŸ“š\n$link');
```

---

ğŸ“¦ USE:
- `app_links` â€” handle incoming deep links (Android App Links)
- `share_plus` â€” share referral link, book link, seller link
- `hive_flutter` â€” store pending referral code until sign-up
- `pocketbase` SDK â€” referral records, user updates
- PocketBase hooks for referral code gen + redemption + badge award

â›” DO NOT:
- Do NOT allow self-referral â€” check `referrer.id !== user.id`
- Do NOT apply referral code if user is already signed up â€” only on first sign-up
- Do NOT crash if deep link points to a deleted book/seller â€” show "Not found" gracefully
- Do NOT forget to handle cold start deep links (app not running)
- Do NOT forget to handle warm start deep links (app in background)
- Do NOT hardcode the deep link domain â€” use a constant: `const kDeepLinkDomain = 'api.jayganga.com'`

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”§ EXECUTE:

**Step 1:** Create `pb_hooks/referral_hooks.pb.js` with code generation + redemption
**Step 2:** Create `lib/screens/profile/referral_screen.dart` with share, stats, referral list
**Step 3:** Modify `AndroidManifest.xml` for App Links intent filter
**Step 4:** Create `lib/services/deep_link_service.dart` with URL pattern routing
**Step 5:** Integrate deep link handling with GoRouter
**Step 6:** Wire share buttons on Book Detail and Seller Profile
**Step 7:** Deploy hooks via `./deploy.sh`
**Step 8:** Run `flutter analyze` â€” 0 issues
**Step 9:** Test: share link â†’ open on another device â†’ correct screen opens

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ… SELF-CHECK:
1. New users auto-get a unique 6-char referral code
2. Referral code is displayed prominently on referral screen
3. "Share" copies the full link to clipboard / opens share sheet
4. Deep link `api.jayganga.com/ref/{code}` stores code for sign-up
5. Referral code applied during onboarding creates referral record
6. Self-referral is blocked
7. Referrer gets push notification on successful referral
8. "Connector" badge awarded on first referral
9. Referral dashboard shows total referrals, successful, and user list
10. Deep link `api.jayganga.com/book/{id}` opens correct book
11. Deep link `api.jayganga.com/seller/{id}` opens correct seller
12. Deep links work on cold start and warm start
13. Graceful "Not found" for deleted books/sellers via deep link
14. `flutter analyze` returns 0 issues

ğŸ‘¤ USER MANUAL STEPS:
1. **Host `assetlinks.json`** at `https://api.jayganga.com/.well-known/assetlinks.json`
2. **Get SHA-256 fingerprint** from your release signing key: `keytool -list -v -keystore your-keystore.jks`
3. **Replace `YOUR_SHA256_FINGERPRINT`** in `assetlinks.json` with the actual value
4. **Verify App Links work** by running: `adb shell am start -a android.intent.action.VIEW -d "https://api.jayganga.com/book/test"`

ğŸ’¬ CONFIRM IN CHAT:
"Prompt 18 complete. Referral System with auto-generated 6-char codes, share flow, referral redemption hook, Connector badge, referral dashboard. Deep Links with Android App Links for book/seller/referral/transaction URLs. flutter analyze: 0 issues. Zero errors."

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â­ï¸ NEXT: Prompt 19 â€” Report & Moderation System
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ PROMPT 19 of 70
Phase: Safety & Moderation (PHASE_14)
Task: Report Flows + Auto-Moderation Hooks + Ban System + Admin Review
Type: ğŸ“± FRONTEND + ğŸ”§ BACKEND (PocketBase Hooks)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ INSTRUCTION:
Build the **Report & Moderation System** â€” report sheets for books/users/chat messages, auto-moderation hooks that auto-hide content after threshold, admin review queue, ban/unban system, and appeal flow.

> **Auth Required:** Reporting requires login. Auto-moderation runs server-side.

---

### PART A: Report Bottom Sheet (Reusable)

ğŸ“ CREATE: `lib/widgets/shared/report_sheet.dart`

A single reusable bottom sheet used for reporting books, users, and chat messages.

| Element | Details |
|---------|---------|
| **Title** | *"Report {type}"* â€” e.g., "Report Book", "Report User", "Report Message" |
| **Reason** | Required. Radio list of reasons (different per type) |
| **Details** | Optional textarea (max 500 chars): *"Tell us more about the issue..."* |
| **Evidence** | Optional photo upload (1 photo max) â€” e.g., screenshot |
| **Submit** | "Submit Report" button â†’ creates `reports` record |
| **Confirmation** | *"Thank you for reporting. We'll review this within 24 hours."* |
| **Duplicate Guard** | Check if user already reported this target â†’ show *"You've already reported this."* instead |

**Report Reasons by Type:**

| Type | Reasons |
|------|---------|
| **Book** | Inappropriate content Â· Spam/fake listing Â· Wrong category Â· Misleading photos Â· Overpriced Â· Scam |
| **User** | Harassment Â· Scam/fraud Â· Fake profile Â· Inappropriate behavior Â· Spam messaging |
| **Message** | Harassment Â· Spam Â· Inappropriate content Â· Threats Â· Scam attempt |
| **Transaction** | Book not as described Â· No-show Â· Wrong book delivered Â· Scam |

---

### PART B: Report Trigger Points

Where the report sheet is accessible from:

| Screen | Trigger | Report Type |
|--------|---------|-------------|
| Book Detail | â‹® overflow â†’ "Report Listing" | `book` |
| Seller Profile | â‹® overflow â†’ "Report User" | `user` |
| Chat Detail | â‹® overflow â†’ "Report User" | `user` |
| Chat Message | Long-press bubble â†’ "Report Message" | `message` |
| Transaction Detail | "Report Problem" button | `transaction` |

---

### PART C: Reports Collection Record

When a report is submitted, create:

```dart
pb.collection('reports').create(body: {
  'reporter': currentUser.id,
  'target_type': 'book' | 'user' | 'message' | 'transaction',
  'target_id': targetId,
  'reason': selectedReason,
  'details': detailsText,
  'evidence': evidenceFile,  // optional
  'status': 'pending',       // pending â†’ reviewed â†’ resolved â†’ dismissed
});
```

---

### PART D: Auto-Moderation Hooks

ğŸ“ CREATE: `pb_hooks/moderation_hooks.pb.js`

**Auto-Hide (Book):**
```javascript
// After a report is created, check report count for the target
onRecordAfterCreateSuccess("reports", (e) => {
  const report = e.record;
  
  if (report.get("target_type") === "book") {
    const bookId = report.get("target_id");
    const reportCount = e.app.findRecordsByFilter(
      "reports",
      `target_type = "book" && target_id = "${bookId}" && status != "dismissed"`
    ).length;
    
    // Auto-hide after 3 reports
    if (reportCount >= 3) {
      const book = e.app.findRecordById("books", bookId);
      book.set("status", "hidden");
      book.set("hidden_reason", "auto_moderation");
      e.app.save(book);
      
      // Notify seller
      sendPushNotification(e.app, book.get("seller"),
        "âš ï¸ Listing Hidden",
        `Your listing "${book.get("title")}" has been temporarily hidden due to reports. Our team will review it.`,
        { type: "listing_hidden", bookId: bookId }
      );
    }
  }
  
  // Auto-restrict user after 5 reports across any content
  if (report.get("target_type") === "user") {
    const userId = report.get("target_id");
    const reportCount = e.app.findRecordsByFilter(
      "reports",
      `target_type = "user" && target_id = "${userId}" && status != "dismissed"`
    ).length;
    
    if (reportCount >= 5) {
      const user = e.app.findRecordById("users", userId);
      user.set("is_restricted", true);
      user.set("restricted_reason", "Multiple reports received");
      e.app.save(user);
      
      // Restricted users can't create new listings or send messages
      sendPushNotification(e.app, userId,
        "âš ï¸ Account Restricted",
        "Your account has been temporarily restricted due to multiple reports. Contact support to appeal.",
        { type: "account_restricted" }
      );
    }
  }
});
```

---

### PART E: Ban System

ğŸ“ ADD TO: `pb_hooks/moderation_hooks.pb.js`

**Ban Hook (admin action via PocketBase Admin UI):**
```javascript
// When admin sets is_banned = true on a user
onRecordAfterUpdateSuccess("users", (e) => {
  const user = e.record;
  const wasBanned = user.original.get("is_banned");
  const isBanned = user.get("is_banned");
  
  if (!wasBanned && isBanned) {
    // User was just banned
    // 1. Hide all their active listings
    const books = e.app.findRecordsByFilter("books", `seller = "${user.id}" && status = "active"`);
    for (const book of books) {
      book.set("status", "hidden");
      book.set("hidden_reason", "user_banned");
      e.app.save(book);
    }
    
    // 2. Notify the banned user
    sendPushNotification(e.app, user.id,
      "ğŸš« Account Banned",
      "Your account has been banned for violating our community guidelines.",
      { type: "account_banned" }
    );
  }
  
  if (wasBanned && !isBanned) {
    // User was unbanned â€” restore their listings
    const books = e.app.findRecordsByFilter("books", `seller = "${user.id}" && hidden_reason = "user_banned"`);
    for (const book of books) {
      book.set("status", "active");
      book.set("hidden_reason", "");
      e.app.save(book);
    }
  }
});
```

**Banned User Experience (Flutter):**
- On app launch, splash screen checks `is_banned` â†’ if true â†’ redirect to `/banned`
- `/banned` screen shows: *"Your account has been banned for violating our community guidelines."* + "Appeal" button + "Logout" button
- "Appeal" button opens email client: `mailto:support@jayganga.com?subject=Ban Appeal - {userId}`

---

### PART F: Restricted User UI

ğŸ“ CREATE: `lib/widgets/shared/restricted_banner.dart`

When `is_restricted == true`:
- Show a persistent banner at top of Home, Profile: *"âš ï¸ Your account is restricted. Some features are disabled."*
- Disabled features: can't create new listings, can't send messages, can't make offers
- Tap banner â†’ bottom sheet explaining restriction + "Contact Support" button

---

### PART G: Admin Review (Info for Admin)

> Admin moderates via **PocketBase Admin UI** â€” no separate admin panel needed.

**Admin Workflow:**
1. View `reports` collection filtered by `status = "pending"`
2. Review the `target_type`, `target_id`, `reason`, `details`, `evidence`
3. Set `status` to:
   - `"reviewed"` â€” currently being looked at
   - `"resolved"` â€” action taken (ban user, hide book, etc.)
   - `"dismissed"` â€” false report, no action needed
4. If action needed: update the target record directly (set `is_banned`, `status: "hidden"`, etc.)

---

ğŸ“¦ USE:
- `pocketbase` SDK â€” create reports, check duplicate reports
- `image_picker` â€” evidence photo upload
- `url_launcher` â€” email for ban appeal
- PocketBase hooks for auto-moderation, ban cascading

â›” DO NOT:
- Do NOT allow users to report their own content
- Do NOT allow duplicate reports (same reporter + same target)
- Do NOT auto-ban users â€” only auto-restrict. Banning is admin-only
- Do NOT show reporter identity to the reported user â€” reports are anonymous
- Do NOT hard-delete reported content â€” only hide/restrict
- Do NOT forget to check `is_banned` and `is_restricted` on app startup
- Do NOT allow restricted users to create listings or send messages

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”§ EXECUTE:

**Step 1:** Create `lib/widgets/shared/report_sheet.dart` (reusable for all report types)
**Step 2:** Wire report triggers into Book Detail, Seller Profile, Chat screens
**Step 3:** Create `pb_hooks/moderation_hooks.pb.js` with auto-hide + auto-restrict + ban cascade
**Step 4:** Create `lib/widgets/shared/restricted_banner.dart`
**Step 5:** Update splash screen to check `is_banned` status
**Step 6:** Deploy hooks via `./deploy.sh`
**Step 7:** Run `flutter analyze` â€” 0 issues
**Step 8:** Test: report book 3x â†’ auto-hidden, report user 5x â†’ auto-restricted, admin ban â†’ listings hidden

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ… SELF-CHECK:
1. Report sheet opens with correct reasons for each type (book/user/message/transaction)
2. Duplicate report blocked â€” shows "already reported" message
3. Report creates record with correct target_type and target_id
4. Auto-hide triggers after 3 reports on same book
5. Auto-restrict triggers after 5 reports on same user
6. Seller notified when listing is auto-hidden
7. User notified when account is restricted
8. Restricted banner shows with disabled features
9. Admin ban hides all user's listings
10. Admin unban restores listings
11. Banned user sees `/banned` screen on app launch
12. Appeal button opens email client
13. Self-reporting blocked
14. `flutter analyze` returns 0 issues

ğŸ‘¤ USER MANUAL STEPS:
- None â€” admin moderation done via PocketBase Admin UI at `https://api.jayganga.com/_/`

ğŸ’¬ CONFIRM IN CHAT:
"Prompt 19 complete. Report & Moderation System with reusable report sheet (4 types), auto-hide after 3 reports, auto-restrict after 5, admin ban with cascade (hide all listings), restricted user banner, ban appeal via email. flutter analyze: 0 issues. Zero errors."

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â­ï¸ NEXT: Prompt 20 â€” App Config + Force Update + Maintenance Mode
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ PROMPT 20 of 70
Phase: App Infrastructure (PHASE_15)
Task: Remote App Config + Force Update Gate + Maintenance Mode Screen
Type: ğŸ“± FRONTEND + ğŸ”§ BACKEND (PocketBase Migration)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ INSTRUCTION:
Build **Remote App Configuration** using a PocketBase `app_config` singleton collection, **Force Update** gate that blocks the app when a new version is required, and **Maintenance Mode** screen that blocks all access during server updates.

> These checks run on splash screen before any other navigation.

---

### PART A: App Config Collection (Backend)

ğŸ“ CREATE: `pb_migrations/app_config_collection.js`

Create a **singleton** collection (single record, always ID = 1):

| Field | Type | Default | Description |
|-------|------|---------|-------------|
| `min_app_version` | text | `"1.0.0"` | Minimum app version allowed. Older versions â†’ force update |
| `latest_app_version` | text | `"1.0.0"` | Latest available version. For optional update prompt |
| `maintenance_mode` | bool | `false` | If true â†’ show maintenance screen |
| `maintenance_message` | text | `""` | Custom maintenance message |
| `maintenance_eta` | text | `""` | Estimated time of completion: e.g., "30 minutes" |
| `play_store_url` | text | `""` | Google Play Store listing URL |
| `terms_url` | text | `"https://api.jayganga.com/terms"` | Terms & Conditions URL |
| `privacy_url` | text | `"https://api.jayganga.com/privacy"` | Privacy Policy URL |
| `support_email` | text | `"support@jayganga.com"` | Support email |
| `announcement` | text | `""` | Global announcement banner (empty = hidden) |
| `announcement_type` | select | `"info"` | info / warning / critical â€” controls banner color |

**API Rules:**
- List/View: public (no auth needed â€” app must read config before login)
- Create/Update/Delete: superuser only

---

### PART B: App Config Service (Flutter)

ğŸ“ CREATE: `lib/services/app_config_service.dart`

```dart
class AppConfigService {
  static AppConfig? _cached;
  
  /// Fetch config from PocketBase (called on splash)
  static Future<AppConfig> fetch() async {
    final records = await pb.collection('app_config').getFullList();
    if (records.isEmpty) return AppConfig.defaults();
    _cached = AppConfig.fromRecord(records.first);
    return _cached!;
  }
  
  static AppConfig get current => _cached ?? AppConfig.defaults();
}

class AppConfig {
  final String minAppVersion;
  final String latestAppVersion;
  final bool maintenanceMode;
  final String maintenanceMessage;
  final String maintenanceEta;
  final String playStoreUrl;
  final String termsUrl;
  final String privacyUrl;
  final String supportEmail;
  final String announcement;
  final String announcementType;
  
  // ... constructor, fromRecord, defaults
}
```

---

### PART C: Force Update Screen

ğŸ“ CREATE: `lib/screens/gates/force_update_screen.dart`

| Element | Details |
|---------|---------|
| **Route** | `/force-update` |
| **When** | App version < `min_app_version` from config |
| **Layout** | Full screen, centered, no back button |
| **Icon** | Large update icon or illustration |
| **Title** | *"Update Required"* |
| **Message** | *"A new version of JayGanga Books is available. Please update to continue using the app."* |
| **Current Version** | *"Your version: v1.0.0"* |
| **Required Version** | *"Required: v{minAppVersion}+"* |
| **Update Button** | "Update Now" â†’ opens Play Store URL (`url_launcher`) |
| **No Dismiss** | Cannot close or go back â€” app is blocked until updated |

**Version Comparison Logic:**
```dart
bool isForceUpdateRequired(String currentVersion, String minVersion) {
  final current = currentVersion.split('.').map(int.parse).toList();
  final minimum = minVersion.split('.').map(int.parse).toList();
  
  for (int i = 0; i < 3; i++) {
    if (current[i] < minimum[i]) return true;
    if (current[i] > minimum[i]) return false;
  }
  return false; // Equal versions â€” no update needed
}
```

---

### PART D: Optional Update Prompt

When app version < `latest_app_version` but >= `min_app_version`:
- Show a **dismissible** bottom sheet on Home Screen (once per session):
  *"A new version is available! Update for the latest features."*
  - "Update" â†’ opens Play Store
  - "Later" â†’ dismiss, don't show again this session

---

### PART E: Maintenance Mode Screen

ğŸ“ CREATE: `lib/screens/gates/maintenance_screen.dart`

| Element | Details |
|---------|---------|
| **Route** | `/maintenance` |
| **When** | `maintenance_mode == true` in app config |
| **Layout** | Full screen, centered, no navigation |
| **Icon** | ğŸ”§ wrench/tools illustration |
| **Title** | *"Under Maintenance"* |
| **Message** | Custom `maintenance_message` or default: *"We're performing scheduled maintenance. We'll be back soon!"* |
| **ETA** | If `maintenance_eta` is set: *"Estimated time: {eta}"* |
| **Retry** | "Try Again" button â†’ re-fetches app config. If maintenance over â†’ proceed to app |
| **Auto-Retry** | Auto-retry every 60 seconds with a subtle countdown timer |

---

### PART F: Splash Screen Integration

ğŸ“ MODIFY: Splash Screen (Prompt 8)

Update the splash screen to run checks **in this order**:

```
1. Fetch app_config from PocketBase
   â†“ (if fetch fails â†’ proceed with defaults, assume no maintenance/update)
2. Check maintenance_mode
   â†“ if true â†’ /maintenance
3. Check force update (compare app version vs min_app_version)
   â†“ if needed â†’ /force-update
4. Check auth state
   â†“ if logged in â†’ check is_banned â†’ /banned or check onboarding
   â†“ if guest â†’ /home (guest browsing)
5. Navigate to appropriate screen
```

---

### PART G: Global Announcement Banner

ğŸ“ CREATE: `lib/widgets/shared/announcement_banner.dart`

| Element | Details |
|---------|---------|
| **When** | `announcement` field is non-empty in app config |
| **Where** | Top of Home Screen, below app bar |
| **Colors** | Info (blue), Warning (orange), Critical (red) â€” based on `announcement_type` |
| **Content** | Text from `announcement` field. Scrollable if long |
| **Dismiss** | "X" close button. Once dismissed, don't show again until new announcement |
| **Example** | *"ğŸ“¢ New feature: You can now sell book bundles! Try it out."* |

---

ğŸ“¦ USE:
- `pocketbase` SDK â€” fetch app_config collection
- `package_info_plus` â€” get current app version
- `url_launcher` â€” open Play Store link
- `hive_flutter` â€” cache config locally for offline fallback
- `provider` â€” app config state

â›” DO NOT:
- Do NOT skip the force update check â€” it's critical for app integrity
- Do NOT allow any navigation past maintenance screen when maintenance is active
- Do NOT crash if app_config fetch fails â€” use sensible defaults
- Do NOT hardcode version numbers in the app â€” always compare against server config
- Do NOT forget the auto-retry on maintenance screen (60s interval)
- Do NOT show force update on first install (version will match)
- Do NOT cache maintenance_mode forever â€” always re-fetch on app launch

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”§ EXECUTE:

**Step 1:** Create `pb_migrations/app_config_collection.js` with all fields
**Step 2:** Create `lib/services/app_config_service.dart`
**Step 3:** Create `lib/screens/gates/force_update_screen.dart`
**Step 4:** Create `lib/screens/gates/maintenance_screen.dart`
**Step 5:** Create `lib/widgets/shared/announcement_banner.dart`
**Step 6:** Modify splash screen to integrate all gate checks in correct order
**Step 7:** Deploy migration via `./deploy.sh`
**Step 8:** Run `flutter analyze` â€” 0 issues
**Step 9:** Test: set maintenance_mode = true â†’ app shows maintenance. Set min_app_version higher â†’ force update shows

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ… SELF-CHECK:
1. App config record created with all 11 fields
2. Config fetched on splash screen before any navigation
3. Maintenance mode blocks app with custom message + ETA + auto-retry (60s)
4. Force update blocks app with version comparison + Play Store link
5. Optional update shows dismissible bottom sheet (once per session)
6. Splash check order: config â†’ maintenance â†’ force update â†’ auth â†’ navigate
7. Announcement banner shows/hides based on config
8. Config fetch failure gracefully falls back to defaults
9. Retry on maintenance screen re-fetches config and proceeds if cleared
10. Version comparison handles all edge cases (1.0.0 < 1.0.1, 1.9.9 < 2.0.0)
11. `flutter analyze` returns 0 issues

ğŸ‘¤ USER MANUAL STEPS:
1. After deployment, open PocketBase Admin UI â†’ create one record in `app_config` collection
2. Set `play_store_url` to your actual Play Store listing URL when published
3. To trigger maintenance: set `maintenance_mode = true`, add `maintenance_message` and `maintenance_eta`
4. To force update: increase `min_app_version` to the version users must have

ğŸ’¬ CONFIRM IN CHAT:
"Prompt 20 complete. App Config singleton collection (11 fields), force update gate with version comparison, maintenance mode with auto-retry, optional update prompt, global announcement banner. Splash screen checks in order: config â†’ maintenance â†’ force update â†’ auth. flutter analyze: 0 issues. Zero errors."

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â­ï¸ NEXT: Prompt 21 â€” Location Service + Distance-Based Book Filtering
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ PROMPT 21 of 70
Phase: Location & Proximity (PHASE_16)
Task: Location Service + Haversine Distance + Distance-Based Filtering/Sorting
Type: ğŸ“± FRONTEND (Flutter)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ INSTRUCTION:
Build the **Location Service** â€” GPS permission handling, lat/lng detection, Haversine distance calculation, distance-based book filtering/sorting, distance display on book cards, and location caching.

> **Important:** All distance computation is done **client-side** using Dart. PocketBase stores lat/lng per book; Flutter calculates distance from user's current location.

---

### PART A: Location Service

ğŸ“ CREATE: `lib/services/location_service.dart`

```dart
import 'package:geolocator/geolocator.dart';
import 'dart:math';

class LocationService {
  static Position? _cachedPosition;
  static DateTime? _cachedAt;
  
  /// Get current location with permission handling
  static Future<Position?> getCurrentLocation() async {
    // Return cached if less than 10 minutes old
    if (_cachedPosition != null && _cachedAt != null &&
        DateTime.now().difference(_cachedAt!) < const Duration(minutes: 10)) {
      return _cachedPosition;
    }
    
    // Check if location services are enabled
    bool serviceEnabled = await Geolocator.isLocationServiceEnabled();
    if (!serviceEnabled) return null;
    
    // Check permission
    LocationPermission permission = await Geolocator.checkPermission();
    if (permission == LocationPermission.denied) {
      permission = await Geolocator.requestPermission();
      if (permission == LocationPermission.denied) return null;
    }
    if (permission == LocationPermission.deniedForever) return null;
    
    // Get position
    _cachedPosition = await Geolocator.getCurrentPosition(
      desiredAccuracy: LocationAccuracy.medium, // ~100m accuracy, fast
      timeLimit: const Duration(seconds: 5),
    );
    _cachedAt = DateTime.now();
    
    // Cache to Hive for offline use
    await _saveToHive(_cachedPosition!);
    
    return _cachedPosition;
  }
  
  /// Get last known location (Hive cache or Geolocator last known)
  static Future<Position?> getLastKnown() async {
    if (_cachedPosition != null) return _cachedPosition;
    return await _loadFromHive() ?? await Geolocator.getLastKnownPosition();
  }
  
  /// Calculate distance in km using Haversine formula
  static double calculateDistance(
    double lat1, double lng1,
    double lat2, double lng2,
  ) {
    const R = 6371.0; // Earth's radius in km
    final dLat = _toRadians(lat2 - lat1);
    final dLng = _toRadians(lng2 - lng1);
    final a = sin(dLat / 2) * sin(dLat / 2) +
        cos(_toRadians(lat1)) * cos(_toRadians(lat2)) *
        sin(dLng / 2) * sin(dLng / 2);
    final c = 2 * atan2(sqrt(a), sqrt(1 - a));
    return R * c;
  }
  
  static double _toRadians(double degrees) => degrees * pi / 180;
  
  /// Format distance for display
  static String formatDistance(double km) {
    if (km < 1) return '${(km * 1000).round()}m away';
    if (km < 10) return '${km.toStringAsFixed(1)} km away';
    return '${km.round()} km away';
  }
  
  // Hive cache helpers
  static Future<void> _saveToHive(Position pos) async {
    final box = Hive.box('settings');
    await box.put('last_lat', pos.latitude);
    await box.put('last_lng', pos.longitude);
  }
  
  static Future<Position?> _loadFromHive() async {
    final box = Hive.box('settings');
    final lat = box.get('last_lat');
    final lng = box.get('last_lng');
    if (lat == null || lng == null) return null;
    return Position(
      latitude: lat, longitude: lng,
      timestamp: DateTime.now(),
      accuracy: 0, altitude: 0, heading: 0,
      speed: 0, speedAccuracy: 0, altitudeAccuracy: 0,
      headingAccuracy: 0,
    );
  }
}
```

---

### PART B: Location Permission Flow

ğŸ“ CREATE: `lib/widgets/shared/location_permission_card.dart`

**Scenarios:**

| State | UI |
|-------|----|
| **Never asked** | Card on Home: *"ğŸ“ Enable location to see books near you"* + "Enable" button â†’ requests permission |
| **Denied** | Same card but: *"ğŸ“ Location denied. Tap to enable in settings."* + "Open Settings" â†’ `Geolocator.openAppSettings()` |
| **Denied Forever** | Same but: *"ğŸ“ Location permanently denied."* + "Open Settings" button |
| **Granted** | Card hidden. Distance shown on book cards |
| **Service Off** | *"ğŸ“ Location services are disabled."* + "Turn On" â†’ `Geolocator.openLocationSettings()` |

---

### PART C: Book Location Data

When a user creates a book listing (Prompt 11), the book records **seller's lat/lng at time of listing**:

```dart
// In Sell Book screen, after photos/details are filled:
final position = await LocationService.getCurrentLocation();
if (position != null) {
  bookData['latitude'] = position.latitude;
  bookData['longitude'] = position.longitude;
}
// If no location â†’ book is still created, just without coordinates
```

Books without lat/lng will show as *"Distance unknown"* and sort to the bottom in distance sort.

---

### PART D: Distance-Based Book Filtering

ğŸ“ MODIFY: `lib/providers/book_provider.dart`

After fetching books from PocketBase, calculate distance for each:

```dart
List<BookWithDistance> attachDistances(List<Book> books, Position userPos) {
  return books.map((book) {
    double? distance;
    if (book.latitude != null && book.longitude != null) {
      distance = LocationService.calculateDistance(
        userPos.latitude, userPos.longitude,
        book.latitude!, book.longitude!,
      );
    }
    return BookWithDistance(book: book, distanceKm: distance);
  }).toList();
}
```

**Filter by Distance:**
In the Search Filter Sheet (Prompt 13), the "Distance" filter:

| Option | Filter |
|--------|--------|
| Within 2 km | `distanceKm != null && distanceKm <= 2` |
| Within 5 km | `distanceKm != null && distanceKm <= 5` |
| Within 10 km | `distanceKm != null && distanceKm <= 10` |
| Within 25 km | `distanceKm != null && distanceKm <= 25` |
| Within 50 km | `distanceKm != null && distanceKm <= 50` |
| Any distance | No distance filter |

**Sort by Distance:**
| Sort Option | Logic |
|-------------|-------|
| Nearest first | Sort ascending by `distanceKm`. Null distances â†’ bottom |

---

### PART E: Distance Display on Book Cards

ğŸ“ MODIFY: `lib/widgets/book/book_card.dart`

| Element | Details |
|---------|---------|
| **Location Chip** | Small chip below price: *"ğŸ“ 1.2 km"* or *"ğŸ“ 5 km"* or *"ğŸ“ 23 km"* |
| **Color** | Green if â‰¤ 5 km (nearby), orange if â‰¤ 15 km, grey if > 15 km |
| **No Location** | Show *"ğŸ“ â€”"* if book has no coordinates |
| **No User Location** | Don't show distance chip. Show location enable card instead |

Same chip on `BookListTile` (used in Manage Listings, Wishlist).

---

### PART F: "Near You" Section on Home Screen

ğŸ“ MODIFY: Home Screen (Prompt 9)

Add a "Near You ğŸ“" section (horizontal carousel):
- Shows books within 5 km of user's location
- Sorted by nearest first
- Max 10 books
- Only shows if user has granted location permission
- If no books within 5 km â†’ section hidden

---

### PART G: Location on Seller Profile

ğŸ“ MODIFY: Seller Profile Screen (Prompt 16)

| Element | Details |
|---------|---------|
| **Location** | Show seller's city/area (from user profile), NOT exact lat/lng |
| **Distance** | *"ğŸ“ 3.2 km from you"* if user has location enabled |
| **Privacy** | Never show exact coordinates â€” only rounded distance and city name |

---

ğŸ“¦ USE:
- `geolocator` â€” GPS location, permission handling, settings
- `hive_flutter` â€” cache last known location
- `provider` â€” location state
- Dart `dart:math` â€” Haversine formula (no external package needed)

â›” DO NOT:
- Do NOT show exact lat/lng coordinates anywhere in the UI â€” always formatted distance
- Do NOT block app usage if location is denied â€” books still browsable without distance
- Do NOT request location permission on first launch â€” only when user taps "Enable" or opens "Near You"
- Do NOT use `LocationAccuracy.best` â€” use `medium` for faster response and less battery
- Do NOT re-request location on every book list load â€” use 10-minute cache
- Do NOT filter distance server-side â€” PocketBase doesn't support geospatial queries; filter client-side
- Do NOT forget to handle location timeout (5 seconds max)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”§ EXECUTE:

**Step 1:** Add `geolocator` to pubspec.yaml
**Step 2:** Create `lib/services/location_service.dart` with Haversine + caching
**Step 3:** Create `lib/widgets/shared/location_permission_card.dart`
**Step 4:** Modify book provider to attach distances after fetching
**Step 5:** Update `BookCard` and `BookListTile` with distance chip
**Step 6:** Add distance filter options to Search Filter Sheet
**Step 7:** Add "Near You ğŸ“" section to Home Screen
**Step 8:** Update Seller Profile with distance display
**Step 9:** Run `flutter analyze` â€” 0 issues
**Step 10:** Test: enable location â†’ distance chips appear, filter by 5 km â†’ only nearby books shown

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ… SELF-CHECK:
1. Location permission requested only when user explicitly taps "Enable"
2. Permission card shows correct state (never asked / denied / denied forever / service off)
3. Haversine distance matches expected values (test: Darbhanga center to nearby areas)
4. Distance chips show correct colors (green â‰¤ 5km, orange â‰¤ 15km, grey > 15km)
5. Books without coordinates show "ğŸ“ â€”" instead of crashing
6. Distance filter works for all ranges (2/5/10/25/50 km)
7. "Nearest first" sort puts closest books at top, null distances at bottom
8. "Near You" home section shows only books within 5 km
9. Location cached for 10 minutes â€” no redundant GPS calls
10. App works fully without location permission (just no distance features)
11. Seller profile shows distance but never exact coordinates
12. `flutter analyze` returns 0 issues

ğŸ‘¤ USER MANUAL STEPS:
- None â€” purely frontend code

ğŸ’¬ CONFIRM IN CHAT:
"Prompt 21 complete. Location Service with geolocator, Haversine distance calculation, 10-min cache, distance chips on BookCard (color-coded), distance filter (2-50km), 'Near You' home section, location permission flow with all states handled. flutter analyze: 0 issues. Zero errors."

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â­ï¸ NEXT: Prompt 22 â€” Image Handling (Compression + Upload + Cache + Gallery)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ PROMPT 22 of 70
Phase: Media Infrastructure (PHASE_17)
Task: Image Compression + PocketBase Upload + Cached Loading + Gallery Viewer
Type: ğŸ“± FRONTEND (Flutter)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ INSTRUCTION:
Build the **Image Handling Infrastructure** â€” a centralized image service covering compression before upload, multipart upload to PocketBase, cached network image loading with placeholders, full-screen photo gallery viewer, and thumbnail URL helper.

> This prompt creates reusable services/widgets used by Sell Book (Prompt 11), Edit Book (Prompt 12), Chat (Prompt 14), Edit Profile (Prompt 16), and Book Detail (Prompt 10).

---

### PART A: Image Compression Service

ğŸ“ CREATE: `lib/services/image_service.dart`

```dart
import 'dart:io';
import 'package:flutter_image_compress/flutter_image_compress.dart';
import 'package:path_provider/path_provider.dart';
import 'package:path/path.dart' as p;

class ImageService {
  /// Compress image before upload
  /// Target: < 500 KB for book photos, < 200 KB for avatars
  static Future<File> compress(File file, {
    int maxWidth = 1200,
    int maxHeight = 1200,
    int quality = 80,
    int maxSizeKB = 500,
  }) async {
    final dir = await getTemporaryDirectory();
    final targetPath = p.join(dir.path, 'compressed_${DateTime.now().millisecondsSinceEpoch}.jpg');
    
    // First pass compression
    XFile? result = await FlutterImageCompress.compressAndGetFile(
      file.absolute.path,
      targetPath,
      minWidth: maxWidth,
      minHeight: maxHeight,
      quality: quality,
      format: CompressFormat.jpeg,
    );
    
    if (result == null) return file;
    
    // If still too large, reduce quality further
    File compressed = File(result.path);
    int sizeKB = await compressed.length() ~/ 1024;
    
    if (sizeKB > maxSizeKB) {
      int reducedQuality = (quality * maxSizeKB / sizeKB).clamp(20, 70).toInt();
      final retryPath = p.join(dir.path, 'retry_${DateTime.now().millisecondsSinceEpoch}.jpg');
      result = await FlutterImageCompress.compressAndGetFile(
        file.absolute.path,
        retryPath,
        minWidth: maxWidth,
        minHeight: maxHeight,
        quality: reducedQuality,
        format: CompressFormat.jpeg,
      );
      if (result != null) compressed = File(result.path);
    }
    
    return compressed;
  }
  
  /// Compress for avatar (smaller target)
  static Future<File> compressAvatar(File file) {
    return compress(file, maxWidth: 400, maxHeight: 400, maxSizeKB: 200);
  }
  
  /// Compress for chat image
  static Future<File> compressChatImage(File file) {
    return compress(file, maxWidth: 800, maxHeight: 800, maxSizeKB: 300);
  }
  
  /// Pick image from camera or gallery
  static Future<File?> pickImage({required ImageSource source}) async {
    final picker = ImagePicker();
    final picked = await picker.pickImage(
      source: source,
      imageQuality: 90, // Initial quality hint
    );
    if (picked == null) return null;
    return File(picked.path);
  }
  
  /// Pick multiple images (for book listing)
  static Future<List<File>> pickMultipleImages({int maxCount = 5}) async {
    final picker = ImagePicker();
    final picked = await picker.pickMultiImage(
      imageQuality: 90,
      limit: maxCount,
    );
    return picked.map((xFile) => File(xFile.path)).toList();
  }
}
```

---

### PART B: PocketBase File Upload Service

ğŸ“ CREATE: `lib/services/upload_service.dart`

```dart
import 'dart:io';
import 'package:http/http.dart' as http;
import 'package:pocketbase/pocketbase.dart';

class UploadService {
  final PocketBase pb;
  UploadService(this.pb);
  
  /// Upload single file to a record's file field
  Future<RecordModel> uploadFile({
    required String collectionName,
    required String recordId,
    required String fieldName,
    required File file,
  }) async {
    return await pb.collection(collectionName).update(
      recordId,
      files: [
        http.MultipartFile.fromBytes(
          fieldName,
          await file.readAsBytes(),
          filename: file.path.split('/').last,
        ),
      ],
    );
  }
  
  /// Upload multiple files (e.g., book photos)
  Future<RecordModel> uploadMultipleFiles({
    required String collectionName,
    required String recordId,
    required String fieldName,
    required List<File> files,
    Function(int uploaded, int total)? onProgress,
  }) async {
    final multipartFiles = <http.MultipartFile>[];
    
    for (int i = 0; i < files.length; i++) {
      final file = files[i];
      final compressed = await ImageService.compress(file);
      multipartFiles.add(
        http.MultipartFile.fromBytes(
          fieldName,
          await compressed.readAsBytes(),
          filename: 'photo_${i + 1}.jpg',
        ),
      );
      onProgress?.call(i + 1, files.length);
    }
    
    return await pb.collection(collectionName).update(
      recordId,
      files: multipartFiles,
    );
  }
  
  /// Create record with files in one call
  Future<RecordModel> createWithFiles({
    required String collectionName,
    required Map<String, dynamic> body,
    required String fieldName,
    required List<File> files,
  }) async {
    final multipartFiles = <http.MultipartFile>[];
    
    for (int i = 0; i < files.length; i++) {
      final compressed = await ImageService.compress(files[i]);
      multipartFiles.add(
        http.MultipartFile.fromBytes(
          fieldName,
          await compressed.readAsBytes(),
          filename: 'photo_${i + 1}.jpg',
        ),
      );
    }
    
    return await pb.collection(collectionName).create(
      body: body,
      files: multipartFiles,
    );
  }
  
  /// Delete a specific file from a record
  Future<RecordModel> deleteFile({
    required String collectionName,
    required String recordId,
    required String fieldName,
    required String fileName,
  }) async {
    return await pb.collection(collectionName).update(
      recordId,
      body: { '$fieldName-': fileName },
    );
  }
}
```

---

### PART C: PocketBase Image URL Helper

ğŸ“ CREATE: `lib/utils/image_url_helper.dart`

```dart
class ImageUrlHelper {
  static const _baseUrl = 'https://api.jayganga.com';  // PocketBase URL
  
  /// Get full image URL from PocketBase record
  static String getUrl(RecordModel record, String fileName) {
    return '$_baseUrl/api/files/${record.collectionId}/${record.id}/$fileName';
  }
  
  /// Get thumbnail URL (PocketBase built-in thumb generation)
  /// Sizes: "100x100", "200x200", "300x300", etc.
  static String getThumbUrl(RecordModel record, String fileName, {
    String size = '200x200',
  }) {
    return '$_baseUrl/api/files/${record.collectionId}/${record.id}/$fileName?thumb=$size';
  }
  
  /// Get first photo URL from a book record
  static String? getBookCover(RecordModel book) {
    final photos = book.getListValue<String>('photos');
    if (photos.isEmpty) return null;
    return getThumbUrl(book, photos.first, size: '300x300');
  }
  
  /// Get all photo URLs for a book
  static List<String> getBookPhotos(RecordModel book, {bool fullSize = false}) {
    final photos = book.getListValue<String>('photos');
    return photos.map((p) => fullSize
      ? getUrl(book, p)
      : getThumbUrl(book, p, size: '400x400')
    ).toList();
  }
  
  /// Get user avatar URL
  static String? getAvatar(RecordModel user, {String size = '100x100'}) {
    final avatar = user.getStringValue('avatar');
    if (avatar.isEmpty) return null;
    return getThumbUrl(user, avatar, size: size);
  }
}
```

---

### PART D: Cached Network Image Widget

ğŸ“ CREATE: `lib/widgets/shared/app_cached_image.dart`

A reusable wrapper around `cached_network_image`:

```dart
class AppCachedImage extends StatelessWidget {
  final String? imageUrl;
  final double? width;
  final double? height;
  final BoxFit fit;
  final BorderRadius? borderRadius;
  final Widget? placeholder;
  final Widget? errorWidget;
  
  // ... constructor
  
  @override
  Widget build(BuildContext context) {
    if (imageUrl == null || imageUrl!.isEmpty) {
      return _buildPlaceholder();
    }
    
    return ClipRRect(
      borderRadius: borderRadius ?? BorderRadius.zero,
      child: CachedNetworkImage(
        imageUrl: imageUrl!,
        width: width,
        height: height,
        fit: fit,
        placeholder: (_, __) => placeholder ?? _shimmerPlaceholder(),
        errorWidget: (_, __, ___) => errorWidget ?? _buildError(),
        fadeInDuration: const Duration(milliseconds: 200),
        memCacheWidth: width?.toInt(),  // Memory optimization
      ),
    );
  }
  
  Widget _shimmerPlaceholder() {
    // Shimmer loading effect â€” grey box with subtle animation
  }
  
  Widget _buildPlaceholder() {
    // Book icon placeholder for missing images
  }
  
  Widget _buildError() {
    // Broken image icon with retry tap
  }
}
```

**Variants:**
| Widget | Usage |
|--------|-------|
| `AppCachedImage.avatar(url, size)` | Circular avatar with fallback initial |
| `AppCachedImage.bookCover(url)` | Book cover with 3:4 aspect ratio |
| `AppCachedImage.chatImage(url)` | Chat message image with rounded corners |

---

### PART E: Full-Screen Photo Gallery

ğŸ“ CREATE: `lib/widgets/shared/photo_gallery_viewer.dart`

| Element | Details |
|---------|---------|
| **Trigger** | Tap any book photo â†’ opens full-screen gallery |
| **Layout** | PageView with swipe left/right between photos |
| **Background** | Black with fade transition |
| **Counter** | *"1 / 5"* top-right corner |
| **Zoom** | Pinch-to-zoom with `InteractiveViewer` |
| **Double Tap** | Toggle zoom in/out |
| **Dismiss** | Swipe down to close (drag dismiss) |
| **Share** | Share button â†’ shares the image URL |
| **Hero** | Hero animation from book detail thumbnail to full-screen |
| **Preload** | Preload adjacent images for smooth swiping |

```dart
class PhotoGalleryViewer extends StatelessWidget {
  final List<String> imageUrls;
  final int initialIndex;
  final String? heroTag;
  
  static void show(BuildContext context, {
    required List<String> imageUrls,
    int initialIndex = 0,
    String? heroTag,
  }) {
    Navigator.push(context, PageRouteBuilder(
      opaque: false,
      pageBuilder: (_, __, ___) => PhotoGalleryViewer(
        imageUrls: imageUrls,
        initialIndex: initialIndex,
        heroTag: heroTag,
      ),
      transitionsBuilder: (_, animation, __, child) =>
        FadeTransition(opacity: animation, child: child),
    ));
  }
}
```

---

### PART F: Upload Progress Overlay

ğŸ“ CREATE: `lib/widgets/shared/upload_progress_overlay.dart`

| Element | Details |
|---------|---------|
| **When** | During book photo upload, avatar upload, chat image upload |
| **Layout** | Semi-transparent overlay with circular progress |
| **Progress** | *"Uploading photo 2 of 5..."* with progress ring |
| **Cancel** | "Cancel" button stops remaining uploads (already uploaded photos stay) |
| **Complete** | Green checkmark animation â†’ auto-dismiss after 1s |
| **Error** | Red X with "Retry" button |

---

ğŸ“¦ USE:
- `flutter_image_compress` â€” image compression before upload
- `image_picker` â€” camera and gallery access
- `cached_network_image` â€” cached image loading with placeholders
- `http` (dart) â€” multipart file uploads
- `pocketbase` SDK â€” file field operations
- `path_provider` â€” temp directory for compressed files
- `share_plus` â€” share images from gallery

â›” DO NOT:
- Do NOT upload images without compression â€” always compress first
- Do NOT use original resolution for thumbnails â€” use PocketBase `?thumb=` parameter
- Do NOT forget to clean up temp compressed files after upload
- Do NOT load full-size images in list views â€” always use thumbnails
- Do NOT block UI during compression â€” show progress indicator
- Do NOT forget the shimmer placeholder for loading images
- Do NOT hardcode the PocketBase URL â€” use the `pb.baseUrl` from the SDK instance
- Do NOT forget Hero animation between book card and gallery

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”§ EXECUTE:

**Step 1:** Add `flutter_image_compress`, `cached_network_image`, `image_picker` to pubspec
**Step 2:** Create `lib/services/image_service.dart` with compression pipeline
**Step 3:** Create `lib/services/upload_service.dart` with multipart upload
**Step 4:** Create `lib/utils/image_url_helper.dart` with thumb URL generation
**Step 5:** Create `lib/widgets/shared/app_cached_image.dart` with shimmer + variants
**Step 6:** Create `lib/widgets/shared/photo_gallery_viewer.dart` with zoom + swipe + Hero
**Step 7:** Create `lib/widgets/shared/upload_progress_overlay.dart`
**Step 8:** Run `flutter analyze` â€” 0 issues
**Step 9:** Test: pick 5 photos â†’ all compress < 500KB â†’ upload with progress â†’ cached thumbnails load on book card â†’ tap opens gallery with zoom

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ… SELF-CHECK:
1. Compression reduces images to < 500 KB (book), < 200 KB (avatar), < 300 KB (chat)
2. Second-pass compression triggers if first pass still too large
3. Upload service handles single file, multiple files, and create-with-files
4. Delete file removes specific file from record
5. Thumbnail URLs use PocketBase `?thumb=` parameter correctly
6. `AppCachedImage` shows shimmer while loading, error on failure
7. Avatar variant shows circular crop with initial fallback
8. Gallery viewer supports pinch-zoom, double-tap zoom, swipe navigation
9. Gallery shows photo counter "1 / 5"
10. Swipe down dismisses gallery
11. Hero animation from book card to gallery works smoothly
12. Upload progress overlay shows accurate count "Uploading 2 of 5"
13. Cancel stops remaining uploads
14. Temp files cleaned up after upload
15. `flutter analyze` returns 0 issues

ğŸ‘¤ USER MANUAL STEPS:
- None â€” purely frontend code

ğŸ’¬ CONFIRM IN CHAT:
"Prompt 22 complete. Image Handling infrastructure: compression pipeline (3 presets), PocketBase upload service (single/multi/create), thumbnail URL helper, AppCachedImage with shimmer, full-screen gallery with zoom/Hero/swipe-dismiss, upload progress overlay. flutter analyze: 0 issues. Zero errors."

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â­ï¸ NEXT: Prompt 23 â€” Error Handling + Connectivity + Retry Logic
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ PROMPT 23 of 70
Phase: Resilience & UX (PHASE_18)
Task: Global Error Handling + Connectivity Monitor + Retry Logic + Error Widgets
Type: ğŸ“± FRONTEND (Flutter)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ INSTRUCTION:
Build the **Error Handling & Resilience Layer** â€” a global error interceptor for PocketBase calls, a connectivity monitor with offline banner, exponential backoff retry logic, error boundary widgets, and standardized error screens for common failure states.

> These are foundational utilities used by every screen in the app.

---

### PART A: PocketBase API Wrapper with Error Handling

ğŸ“ CREATE: `lib/services/api_service.dart`

A centralized wrapper around all PocketBase API calls:

```dart
class ApiService {
  final PocketBase pb;
  ApiService(this.pb);
  
  /// Generic API call wrapper with error handling
  Future<T> call<T>(Future<T> Function() apiCall, {
    int maxRetries = 2,
    String? errorContext,  // e.g., "loading books", "sending message"
  }) async {
    int attempt = 0;
    
    while (true) {
      try {
        return await apiCall();
      } on ClientException catch (e) {
        attempt++;
        
        // Map PocketBase errors to user-friendly messages
        final appError = AppError.fromClientException(e, context: errorContext);
        
        // Don't retry on auth errors or validation errors
        if (appError.isAuthError || appError.isValidationError) {
          throw appError;
        }
        
        // Retry on network/server errors
        if (attempt <= maxRetries && appError.isRetryable) {
          await Future.delayed(Duration(milliseconds: 500 * attempt)); // Exponential backoff
          continue;
        }
        
        throw appError;
      } catch (e) {
        throw AppError(
          message: 'Something went wrong',
          detail: e.toString(),
          type: ErrorType.unknown,
        );
      }
    }
  }
}
```

---

### PART B: App Error Model

ğŸ“ CREATE: `lib/models/app_error.dart`

```dart
enum ErrorType {
  network,       // No internet, timeout
  server,        // 500, 502, 503
  auth,          // 401, 403 â€” token expired, unauthorized
  notFound,      // 404
  validation,    // 400 â€” bad request, form errors
  conflict,      // 409 â€” duplicate record
  rateLimited,   // 429
  unknown,       // Anything else
}

class AppError implements Exception {
  final String message;       // User-friendly message
  final String? detail;       // Technical detail for logging
  final ErrorType type;
  final int? statusCode;
  final Map<String, dynamic>? fieldErrors;  // Validation errors per field
  
  const AppError({
    required this.message,
    this.detail,
    required this.type,
    this.statusCode,
    this.fieldErrors,
  });
  
  bool get isRetryable => type == ErrorType.network || type == ErrorType.server;
  bool get isAuthError => type == ErrorType.auth;
  bool get isValidationError => type == ErrorType.validation;
  
  factory AppError.fromClientException(ClientException e, {String? context}) {
    final status = e.statusCode;
    final ctx = context != null ? ' while $context' : '';
    
    if (status == 0 || e.originalError is SocketException) {
      return AppError(
        message: 'No internet connection$ctx',
        detail: e.toString(),
        type: ErrorType.network,
        statusCode: 0,
      );
    }
    
    switch (status) {
      case 400:
        return AppError(
          message: 'Invalid data$ctx',
          detail: e.response?['message'],
          type: ErrorType.validation,
          statusCode: 400,
          fieldErrors: _extractFieldErrors(e),
        );
      case 401:
        return AppError(
          message: 'Session expired. Please sign in again.',
          type: ErrorType.auth,
          statusCode: 401,
        );
      case 403:
        return AppError(
          message: 'You don\'t have permission$ctx',
          type: ErrorType.auth,
          statusCode: 403,
        );
      case 404:
        return AppError(
          message: 'Content not found$ctx',
          type: ErrorType.notFound,
          statusCode: 404,
        );
      case 429:
        return AppError(
          message: 'Too many requests. Please wait a moment.',
          type: ErrorType.rateLimited,
          statusCode: 429,
        );
      default:
        if (status >= 500) {
          return AppError(
            message: 'Server error$ctx. Please try again.',
            type: ErrorType.server,
            statusCode: status,
          );
        }
        return AppError(
          message: 'Something went wrong$ctx',
          detail: e.toString(),
          type: ErrorType.unknown,
          statusCode: status,
        );
    }
  }
}
```

---

### PART C: Connectivity Monitor

ğŸ“ CREATE: `lib/services/connectivity_service.dart`

```dart
import 'package:connectivity_plus/connectivity_plus.dart';

class ConnectivityService extends ChangeNotifier {
  bool _isOnline = true;
  bool get isOnline => _isOnline;
  
  late final StreamSubscription _subscription;
  
  ConnectivityService() {
    _init();
  }
  
  Future<void> _init() async {
    // Initial check
    final result = await Connectivity().checkConnectivity();
    _isOnline = !result.contains(ConnectivityResult.none);
    
    // Listen for changes
    _subscription = Connectivity().onConnectivityChanged.listen((results) {
      final wasOnline = _isOnline;
      _isOnline = !results.contains(ConnectivityResult.none);
      
      if (wasOnline != _isOnline) {
        notifyListeners();
      }
    });
  }
  
  @override
  void dispose() {
    _subscription.cancel();
    super.dispose();
  }
}
```

---

### PART D: Offline Banner Widget

ğŸ“ CREATE: `lib/widgets/shared/offline_banner.dart`

| Element | Details |
|---------|---------|
| **When** | `ConnectivityService.isOnline == false` |
| **Where** | Top of every screen, below app bar (persistent) |
| **Look** | Red banner: *"ğŸ“¡ No internet connection"* |
| **Reconnect** | When connection returns â†’ green banner: *"âœ… Back online!"* for 3 seconds â†’ auto-hide |
| **Animation** | Slide down animation on appear, slide up on dismiss |

```dart
class OfflineBanner extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Consumer<ConnectivityService>(
      builder: (_, connectivity, __) {
        if (connectivity.isOnline) return const SizedBox.shrink();
        return MaterialBanner(
          backgroundColor: Colors.red.shade700,
          content: Text('ğŸ“¡ No internet connection',
            style: TextStyle(color: Colors.white)),
          actions: [
            TextButton(
              onPressed: () => connectivity.checkNow(),
              child: Text('RETRY', style: TextStyle(color: Colors.white)),
            ),
          ],
        );
      },
    );
  }
}
```

---

### PART E: Error Boundary Widget

ğŸ“ CREATE: `lib/widgets/shared/error_boundary.dart`

Wraps any async data-loading widget with standardized error/loading/empty states:

```dart
class ErrorBoundary<T> extends StatelessWidget {
  final Future<T> future;
  final Widget Function(T data) builder;
  final Widget? loading;
  final Widget Function(AppError error, VoidCallback retry)? errorBuilder;
  final Widget? empty;
  final bool Function(T data)? isEmpty;
  
  // ... constructor
  
  @override
  Widget build(BuildContext context) {
    return FutureBuilder<T>(
      future: future,
      builder: (context, snapshot) {
        if (snapshot.connectionState == ConnectionState.waiting) {
          return loading ?? const Center(child: CircularProgressIndicator());
        }
        
        if (snapshot.hasError) {
          final error = snapshot.error is AppError
            ? snapshot.error as AppError
            : AppError(message: 'Something went wrong', type: ErrorType.unknown);
          
          return errorBuilder?.call(error, () { /* trigger rebuild */ })
            ?? ErrorStateWidget(error: error, onRetry: () { /* rebuild */ });
        }
        
        if (snapshot.hasData) {
          if (isEmpty?.call(snapshot.data as T) ?? false) {
            return empty ?? const EmptyStateWidget();
          }
          return builder(snapshot.data as T);
        }
        
        return const SizedBox.shrink();
      },
    );
  }
}
```

---

### PART F: Standardized Error State Widget

ğŸ“ CREATE: `lib/widgets/shared/error_state_widget.dart`

| Error Type | Icon | Title | Action |
|------------|------|-------|--------|
| `network` | ğŸ“¡ | *"No Internet"* | "Try Again" button |
| `server` | ğŸ”§ | *"Server Error"* | "Try Again" button |
| `auth` | ğŸ” | *"Session Expired"* | "Sign In" button â†’ LoginGate |
| `notFound` | ğŸ” | *"Not Found"* | "Go Back" button |
| `rateLimited` | â³ | *"Too Many Requests"* | "Wait & Retry" with countdown |
| `unknown` | â“ | *"Something Went Wrong"* | "Try Again" button + "Report Issue" link |

```dart
class ErrorStateWidget extends StatelessWidget {
  final AppError error;
  final VoidCallback? onRetry;
  
  // ... constructor
  
  @override
  Widget build(BuildContext context) {
    return Center(
      child: Padding(
        padding: const EdgeInsets.all(32),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Icon(_iconForType(error.type), size: 64, color: Colors.grey),
            const SizedBox(height: 16),
            Text(error.message, style: Theme.of(context).textTheme.titleMedium,
              textAlign: TextAlign.center),
            if (error.detail != null) ...[
              const SizedBox(height: 8),
              Text(error.detail!, style: TextStyle(color: Colors.grey, fontSize: 12)),
            ],
            const SizedBox(height: 24),
            if (onRetry != null)
              ElevatedButton.icon(
                onPressed: onRetry,
                icon: const Icon(Icons.refresh),
                label: const Text('Try Again'),
              ),
          ],
        ),
      ),
    );
  }
}
```

---

### PART G: Empty State Widget

ğŸ“ CREATE: `lib/widgets/shared/empty_state_widget.dart`

| Usage | Icon | Message |
|-------|------|---------|
| No books found | ğŸ“š | *"No books found. Try adjusting your filters."* |
| No messages | ğŸ’¬ | *"No messages yet. Start a conversation!"* |
| No notifications | ğŸ”” | *"All caught up! ğŸ‰"* |
| No wishlist | â¤ï¸ | *"Your wishlist is empty."* |
| No transactions | ğŸ“¦ | *"No transactions yet."* |
| Generic | ğŸ“­ | *"Nothing here yet."* |

```dart
class EmptyStateWidget extends StatelessWidget {
  final IconData icon;
  final String message;
  final String? actionLabel;
  final VoidCallback? onAction;
  
  // Predefined factories
  factory EmptyStateWidget.noBooks() => ...
  factory EmptyStateWidget.noMessages() => ...
  factory EmptyStateWidget.noNotifications() => ...
  // ... etc
}
```

---

### PART H: Auth Error Auto-Handler

ğŸ“ MODIFY: `lib/services/api_service.dart`

When a 401 error is encountered:

```dart
// On auth error (401):
// 1. Try to refresh the auth token
// 2. If refresh fails â†’ clear auth store â†’ redirect to splash
// 3. Show snackbar: "Session expired. Please sign in again."
```

Integrate with GoRouter redirect:
```dart
if (response.statusCode == 401) {
  pb.authStore.clear();
  router.go('/splash');
}
```

---

ğŸ“¦ USE:
- `connectivity_plus` â€” internet connection monitoring
- `pocketbase` SDK â€” ClientException handling
- `provider` â€” connectivity state, error state
- No additional packages â€” pure Dart error handling

â›” DO NOT:
- Do NOT show raw error messages to users â€” always use `AppError.message`
- Do NOT retry on auth (401/403) or validation (400) errors â€” only on network/server
- Do NOT retry more than 2 times â€” fail fast with user-friendly message
- Do NOT ignore connectivity changes â€” always show/hide offline banner
- Do NOT show stack traces in production â€” only the user-friendly message
- Do NOT forget to handle 401 â†’ auto-logout + redirect to splash
- Do NOT block the entire app on network errors â€” show inline error states
- Do NOT forget to add OfflineBanner to every scaffold

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”§ EXECUTE:

**Step 1:** Create `lib/models/app_error.dart` with ErrorType enum + AppError class
**Step 2:** Create `lib/services/api_service.dart` with retry + error mapping
**Step 3:** Create `lib/services/connectivity_service.dart` with ChangeNotifier
**Step 4:** Create `lib/widgets/shared/offline_banner.dart`
**Step 5:** Create `lib/widgets/shared/error_boundary.dart`
**Step 6:** Create `lib/widgets/shared/error_state_widget.dart` with per-type variants
**Step 7:** Create `lib/widgets/shared/empty_state_widget.dart` with factory constructors
**Step 8:** Wire connectivity provider into `main.dart`
**Step 9:** Run `flutter analyze` â€” 0 issues
**Step 10:** Test: airplane mode â†’ offline banner shows, API call fails â†’ error state + retry works, 401 â†’ auto-logout

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ… SELF-CHECK:
1. `AppError.fromClientException` maps all status codes correctly
2. Retry logic retries 2x with exponential backoff (500ms, 1000ms)
3. No retry on 400, 401, 403, 409 errors
4. Connectivity monitor detects online/offline transitions
5. Offline banner slides in/out with animation
6. "Back online" green banner shows for 3 seconds on reconnect
7. ErrorBoundary handles loading/error/empty/data states
8. ErrorStateWidget shows correct icon + message per error type
9. EmptyStateWidget has factory constructors for each screen
10. Auth error (401) auto-clears auth store + redirects to splash
11. Validation errors extract field-level errors for form highlighting
12. No raw error messages shown to users anywhere
13. `flutter analyze` returns 0 issues

ğŸ‘¤ USER MANUAL STEPS:
- None â€” purely frontend code

ğŸ’¬ CONFIRM IN CHAT:
"Prompt 23 complete. Error Handling layer: AppError model (8 types), API wrapper with 2x exponential backoff retry, connectivity monitor with offline/online banner, ErrorBoundary widget, ErrorStateWidget (6 variants), EmptyStateWidget (6 factories), auth error auto-logout. flutter analyze: 0 issues. Zero errors."

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â­ï¸ NEXT: Prompt 24 â€” Theme System (Light + Dark + Dynamic Colors)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ PROMPT 24 of 70
Phase: Design System (PHASE_19)
Task: Material 3 Theme (Light + Dark) + Color Scheme + Typography + Component Themes
Type: ğŸ“± FRONTEND (Flutter)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ INSTRUCTION:
Build the **App Theme System** â€” Material 3 color scheme with brand colors, light/dark `ThemeData`, custom typography using Google Fonts, per-component theme overrides, and a `ThemeProvider` with persistence.

> **Brand Colors:**
> - Primary: **Saffron (#FF6B00)** â€” warm, Indian-book feel
> - Secondary: **Teal (#009688)** â€” trust, knowledge
> - Tertiary: **Deep Purple (#7B1FA2)** â€” premium feel

---

### PART A: Color Scheme

ğŸ“ CREATE: `lib/theme/app_colors.dart`

```dart
class AppColors {
  // Brand
  static const saffron = Color(0xFFFF6B00);
  static const teal = Color(0xFF009688);
  static const deepPurple = Color(0xFF7B1FA2);
  
  // Light Mode
  static const lightBackground = Color(0xFFF8F9FA);
  static const lightSurface = Color(0xFFFFFFFF);
  static const lightOnSurface = Color(0xFF1A1A1A);
  static const lightSurfaceVariant = Color(0xFFF0F0F0);
  static const lightOutline = Color(0xFFE0E0E0);
  
  // Dark Mode
  static const darkBackground = Color(0xFF121212);
  static const darkSurface = Color(0xFF1E1E1E);
  static const darkOnSurface = Color(0xFFE8E8E8);
  static const darkSurfaceVariant = Color(0xFF2C2C2C);
  static const darkOutline = Color(0xFF3A3A3A);
  
  // Semantic
  static const success = Color(0xFF4CAF50);
  static const warning = Color(0xFFFFC107);
  static const error = Color(0xFFE53935);
  static const info = Color(0xFF2196F3);
  
  // Book Condition
  static const conditionNew = Color(0xFF4CAF50);     // Like New
  static const conditionGood = Color(0xFFFFC107);    // Good
  static const conditionFair = Color(0xFFFF9800);    // Fair
  
  // Transaction Status
  static const statusInitiated = Color(0xFF9E9E9E);
  static const statusConfirmed = Color(0xFF2196F3);
  static const statusHandover = Color(0xFFFF9800);
  static const statusCompleted = Color(0xFF4CAF50);
  static const statusReviewed = Color(0xFF7B1FA2);
  static const statusDisputed = Color(0xFFE53935);
  
  // Distance
  static const distanceNear = Color(0xFF4CAF50);     // â‰¤ 5 km
  static const distanceMedium = Color(0xFFFF9800);   // â‰¤ 15 km
  static const distanceFar = Color(0xFF9E9E9E);      // > 15 km
  
  // Light ColorScheme
  static ColorScheme get lightScheme => ColorScheme(
    brightness: Brightness.light,
    primary: saffron,
    onPrimary: Colors.white,
    secondary: teal,
    onSecondary: Colors.white,
    tertiary: deepPurple,
    onTertiary: Colors.white,
    error: error,
    onError: Colors.white,
    surface: lightSurface,
    onSurface: lightOnSurface,
    surfaceContainerHighest: lightSurfaceVariant,
    outline: lightOutline,
  );
  
  // Dark ColorScheme
  static ColorScheme get darkScheme => ColorScheme(
    brightness: Brightness.dark,
    primary: saffron,
    onPrimary: Colors.black,
    secondary: teal,
    onSecondary: Colors.black,
    tertiary: deepPurple,
    onTertiary: Colors.white,
    error: error,
    onError: Colors.black,
    surface: darkSurface,
    onSurface: darkOnSurface,
    surfaceContainerHighest: darkSurfaceVariant,
    outline: darkOutline,
  );
}
```

---

### PART B: Typography

ğŸ“ CREATE: `lib/theme/app_typography.dart`

```dart
import 'package:google_fonts/google_fonts.dart';

class AppTypography {
  static TextTheme get textTheme => TextTheme(
    // Display
    displayLarge: GoogleFonts.outfit(fontSize: 32, fontWeight: FontWeight.bold),
    displayMedium: GoogleFonts.outfit(fontSize: 28, fontWeight: FontWeight.bold),
    displaySmall: GoogleFonts.outfit(fontSize: 24, fontWeight: FontWeight.bold),
    
    // Headlines
    headlineLarge: GoogleFonts.outfit(fontSize: 22, fontWeight: FontWeight.w600),
    headlineMedium: GoogleFonts.outfit(fontSize: 20, fontWeight: FontWeight.w600),
    headlineSmall: GoogleFonts.outfit(fontSize: 18, fontWeight: FontWeight.w600),
    
    // Titles
    titleLarge: GoogleFonts.inter(fontSize: 16, fontWeight: FontWeight.w600),
    titleMedium: GoogleFonts.inter(fontSize: 14, fontWeight: FontWeight.w600),
    titleSmall: GoogleFonts.inter(fontSize: 12, fontWeight: FontWeight.w600),
    
    // Body
    bodyLarge: GoogleFonts.inter(fontSize: 16, fontWeight: FontWeight.w400),
    bodyMedium: GoogleFonts.inter(fontSize: 14, fontWeight: FontWeight.w400),
    bodySmall: GoogleFonts.inter(fontSize: 12, fontWeight: FontWeight.w400),
    
    // Labels
    labelLarge: GoogleFonts.inter(fontSize: 14, fontWeight: FontWeight.w500),
    labelMedium: GoogleFonts.inter(fontSize: 12, fontWeight: FontWeight.w500),
    labelSmall: GoogleFonts.inter(fontSize: 10, fontWeight: FontWeight.w500),
  );
}
```

---

### PART C: Component Themes

ğŸ“ CREATE: `lib/theme/component_themes.dart`

```dart
class ComponentThemes {
  static AppBarTheme appBar(ColorScheme scheme) => AppBarTheme(
    backgroundColor: scheme.surface,
    foregroundColor: scheme.onSurface,
    elevation: 0,
    scrolledUnderElevation: 1,
    centerTitle: false,
    titleTextStyle: GoogleFonts.outfit(
      fontSize: 20, fontWeight: FontWeight.w600,
      color: scheme.onSurface,
    ),
  );
  
  static CardTheme card(ColorScheme scheme) => CardTheme(
    color: scheme.surface,
    elevation: 0,
    shape: RoundedRectangleBorder(
      borderRadius: BorderRadius.circular(12),
      side: BorderSide(color: scheme.outline.withOpacity(0.3)),
    ),
  );
  
  static ElevatedButtonThemeData elevatedButton(ColorScheme scheme) =>
    ElevatedButtonThemeData(
      style: ElevatedButton.styleFrom(
        backgroundColor: scheme.primary,
        foregroundColor: scheme.onPrimary,
        elevation: 0,
        padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 14),
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
        textStyle: GoogleFonts.inter(fontSize: 14, fontWeight: FontWeight.w600),
      ),
    );
  
  static OutlinedButtonThemeData outlinedButton(ColorScheme scheme) =>
    OutlinedButtonThemeData(
      style: OutlinedButton.styleFrom(
        foregroundColor: scheme.primary,
        side: BorderSide(color: scheme.primary),
        padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 14),
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
      ),
    );
  
  static InputDecorationTheme inputDecoration(ColorScheme scheme) =>
    InputDecorationTheme(
      filled: true,
      fillColor: scheme.surfaceContainerHighest.withOpacity(0.5),
      border: OutlineInputBorder(
        borderRadius: BorderRadius.circular(12),
        borderSide: BorderSide(color: scheme.outline),
      ),
      focusedBorder: OutlineInputBorder(
        borderRadius: BorderRadius.circular(12),
        borderSide: BorderSide(color: scheme.primary, width: 2),
      ),
      errorBorder: OutlineInputBorder(
        borderRadius: BorderRadius.circular(12),
        borderSide: BorderSide(color: scheme.error),
      ),
      contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 14),
    );
  
  static BottomNavigationBarThemeData bottomNav(ColorScheme scheme) =>
    BottomNavigationBarThemeData(
      backgroundColor: scheme.surface,
      selectedItemColor: scheme.primary,
      unselectedItemColor: scheme.onSurface.withOpacity(0.5),
      type: BottomNavigationBarType.fixed,
      elevation: 8,
    );
  
  static ChipThemeData chip(ColorScheme scheme) => ChipThemeData(
    backgroundColor: scheme.surfaceContainerHighest,
    selectedColor: scheme.primary.withOpacity(0.15),
    labelStyle: GoogleFonts.inter(fontSize: 12),
    shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
    side: BorderSide.none,
    padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
  );
  
  static BottomSheetThemeData bottomSheet(ColorScheme scheme) =>
    BottomSheetThemeData(
      backgroundColor: scheme.surface,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
      ),
      dragHandleSize: const Size(32, 4),
      showDragHandle: true,
    );
  
  static FloatingActionButtonThemeData fab(ColorScheme scheme) =>
    FloatingActionButtonThemeData(
      backgroundColor: scheme.primary,
      foregroundColor: scheme.onPrimary,
      elevation: 4,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
    );
}
```

---

### PART D: ThemeData Assembly

ğŸ“ CREATE: `lib/theme/app_theme.dart`

```dart
class AppTheme {
  static ThemeData light() {
    final scheme = AppColors.lightScheme;
    return ThemeData(
      useMaterial3: true,
      colorScheme: scheme,
      scaffoldBackgroundColor: AppColors.lightBackground,
      textTheme: AppTypography.textTheme,
      appBarTheme: ComponentThemes.appBar(scheme),
      cardTheme: ComponentThemes.card(scheme),
      elevatedButtonTheme: ComponentThemes.elevatedButton(scheme),
      outlinedButtonTheme: ComponentThemes.outlinedButton(scheme),
      inputDecorationTheme: ComponentThemes.inputDecoration(scheme),
      bottomNavigationBarTheme: ComponentThemes.bottomNav(scheme),
      chipTheme: ComponentThemes.chip(scheme),
      bottomSheetTheme: ComponentThemes.bottomSheet(scheme),
      floatingActionButtonTheme: ComponentThemes.fab(scheme),
      dividerTheme: DividerThemeData(color: scheme.outline.withOpacity(0.3)),
      snackBarTheme: SnackBarThemeData(
        behavior: SnackBarBehavior.floating,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
      ),
    );
  }
  
  static ThemeData dark() {
    final scheme = AppColors.darkScheme;
    return ThemeData(
      useMaterial3: true,
      colorScheme: scheme,
      scaffoldBackgroundColor: AppColors.darkBackground,
      textTheme: AppTypography.textTheme.apply(
        bodyColor: AppColors.darkOnSurface,
        displayColor: AppColors.darkOnSurface,
      ),
      appBarTheme: ComponentThemes.appBar(scheme),
      cardTheme: ComponentThemes.card(scheme),
      elevatedButtonTheme: ComponentThemes.elevatedButton(scheme),
      outlinedButtonTheme: ComponentThemes.outlinedButton(scheme),
      inputDecorationTheme: ComponentThemes.inputDecoration(scheme),
      bottomNavigationBarTheme: ComponentThemes.bottomNav(scheme),
      chipTheme: ComponentThemes.chip(scheme),
      bottomSheetTheme: ComponentThemes.bottomSheet(scheme),
      floatingActionButtonTheme: ComponentThemes.fab(scheme),
      dividerTheme: DividerThemeData(color: scheme.outline.withOpacity(0.3)),
      snackBarTheme: SnackBarThemeData(
        behavior: SnackBarBehavior.floating,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
      ),
    );
  }
}
```

---

### PART E: Theme Provider

ğŸ“ CREATE: `lib/providers/theme_provider.dart`

```dart
class ThemeProvider extends ChangeNotifier {
  ThemeMode _mode = ThemeMode.system;
  ThemeMode get mode => _mode;
  
  ThemeProvider() {
    _loadFromHive();
  }
  
  void setTheme(ThemeMode mode) {
    _mode = mode;
    _saveToHive(mode);
    notifyListeners();
  }
  
  void _loadFromHive() {
    final box = Hive.box('settings');
    final saved = box.get('theme_mode', defaultValue: 'system');
    _mode = {
      'light': ThemeMode.light,
      'dark': ThemeMode.dark,
      'system': ThemeMode.system,
    }[saved] ?? ThemeMode.system;
  }
  
  void _saveToHive(ThemeMode mode) {
    final box = Hive.box('settings');
    box.put('theme_mode', mode.name);
  }
}
```

---

### PART F: Wire into MaterialApp

ğŸ“ MODIFY: `lib/main.dart`

```dart
MaterialApp.router(
  title: 'JayGanga Books',
  theme: AppTheme.light(),
  darkTheme: AppTheme.dark(),
  themeMode: context.watch<ThemeProvider>().mode,
  routerConfig: router,
)
```

---

### PART G: Theme Toggle in Settings

ğŸ“ MODIFY: Settings Screen (Prompt 16)

| Element | Details |
|---------|---------|
| **Row** | "Theme" â†’ dropdown/segmented control |
| **Options** | System (default) Â· Light â˜€ï¸ Â· Dark ğŸŒ™ |
| **Preview** | Instant theme change on selection |
| **Persistence** | Saved to Hive via `ThemeProvider` |

---

ğŸ“¦ USE:
- `google_fonts` â€” Outfit (headings) + Inter (body)
- `provider` â€” ThemeProvider
- `hive_flutter` â€” persist theme mode
- Material 3 â€” `useMaterial3: true`

â›” DO NOT:
- Do NOT use default Material colors â€” use custom brand palette
- Do NOT use different font packages â€” standardize on Outfit + Inter
- Do NOT hardcode colors in widgets â€” always use `Theme.of(context).colorScheme`
- Do NOT forget to apply text theme colors for dark mode
- Do NOT use `elevation > 0` on cards â€” use border outlines for modern look
- Do NOT forget rounded corners (12px standard) on all interactive elements
- Do NOT forget to test both light AND dark themes for every screen

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”§ EXECUTE:

**Step 1:** Create `lib/theme/app_colors.dart` with brand colors + light/dark schemes
**Step 2:** Create `lib/theme/app_typography.dart` with Google Fonts
**Step 3:** Create `lib/theme/component_themes.dart` with all component overrides
**Step 4:** Create `lib/theme/app_theme.dart` assembling light() and dark()
**Step 5:** Create `lib/providers/theme_provider.dart` with Hive persistence
**Step 6:** Wire theme into `MaterialApp.router` in `main.dart`
**Step 7:** Update Settings screen theme toggle
**Step 8:** Run `flutter analyze` â€” 0 issues
**Step 9:** Test: switch to dark mode â†’ all screens render correctly, switch back â†’ light mode correct

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ… SELF-CHECK:
1. Light theme uses saffron primary with white background
2. Dark theme uses saffron primary with dark background (#121212)
3. All text is readable in both themes (proper contrast ratios)
4. Card borders visible in both themes
5. Input fields have focused + error + default states in both themes
6. Bottom nav icons use primary color when selected
7. Chips have consistent borderRadius (8px)
8. Bottom sheets have drag handle and rounded top corners
9. Snackbars float with rounded corners
10. Theme toggle in Settings works: System / Light / Dark
11. Theme persists across app restarts (Hive)
12. Google Fonts load correctly (Outfit + Inter)
13. `flutter analyze` returns 0 issues

ğŸ‘¤ USER MANUAL STEPS:
- None â€” purely frontend code

ğŸ’¬ CONFIRM IN CHAT:
"Prompt 24 complete. Theme System: Material 3 with saffron/teal/deepPurple brand, light + dark ThemeData, Outfit/Inter typography, 9 component theme overrides, ThemeProvider with Hive persistence, Settings toggle (System/Light/Dark). flutter analyze: 0 issues. Zero errors."

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â­ï¸ NEXT: Prompt 25 â€” Animations & Micro-Interactions
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ PROMPT 25 of 70
Phase: Polish & UX (PHASE_20)
Task: Page Transitions + List Animations + Shimmer Skeletons + Micro-Interactions
Type: ğŸ“± FRONTEND (Flutter)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ INSTRUCTION:
Build the **Animation & Micro-Interaction Layer** â€” custom page transitions, staggered list item animations, shimmer skeleton loaders, button press feedback, pull-to-refresh animations, Hero transitions, success/error feedback, and reusable animation utilities.

> Keep animations **subtle and fast** (150â€“300ms). The goal is to feel polished, not flashy.

---

### PART A: Page Transition Animations

ğŸ“ CREATE: `lib/utils/page_transitions.dart`

| Transition | When | Duration |
|------------|------|----------|
| **SlideUp** | Bottom sheets, modal screens | 250ms |
| **FadeThrough** | Tab switches (Home, Search, Chat, Sell, Profile) | 200ms |
| **SharedAxisX** | Forward navigation (Home â†’ Book Detail) | 300ms |
| **FadeIn** | Overlay screens (Gallery, Force Update) | 200ms |

```dart
class AppPageTransitions {
  /// Slide up from bottom
  static PageRouteBuilder slideUp(Widget page) => PageRouteBuilder(
    pageBuilder: (_, __, ___) => page,
    transitionsBuilder: (_, animation, __, child) {
      final tween = Tween(begin: const Offset(0, 0.3), end: Offset.zero)
        .chain(CurveTween(curve: Curves.easeOutCubic));
      return SlideTransition(position: animation.drive(tween), child: child);
    },
    transitionDuration: const Duration(milliseconds: 250),
  );
  
  /// Fade through (for tab switches)
  static Widget fadeThrough(Widget child, Animation<double> animation) {
    return FadeTransition(
      opacity: CurveTween(curve: Curves.easeInOut).animate(animation),
      child: child,
    );
  }
  
  /// Shared axis X (horizontal slide + fade)
  static PageRouteBuilder sharedAxisX(Widget page) => PageRouteBuilder(
    pageBuilder: (_, __, ___) => page,
    transitionsBuilder: (_, animation, secondaryAnimation, child) {
      final slideTween = Tween(begin: const Offset(0.1, 0), end: Offset.zero)
        .chain(CurveTween(curve: Curves.easeOutCubic));
      final fadeTween = Tween(begin: 0.0, end: 1.0)
        .chain(CurveTween(curve: Curves.easeIn));
      return SlideTransition(
        position: animation.drive(slideTween),
        child: FadeTransition(
          opacity: animation.drive(fadeTween),
          child: child,
        ),
      );
    },
    transitionDuration: const Duration(milliseconds: 300),
  );
}
```

**GoRouter Integration:**
```dart
GoRoute(
  path: '/book/:id',
  pageBuilder: (context, state) => CustomTransitionPage(
    child: BookDetailScreen(id: state.pathParameters['id']!),
    transitionsBuilder: (_, animation, __, child) =>
      AppPageTransitions.sharedAxisX(child)..build(context),
  ),
)
```

---

### PART B: Staggered List Item Animation

ğŸ“ CREATE: `lib/widgets/shared/animated_list_item.dart`

```dart
class AnimatedListItem extends StatelessWidget {
  final int index;
  final Widget child;
  final Duration delay;
  
  const AnimatedListItem({
    required this.index,
    required this.child,
    this.delay = const Duration(milliseconds: 50),
  });
  
  @override
  Widget build(BuildContext context) {
    return TweenAnimationBuilder<double>(
      tween: Tween(begin: 0, end: 1),
      duration: const Duration(milliseconds: 300),
      // Stagger: each item starts 50ms after the previous
      // Cap at 500ms to avoid very long delays for large lists
      curve: Curves.easeOutCubic,
      builder: (context, value, child) {
        return Opacity(
          opacity: value,
          child: Transform.translate(
            offset: Offset(0, 20 * (1 - value)),
            child: child,
          ),
        );
      },
      child: child,
    );
  }
}
```

**Usage:** Wrap each item in `ListView.builder`:
```dart
ListView.builder(
  itemBuilder: (context, index) => AnimatedListItem(
    index: index,
    child: BookCard(book: books[index]),
  ),
)
```

---

### PART C: Shimmer Skeleton Loaders

ğŸ“ CREATE: `lib/widgets/shared/shimmer_skeleton.dart`

```dart
class ShimmerSkeleton extends StatelessWidget {
  final double width;
  final double height;
  final BorderRadius? borderRadius;
  
  // ... constructor
  
  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    final baseColor = isDark ? Colors.grey[800]! : Colors.grey[300]!;
    final highlightColor = isDark ? Colors.grey[700]! : Colors.grey[100]!;
    
    return TweenAnimationBuilder<double>(
      tween: Tween(begin: -1, end: 2),
      duration: const Duration(milliseconds: 1500),
      // Repeat animation
      builder: (context, value, child) {
        return Container(
          width: width,
          height: height,
          decoration: BoxDecoration(
            borderRadius: borderRadius ?? BorderRadius.circular(8),
            gradient: LinearGradient(
              begin: Alignment(value - 1, 0),
              end: Alignment(value, 0),
              colors: [baseColor, highlightColor, baseColor],
            ),
          ),
        );
      },
    );
  }
}
```

**Preset Skeletons:**

| Skeleton | Mimics |
|----------|--------|
| `BookCardSkeleton` | Book card: image rectangle + 3 text lines + price |
| `BookListTileSkeleton` | List tile: small image + 2 text lines |
| `ChatBubbleSkeleton` | Chat message: rounded rect varying widths |
| `ProfileHeaderSkeleton` | Circle (avatar) + 2 text lines |
| `NotificationSkeleton` | Icon circle + 2 text lines |

```dart
class BookCardSkeleton extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Card(
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          ShimmerSkeleton(width: double.infinity, height: 150,
            borderRadius: BorderRadius.vertical(top: Radius.circular(12))),
          Padding(
            padding: EdgeInsets.all(12),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                ShimmerSkeleton(width: 140, height: 14),
                SizedBox(height: 8),
                ShimmerSkeleton(width: 100, height: 12),
                SizedBox(height: 8),
                ShimmerSkeleton(width: 60, height: 16),
              ],
            ),
          ),
        ],
      ),
    );
  }
}
```

---

### PART D: Button Press Micro-Interactions

ğŸ“ CREATE: `lib/widgets/shared/tap_bounce.dart`

```dart
class TapBounce extends StatefulWidget {
  final Widget child;
  final VoidCallback? onTap;
  final double scaleFactor;
  
  const TapBounce({
    required this.child,
    this.onTap,
    this.scaleFactor = 0.95,
  });
  
  @override
  State<TapBounce> createState() => _TapBounceState();
}

class _TapBounceState extends State<TapBounce>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _scale;
  
  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 100),
    );
    _scale = Tween(begin: 1.0, end: widget.scaleFactor)
      .animate(CurvedAnimation(parent: _controller, curve: Curves.easeInOut));
  }
  
  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTapDown: (_) => _controller.forward(),
      onTapUp: (_) => _controller.reverse(),
      onTapCancel: () => _controller.reverse(),
      onTap: widget.onTap,
      child: ScaleTransition(scale: _scale, child: widget.child),
    );
  }
}
```

**Apply to:** Book cards, action buttons, chip filters, category tiles.

---

### PART E: Pull-to-Refresh Animation

ğŸ“ CREATE: `lib/widgets/shared/custom_refresh_indicator.dart`

| Element | Details |
|---------|---------|
| **Indicator** | Custom saffron-colored progress indicator |
| **Icon** | Book icon that flips/rotates during pull |
| **Threshold** | Pull 80px to trigger refresh |
| **Haptic** | Light haptic feedback when threshold is reached |

Wrap all scrollable screens:
```dart
RefreshIndicator(
  onRefresh: _loadBooks,
  color: Theme.of(context).colorScheme.primary,
  child: ListView(...),
)
```

---

### PART F: Success & Error Feedback

ğŸ“ CREATE: `lib/widgets/shared/feedback_animations.dart`

| Animation | When | Duration |
|-----------|------|----------|
| **Success Checkmark** | Transaction complete, book listed, review submitted | 600ms |
| **Error Shake** | Login failed, validation error | 300ms |
| **Confetti Burst** | First sale, badge earned, referral success | 1500ms |
| **Heart Pop** | Add to wishlist | 200ms |

```dart
class SuccessCheckmark extends StatelessWidget {
  // Animated green circle that draws, then checkmark that draws inside
  // Uses CustomPainter + AnimationController
}

class ErrorShake extends StatelessWidget {
  // Shakes child widget left-right 3 times
  final Widget child;
  final bool shouldShake;
  // Uses Transform.translate with sin wave
}

class HeartPop extends StatelessWidget {
  // Scale up 1.0 â†’ 1.3 â†’ 1.0 with color change (grey â†’ red)
  final bool isActive;
}
```

---

### PART G: Hero Transitions

Apply `Hero` widget to these elements:

| Source | Destination | Tag |
|--------|-------------|-----|
| Book card image | Book detail header image | `book_image_{id}` |
| Book card title | Book detail title | `book_title_{id}` |
| User avatar (chat list) | Chat detail header avatar | `avatar_{userId}` |
| FAB icon | Sell book screen header | `sell_fab` |

```dart
// On BookCard:
Hero(
  tag: 'book_image_${book.id}',
  child: AppCachedImage.bookCover(coverUrl),
)

// On BookDetailScreen:
Hero(
  tag: 'book_image_${book.id}',
  child: AppCachedImage(imageUrl: coverUrl, height: 300),
)
```

---

### PART H: FAB Animation

ğŸ“ MODIFY: Home Screen FAB (Prompt 9)

| Animation | Details |
|-----------|---------|
| **Entrance** | Scale up from 0 â†’ 1 with elasticOut curve on screen load |
| **Scroll Hide** | Hide FAB when scrolling down, show when scrolling up |
| **Press** | Scale to 0.9 on press, back to 1.0 on release |

```dart
AnimatedSlide(
  offset: _isScrollingDown ? const Offset(0, 2) : Offset.zero,
  duration: const Duration(milliseconds: 200),
  child: FloatingActionButton.extended(
    onPressed: () => context.push('/sell'),
    icon: const Icon(Icons.add),
    label: const Text('Sell'),
  ),
)
```

---

ğŸ“¦ USE:
- Flutter built-in: `AnimationController`, `Tween`, `CurvedAnimation`, `Hero`
- Flutter built-in: `TweenAnimationBuilder`, `AnimatedSlide`, `AnimatedOpacity`
- `HapticFeedback` â€” light feedback on pull-to-refresh threshold
- No external animation packages â€” all built with Flutter primitives

â›” DO NOT:
- Do NOT make animations longer than 300ms for interactions (keep snappy)
- Do NOT animate everything â€” only key touch points
- Do NOT use `AnimatedContainer` for layout-critical elements (causes jank)
- Do NOT forget to dispose AnimationControllers
- Do NOT use `Curves.bounceOut` â€” it feels cheap. Use `easeOutCubic` or `elasticOut`
- Do NOT add shimmer to elements that load instantly
- Do NOT add stagger to lists with < 3 items
- Do NOT forget haptic feedback on important actions (wishlist, send message, confirm handover)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”§ EXECUTE:

**Step 1:** Create `lib/utils/page_transitions.dart` with 4 transition types
**Step 2:** Create `lib/widgets/shared/animated_list_item.dart`
**Step 3:** Create `lib/widgets/shared/shimmer_skeleton.dart` with 5 preset skeletons
**Step 4:** Create `lib/widgets/shared/tap_bounce.dart`
**Step 5:** Create `lib/widgets/shared/feedback_animations.dart` (checkmark, shake, heart)
**Step 6:** Apply Hero tags to BookCard â†” BookDetail, Avatar â†” ChatDetail
**Step 7:** Add FAB scroll-hide behavior to Home Screen
**Step 8:** Wire page transitions into GoRouter
**Step 9:** Run `flutter analyze` â€” 0 issues
**Step 10:** Test: open book â†’ Hero image animates, scroll list â†’ staggered fade-in, tap card â†’ bounce, wishlist â†’ heart pop

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ… SELF-CHECK:
1. Page transitions: SlideUp (250ms), FadeThrough (200ms), SharedAxisX (300ms)
2. List items stagger with 50ms delay, capped at 500ms total
3. Shimmer skeletons match layout of their real counterparts
4. Shimmer works correctly in both light and dark themes
5. TapBounce scales to 0.95 on press, back to 1.0 on release
6. Pull-to-refresh uses brand color with haptic feedback
7. Success checkmark animates green circle + check path in 600ms
8. Error shake moves left-right 3x in 300ms
9. Heart pop scales 1.0 â†’ 1.3 â†’ 1.0 with grey â†’ red color
10. Hero tags match between source and destination screens
11. FAB hides on scroll down, shows on scroll up
12. No animation exceeds 300ms for user interactions
13. All AnimationControllers properly disposed
14. `flutter analyze` returns 0 issues

ğŸ‘¤ USER MANUAL STEPS:
- None â€” purely frontend code

ğŸ’¬ CONFIRM IN CHAT:
"Prompt 25 complete. Animations: 4 page transitions (GoRouter), staggered list animation, shimmer skeletons (5 presets), TapBounce, pull-to-refresh with haptic, success/error/heart feedback, Hero transitions (book image + title + avatar), FAB scroll-hide. All < 300ms. flutter analyze: 0 issues. Zero errors."

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â­ï¸ NEXT: Prompt 26 â€” Pagination + Infinite Scroll + Pull-to-Refresh
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ PROMPT 26 of 70
Phase: Performance (PHASE_21)
Task: PocketBase Pagination + Infinite Scroll Controller + Pull-to-Refresh
Type: ğŸ“± FRONTEND (Flutter)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ INSTRUCTION:
Build the **Pagination & Infinite Scroll System** â€” a reusable paginated data fetcher using PocketBase `getList()`, a scroll controller that triggers loading more items, pull-to-refresh to reset lists, loading/end-of-list indicators, and a paginated provider pattern used across all list screens.

> **Every list in the app must be paginated.** No full-list fetches for books, chats, notifications, transactions, or reviews.

---

### PART A: Paginated Data Controller

ğŸ“ CREATE: `lib/controllers/paginated_controller.dart`

```dart
class PaginatedController<T> extends ChangeNotifier {
  final Future<ResultList<RecordModel>> Function(int page, int perPage) fetcher;
  final T Function(RecordModel record) mapper;
  
  List<T> _items = [];
  int _currentPage = 1;
  int _totalPages = 1;
  bool _isLoading = false;
  bool _hasMore = true;
  AppError? _error;
  
  // Getters
  List<T> get items => _items;
  bool get isLoading => _isLoading;
  bool get hasMore => _hasMore;
  bool get isEmpty => _items.isEmpty && !_isLoading;
  AppError? get error => _error;
  bool get isFirstLoad => _items.isEmpty && _isLoading;
  
  static const int _perPage = 20;
  
  PaginatedController({
    required this.fetcher,
    required this.mapper,
  });
  
  /// Initial load
  Future<void> loadInitial() async {
    _currentPage = 1;
    _items.clear();
    _error = null;
    _hasMore = true;
    notifyListeners();
    await _fetchPage(1);
  }
  
  /// Load next page (triggered by scroll)
  Future<void> loadMore() async {
    if (_isLoading || !_hasMore) return;
    await _fetchPage(_currentPage + 1);
  }
  
  /// Refresh (pull-to-refresh)
  Future<void> refresh() async {
    _currentPage = 1;
    _error = null;
    _hasMore = true;
    final result = await _fetchPageRaw(1);
    if (result != null) {
      _items = result;
      notifyListeners();
    }
  }
  
  Future<void> _fetchPage(int page) async {
    _isLoading = true;
    _error = null;
    notifyListeners();
    
    try {
      final result = await fetcher(page, _perPage);
      final mapped = result.items.map(mapper).toList();
      
      if (page == 1) {
        _items = mapped;
      } else {
        _items.addAll(mapped);
      }
      
      _currentPage = page;
      _totalPages = result.totalPages;
      _hasMore = page < _totalPages;
    } catch (e) {
      _error = e is AppError ? e : AppError(
        message: 'Failed to load data',
        type: ErrorType.unknown,
      );
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }
  
  /// Remove item locally (optimistic delete)
  void removeItem(T item) {
    _items.remove(item);
    notifyListeners();
  }
  
  /// Insert item at top (optimistic add)
  void insertAtTop(T item) {
    _items.insert(0, item);
    notifyListeners();
  }
}
```

---

### PART B: Infinite Scroll Widget

ğŸ“ CREATE: `lib/widgets/shared/paginated_list_view.dart`

```dart
class PaginatedListView<T> extends StatefulWidget {
  final PaginatedController<T> controller;
  final Widget Function(T item, int index) itemBuilder;
  final Widget? emptyWidget;
  final Widget? loadingWidget;
  final Widget? errorWidget;
  final EdgeInsets? padding;
  final bool isGrid;
  final int gridCrossAxisCount;
  final ScrollPhysics? physics;
  final Widget? header;
  
  // ... constructor
  
  @override
  State<PaginatedListView<T>> createState() => _PaginatedListViewState<T>();
}

class _PaginatedListViewState<T> extends State<PaginatedListView<T>> {
  final ScrollController _scrollController = ScrollController();
  
  @override
  void initState() {
    super.initState();
    _scrollController.addListener(_onScroll);
  }
  
  void _onScroll() {
    // Trigger load more when 200px from bottom
    if (_scrollController.position.pixels >=
        _scrollController.position.maxScrollExtent - 200) {
      widget.controller.loadMore();
    }
  }
  
  @override
  Widget build(BuildContext context) {
    return ListenableBuilder(
      listenable: widget.controller,
      builder: (context, _) {
        final ctrl = widget.controller;
        
        // First load
        if (ctrl.isFirstLoad) {
          return widget.loadingWidget ?? _buildSkeletonList();
        }
        
        // Error on empty
        if (ctrl.error != null && ctrl.isEmpty) {
          return ErrorStateWidget(
            error: ctrl.error!,
            onRetry: ctrl.loadInitial,
          );
        }
        
        // Empty state
        if (ctrl.isEmpty) {
          return widget.emptyWidget ?? const EmptyStateWidget();
        }
        
        // Data list
        return RefreshIndicator(
          onRefresh: ctrl.refresh,
          color: Theme.of(context).colorScheme.primary,
          child: widget.isGrid
            ? _buildGrid(ctrl)
            : _buildList(ctrl),
        );
      },
    );
  }
  
  Widget _buildList(PaginatedController<T> ctrl) {
    return ListView.builder(
      controller: _scrollController,
      padding: widget.padding,
      physics: widget.physics ?? const AlwaysScrollableScrollPhysics(),
      itemCount: ctrl.items.length + (ctrl.hasMore ? 1 : 1),
      // +1 for loading indicator or end-of-list
      itemBuilder: (context, index) {
        // Header
        if (widget.header != null && index == 0) {
          return widget.header!;
        }
        
        // Items
        if (index < ctrl.items.length) {
          return AnimatedListItem(
            index: index,
            child: widget.itemBuilder(ctrl.items[index], index),
          );
        }
        
        // Footer: loading or end
        if (ctrl.hasMore) {
          return _buildLoadingMore();
        } else {
          return _buildEndOfList();
        }
      },
    );
  }
  
  Widget _buildGrid(PaginatedController<T> ctrl) {
    return GridView.builder(
      controller: _scrollController,
      padding: widget.padding,
      gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
        crossAxisCount: widget.gridCrossAxisCount,
        childAspectRatio: 0.7,
        crossAxisSpacing: 8,
        mainAxisSpacing: 8,
      ),
      itemCount: ctrl.items.length + (ctrl.hasMore ? 1 : 0),
      itemBuilder: (context, index) {
        if (index < ctrl.items.length) {
          return AnimatedListItem(
            index: index,
            child: widget.itemBuilder(ctrl.items[index], index),
          );
        }
        return _buildLoadingMore();
      },
    );
  }
  
  Widget _buildLoadingMore() {
    return Padding(
      padding: const EdgeInsets.all(16),
      child: Center(
        child: SizedBox(width: 24, height: 24,
          child: CircularProgressIndicator(strokeWidth: 2)),
      ),
    );
  }
  
  Widget _buildEndOfList() {
    return Padding(
      padding: const EdgeInsets.all(24),
      child: Center(
        child: Text('You\'ve reached the end ğŸ“š',
          style: TextStyle(color: Colors.grey, fontSize: 13)),
      ),
    );
  }
  
  Widget _buildSkeletonList() {
    return ListView.builder(
      itemCount: 6,
      itemBuilder: (_, __) => BookCardSkeleton(),
    );
  }
}
```

---

### PART C: Usage Examples for All Screens

| Screen | Collection | Per Page | Sort | Filter |
|--------|-----------|----------|------|--------|
| **Home â€” Recently Added** | `books` | 20 | `-created` | `status = "active"` |
| **Home â€” Near You** | `books` | 10 | `-created` | `status = "active"` + client-side distance filter |
| **Search Results** | `books` | 20 | user-selected | user-applied filters |
| **Chat List** | `chats` | 20 | `-updated` | `participant = userId` |
| **Chat Messages** | `messages` | 30 | `-created` | `chat = chatId` (reverse scroll) |
| **Notifications** | `notifications` | 20 | `-created` | `user = userId` |
| **My Listings** | `books` | 20 | `-created` | `seller = userId` |
| **Transactions** | `transactions` | 15 | `-created` | `buyer = userId OR seller = userId` |
| **Reviews** | `reviews` | 10 | `-created` | `seller = userId` |
| **Wishlist** | `wishlist` | 20 | `-created` | `user = userId` |

**Example â€” Home Screen:**
```dart
final booksController = PaginatedController<Book>(
  fetcher: (page, perPage) => pb.collection('books').getList(
    page: page,
    perPage: perPage,
    sort: '-created',
    filter: 'status = "active"',
  ),
  mapper: (record) => Book.fromRecord(record),
);

@override
void initState() {
  super.initState();
  booksController.loadInitial();
}

// In build:
PaginatedListView<Book>(
  controller: booksController,
  isGrid: true,
  gridCrossAxisCount: 2,
  emptyWidget: EmptyStateWidget.noBooks(),
  itemBuilder: (book, index) => BookCard(book: book),
)
```

---

### PART D: Reverse Pagination (Chat Messages)

ğŸ“ For chat messages, we need **reverse scroll** (newest at bottom):

```dart
class ReversePaginatedController<T> extends PaginatedController<T> {
  // Same as PaginatedController but:
  // - New items added to the END of the list (bottom)
  // - loadMore fetches OLDER messages (prepends to top)
  // - Scroll listener triggers at scrollPosition.pixels <= 200 (near top)
  
  @override
  Future<void> loadMore() async {
    if (_isLoading || !_hasMore) return;
    // Fetch older page and prepend to start of list
    final result = await fetcher(_currentPage + 1, _perPage);
    final mapped = result.items.map(mapper).toList();
    _items.insertAll(0, mapped); // Prepend
    _currentPage++;
    _hasMore = _currentPage < result.totalPages;
    notifyListeners();
  }
}
```

---

### PART E: Scroll-to-Top Button

ğŸ“ CREATE: `lib/widgets/shared/scroll_to_top_button.dart`

| Element | Details |
|---------|---------|
| **When** | User scrolls down > 500px from top |
| **Where** | Bottom-left of screen, above bottom nav |
| **Look** | Small circular FAB with â†‘ arrow icon |
| **Action** | Smooth scroll to top with `animateTo(0)` |
| **Animation** | Fade in/out based on scroll position |

---

ğŸ“¦ USE:
- `pocketbase` SDK â€” `getList(page, perPage, sort, filter)` for pagination
- `provider` â€” PaginatedController as ChangeNotifier
- Flutter built-in â€” ScrollController, RefreshIndicator
- Existing â€” AnimatedListItem, ShimmerSkeleton, ErrorStateWidget, EmptyStateWidget

â›” DO NOT:
- Do NOT use `getFullList()` anywhere â€” always `getList()` with pagination
- Do NOT fetch more than 30 items per page
- Do NOT trigger `loadMore` while already loading â€” check `isLoading` first
- Do NOT forget pull-to-refresh on paginated lists
- Do NOT forget the "end of list" indicator
- Do NOT forget to handle error mid-pagination (show error at bottom, keep existing items)
- Do NOT forget reverse pagination for chat messages
- Do NOT re-fetch on tab switch if data is already loaded (cache in controller)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”§ EXECUTE:

**Step 1:** Create `lib/controllers/paginated_controller.dart`
**Step 2:** Create `lib/widgets/shared/paginated_list_view.dart` with list + grid modes
**Step 3:** Create `ReversePaginatedController` for chat messages
**Step 4:** Create `lib/widgets/shared/scroll_to_top_button.dart`
**Step 5:** Integrate pagination into Home, Search, Chat, Notifications, Listings, Transactions
**Step 6:** Run `flutter analyze` â€” 0 issues
**Step 7:** Test: scroll to bottom â†’ loading spinner â†’ new items load â†’ "end of list" shown â†’ pull to refresh resets

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ… SELF-CHECK:
1. PaginatedController tracks page, totalPages, hasMore, isLoading, error
2. Initial load shows skeleton shimmer (not blank screen)
3. Error on first load shows ErrorStateWidget with retry
4. Subsequent page error shows error at bottom, keeps existing items
5. Pull-to-refresh resets to page 1 and replaces all items
6. Infinite scroll triggers at 200px before bottom
7. "Loading more" shows small spinner at bottom
8. "End of list" shows friendly message
9. Grid mode works for book cards (2-column)
10. List mode works for chats, notifications, transactions
11. Reverse pagination works for chat messages (oldest at top loads more)
12. Scroll-to-top button appears after 500px scroll
13. Optimistic remove/insert works without re-fetching
14. Controller caches data â€” no re-fetch on tab switch
15. `flutter analyze` returns 0 issues

ğŸ‘¤ USER MANUAL STEPS:
- None â€” purely frontend code

ğŸ’¬ CONFIRM IN CHAT:
"Prompt 26 complete. Pagination: PaginatedController (loadInitial/loadMore/refresh), PaginatedListView with list+grid modes, ReversePaginatedController for chat, scroll-to-top button, shimmer on first load, end-of-list indicator. 20 items/page, 10 screens paginated. flutter analyze: 0 issues. Zero errors."

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â­ï¸ NEXT: Prompt 27 â€” Form Validation + Input Formatters
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ PROMPT 27 of 70
Phase: Forms & Input (PHASE_22)
Task: Reusable Validators + Input Formatters + Custom Form Fields
Type: ğŸ“± FRONTEND (Flutter)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ INSTRUCTION:
Build the **Form Validation & Input Layer** â€” reusable validator functions for all form fields, custom input formatters (price, phone, ISBN), styled form field widgets with integrated error display, and a form-level validation helper.

> Used by: Sell Book (P11), Edit Book (P12), Edit Profile (P16), Onboarding (P7), Chat offer system (P14), Report (P19).

---

### PART A: Validator Functions

ğŸ“ CREATE: `lib/utils/validators.dart`

```dart
class Validators {
  // Required
  static String? required(String? value, [String fieldName = 'This field']) {
    if (value == null || value.trim().isEmpty) {
      return '$fieldName is required';
    }
    return null;
  }
  
  // Min length
  static String? minLength(String? value, int min, [String fieldName = 'This field']) {
    if (value != null && value.trim().length < min) {
      return '$fieldName must be at least $min characters';
    }
    return null;
  }
  
  // Max length
  static String? maxLength(String? value, int max, [String fieldName = 'This field']) {
    if (value != null && value.trim().length > max) {
      return '$fieldName must be at most $max characters';
    }
    return null;
  }
  
  // Email
  static String? email(String? value) {
    if (value == null || value.isEmpty) return null;
    final regex = RegExp(r'^[\w\.\-]+@[\w\-]+\.[\w\.\-]+$');
    if (!regex.hasMatch(value)) return 'Enter a valid email';
    return null;
  }
  
  // Phone (Indian 10-digit)
  static String? phone(String? value) {
    if (value == null || value.isEmpty) return null;
    final digits = value.replaceAll(RegExp(r'\D'), '');
    if (digits.length != 10) return 'Enter a valid 10-digit phone number';
    if (!RegExp(r'^[6-9]').hasMatch(digits)) return 'Phone must start with 6-9';
    return null;
  }
  
  // Price (â‚¹)
  static String? price(String? value) {
    if (value == null || value.isEmpty) return 'Price is required';
    final amount = double.tryParse(value.replaceAll(',', ''));
    if (amount == null) return 'Enter a valid price';
    if (amount < 10) return 'Minimum price is â‚¹10';
    if (amount > 50000) return 'Maximum price is â‚¹50,000';
    return null;
  }
  
  // ISBN (10 or 13 digits)
  static String? isbn(String? value) {
    if (value == null || value.isEmpty) return null; // Optional
    final cleaned = value.replaceAll(RegExp(r'[\-\s]'), '');
    if (cleaned.length != 10 && cleaned.length != 13) {
      return 'ISBN must be 10 or 13 digits';
    }
    if (!RegExp(r'^\d+$').hasMatch(cleaned)) return 'ISBN must be numbers only';
    return null;
  }
  
  // Pin Code (Indian 6-digit)
  static String? pinCode(String? value) {
    if (value == null || value.isEmpty) return null;
    if (value.length != 6) return 'Pin code must be 6 digits';
    if (!RegExp(r'^[1-9]\d{5}$').hasMatch(value)) return 'Enter a valid pin code';
    return null;
  }
  
  // Name
  static String? name(String? value) {
    final req = required(value, 'Name');
    if (req != null) return req;
    final min = minLength(value, 2, 'Name');
    if (min != null) return min;
    final max = maxLength(value, 50, 'Name');
    if (max != null) return max;
    if (!RegExp(r'^[a-zA-Z\s]+$').hasMatch(value!.trim())) {
      return 'Name can only contain letters';
    }
    return null;
  }
  
  // Book Title
  static String? bookTitle(String? value) {
    final req = required(value, 'Title');
    if (req != null) return req;
    return maxLength(value, 100, 'Title');
  }
  
  // Book Description
  static String? description(String? value) {
    return maxLength(value, 500, 'Description');
  }
  
  // Offer Price
  static String? offerPrice(String? value, double listingPrice) {
    final p = price(value);
    if (p != null) return p;
    final amount = double.parse(value!.replaceAll(',', ''));
    if (amount > listingPrice) return 'Offer cannot exceed listing price';
    if (amount < listingPrice * 0.3) return 'Offer too low (min 30% of price)';
    return null;
  }
  
  // Compose validators
  static String? Function(String?) compose(List<String? Function(String?)> validators) {
    return (String? value) {
      for (final validator in validators) {
        final result = validator(value);
        if (result != null) return result;
      }
      return null;
    };
  }
}
```

---

### PART B: Input Formatters

ğŸ“ CREATE: `lib/utils/input_formatters.dart`

```dart
class AppInputFormatters {
  /// Price formatter: adds commas (1,200 â†’ â‚¹1,200)
  static TextInputFormatter price() => FilteringTextInputFormatter.allow(
    RegExp(r'[\d,]'),
  );
  
  /// Phone formatter: only digits, max 10
  static TextInputFormatter phone() => FilteringTextInputFormatter.allow(
    RegExp(r'\d'),
  );
  
  /// Pin code: only digits, max 6
  static TextInputFormatter pinCode() => LengthLimitingTextInputFormatter(6);
  
  /// ISBN: digits and hyphens
  static TextInputFormatter isbn() => FilteringTextInputFormatter.allow(
    RegExp(r'[\d\-]'),
  );
  
  /// Name: letters and spaces only
  static TextInputFormatter nameOnly() => FilteringTextInputFormatter.allow(
    RegExp(r'[a-zA-Z\s]'),
  );
  
  /// No special characters
  static TextInputFormatter alphanumeric() => FilteringTextInputFormatter.allow(
    RegExp(r'[a-zA-Z0-9\s]'),
  );
  
  /// Max length
  static TextInputFormatter maxLen(int max) =>
    LengthLimitingTextInputFormatter(max);
}
```

---

### PART C: Custom Form Field Widgets

ğŸ“ CREATE: `lib/widgets/forms/app_text_field.dart`

```dart
class AppTextField extends StatelessWidget {
  final String label;
  final String? hint;
  final TextEditingController? controller;
  final String? Function(String?)? validator;
  final List<TextInputFormatter>? formatters;
  final TextInputType? keyboardType;
  final int maxLines;
  final bool obscure;
  final Widget? prefix;
  final Widget? suffix;
  final bool readOnly;
  final VoidCallback? onTap;
  final void Function(String)? onChanged;
  final FocusNode? focusNode;
  final TextInputAction? textInputAction;
  
  // ... constructor
  
  @override
  Widget build(BuildContext context) {
    return TextFormField(
      controller: controller,
      validator: validator,
      inputFormatters: formatters,
      keyboardType: keyboardType,
      maxLines: maxLines,
      obscureText: obscure,
      readOnly: readOnly,
      onTap: onTap,
      onChanged: onChanged,
      focusNode: focusNode,
      textInputAction: textInputAction ?? TextInputAction.next,
      autovalidateMode: AutovalidateMode.onUserInteraction,
      decoration: InputDecoration(
        labelText: label,
        hintText: hint,
        prefixIcon: prefix,
        suffixIcon: suffix,
        // Error styling from theme (Prompt 24)
      ),
    );
  }
}
```

**Specialized Variants:**

ğŸ“ CREATE: `lib/widgets/forms/app_price_field.dart`
```dart
class AppPriceField extends StatelessWidget {
  // Pre-configured with:
  // - â‚¹ prefix icon
  // - Price formatter (digits + commas)
  // - Numeric keyboard
  // - Price validator
}
```

ğŸ“ CREATE: `lib/widgets/forms/app_phone_field.dart`
```dart
class AppPhoneField extends StatelessWidget {
  // Pre-configured with:
  // - +91 prefix
  // - Phone formatter (digits only, max 10)
  // - Phone keyboard
  // - Indian phone validator
}
```

ğŸ“ CREATE: `lib/widgets/forms/app_dropdown_field.dart`
```dart
class AppDropdownField<T> extends StatelessWidget {
  final String label;
  final T? value;
  final List<DropdownMenuItem<T>> items;
  final void Function(T?) onChanged;
  final String? Function(T?)? validator;
  
  // Styled to match AppTextField appearance
  // Uses DropdownButtonFormField with theme-consistent decoration
}
```

ğŸ“ CREATE: `lib/widgets/forms/app_chip_selector.dart`
```dart
class AppChipSelector extends StatelessWidget {
  final String label;
  final List<String> options;
  final String? selected;
  final void Function(String) onSelected;
  final bool allowMultiple;
  
  // Horizontal scrollable chip row
  // Selected chip uses primary color
  // Used for: condition, category, board, class
}
```

---

### PART D: Form Helper Mixin

ğŸ“ CREATE: `lib/mixins/form_mixin.dart`

```dart
mixin FormMixin<T extends StatefulWidget> on State<T> {
  final formKey = GlobalKey<FormState>();
  bool isSubmitting = false;
  
  /// Validate and submit
  Future<void> submitForm(Future<void> Function() onSubmit) async {
    if (!formKey.currentState!.validate()) {
      // Scroll to first error
      _scrollToFirstError();
      return;
    }
    
    setState(() => isSubmitting = true);
    
    try {
      await onSubmit();
    } on AppError catch (e) {
      if (e.isValidationError && e.fieldErrors != null) {
        // Map server-side field errors to form fields
        _applyServerErrors(e.fieldErrors!);
      } else {
        _showErrorSnackbar(e.message);
      }
    } finally {
      if (mounted) setState(() => isSubmitting = false);
    }
  }
  
  void _scrollToFirstError() {
    // Find the first form field with an error and scroll to it
  }
  
  void _showErrorSnackbar(String message) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(content: Text(message)),
    );
  }
}
```

---

### PART E: Forms Usage Map

| Screen | Form Fields | Validators |
|--------|------------|------------|
| **Sell Book** | title, author, description, price, ISBN, condition, category, board, class | bookTitle, required, price, isbn, required(condition) |
| **Edit Book** | same as Sell Book | same |
| **Edit Profile** | name, bio, phone, pincode, college | name, maxLength(200), phone, pinCode |
| **Onboarding** | name, phone, college, pincode | name, phone, required(college) |
| **Chat Offer** | offer price | offerPrice(listingPrice) |
| **Report** | reason (dropdown), details (optional) | required(reason), maxLength(500) |

---

ğŸ“¦ USE:
- Flutter built-in â€” `TextFormField`, `FormState`, `TextInputFormatter`
- Existing theme â€” `InputDecorationTheme` from Prompt 24
- Existing errors â€” `AppError.fieldErrors` from Prompt 23

â›” DO NOT:
- Do NOT validate on every keystroke â€” use `AutovalidateMode.onUserInteraction`
- Do NOT show validation error before user has interacted with the field
- Do NOT allow form submission while already submitting (disable button + loading)
- Do NOT forget server-side validation error mapping to form fields
- Do NOT hardcode error messages â€” use Validators class for consistency
- Do NOT forget to scroll to the first error field on validation failure
- Do NOT use generic TextFormField directly â€” always use `AppTextField` or variants

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”§ EXECUTE:

**Step 1:** Create `lib/utils/validators.dart` with all validator functions
**Step 2:** Create `lib/utils/input_formatters.dart`
**Step 3:** Create `lib/widgets/forms/app_text_field.dart`
**Step 4:** Create specialized fields: `AppPriceField`, `AppPhoneField`, `AppDropdownField`, `AppChipSelector`
**Step 5:** Create `lib/mixins/form_mixin.dart`
**Step 6:** Apply form fields to Sell Book, Edit Profile, and Onboarding screens
**Step 7:** Run `flutter analyze` â€” 0 issues
**Step 8:** Test: empty submit â†’ errors shown, invalid phone â†’ error, valid form â†’ success

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ… SELF-CHECK:
1. All validators return null on valid input, error string on invalid
2. `compose()` chains multiple validators in order
3. Price validator enforces â‚¹10â€“â‚¹50,000 range
4. Phone validator requires 10 digits starting with 6-9
5. ISBN validator accepts 10 or 13 digits
6. Pin code validator requires 6 digits starting with 1-9
7. Offer price validator blocks amounts > listing price or < 30%
8. Input formatters restrict invalid characters at keystroke level
9. `AppTextField` uses `AutovalidateMode.onUserInteraction`
10. `AppPriceField` shows â‚¹ prefix with comma formatting
11. `AppPhoneField` shows +91 prefix with digit-only input
12. `AppChipSelector` highlights selected chip with primary color
13. FormMixin scrolls to first error on failed validation
14. FormMixin maps server-side field errors to form
15. Submit button disabled + loading spinner during submission
16. `flutter analyze` returns 0 issues

ğŸ‘¤ USER MANUAL STEPS:
- None â€” purely frontend code

ğŸ’¬ CONFIRM IN CHAT:
"Prompt 27 complete. Form Validation: 12 validators (compose pattern), 6 input formatters, AppTextField + 4 variants (price/phone/dropdown/chipSelector), FormMixin with server error mapping + scroll-to-error. Applied to 6 screens. flutter analyze: 0 issues. Zero errors."

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â­ï¸ NEXT: Prompt 28 â€” Local Storage (Hive) + Offline Data Caching
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ PROMPT 28 of 70
Phase: Data Layer (PHASE_23)
Task: Hive Setup + Typed Box Managers + Cache-First Pattern + TTL Invalidation
Type: ğŸ“± FRONTEND (Flutter)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ INSTRUCTION:
Build the **Local Storage & Offline Caching Layer** â€” initialize Hive boxes, create typed box managers for each data domain, implement a cache-first loading pattern with TTL-based invalidation, and handle offline fallback for all major screens.

> **Principle:** Show cached data instantly â†’ fetch fresh data in background â†’ update UI silently. Never show a loading spinner if cached data exists.

---

### PART A: Hive Initialization

ğŸ“ MODIFY: `lib/main.dart`

```dart
Future<void> _initHive() async {
  await Hive.initFlutter();
  
  // Register adapters
  Hive.registerAdapter(CachedBookAdapter());
  Hive.registerAdapter(CachedUserAdapter());
  Hive.registerAdapter(CachedChatAdapter());
  
  // Open boxes
  await Future.wait([
    Hive.openBox('settings'),           // theme, onboarding, locale
    Hive.openBox('auth'),               // token, user ID, expiry
    Hive.openBox<CachedBook>('books_cache'),
    Hive.openBox<CachedUser>('user_cache'),
    Hive.openBox<CachedChat>('chats_cache'),
    Hive.openBox('notifications_cache'),
    Hive.openBox('search_history'),
    Hive.openBox('cache_metadata'),     // TTL timestamps
  ]);
}
```

---

### PART B: Cache Models

ğŸ“ CREATE: `lib/models/cache/cached_book.dart`

```dart
@HiveType(typeId: 10)
class CachedBook extends HiveObject {
  @HiveField(0) late String id;
  @HiveField(1) late String title;
  @HiveField(2) late String author;
  @HiveField(3) late double price;
  @HiveField(4) late String condition;
  @HiveField(5) late String coverUrl;
  @HiveField(6) late String sellerName;
  @HiveField(7) late String sellerId;
  @HiveField(8) late DateTime cachedAt;
  @HiveField(9) late String category;
  @HiveField(10) late String status;
  
  CachedBook.fromBook(Book book) {
    id = book.id;
    title = book.title;
    author = book.author;
    price = book.price;
    condition = book.condition;
    coverUrl = book.coverUrl;
    sellerName = book.sellerName;
    sellerId = book.sellerId;
    cachedAt = DateTime.now();
    category = book.category;
    status = book.status;
  }
  
  Book toBook() => Book(
    id: id, title: title, author: author,
    price: price, condition: condition,
    coverUrl: coverUrl, sellerName: sellerName,
    sellerId: sellerId, category: category,
    status: status,
  );
}
```

Similarly create: `CachedUser`, `CachedChat`.

---

### PART C: Cache Service

ğŸ“ CREATE: `lib/services/cache_service.dart`

```dart
class CacheService {
  static final CacheService _instance = CacheService._();
  factory CacheService() => _instance;
  CacheService._();
  
  // TTL Durations
  static const Duration booksTTL = Duration(minutes: 10);
  static const Duration userTTL = Duration(minutes: 30);
  static const Duration chatsTTL = Duration(minutes: 5);
  static const Duration notificationsTTL = Duration(minutes: 5);
  static const Duration configTTL = Duration(hours: 1);
  static const Duration searchHistoryTTL = Duration(days: 30);
  
  final _metaBox = Hive.box('cache_metadata');
  
  /// Check if cache is still valid
  bool isCacheValid(String key, Duration ttl) {
    final timestamp = _metaBox.get('${key}_timestamp');
    if (timestamp == null) return false;
    final cachedAt = DateTime.parse(timestamp);
    return DateTime.now().difference(cachedAt) < ttl;
  }
  
  /// Mark cache as updated
  void markUpdated(String key) {
    _metaBox.put('${key}_timestamp', DateTime.now().toIso8601String());
  }
  
  /// Invalidate specific cache
  void invalidate(String key) {
    _metaBox.delete('${key}_timestamp');
  }
  
  /// Invalidate all caches
  Future<void> invalidateAll() async {
    await _metaBox.clear();
  }
  
  /// Get total cache size (approximate)
  int getTotalCacheSize() {
    int total = 0;
    for (final boxName in ['books_cache', 'user_cache', 'chats_cache', 'notifications_cache']) {
      final box = Hive.box(boxName);
      total += box.length;
    }
    return total;
  }
  
  /// Clear all cached data (Settings â†’ Clear Cache)
  Future<void> clearAllCaches() async {
    await Hive.box<CachedBook>('books_cache').clear();
    await Hive.box<CachedUser>('user_cache').clear();
    await Hive.box<CachedChat>('chats_cache').clear();
    await Hive.box('notifications_cache').clear();
    await invalidateAll();
  }
}
```

---

### PART D: Cache-First Data Loading Pattern

ğŸ“ CREATE: `lib/services/cached_data_loader.dart`

```dart
class CachedDataLoader<T> {
  final String cacheKey;
  final Duration ttl;
  final Future<List<T>> Function() fetcher;
  final List<T> Function() cacheReader;
  final void Function(List<T>) cacheWriter;
  
  CachedDataLoader({
    required this.cacheKey,
    required this.ttl,
    required this.fetcher,
    required this.cacheReader,
    required this.cacheWriter,
  });
  
  /// Load data: cache first, then network
  Future<CachedResult<List<T>>> load({bool forceRefresh = false}) async {
    final cache = CacheService();
    
    // Step 1: Return cached data if valid (and not forced)
    if (!forceRefresh && cache.isCacheValid(cacheKey, ttl)) {
      final cached = cacheReader();
      if (cached.isNotEmpty) {
        // Return cached, but also refresh in background
        _refreshInBackground();
        return CachedResult(data: cached, source: DataSource.cache);
      }
    }
    
    // Step 2: Fetch from network
    try {
      final fresh = await fetcher();
      cacheWriter(fresh);
      cache.markUpdated(cacheKey);
      return CachedResult(data: fresh, source: DataSource.network);
    } catch (e) {
      // Step 3: On network error, fall back to stale cache
      final stale = cacheReader();
      if (stale.isNotEmpty) {
        return CachedResult(
          data: stale,
          source: DataSource.staleCache,
          error: e is AppError ? e : null,
        );
      }
      rethrow; // No cache, no network â€” let error propagate
    }
  }
  
  void _refreshInBackground() {
    fetcher().then((fresh) {
      cacheWriter(fresh);
      CacheService().markUpdated(cacheKey);
    }).catchError((_) {}); // Silent background refresh
  }
}

enum DataSource { cache, network, staleCache }

class CachedResult<T> {
  final T data;
  final DataSource source;
  final AppError? error;
  
  CachedResult({required this.data, required this.source, this.error});
  
  bool get isStale => source == DataSource.staleCache;
}
```

---

### PART E: Box Managers (Per Domain)

ğŸ“ CREATE: `lib/services/cache/book_cache_manager.dart`

```dart
class BookCacheManager {
  final _box = Hive.box<CachedBook>('books_cache');
  
  /// Cache list of books
  void cacheBooks(List<Book> books, {String section = 'home'}) {
    for (final book in books) {
      _box.put('${section}_${book.id}', CachedBook.fromBook(book));
    }
    // Limit cache to 200 items per section
    _enforceLimit(section, 200);
  }
  
  /// Get cached books for a section
  List<Book> getCachedBooks(String section) {
    return _box.values
      .where((b) => _box.keys.any((k) => k.toString().startsWith(section)))
      .map((b) => b.toBook())
      .toList();
  }
  
  /// Cache single book detail
  void cacheBookDetail(Book book) {
    _box.put('detail_${book.id}', CachedBook.fromBook(book));
  }
  
  /// Get cached book detail
  Book? getCachedBookDetail(String bookId) {
    final cached = _box.get('detail_$bookId');
    return cached?.toBook();
  }
  
  void _enforceLimit(String section, int max) {
    final keys = _box.keys
      .where((k) => k.toString().startsWith(section))
      .toList();
    if (keys.length > max) {
      final toRemove = keys.sublist(0, keys.length - max);
      for (final key in toRemove) {
        _box.delete(key);
      }
    }
  }
}
```

Similarly create:
- `UserCacheManager` â€” cache current user profile + viewed seller profiles
- `ChatCacheManager` â€” cache chat list (not messages, they're real-time)
- `SearchHistoryManager` â€” last 20 search queries + last used filters

---

### PART F: Settings Storage

ğŸ“ CREATE: `lib/services/cache/settings_manager.dart`

```dart
class SettingsManager {
  final _box = Hive.box('settings');
  
  // Theme
  ThemeMode get themeMode => ThemeMode.values.firstWhere(
    (m) => m.name == _box.get('theme_mode', defaultValue: 'system'),
    orElse: () => ThemeMode.system,
  );
  set themeMode(ThemeMode mode) => _box.put('theme_mode', mode.name);
  
  // Onboarding
  bool get isOnboardingComplete => _box.get('onboarding_complete', defaultValue: false);
  set isOnboardingComplete(bool v) => _box.put('onboarding_complete', v);
  
  // Location permission
  bool get locationAsked => _box.get('location_asked', defaultValue: false);
  set locationAsked(bool v) => _box.put('location_asked', v);
  
  // Notification permission
  bool get notificationAsked => _box.get('notification_asked', defaultValue: false);
  set notificationAsked(bool v) => _box.put('notification_asked', v);
  
  // Optional update dismissed this session
  bool get optionalUpdateDismissed => _box.get('update_dismissed', defaultValue: false);
  set optionalUpdateDismissed(bool v) => _box.put('update_dismissed', v);
  
  // Last known location
  double? get lastLat => _box.get('last_lat');
  double? get lastLng => _box.get('last_lng');
  void saveLocation(double lat, double lng) {
    _box.put('last_lat', lat);
    _box.put('last_lng', lng);
  }
  
  // Referral code used
  bool get referralUsed => _box.get('referral_used', defaultValue: false);
  set referralUsed(bool v) => _box.put('referral_used', v);
}
```

---

### PART G: Clear Cache in Settings

ğŸ“ MODIFY: Settings Screen (Prompt 16)

| Element | Details |
|---------|---------|
| **Row** | "Clear Cache" â†’ subtitle shows cache size (e.g., "42 items cached") |
| **Action** | Tap â†’ confirm dialog â†’ `CacheService().clearAllCaches()` |
| **After** | Show success snackbar "Cache cleared" |
| **Note** | Does NOT clear auth or settings â€” only data caches |

---

ğŸ“¦ USE:
- `hive_flutter` â€” typed boxes with adapters
- `build_runner` + `hive_generator` â€” generate HiveType adapters
- Existing â€” `AppError` for error fallback, connectivity monitor

â›” DO NOT:
- Do NOT cache chat messages â€” they use real-time subscriptions
- Do NOT cache sensitive data (passwords, tokens in plain boxes) â€” auth uses separate encrypted box
- Do NOT cache more than 200 items per section
- Do NOT show "loading" if cache data is available â€” show cache + silently refresh
- Do NOT forget to invalidate cache when user creates/edits/deletes a book
- Do NOT forget the "stale data" indicator when showing old cached data offline
- Do NOT use `getAt()` / `putAt()` â€” use string keys for safe lookups
- Do NOT forget to run `build_runner` to generate Hive adapters

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”§ EXECUTE:

**Step 1:** Create cache models: `CachedBook`, `CachedUser`, `CachedChat` with `@HiveType`
**Step 2:** Run `dart run build_runner build` to generate adapters
**Step 3:** Create `lib/services/cache_service.dart` with TTL logic
**Step 4:** Create `lib/services/cached_data_loader.dart` with cache-first pattern
**Step 5:** Create box managers: `BookCacheManager`, `UserCacheManager`, `ChatCacheManager`, `SearchHistoryManager`, `SettingsManager`
**Step 6:** Initialize all Hive boxes in `main.dart`
**Step 7:** Integrate cache-first loading into Home, Book Detail, Profile
**Step 8:** Add "Clear Cache" to Settings screen
**Step 9:** Run `flutter analyze` â€” 0 issues
**Step 10:** Test: load books â†’ kill network â†’ reopen app â†’ cached books shown â†’ enable network â†’ fresh data loads silently

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ… SELF-CHECK:
1. All Hive boxes open in `main.dart` before app starts
2. `CachedBook` adapter generated with `build_runner`
3. TTL durations: books 10min, user 30min, chats 5min, config 1hr
4. `isCacheValid()` returns true within TTL, false after
5. Cache-first: cached data shown instantly, network fetch in background
6. Stale cache: shown when offline with "offline" banner from Prompt 23
7. `BookCacheManager` limits cache to 200 items per section
8. `SettingsManager` stores theme, onboarding, location, permissions
9. "Clear Cache" in Settings shows item count + confirm dialog
10. Cache invalidated when book created/edited/deleted
11. Auth tokens NOT in plain Hive box â€” separate encrypted storage
12. `build_runner` runs without errors
13. `flutter analyze` returns 0 issues

ğŸ‘¤ USER MANUAL STEPS:
- None â€” purely frontend code

ğŸ’¬ CONFIRM IN CHAT:
"Prompt 28 complete. Local Storage: Hive with 8 boxes, 3 typed cache models (CachedBook/User/Chat), CacheService with TTL (10m/30m/5m/1h), CachedDataLoader (cache-first + stale fallback), 5 box managers, SettingsManager (11 keys), Clear Cache in Settings. flutter analyze: 0 issues. Zero errors."

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â­ï¸ NEXT: Prompt 29 â€” Accessibility + Localization (Hindi/English)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ PROMPT 29 of 70
Phase: Internationalization (PHASE_24)
Task: Flutter l10n (Hindi/English) + ARB Files + Accessibility Semantics + Language Toggle
Type: ğŸ“± FRONTEND (Flutter)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ INSTRUCTION:
Build the **Localization & Accessibility Layer** â€” Flutter's official `gen-l10n` system with Hindi and English ARB files, a `LocaleProvider` with Hive persistence, semantic labels for screen readers, large text support, and a language toggle in Settings.

> **Target Users:** Bihar students â€” many prefer Hindi UI. English as default, Hindi as secondary.

---

### PART A: Enable gen-l10n

ğŸ“ CREATE: `l10n.yaml` (project root)

```yaml
arb-dir: lib/l10n
template-arb-file: app_en.arb
output-localization-file: app_localizations.dart
output-class: S
nullable-getter: false
```

ğŸ“ MODIFY: `pubspec.yaml`

```yaml
dependencies:
  flutter_localizations:
    sdk: flutter
  intl: any

flutter:
  generate: true
```

---

### PART B: English ARB File

ğŸ“ CREATE: `lib/l10n/app_en.arb`

```json
{
  "@@locale": "en",
  
  "appName": "JayGanga Books",
  
  "// --- Navigation ---": "",
  "navHome": "Home",
  "navSearch": "Search",
  "navChat": "Chat",
  "navSell": "Sell",
  "navProfile": "Profile",
  
  "// --- Auth ---": "",
  "signInWithGoogle": "Sign in with Google",
  "signOut": "Sign Out",
  "signOutConfirm": "Are you sure you want to sign out?",
  
  "// --- Onboarding ---": "",
  "onboardingTitle": "Complete Your Profile",
  "onboardingName": "Full Name",
  "onboardingPhone": "Phone Number",
  "onboardingCollege": "College / University",
  "onboardingPincode": "Pin Code",
  "onboardingContinue": "Continue",
  
  "// --- Home ---": "",
  "homeGreeting": "Hi, {name}!",
  "@homeGreeting": { "placeholders": { "name": { "type": "String" } } },
  "homeRecentlyAdded": "Recently Added",
  "homeNearYou": "Near You",
  "homePopular": "Popular",
  "homeSeeAll": "See All",
  
  "// --- Search ---": "",
  "searchHint": "Search books, authors...",
  "searchNoResults": "No books found",
  "searchFilters": "Filters",
  "searchSort": "Sort By",
  "searchClearAll": "Clear All",
  
  "// --- Book ---": "",
  "bookCondition": "Condition",
  "bookConditionNew": "Like New",
  "bookConditionGood": "Good",
  "bookConditionFair": "Fair",
  "bookPrice": "Price",
  "bookAuthor": "Author",
  "bookCategory": "Category",
  "bookDescription": "Description",
  "bookSeller": "Seller",
  "bookContactSeller": "Contact Seller",
  "bookMakeOffer": "Make an Offer",
  "bookAddToWishlist": "Add to Wishlist",
  "bookRemoveFromWishlist": "Remove from Wishlist",
  "bookShare": "Share",
  "bookReport": "Report",
  "bookSold": "Sold",
  "bookDistance": "{distance} km away",
  "@bookDistance": { "placeholders": { "distance": { "type": "String" } } },
  
  "// --- Sell ---": "",
  "sellTitle": "Sell a Book",
  "sellBookTitle": "Book Title",
  "sellAuthor": "Author Name",
  "sellPrice": "Selling Price (â‚¹)",
  "sellISBN": "ISBN (optional)",
  "sellDescription": "Description (optional)",
  "sellCondition": "Book Condition",
  "sellCategory": "Category",
  "sellBoard": "Board / University",
  "sellClass": "Class / Year",
  "sellPhotos": "Add Photos",
  "sellPhotosHint": "Add up to 5 photos",
  "sellSubmit": "List for Sale",
  "sellSuccess": "Book listed successfully!",
  
  "// --- Chat ---": "",
  "chatTitle": "Messages",
  "chatEmpty": "No messages yet",
  "chatTyping": "Type a message...",
  "chatOffer": "Offer â‚¹{amount}",
  "@chatOffer": { "placeholders": { "amount": { "type": "String" } } },
  "chatOfferAccepted": "Offer Accepted",
  "chatOfferRejected": "Offer Rejected",
  
  "// --- Transaction ---": "",
  "txnTitle": "Transaction",
  "txnInitiated": "Initiated",
  "txnConfirmed": "Confirmed",
  "txnHandover": "Handover",
  "txnCompleted": "Completed",
  "txnDisputed": "Disputed",
  "txnScanQR": "Scan QR Code",
  "txnShowQR": "Show QR Code",
  "txnLeaveReview": "Leave a Review",
  
  "// --- Profile ---": "",
  "profileEdit": "Edit Profile",
  "profileMyListings": "My Listings",
  "profileWishlist": "Wishlist",
  "profileTransactions": "Transactions",
  "profileSettings": "Settings",
  "profileReferral": "Refer & Earn",
  
  "// --- Settings ---": "",
  "settingsTitle": "Settings",
  "settingsTheme": "Theme",
  "settingsThemeSystem": "System",
  "settingsThemeLight": "Light",
  "settingsThemeDark": "Dark",
  "settingsLanguage": "Language",
  "settingsNotifications": "Notifications",
  "settingsClearCache": "Clear Cache",
  "settingsCacheSize": "{count} items cached",
  "@settingsCacheSize": { "placeholders": { "count": { "type": "int" } } },
  "settingsAbout": "About",
  "settingsPrivacy": "Privacy Policy",
  "settingsTerms": "Terms of Service",
  
  "// --- Common ---": "",
  "cancel": "Cancel",
  "confirm": "Confirm",
  "delete": "Delete",
  "edit": "Edit",
  "save": "Save",
  "retry": "Retry",
  "loading": "Loading...",
  "error": "Something went wrong",
  "noInternet": "No internet connection",
  "offline": "You are offline",
  "backOnline": "Back online!",
  "endOfList": "You've reached the end",
  "pullToRefresh": "Pull to refresh"
}
```

---

### PART C: Hindi ARB File

ğŸ“ CREATE: `lib/l10n/app_hi.arb`

```json
{
  "@@locale": "hi",
  
  "appName": "à¤œà¤¯à¤—à¤‚à¤—à¤¾ à¤¬à¥à¤•à¥à¤¸",
  
  "navHome": "à¤¹à¥‹à¤®",
  "navSearch": "à¤–à¥‹à¤œà¥‡à¤‚",
  "navChat": "à¤šà¥ˆà¤Ÿ",
  "navSell": "à¤¬à¥‡à¤šà¥‡à¤‚",
  "navProfile": "à¤ªà¥à¤°à¥‹à¤«à¤¾à¤‡à¤²",
  
  "signInWithGoogle": "Google à¤¸à¥‡ à¤¸à¤¾à¤‡à¤¨ à¤‡à¤¨ à¤•à¤°à¥‡à¤‚",
  "signOut": "à¤¸à¤¾à¤‡à¤¨ à¤†à¤‰à¤Ÿ",
  "signOutConfirm": "à¤•à¥à¤¯à¤¾ à¤†à¤ª à¤¸à¤¾à¤‡à¤¨ à¤†à¤‰à¤Ÿ à¤•à¤°à¤¨à¤¾ à¤šà¤¾à¤¹à¤¤à¥‡ à¤¹à¥ˆà¤‚?",
  
  "onboardingTitle": "à¤…à¤ªà¤¨à¥€ à¤ªà¥à¤°à¥‹à¤«à¤¾à¤‡à¤² à¤ªà¥‚à¤°à¥€ à¤•à¤°à¥‡à¤‚",
  "onboardingName": "à¤ªà¥‚à¤°à¤¾ à¤¨à¤¾à¤®",
  "onboardingPhone": "à¤«à¥‹à¤¨ à¤¨à¤‚à¤¬à¤°",
  "onboardingCollege": "à¤•à¥‰à¤²à¥‡à¤œ / à¤µà¤¿à¤¶à¥à¤µà¤µà¤¿à¤¦à¥à¤¯à¤¾à¤²à¤¯",
  "onboardingPincode": "à¤ªà¤¿à¤¨ à¤•à¥‹à¤¡",
  "onboardingContinue": "à¤œà¤¾à¤°à¥€ à¤°à¤–à¥‡à¤‚",
  
  "homeGreeting": "à¤¨à¤®à¤¸à¥à¤¤à¥‡, {name}!",
  "homeRecentlyAdded": "à¤¹à¤¾à¤² à¤¹à¥€ à¤®à¥‡à¤‚ à¤œà¥‹à¤¡à¤¼à¥€ à¤—à¤ˆ",
  "homeNearYou": "à¤†à¤ªà¤•à¥‡ à¤ªà¤¾à¤¸",
  "homePopular": "à¤²à¥‹à¤•à¤ªà¥à¤°à¤¿à¤¯",
  "homeSeeAll": "à¤¸à¤­à¥€ à¤¦à¥‡à¤–à¥‡à¤‚",
  
  "searchHint": "à¤•à¤¿à¤¤à¤¾à¤¬à¥‡à¤‚, à¤²à¥‡à¤–à¤• à¤–à¥‹à¤œà¥‡à¤‚...",
  "searchNoResults": "à¤•à¥‹à¤ˆ à¤•à¤¿à¤¤à¤¾à¤¬ à¤¨à¤¹à¥€à¤‚ à¤®à¤¿à¤²à¥€",
  "searchFilters": "à¤«à¤¿à¤²à¥à¤Ÿà¤°",
  "searchSort": "à¤•à¥à¤°à¤®",
  "searchClearAll": "à¤¸à¤¬ à¤¹à¤Ÿà¤¾à¤à¤‚",
  
  "bookCondition": "à¤¸à¥à¤¥à¤¿à¤¤à¤¿",
  "bookConditionNew": "à¤¨à¤ˆ à¤œà¥ˆà¤¸à¥€",
  "bookConditionGood": "à¤…à¤šà¥à¤›à¥€",
  "bookConditionFair": "à¤ à¥€à¤•",
  "bookPrice": "à¤•à¥€à¤®à¤¤",
  "bookAuthor": "à¤²à¥‡à¤–à¤•",
  "bookCategory": "à¤¶à¥à¤°à¥‡à¤£à¥€",
  "bookDescription": "à¤µà¤¿à¤µà¤°à¤£",
  "bookSeller": "à¤µà¤¿à¤•à¥à¤°à¥‡à¤¤à¤¾",
  "bookContactSeller": "à¤µà¤¿à¤•à¥à¤°à¥‡à¤¤à¤¾ à¤¸à¥‡ à¤¸à¤‚à¤ªà¤°à¥à¤• à¤•à¤°à¥‡à¤‚",
  "bookMakeOffer": "à¤‘à¤«à¤° à¤¦à¥‡à¤‚",
  "bookAddToWishlist": "à¤µà¤¿à¤¶à¤²à¤¿à¤¸à¥à¤Ÿ à¤®à¥‡à¤‚ à¤œà¥‹à¤¡à¤¼à¥‡à¤‚",
  "bookRemoveFromWishlist": "à¤µà¤¿à¤¶à¤²à¤¿à¤¸à¥à¤Ÿ à¤¸à¥‡ à¤¹à¤Ÿà¤¾à¤à¤‚",
  "bookShare": "à¤¶à¥‡à¤¯à¤° à¤•à¤°à¥‡à¤‚",
  "bookReport": "à¤°à¤¿à¤ªà¥‹à¤°à¥à¤Ÿ à¤•à¤°à¥‡à¤‚",
  "bookSold": "à¤¬à¤¿à¤• à¤—à¤ˆ",
  "bookDistance": "{distance} km à¤¦à¥‚à¤°",
  
  "sellTitle": "à¤•à¤¿à¤¤à¤¾à¤¬ à¤¬à¥‡à¤šà¥‡à¤‚",
  "sellBookTitle": "à¤•à¤¿à¤¤à¤¾à¤¬ à¤•à¤¾ à¤¨à¤¾à¤®",
  "sellAuthor": "à¤²à¥‡à¤–à¤• à¤•à¤¾ à¤¨à¤¾à¤®",
  "sellPrice": "à¤¬à¤¿à¤•à¥à¤°à¥€ à¤®à¥‚à¤²à¥à¤¯ (â‚¹)",
  "sellISBN": "ISBN (à¤µà¥ˆà¤•à¤²à¥à¤ªà¤¿à¤•)",
  "sellDescription": "à¤µà¤¿à¤µà¤°à¤£ (à¤µà¥ˆà¤•à¤²à¥à¤ªà¤¿à¤•)",
  "sellCondition": "à¤•à¤¿à¤¤à¤¾à¤¬ à¤•à¥€ à¤¸à¥à¤¥à¤¿à¤¤à¤¿",
  "sellCategory": "à¤¶à¥à¤°à¥‡à¤£à¥€",
  "sellBoard": "à¤¬à¥‹à¤°à¥à¤¡ / à¤µà¤¿à¤¶à¥à¤µà¤µà¤¿à¤¦à¥à¤¯à¤¾à¤²à¤¯",
  "sellClass": "à¤•à¤•à¥à¤·à¤¾ / à¤µà¤°à¥à¤·",
  "sellPhotos": "à¤«à¥‹à¤Ÿà¥‹ à¤œà¥‹à¤¡à¤¼à¥‡à¤‚",
  "sellPhotosHint": "5 à¤«à¥‹à¤Ÿà¥‹ à¤¤à¤• à¤œà¥‹à¤¡à¤¼ à¤¸à¤•à¤¤à¥‡ à¤¹à¥ˆà¤‚",
  "sellSubmit": "à¤¬à¤¿à¤•à¥à¤°à¥€ à¤•à¥‡ à¤²à¤¿à¤ à¤²à¤¿à¤¸à¥à¤Ÿ à¤•à¤°à¥‡à¤‚",
  "sellSuccess": "à¤•à¤¿à¤¤à¤¾à¤¬ à¤¸à¤«à¤²à¤¤à¤¾à¤ªà¥‚à¤°à¥à¤µà¤• à¤²à¤¿à¤¸à¥à¤Ÿ à¤¹à¥‹ à¤—à¤ˆ!",
  
  "chatTitle": "à¤¸à¤‚à¤¦à¥‡à¤¶",
  "chatEmpty": "à¤•à¥‹à¤ˆ à¤¸à¤‚à¤¦à¥‡à¤¶ à¤¨à¤¹à¥€à¤‚",
  "chatTyping": "à¤¸à¤‚à¤¦à¥‡à¤¶ à¤²à¤¿à¤–à¥‡à¤‚...",
  "chatOffer": "à¤‘à¤«à¤° â‚¹{amount}",
  "chatOfferAccepted": "à¤‘à¤«à¤° à¤¸à¥à¤µà¥€à¤•à¤¾à¤°",
  "chatOfferRejected": "à¤‘à¤«à¤° à¤…à¤¸à¥à¤µà¥€à¤•à¤¾à¤°",
  
  "txnTitle": "à¤²à¥‡à¤¨à¤¦à¥‡à¤¨",
  "txnInitiated": "à¤¶à¥à¤°à¥‚ à¤•à¤¿à¤¯à¤¾",
  "txnConfirmed": "à¤ªà¥à¤·à¥à¤Ÿà¤¿ à¤¹à¥à¤ˆ",
  "txnHandover": "à¤¹à¥ˆà¤‚à¤¡à¤“à¤µà¤°",
  "txnCompleted": "à¤ªà¥‚à¤°à¤¾ à¤¹à¥à¤†",
  "txnDisputed": "à¤µà¤¿à¤µà¤¾à¤¦",
  "txnScanQR": "QR à¤•à¥‹à¤¡ à¤¸à¥à¤•à¥ˆà¤¨ à¤•à¤°à¥‡à¤‚",
  "txnShowQR": "QR à¤•à¥‹à¤¡ à¤¦à¤¿à¤–à¤¾à¤à¤‚",
  "txnLeaveReview": "à¤¸à¤®à¥€à¤•à¥à¤·à¤¾ à¤¦à¥‡à¤‚",
  
  "profileEdit": "à¤ªà¥à¤°à¥‹à¤«à¤¾à¤‡à¤² à¤¬à¤¦à¤²à¥‡à¤‚",
  "profileMyListings": "à¤®à¥‡à¤°à¥€ à¤²à¤¿à¤¸à¥à¤Ÿà¤¿à¤‚à¤—",
  "profileWishlist": "à¤µà¤¿à¤¶à¤²à¤¿à¤¸à¥à¤Ÿ",
  "profileTransactions": "à¤²à¥‡à¤¨à¤¦à¥‡à¤¨",
  "profileSettings": "à¤¸à¥‡à¤Ÿà¤¿à¤‚à¤—à¥à¤¸",
  "profileReferral": "à¤°à¥‡à¤«à¤° à¤•à¤°à¥‡à¤‚ à¤”à¤° à¤•à¤®à¤¾à¤à¤‚",
  
  "settingsTitle": "à¤¸à¥‡à¤Ÿà¤¿à¤‚à¤—à¥à¤¸",
  "settingsTheme": "à¤¥à¥€à¤®",
  "settingsThemeSystem": "à¤¸à¤¿à¤¸à¥à¤Ÿà¤®",
  "settingsThemeLight": "à¤²à¤¾à¤‡à¤Ÿ",
  "settingsThemeDark": "à¤¡à¤¾à¤°à¥à¤•",
  "settingsLanguage": "à¤­à¤¾à¤·à¤¾",
  "settingsNotifications": "à¤¸à¥‚à¤šà¤¨à¤¾à¤à¤‚",
  "settingsClearCache": "à¤•à¥ˆà¤¶ à¤¸à¤¾à¤« à¤•à¤°à¥‡à¤‚",
  "settingsCacheSize": "{count} à¤†à¤‡à¤Ÿà¤® à¤•à¥ˆà¤¶à¥à¤¡",
  "settingsAbout": "à¤à¤ª à¤•à¥‡ à¤¬à¤¾à¤°à¥‡ à¤®à¥‡à¤‚",
  "settingsPrivacy": "à¤—à¥‹à¤ªà¤¨à¥€à¤¯à¤¤à¤¾ à¤¨à¥€à¤¤à¤¿",
  "settingsTerms": "à¤¸à¥‡à¤µà¤¾ à¤•à¥€ à¤¶à¤°à¥à¤¤à¥‡à¤‚",
  
  "cancel": "à¤°à¤¦à¥à¤¦ à¤•à¤°à¥‡à¤‚",
  "confirm": "à¤ªà¥à¤·à¥à¤Ÿà¤¿ à¤•à¤°à¥‡à¤‚",
  "delete": "à¤¹à¤Ÿà¤¾à¤à¤‚",
  "edit": "à¤¬à¤¦à¤²à¥‡à¤‚",
  "save": "à¤¸à¤¹à¥‡à¤œà¥‡à¤‚",
  "retry": "à¤ªà¥à¤¨à¤ƒ à¤ªà¥à¤°à¤¯à¤¾à¤¸ à¤•à¤°à¥‡à¤‚",
  "loading": "à¤²à¥‹à¤¡ à¤¹à¥‹ à¤°à¤¹à¤¾ à¤¹à¥ˆ...",
  "error": "à¤•à¥à¤› à¤—à¤²à¤¤ à¤¹à¥‹ à¤—à¤¯à¤¾",
  "noInternet": "à¤‡à¤‚à¤Ÿà¤°à¤¨à¥‡à¤Ÿ à¤•à¤¨à¥‡à¤•à¥à¤¶à¤¨ à¤¨à¤¹à¥€à¤‚ à¤¹à¥ˆ",
  "offline": "à¤†à¤ª à¤‘à¤«à¤²à¤¾à¤‡à¤¨ à¤¹à¥ˆà¤‚",
  "backOnline": "à¤µà¤¾à¤ªà¤¸ à¤‘à¤¨à¤²à¤¾à¤‡à¤¨!",
  "endOfList": "à¤¸à¥‚à¤šà¥€ à¤•à¤¾ à¤…à¤‚à¤¤",
  "pullToRefresh": "à¤°à¤¿à¤«à¥à¤°à¥‡à¤¶ à¤•à¥‡ à¤²à¤¿à¤ à¤–à¥€à¤‚à¤šà¥‡à¤‚"
}
```

---

### PART D: Locale Provider

ğŸ“ CREATE: `lib/providers/locale_provider.dart`

```dart
class LocaleProvider extends ChangeNotifier {
  Locale _locale = const Locale('en');
  Locale get locale => _locale;
  
  LocaleProvider() {
    _loadFromHive();
  }
  
  void setLocale(Locale locale) {
    _locale = locale;
    _saveToHive(locale);
    notifyListeners();
  }
  
  void _loadFromHive() {
    final box = Hive.box('settings');
    final code = box.get('locale', defaultValue: 'en');
    _locale = Locale(code);
  }
  
  void _saveToHive(Locale locale) {
    final box = Hive.box('settings');
    box.put('locale', locale.languageCode);
  }
}
```

---

### PART E: Wire into MaterialApp

ğŸ“ MODIFY: `lib/main.dart`

```dart
MaterialApp.router(
  title: 'JayGanga Books',
  locale: context.watch<LocaleProvider>().locale,
  supportedLocales: S.supportedLocales,
  localizationsDelegates: S.localizationsDelegates,
  theme: AppTheme.light(),
  darkTheme: AppTheme.dark(),
  themeMode: context.watch<ThemeProvider>().mode,
  routerConfig: router,
)
```

**Usage in widgets:**
```dart
Text(S.of(context).navHome)       // "Home" or "à¤¹à¥‹à¤®"
Text(S.of(context).homeGreeting('Jay'))  // "Hi, Jay!" or "à¤¨à¤®à¤¸à¥à¤¤à¥‡, Jay!"
Text(S.of(context).bookDistance('3.2'))   // "3.2 km away" or "3.2 km à¤¦à¥‚à¤°"
```

---

### PART F: Language Toggle in Settings

ğŸ“ MODIFY: Settings Screen (Prompt 16)

| Element | Details |
|---------|---------|
| **Row** | "Language" / "à¤­à¤¾à¤·à¤¾" â†’ segmented control |
| **Options** | English Â· à¤¹à¤¿à¤¨à¥à¤¦à¥€ |
| **Behavior** | Instant switch, entire app re-renders |
| **Persistence** | Saved to Hive via `LocaleProvider` |
| **Default** | English |

---

### PART G: Accessibility Semantics

Apply `Semantics` labels to key interactive elements:

| Widget | Semantic Label |
|--------|---------------|
| **BookCard** | `"${book.title} by ${book.author}, â‚¹${book.price}, ${book.condition}"` |
| **WishlistButton** | `"Add ${book.title} to wishlist"` / `"Remove from wishlist"` |
| **ChatBubble** | `"Message from ${sender}: ${text}"` |
| **BottomNav items** | Already via label property |
| **FAB** | `"Sell a book"` |
| **Distance chip** | `"${distance} kilometers away"` |
| **Star rating** | `"Rated ${rating} out of 5 stars"` |

```dart
Semantics(
  label: '${book.title} by ${book.author}, ${book.price} rupees',
  child: BookCard(book: book),
)
```

**Additional accessibility:**
- All images have `semanticLabel` set
- Touchable areas minimum **48x48dp** (Material guideline)
- Color contrast ratios meet **WCAG AA** (4.5:1 for text)
- Form fields have proper `labelText` (not just `hintText`)

---

ğŸ“¦ USE:
- `flutter_localizations` â€” official l10n support
- `intl` â€” date/number formatting
- `flutter generate` / `gen-l10n` â€” auto-generate `S` class
- `hive_flutter` â€” persist locale choice

â›” DO NOT:
- Do NOT hardcode any user-facing string â€” always use `S.of(context).key`
- Do NOT use third-party l10n packages â€” Flutter's built-in `gen-l10n` is standard
- Do NOT forget to add `{placeholder}` syntax in ARB for dynamic values
- Do NOT translate technical terms (ISBN, QR Code, Google) â€” keep them as-is
- Do NOT forget `Semantics` on book cards, buttons, and navigation
- Do NOT make touch targets smaller than 48x48dp

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”§ EXECUTE:

**Step 1:** Create `l10n.yaml` in project root
**Step 2:** Add `flutter_localizations` and `intl` to `pubspec.yaml`
**Step 3:** Create `lib/l10n/app_en.arb` with all English strings
**Step 4:** Create `lib/l10n/app_hi.arb` with all Hindi strings
**Step 5:** Run `flutter gen-l10n` to generate `S` class
**Step 6:** Create `lib/providers/locale_provider.dart`
**Step 7:** Wire locale + delegates into `MaterialApp.router`
**Step 8:** Add language toggle to Settings screen
**Step 9:** Replace all hardcoded strings with `S.of(context).key`
**Step 10:** Add `Semantics` labels to BookCard, WishlistButton, FAB, ChatBubble
**Step 11:** Run `flutter analyze` â€” 0 issues
**Step 12:** Test: switch to Hindi â†’ entire app in Hindi â†’ switch back â†’ English

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ… SELF-CHECK:
1. `l10n.yaml` config generates `S` class with `S.of(context)` access
2. English ARB has 120+ keys covering all screens
3. Hindi ARB has matching 120+ keys with proper translations
4. Placeholders work: `homeGreeting('Jay')` â†’ "Hi, Jay!" / "à¤¨à¤®à¤¸à¥à¤¤à¥‡, Jay!"
5. `LocaleProvider` persists choice in Hive
6. Language toggle in Settings switches instantly
7. Default locale is English
8. All user-facing strings use `S.of(context)` â€” zero hardcoded text
9. `Semantics` added to BookCard, buttons, FAB, ratings
10. Touch targets â‰¥ 48x48dp
11. Color contrast meets WCAG AA (4.5:1)
12. Technical terms (ISBN, QR, Google) not translated
13. `flutter gen-l10n` generates without errors
14. `flutter analyze` returns 0 issues

ğŸ‘¤ USER MANUAL STEPS:
- None â€” purely frontend code

ğŸ’¬ CONFIRM IN CHAT:
"Prompt 29 complete. Localization: gen-l10n with English + Hindi ARBs (120+ keys each), LocaleProvider (Hive), language toggle in Settings. Accessibility: Semantics on 7 widget types, 48dp touch targets, WCAG AA contrast. flutter analyze: 0 issues. Zero errors."

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â­ï¸ NEXT: Prompt 30 â€” Analytics + Event Tracking (Firebase Analytics)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ PROMPT 30 of 70
Phase: Analytics & Monitoring (PHASE_25)
Task: Firebase Analytics + Custom Events + Screen Tracking + User Properties
Type: ğŸ“± FRONTEND (Flutter) + ğŸ”§ CONFIG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ INSTRUCTION:
Build the **Analytics & Event Tracking Layer** â€” Firebase Analytics integration, an `AnalyticsService` wrapper for clean event logging, automatic screen tracking via `RouteObserver`, custom business events for all key user actions, user property tracking, and funnel events for conversion analysis.

> **Goal:** Track every meaningful user action to understand behavior, measure funnels, and optimize the app post-launch.

---

### PART A: Firebase Analytics Setup

ğŸ“ MODIFY: `pubspec.yaml`

```yaml
dependencies:
  firebase_analytics: ^11.0.0
```

ğŸ“ MODIFY: `lib/main.dart`

```dart
// Firebase already initialized from Prompt 17 (FCM)
// Analytics is automatically enabled when firebase_analytics is added
```

---

### PART B: Analytics Service

ğŸ“ CREATE: `lib/services/analytics_service.dart`

```dart
class AnalyticsService {
  static final AnalyticsService _instance = AnalyticsService._();
  factory AnalyticsService() => _instance;
  AnalyticsService._();
  
  final _analytics = FirebaseAnalytics.instance;
  
  // â”€â”€â”€ Screen Tracking â”€â”€â”€
  FirebaseAnalyticsObserver get observer =>
    FirebaseAnalyticsObserver(analytics: _analytics);
  
  Future<void> logScreenView(String screenName) async {
    await _analytics.logScreenView(screenName: screenName);
  }
  
  // â”€â”€â”€ User Properties â”€â”€â”€
  Future<void> setUserProperties({
    required String userId,
    String? college,
    String? city,
    String? pinCode,
    int? totalListings,
    int? totalPurchases,
    String? referralSource,
  }) async {
    await _analytics.setUserId(id: userId);
    if (college != null) {
      await _analytics.setUserProperty(name: 'college', value: college);
    }
    if (city != null) {
      await _analytics.setUserProperty(name: 'city', value: city);
    }
    if (pinCode != null) {
      await _analytics.setUserProperty(name: 'pin_code', value: pinCode);
    }
    if (totalListings != null) {
      await _analytics.setUserProperty(
        name: 'total_listings',
        value: totalListings.toString(),
      );
    }
  }
  
  // â”€â”€â”€ Auth Events â”€â”€â”€
  Future<void> logLogin() async {
    await _analytics.logLogin(loginMethod: 'google');
  }
  
  Future<void> logSignUp() async {
    await _analytics.logSignUp(signUpMethod: 'google');
  }
  
  Future<void> logLogout() async {
    await _logEvent('logout');
  }
  
  // â”€â”€â”€ Onboarding Events â”€â”€â”€
  Future<void> logOnboardingStart() async {
    await _logEvent('onboarding_start');
  }
  
  Future<void> logOnboardingComplete({
    required String college,
    required String pinCode,
  }) async {
    await _logEvent('onboarding_complete', {
      'college': college,
      'pin_code': pinCode,
    });
  }
  
  // â”€â”€â”€ Book Events â”€â”€â”€
  Future<void> logViewBook({
    required String bookId,
    required String category,
    required double price,
    required String condition,
  }) async {
    await _analytics.logViewItem(
      items: [AnalyticsEventItem(
        itemId: bookId,
        itemCategory: category,
        price: price,
      )],
    );
  }
  
  Future<void> logListBook({
    required String bookId,
    required String category,
    required double price,
    required String condition,
    required int photoCount,
  }) async {
    await _logEvent('list_book', {
      'book_id': bookId,
      'category': category,
      'price': price,
      'condition': condition,
      'photo_count': photoCount,
    });
  }
  
  Future<void> logEditBook(String bookId) async {
    await _logEvent('edit_book', {'book_id': bookId});
  }
  
  Future<void> logDeleteBook(String bookId) async {
    await _logEvent('delete_book', {'book_id': bookId});
  }
  
  Future<void> logMarkAsSold(String bookId) async {
    await _logEvent('mark_as_sold', {'book_id': bookId});
  }
  
  // â”€â”€â”€ Search Events â”€â”€â”€
  Future<void> logSearch(String query, int resultCount) async {
    await _analytics.logSearch(searchTerm: query);
    await _logEvent('search_results', {
      'query': query,
      'result_count': resultCount,
    });
  }
  
  Future<void> logFilterApplied(Map<String, dynamic> filters) async {
    await _logEvent('filter_applied', filters);
  }
  
  Future<void> logSortChanged(String sortBy) async {
    await _logEvent('sort_changed', {'sort_by': sortBy});
  }
  
  // â”€â”€â”€ Wishlist Events â”€â”€â”€
  Future<void> logAddToWishlist(String bookId, double price) async {
    await _analytics.logAddToWishlist(
      items: [AnalyticsEventItem(itemId: bookId, price: price)],
    );
  }
  
  Future<void> logRemoveFromWishlist(String bookId) async {
    await _logEvent('remove_from_wishlist', {'book_id': bookId});
  }
  
  // â”€â”€â”€ Chat Events â”€â”€â”€
  Future<void> logStartChat({
    required String bookId,
    required String sellerId,
  }) async {
    await _logEvent('start_chat', {
      'book_id': bookId,
      'seller_id': sellerId,
    });
  }
  
  Future<void> logSendMessage(String chatId) async {
    await _logEvent('send_message', {'chat_id': chatId});
  }
  
  Future<void> logMakeOffer({
    required String bookId,
    required double offerAmount,
    required double listingPrice,
  }) async {
    await _logEvent('make_offer', {
      'book_id': bookId,
      'offer_amount': offerAmount,
      'listing_price': listingPrice,
      'discount_percent': ((1 - offerAmount / listingPrice) * 100).round(),
    });
  }
  
  Future<void> logOfferResponse(String bookId, bool accepted) async {
    await _logEvent('offer_response', {
      'book_id': bookId,
      'accepted': accepted,
    });
  }
  
  // â”€â”€â”€ Transaction Events â”€â”€â”€
  Future<void> logTransactionInitiated({
    required String transactionId,
    required String bookId,
    required double amount,
  }) async {
    await _logEvent('transaction_initiated', {
      'transaction_id': transactionId,
      'book_id': bookId,
      'amount': amount,
    });
  }
  
  Future<void> logQRScanned(String transactionId) async {
    await _logEvent('qr_scanned', {'transaction_id': transactionId});
  }
  
  Future<void> logTransactionCompleted({
    required String transactionId,
    required double amount,
  }) async {
    await _analytics.logPurchase(
      transactionId: transactionId,
      value: amount,
      currency: 'INR',
    );
  }
  
  Future<void> logReviewSubmitted({
    required String transactionId,
    required int rating,
  }) async {
    await _logEvent('review_submitted', {
      'transaction_id': transactionId,
      'rating': rating,
    });
  }
  
  // â”€â”€â”€ Referral Events â”€â”€â”€
  Future<void> logShareReferral(String method) async {
    await _analytics.logShare(
      contentType: 'referral',
      itemId: 'referral_code',
      method: method,
    );
  }
  
  Future<void> logReferralUsed(String referralCode) async {
    await _logEvent('referral_used', {'code': referralCode});
  }
  
  // â”€â”€â”€ Share Events â”€â”€â”€
  Future<void> logShareBook(String bookId, String method) async {
    await _analytics.logShare(
      contentType: 'book',
      itemId: bookId,
      method: method,
    );
  }
  
  // â”€â”€â”€ Report Events â”€â”€â”€
  Future<void> logReport(String type, String reason) async {
    await _logEvent('report_submitted', {
      'type': type,
      'reason': reason,
    });
  }
  
  // â”€â”€â”€ Settings Events â”€â”€â”€
  Future<void> logThemeChanged(String theme) async {
    await _logEvent('theme_changed', {'theme': theme});
  }
  
  Future<void> logLanguageChanged(String language) async {
    await _logEvent('language_changed', {'language': language});
  }
  
  // â”€â”€â”€ Private Helper â”€â”€â”€
  Future<void> _logEvent(String name, [Map<String, Object>? params]) async {
    await _analytics.logEvent(name: name, parameters: params);
  }
}
```

---

### PART C: Auto Screen Tracking

ğŸ“ MODIFY: GoRouter setup (Prompt 8)

```dart
GoRouter(
  observers: [AnalyticsService().observer],
  routes: [...],
)
```

This auto-logs every screen navigation. Additionally, for tab-based screens, manually call:

```dart
// In Home/Search/Chat/Sell/Profile tab switch:
AnalyticsService().logScreenView('home_tab');
AnalyticsService().logScreenView('search_tab');
```

---

### PART D: Event Integration Points

| Screen | Event | When |
|--------|-------|------|
| **Splash** | `logLogin` / `logSignUp` | After Google OAuth |
| **Onboarding** | `onboarding_start`, `onboarding_complete` | Screen open / form submit |
| **Home** | `logScreenView('home')` | Tab opened |
| **Book Detail** | `logViewBook` | Screen opened |
| **Sell Book** | `logListBook` | Form submitted successfully |
| **Edit Book** | `logEditBook` | Save pressed |
| **Search** | `logSearch`, `logFilterApplied`, `logSortChanged` | Query/filter/sort action |
| **Wishlist** | `logAddToWishlist`, `logRemoveFromWishlist` | Heart button press |
| **Chat** | `logStartChat`, `logSendMessage` | Chat opened / message sent |
| **Offer** | `logMakeOffer`, `logOfferResponse` | Offer sent / accepted/rejected |
| **Transaction** | `logTransactionInitiated`, `logQRScanned`, `logTransactionCompleted` | Each step |
| **Review** | `logReviewSubmitted` | Review posted |
| **Share** | `logShareBook`, `logShareReferral` | Share action |
| **Report** | `logReport` | Report submitted |
| **Settings** | `logThemeChanged`, `logLanguageChanged` | Toggle changed |
| **Referral** | `logReferralUsed` | Code applied |

---

### PART E: Key Funnels to Track

| Funnel | Steps |
|--------|-------|
| **New User** | `sign_up` â†’ `onboarding_start` â†’ `onboarding_complete` |
| **Buyer** | `view_item` â†’ `start_chat` â†’ `make_offer` â†’ `transaction_initiated` â†’ `purchase` |
| **Seller** | `list_book` â†’ (wait) â†’ `offer_response` â†’ `transaction_initiated` â†’ `purchase` |
| **Engagement** | `search` â†’ `view_item` â†’ `add_to_wishlist` / `start_chat` |

---

ğŸ“¦ USE:
- `firebase_analytics` â€” Firebase Analytics SDK
- `firebase_core` â€” already added in Prompt 17
- GoRouter `observers` â€” auto screen tracking

â›” DO NOT:
- Do NOT log PII (personal identifiable info) â€” no email, phone, or name in events
- Do NOT log more than 25 custom parameters per event (Firebase limit)
- Do NOT log events with names starting with `firebase_` or `google_` (reserved)
- Do NOT log high-frequency events (e.g., every keystroke) â€” only meaningful actions
- Do NOT forget to set user properties after login for segmentation
- Do NOT block UI for analytics â€” all calls are fire-and-forget
- Do NOT log in debug mode excessively â€” use `setAnalyticsCollectionEnabled(false)` in debug

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”§ EXECUTE:

**Step 1:** Add `firebase_analytics` to `pubspec.yaml`
**Step 2:** Create `lib/services/analytics_service.dart` with all event methods
**Step 3:** Add `AnalyticsService().observer` to GoRouter
**Step 4:** Integrate events into all screens (see table above)
**Step 5:** Set user properties after login/onboarding
**Step 6:** Disable analytics collection in debug: `kDebugMode ? setAnalyticsCollectionEnabled(false) : null`
**Step 7:** Run `flutter analyze` â€” 0 issues
**Step 8:** Test: perform actions â†’ check Firebase Console DebugView â†’ events appearing

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ… SELF-CHECK:
1. `firebase_analytics` added and initialized
2. AnalyticsService is singleton â€” one instance app-wide
3. GoRouter observer auto-tracks all screen views
4. Tab switches manually log screen views
5. 30+ custom events covering auth, books, search, chat, transactions, referral, settings
6. User properties set: userId, college, city, pinCode, totalListings
7. Standard events used where applicable (logLogin, logSignUp, logPurchase, logSearch, logShare)
8. Custom events use snake_case naming
9. No PII logged in any event parameter
10. Funnels trackable: new user, buyer, seller, engagement
11. Analytics disabled in debug mode
12. All analytics calls are async fire-and-forget (no await blocking UI)
13. `flutter analyze` returns 0 issues

ğŸ‘¤ USER MANUAL STEPS:
1. **Firebase Console** â†’ Enable Analytics (should be auto-enabled)
2. **Firebase Console** â†’ DebugView â†’ enable debug device for testing
3. **Firebase Console** â†’ Create custom funnels (New User, Buyer, Seller) after launch

ğŸ’¬ CONFIRM IN CHAT:
"Prompt 30 complete. Analytics: Firebase Analytics with AnalyticsService singleton, GoRouter observer (auto screen tracking), 30+ custom events (auth/books/search/chat/txn/referral/settings), user properties (5 fields), 4 funnels defined. Debug mode disabled. flutter analyze: 0 issues. Zero errors."

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â­ï¸ NEXT: Prompt 31 â€” Crashlytics + Performance Monitoring
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ PROMPT 31 of 70
Phase: Analytics & Monitoring (PHASE_25)
Task: Firebase Crashlytics + Performance Monitoring + Error Logging + Custom Traces
Type: ğŸ“± FRONTEND (Flutter) + ğŸ”§ CONFIG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ INSTRUCTION:
Build the **Crash Reporting & Performance Monitoring Layer** â€” Firebase Crashlytics for automatic crash reports + non-fatal error logging, Performance Monitoring with custom traces for API calls and screen render times, and integration with the existing error handling system (Prompt 23).

> **Goal:** Know exactly when the app crashes, for whom, and which API calls are slow â€” before users complain.

---

### PART A: Dependencies

ğŸ“ MODIFY: `pubspec.yaml`

```yaml
dependencies:
  firebase_crashlytics: ^4.0.0
  firebase_performance: ^0.10.0
```

---

### PART B: Crashlytics Initialization

ğŸ“ MODIFY: `lib/main.dart`

```dart
void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await Firebase.initializeApp();
  
  // â”€â”€â”€ Crashlytics Setup â”€â”€â”€
  // Pass all uncaught Flutter errors to Crashlytics
  FlutterError.onError = FirebaseCrashlytics.instance.recordFlutterFatalError;
  
  // Pass all uncaught async errors to Crashlytics
  PlatformDispatcher.instance.onError = (error, stack) {
    FirebaseCrashlytics.instance.recordError(error, stack, fatal: true);
    return true;
  };
  
  // Disable in debug mode
  if (kDebugMode) {
    await FirebaseCrashlytics.instance.setCrashlyticsCollectionEnabled(false);
  }
  
  await _initHive();
  runApp(const JayGangaApp());
}
```

---

### PART C: Crash Service

ğŸ“ CREATE: `lib/services/crash_service.dart`

```dart
class CrashService {
  static final CrashService _instance = CrashService._();
  factory CrashService() => _instance;
  CrashService._();
  
  final _crashlytics = FirebaseCrashlytics.instance;
  
  /// Set user identifier for crash reports
  Future<void> setUser(String userId) async {
    await _crashlytics.setUserIdentifier(userId);
  }
  
  /// Clear user on logout
  Future<void> clearUser() async {
    await _crashlytics.setUserIdentifier('');
  }
  
  /// Log non-fatal error (API errors, validation failures, etc.)
  Future<void> logError(
    dynamic error,
    StackTrace? stackTrace, {
    String? reason,
    Map<String, String>? context,
  }) async {
    // Add context keys
    if (context != null) {
      for (final entry in context.entries) {
        await _crashlytics.setCustomKey(entry.key, entry.value);
      }
    }
    
    await _crashlytics.recordError(
      error,
      stackTrace,
      reason: reason ?? 'Non-fatal error',
      fatal: false,
    );
  }
  
  /// Log breadcrumb message (trail of events before a crash)
  Future<void> log(String message) async {
    await _crashlytics.log(message);
  }
  
  /// Set custom keys for context
  Future<void> setContext(String key, String value) async {
    await _crashlytics.setCustomKey(key, value);
  }
  
  /// Log when entering a screen (breadcrumb)
  Future<void> logScreen(String screenName) async {
    await _crashlytics.log('Screen: $screenName');
    await _crashlytics.setCustomKey('last_screen', screenName);
  }
  
  /// Force a test crash (debug only)
  void testCrash() {
    if (kDebugMode) {
      _crashlytics.crash();
    }
  }
}
```

---

### PART D: Integrate with Error Handling (Prompt 23)

ğŸ“ MODIFY: `lib/services/api_interceptor.dart` (from Prompt 23)

Add Crashlytics logging to the global error interceptor:

```dart
// Inside the API error interceptor catch block:
catch (e, stackTrace) {
  // Log to Crashlytics as non-fatal
  CrashService().logError(
    e,
    stackTrace,
    reason: 'API call failed',
    context: {
      'endpoint': endpoint,
      'method': method,
      'status_code': statusCode.toString(),
    },
  );
  
  // Continue with existing error handling...
}
```

ğŸ“ MODIFY: `lib/widgets/error_boundary.dart` (from Prompt 23)

```dart
// When ErrorBoundary catches an error:
@override
void onError(FlutterErrorDetails details) {
  CrashService().logError(
    details.exception,
    details.stack,
    reason: 'ErrorBoundary caught: ${details.context}',
  );
  super.onError(details);
}
```

---

### PART E: Performance Monitoring Service

ğŸ“ CREATE: `lib/services/performance_service.dart`

```dart
class PerformanceService {
  static final PerformanceService _instance = PerformanceService._();
  factory PerformanceService() => _instance;
  PerformanceService._();
  
  final _performance = FirebasePerformance.instance;
  
  /// Track API call performance
  Future<T> trackApiCall<T>({
    required String name,
    required String url,
    required String method,
    required Future<T> Function() apiCall,
  }) async {
    final metric = _performance.newHttpMetric(url, _toMethod(method));
    await metric.start();
    
    try {
      final result = await apiCall();
      metric.responsePayloadSize = _estimateSize(result);
      metric.httpResponseCode = 200;
      await metric.stop();
      return result;
    } catch (e) {
      metric.httpResponseCode = _extractStatusCode(e);
      await metric.stop();
      rethrow;
    }
  }
  
  /// Track custom operation (e.g., image compression, cache read)
  Future<T> trackOperation<T>({
    required String name,
    Map<String, String>? attributes,
    required Future<T> Function() operation,
  }) async {
    final trace = _performance.newTrace(name);
    if (attributes != null) {
      for (final entry in attributes.entries) {
        trace.putAttribute(entry.key, entry.value);
      }
    }
    await trace.start();
    
    try {
      final result = await operation();
      trace.setMetric('success', 1);
      await trace.stop();
      return result;
    } catch (e) {
      trace.setMetric('success', 0);
      await trace.stop();
      rethrow;
    }
  }
  
  /// Track screen render time
  Trace startScreenTrace(String screenName) {
    final trace = _performance.newTrace('screen_$screenName');
    trace.start();
    return trace;
  }
  
  HttpMethod _toMethod(String method) {
    switch (method.toUpperCase()) {
      case 'GET': return HttpMethod.Get;
      case 'POST': return HttpMethod.Post;
      case 'PUT': return HttpMethod.Put;
      case 'PATCH': return HttpMethod.Patch;
      case 'DELETE': return HttpMethod.Delete;
      default: return HttpMethod.Get;
    }
  }
  
  int _extractStatusCode(dynamic error) {
    if (error is AppError) return error.statusCode ?? 500;
    return 500;
  }
  
  int _estimateSize(dynamic result) {
    if (result is String) return result.length;
    if (result is List) return result.length * 100; // estimate
    return 0;
  }
}
```

---

### PART F: Performance Integration Points

| Operation | Trace Name | Where |
|-----------|-----------|-------|
| **Fetch Books** | `api_get_books` | Home screen load |
| **Fetch Book Detail** | `api_get_book_detail` | Book detail screen |
| **Create Book** | `api_create_book` | Sell book submit |
| **Search** | `api_search` | Search query |
| **Send Message** | `api_send_message` | Chat send |
| **Image Compress** | `image_compression` | Before upload |
| **Image Upload** | `api_upload_image` | File upload |
| **Auth Flow** | `google_auth` | Login process |
| **Home Screen Render** | `screen_home` | initState â†’ build complete |
| **Book Detail Render** | `screen_book_detail` | initState â†’ build complete |

```dart
// Example: wrap API call with performance tracking
final books = await PerformanceService().trackApiCall(
  name: 'get_books',
  url: '${PocketBase.url}/api/collections/books/records',
  method: 'GET',
  apiCall: () => bookService.getBooks(page: 1),
);

// Example: track image compression
final compressed = await PerformanceService().trackOperation(
  name: 'image_compression',
  attributes: {'preset': 'thumbnail'},
  operation: () => imageService.compress(file),
);
```

---

### PART G: Crashlytics Context Trail

Log breadcrumbs at key user actions so crashes have context:

```dart
// In NavigatorObserver or GoRouter redirect:
CrashService().logScreen('home');
CrashService().logScreen('book_detail');

// Before important operations:
CrashService().log('User listing book: $bookId');
CrashService().log('User starting transaction: $txnId');
CrashService().log('User sending message in chat: $chatId');
```

---

ğŸ“¦ USE:
- `firebase_crashlytics` â€” crash reporting
- `firebase_performance` â€” performance traces + HTTP metrics
- `firebase_core` â€” already added
- Existing â€” `AppError` (Prompt 23), ErrorBoundary (Prompt 23)

â›” DO NOT:
- Do NOT enable Crashlytics collection in debug mode â€” noisy
- Do NOT log PII in custom keys â€” no email, phone, or name
- Do NOT create traces for trivial operations (< 10ms)
- Do NOT forget to call `metric.stop()` / `trace.stop()` â€” leaks resources
- Do NOT use `FirebaseCrashlytics.instance.crash()` in production â€” test only
- Do NOT forget to set userId on Crashlytics after login
- Do NOT block UI thread for performance traces â€” they are async

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”§ EXECUTE:

**Step 1:** Add `firebase_crashlytics` + `firebase_performance` to `pubspec.yaml`
**Step 2:** Configure Crashlytics in `main.dart` (FlutterError.onError + PlatformDispatcher)
**Step 3:** Create `lib/services/crash_service.dart`
**Step 4:** Create `lib/services/performance_service.dart`
**Step 5:** Integrate CrashService into API interceptor (Prompt 23)
**Step 6:** Integrate CrashService into ErrorBoundary (Prompt 23)
**Step 7:** Wrap key API calls with `PerformanceService.trackApiCall()`
**Step 8:** Add breadcrumb logs at screen transitions and key actions
**Step 9:** Set user ID on Crashlytics after login, clear on logout
**Step 10:** Run `flutter analyze` â€” 0 issues
**Step 11:** Test: force a crash in debug â†’ verify in Firebase Console (next day)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ… SELF-CHECK:
1. `firebase_crashlytics` + `firebase_performance` added
2. `FlutterError.onError` routes to Crashlytics
3. `PlatformDispatcher.onError` catches async errors
4. Crashlytics disabled in debug mode (`kDebugMode`)
5. CrashService singleton with `setUser`, `logError`, `log`, `logScreen`
6. Non-fatal API errors logged with endpoint + status code context
7. ErrorBoundary widget sends caught errors to Crashlytics
8. PerformanceService tracks API calls with HTTP metrics
9. Custom traces for image compression, screen renders
10. Breadcrumb trail logged for screens + key actions
11. No PII in custom keys or breadcrumbs
12. All traces properly stopped (start â†’ stop)
13. User ID set on login, cleared on logout
14. `flutter analyze` returns 0 issues

ğŸ‘¤ USER MANUAL STEPS:
1. **Firebase Console** â†’ Crashlytics â†’ verify integration after first crash
2. **Firebase Console** â†’ Performance â†’ check API latency metrics after launch
3. Add **Crashlytics Gradle plugin** if not already: `com.google.firebase.crashlytics` in `android/app/build.gradle`

ğŸ’¬ CONFIRM IN CHAT:
"Prompt 31 complete. Crashlytics: auto crash catch (Flutter + async), CrashService (non-fatal + breadcrumbs + context keys), ErrorBoundary integration. Performance: PerformanceService (API HTTP metrics + custom traces), 10 trace points. Debug disabled. flutter analyze: 0 issues. Zero errors."

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â­ï¸ NEXT: Prompt 32 â€” Deep Linking + Dynamic Links
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ PROMPT 32 of 70
Phase: Navigation & Links (PHASE_26)
Task: Android App Links + iOS Universal Links + GoRouter Deep Linking + Share URLs
Type: ğŸ“± FRONTEND (Flutter) + ğŸ”§ CONFIG (Android/iOS)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ INSTRUCTION:
Build the **Deep Linking Layer** â€” configure Android App Links and iOS Universal Links for `api.jayganga.com`, handle deep link routing in GoRouter, generate shareable URLs for books/referrals/profiles, and support deferred deep linking for new installs.

> **Domain:** `api.jayganga.com`
> **Link Patterns:** `/book/{id}`, `/referral/{code}`, `/profile/{id}`, `/search?q={query}`

---

### PART A: Android App Links

ğŸ“ MODIFY: `android/app/src/main/AndroidManifest.xml`

```xml
<activity android:name=".MainActivity"
  android:launchMode="singleTop">
  
  <!-- Deep Links -->
  <intent-filter android:autoVerify="true">
    <action android:name="android.intent.action.VIEW" />
    <category android:name="android.intent.category.DEFAULT" />
    <category android:name="android.intent.category.BROWSABLE" />
    <data
      android:scheme="https"
      android:host="api.jayganga.com" />
  </intent-filter>
  
  <!-- Custom scheme for development -->
  <intent-filter>
    <action android:name="android.intent.action.VIEW" />
    <category android:name="android.intent.category.DEFAULT" />
    <category android:name="android.intent.category.BROWSABLE" />
    <data
      android:scheme="jayganga"
      android:host="books" />
  </intent-filter>
</activity>
```

ğŸ“ CREATE: `.well-known/assetlinks.json` (host on `api.jayganga.com`)

```json
[{
  "relation": ["delegate_permission/common.handle_all_urls"],
  "target": {
    "namespace": "android_app",
    "package_name": "com.jayganga.books",
    "sha256_cert_fingerprints": ["<YOUR_SHA256_FINGERPRINT>"]
  }
}]
```

---

### PART B: iOS Universal Links

ğŸ“ MODIFY: `ios/Runner/Runner.entitlements`

```xml
<key>com.apple.developer.associated-domains</key>
<array>
  <string>applinks:api.jayganga.com</string>
</array>
```

ğŸ“ CREATE: `.well-known/apple-app-site-association` (host on `api.jayganga.com`)

```json
{
  "applinks": {
    "apps": [],
    "details": [{
      "appID": "<TEAM_ID>.com.jayganga.books",
      "paths": ["/book/*", "/referral/*", "/profile/*", "/search*"]
    }]
  }
}
```

---

### PART C: Deep Link Router Integration

ğŸ“ MODIFY: GoRouter setup (Prompt 8)

```dart
final router = GoRouter(
  initialLocation: '/',
  observers: [AnalyticsService().observer],
  
  // Deep link handling is automatic with GoRouter
  // URL paths map directly to routes
  
  routes: [
    // ... existing routes ...
    
    // Deep link routes
    GoRoute(
      path: '/book/:id',
      builder: (context, state) {
        final bookId = state.pathParameters['id']!;
        return BookDetailScreen(bookId: bookId);
      },
    ),
    
    GoRoute(
      path: '/referral/:code',
      redirect: (context, state) {
        final code = state.pathParameters['code']!;
        // Store referral code for processing after auth
        ReferralService().storeIncomingCode(code);
        // Redirect to home (or onboarding if new user)
        return '/';
      },
    ),
    
    GoRoute(
      path: '/profile/:id',
      builder: (context, state) {
        final userId = state.pathParameters['id']!;
        return SellerProfileScreen(userId: userId);
      },
    ),
    
    GoRoute(
      path: '/search',
      builder: (context, state) {
        final query = state.uri.queryParameters['q'] ?? '';
        return SearchScreen(initialQuery: query);
      },
    ),
  ],
);
```

---

### PART D: Deep Link Service

ğŸ“ CREATE: `lib/services/deep_link_service.dart`

```dart
class DeepLinkService {
  static final DeepLinkService _instance = DeepLinkService._();
  factory DeepLinkService() => _instance;
  DeepLinkService._();
  
  static const String _baseUrl = 'https://api.jayganga.com';
  
  /// Generate book share URL
  String bookUrl(String bookId) => '$_baseUrl/book/$bookId';
  
  /// Generate referral share URL
  String referralUrl(String referralCode) => '$_baseUrl/referral/$referralCode';
  
  /// Generate profile share URL
  String profileUrl(String userId) => '$_baseUrl/profile/$userId';
  
  /// Generate search share URL
  String searchUrl(String query) =>
    '$_baseUrl/search?q=${Uri.encodeComponent(query)}';
  
  /// Parse incoming deep link to route
  String? parseDeepLink(Uri uri) {
    // Handle both https://api.jayganga.com and jayganga://books
    if (uri.host == 'api.jayganga.com' || uri.host == 'books') {
      return uri.path + (uri.query.isNotEmpty ? '?${uri.query}' : '');
    }
    return null;
  }
  
  /// Handle deferred deep link (new install)
  Future<void> handleDeferredDeepLink() async {
    final box = Hive.box('settings');
    final pendingLink = box.get('pending_deep_link');
    if (pendingLink != null) {
      box.delete('pending_deep_link');
      // Navigate to the pending link after auth
      GoRouter.of(navigatorKey.currentContext!).go(pendingLink);
    }
  }
  
  /// Store deep link for processing after auth/onboarding
  void storePendingLink(String path) {
    final box = Hive.box('settings');
    box.put('pending_deep_link', path);
  }
}
```

---

### PART E: Share Integration

ğŸ“ MODIFY: Book Detail Screen (Prompt 10)

```dart
// Share button action
void _shareBook(Book book) {
  final url = DeepLinkService().bookUrl(book.id);
  Share.share(
    'ğŸ“š Check out "${book.title}" by ${book.author} for â‚¹${book.price.toInt()} on JayGanga Books!\n\n$url',
    subject: book.title,
  );
  
  AnalyticsService().logShareBook(book.id, 'share_sheet');
}
```

ğŸ“ MODIFY: Referral Screen (Prompt 18)

```dart
// Share referral
void _shareReferral(String code) {
  final url = DeepLinkService().referralUrl(code);
  Share.share(
    'ğŸ Join JayGanga Books and get â‚¹50 off your first book! Use my code: $code\n\n$url',
    subject: 'JayGanga Books Referral',
  );
  
  AnalyticsService().logShareReferral('share_sheet');
}
```

---

### PART F: Deferred Deep Link Flow

For users who don't have the app installed:

```
User taps link â†’ Browser opens api.jayganga.com/book/abc123
  â†’ Play Store / App Store redirect page shown
    â†’ User installs app
      â†’ App opens â†’ checks stored pending link
        â†’ Navigates to /book/abc123
```

ğŸ“ CREATE: Web landing page (static HTML hosted on `api.jayganga.com`)

```html
<!-- api.jayganga.com/book/{id} -->
<!-- Simple meta redirect page with app store links -->
<html>
<head>
  <meta property="og:title" content="Book on JayGanga Books" />
  <meta property="og:description" content="Buy & sell used books near you" />
  <meta property="og:image" content="https://api.jayganga.com/og-image.png" />
  <script>
    // Try to open in app, fallback to Play Store
    const appLink = 'jayganga://books' + window.location.pathname;
    const playStore = 'https://play.google.com/store/apps/details?id=com.jayganga.books';
    
    window.location = appLink;
    setTimeout(() => { window.location = playStore; }, 500);
  </script>
</head>
<body>
  <h1>Opening JayGanga Books...</h1>
  <p><a href="playStore">Download from Play Store</a></p>
</body>
</html>
```

---

### PART G: Deep Link Routes Map

| URL Pattern | Screen | Params |
|-------------|--------|--------|
| `/book/{id}` | BookDetailScreen | bookId |
| `/referral/{code}` | Home (code stored) | referralCode |
| `/profile/{id}` | SellerProfileScreen | userId |
| `/search?q={query}` | SearchScreen | initialQuery |
| `/` | HomeScreen | â€” |

---

ğŸ“¦ USE:
- GoRouter â€” built-in deep link handling
- `share_plus` â€” native share sheet
- `app_links` â€” for initial link + stream handling on Android/iOS
- Static HTML â€” web landing page for non-app users

â›” DO NOT:
- Do NOT use Firebase Dynamic Links â€” deprecated, use native app links instead
- Do NOT hardcode URLs â€” always use `DeepLinkService` constants
- Do NOT forget `android:autoVerify="true"` for App Links
- Do NOT forget `assetlinks.json` + `apple-app-site-association` on the server
- Do NOT lose deep link on auth redirect â€” store as pending link
- Do NOT forget to handle the case where bookId doesn't exist (show "not found")
- Do NOT forget Open Graph meta tags on the web landing page for social media previews

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”§ EXECUTE:

**Step 1:** Configure Android App Links in `AndroidManifest.xml`
**Step 2:** Configure iOS Universal Links in `Runner.entitlements`
**Step 3:** Create `lib/services/deep_link_service.dart`
**Step 4:** Add deep link routes to GoRouter (book, referral, profile, search)
**Step 5:** Integrate share URLs into Book Detail + Referral screens
**Step 6:** Implement deferred deep link flow (store pending â†’ process after auth)
**Step 7:** Create static web landing page for `api.jayganga.com`
**Step 8:** Run `flutter analyze` â€” 0 issues
**Step 9:** Test: open `https://api.jayganga.com/book/test123` â†’ app opens to book detail

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ… SELF-CHECK:
1. `android:autoVerify="true"` set in intent-filter
2. Both `https` and custom `jayganga://` schemes handled
3. `assetlinks.json` structure is valid with correct package name
4. `apple-app-site-association` covers all 4 path patterns
5. GoRouter handles `/book/:id`, `/referral/:code`, `/profile/:id`, `/search`
6. `DeepLinkService` generates correct URLs for book/referral/profile/search
7. Referral deep link stores code and redirects to home
8. Share text includes readable message + deep link URL
9. Deferred deep link stored in Hive, processed after auth
10. Web landing page has OG meta tags for social previews
11. Web landing page tries app link first, falls back to Play Store
12. 404-like "Book not found" state when deep link points to deleted book
13. `flutter analyze` returns 0 issues

ğŸ‘¤ USER MANUAL STEPS:
1. **VPS:** Host `assetlinks.json` at `https://api.jayganga.com/.well-known/assetlinks.json`
2. **VPS:** Host `apple-app-site-association` at `https://api.jayganga.com/.well-known/apple-app-site-association`
3. **VPS:** Host static landing page HTML for `/book/*`, `/referral/*`, `/profile/*`
4. **Android:** Get SHA256 fingerprint from keystore: `keytool -list -v -keystore keystore.jks`
5. **iOS:** Add Associated Domains capability in Xcode + Apple Developer Portal

ğŸ’¬ CONFIRM IN CHAT:
"Prompt 32 complete. Deep Linking: Android App Links + iOS Universal Links for api.jayganga.com, 4 route patterns (/book, /referral, /profile, /search), DeepLinkService (URL gen + parsing), deferred deep link (pending â†’ auth â†’ navigate), share integration, web landing page with OG tags. flutter analyze: 0 issues. Zero errors."

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â­ï¸ NEXT: Prompt 33 â€” Security Hardening (SSL Pinning + Secure Storage + Obfuscation)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ PROMPT 33 of 70
Phase: Security (PHASE_27)
Task: SSL Pinning + Secure Storage + Obfuscation + API Key Protection + Root Detection
Type: ğŸ“± FRONTEND (Flutter) + ğŸ”§ CONFIG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ INSTRUCTION:
Build the **Security Hardening Layer** â€” SSL certificate pinning for PocketBase API, encrypted storage for auth tokens, Dart code obfuscation for release builds, API key protection via `--dart-define`, and root/jailbreak detection with appropriate warnings.

> **Goal:** Prevent man-in-the-middle attacks, protect user credentials, make reverse-engineering harder, and detect compromised devices.

---

### PART A: Secure Token Storage

ğŸ“ MODIFY: `pubspec.yaml`

```yaml
dependencies:
  flutter_secure_storage: ^9.0.0
```

ğŸ“ CREATE: `lib/services/secure_storage_service.dart`

```dart
class SecureStorageService {
  static final SecureStorageService _instance = SecureStorageService._();
  factory SecureStorageService() => _instance;
  SecureStorageService._();
  
  final _storage = const FlutterSecureStorage(
    aOptions: AndroidOptions(encryptedSharedPreferences: true),
    iOptions: IOSOptions(accessibility: KeychainAccessibility.first_unlock),
  );
  
  // â”€â”€â”€ Auth Token â”€â”€â”€
  static const _tokenKey = 'pb_auth_token';
  static const _userIdKey = 'pb_user_id';
  static const _tokenExpiryKey = 'pb_token_expiry';
  
  Future<void> saveAuthToken(String token, String userId, DateTime expiry) async {
    await Future.wait([
      _storage.write(key: _tokenKey, value: token),
      _storage.write(key: _userIdKey, value: userId),
      _storage.write(key: _tokenExpiryKey, value: expiry.toIso8601String()),
    ]);
  }
  
  Future<String?> getAuthToken() async {
    final token = await _storage.read(key: _tokenKey);
    if (token == null) return null;
    
    // Check expiry
    final expiryStr = await _storage.read(key: _tokenExpiryKey);
    if (expiryStr != null) {
      final expiry = DateTime.parse(expiryStr);
      if (DateTime.now().isAfter(expiry)) {
        await clearAuth(); // Token expired
        return null;
      }
    }
    return token;
  }
  
  Future<String?> getUserId() async => _storage.read(key: _userIdKey);
  
  Future<void> clearAuth() async {
    await Future.wait([
      _storage.delete(key: _tokenKey),
      _storage.delete(key: _userIdKey),
      _storage.delete(key: _tokenExpiryKey),
    ]);
  }
  
  /// Clear everything (account deletion)
  Future<void> clearAll() async {
    await _storage.deleteAll();
  }
}
```

---

### PART B: SSL Certificate Pinning

ğŸ“ CREATE: `lib/services/pinned_http_client.dart`

```dart
class PinnedHttpClient {
  /// SHA-256 fingerprint of api.jayganga.com SSL certificate
  /// Update this when renewing the SSL certificate
  static const String _expectedFingerprint = '<YOUR_SSL_SHA256_FINGERPRINT>';
  
  static HttpClient createPinnedClient() {
    final client = HttpClient();
    client.badCertificateCallback = (cert, host, port) {
      // In debug mode, allow all certificates
      if (kDebugMode) return true;
      
      // In production, verify certificate fingerprint
      final fingerprint = sha256.convert(cert.der).toString();
      return fingerprint == _expectedFingerprint;
    };
    return client;
  }
}
```

ğŸ“ MODIFY: PocketBase client initialization

```dart
// Use pinned HTTP client for PocketBase
final pb = PocketBase(
  AppConfig.pocketbaseUrl,
  httpClientFactory: () => PinnedHttpClient.createPinnedClient(),
);
```

> **Note:** For Let's Encrypt certificates (auto-renewed every 90 days), consider pinning the intermediate CA certificate instead of the leaf certificate, or use a certificate transparency approach.

---

### PART C: API Key Protection via --dart-define

ğŸ“ CREATE: `lib/config/app_config.dart`

```dart
class AppConfig {
  // All sensitive values loaded from --dart-define at build time
  // NEVER hardcoded in source code
  
  static const String pocketbaseUrl = String.fromEnvironment(
    'PB_URL',
    defaultValue: 'http://localhost:8090', // dev only
  );
  
  static const String googleClientId = String.fromEnvironment(
    'GOOGLE_CLIENT_ID',
    defaultValue: '',
  );
  
  static const String googleClientIdIos = String.fromEnvironment(
    'GOOGLE_CLIENT_ID_IOS',
    defaultValue: '',
  );
  
  static bool get isProduction =>
    const String.fromEnvironment('ENV', defaultValue: 'dev') == 'prod';
}
```

ğŸ“ Build command:

```bash
flutter build apk --release \
  --dart-define=PB_URL=https://api.jayganga.com/api \
  --dart-define=GOOGLE_CLIENT_ID=<your-id> \
  --dart-define=ENV=prod
```

---

### PART D: Code Obfuscation

ğŸ“ Build with obfuscation enabled:

```bash
flutter build apk --release \
  --obfuscate \
  --split-debug-info=build/debug-info/
```

**What this does:**
- Renames all Dart classes, methods, variables to meaningless names
- Generates a symbol map in `build/debug-info/` for crash report translation
- Makes reverse-engineering significantly harder

**Upload debug symbols to Crashlytics:**
```bash
firebase crashlytics:symbols:upload --app=<FIREBASE_APP_ID> build/debug-info/
```

---

### PART E: Root/Jailbreak Detection

ğŸ“ MODIFY: `pubspec.yaml`

```yaml
dependencies:
  flutter_jailbreak_detection: ^1.10.0
```

ğŸ“ CREATE: `lib/services/device_security_service.dart`

```dart
class DeviceSecurityService {
  static Future<bool> isDeviceCompromised() async {
    try {
      return await FlutterJailbreakDetection.jailbroken;
    } catch (_) {
      return false; // Can't determine
    }
  }
  
  /// Show warning if device is rooted/jailbroken
  static Future<void> checkAndWarn(BuildContext context) async {
    if (await isDeviceCompromised()) {
      showDialog(
        context: context,
        barrierDismissible: false,
        builder: (ctx) => AlertDialog(
          title: const Text('Security Warning'),
          content: const Text(
            'Your device appears to be rooted/jailbroken. '
            'This may compromise the security of your account. '
            'Proceed with caution.',
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.pop(ctx),
              child: const Text('I Understand'),
            ),
          ],
        ),
      );
      
      // Log to analytics
      AnalyticsService().logEvent('rooted_device_detected');
      CrashService().setContext('rooted_device', 'true');
    }
  }
}
```

ğŸ“ Call in `main.dart` after app launch:
```dart
// After first frame renders:
WidgetsBinding.instance.addPostFrameCallback((_) {
  DeviceSecurityService.checkAndWarn(context);
});
```

---

### PART F: Additional Security Measures

**1. Prevent screenshots on sensitive screens:**
```dart
// On transaction/payment screens:
SystemChrome.setEnabledSystemUIMode(SystemUiMode.manual, overlays: []);
// Use FLAG_SECURE on Android
```

**2. Session timeout:**
```dart
// Auto-logout after 30 days of inactivity
class SessionManager {
  static const _lastActiveKey = 'last_active';
  static const _sessionTimeout = Duration(days: 30);
  
  static void updateActivity() {
    Hive.box('settings').put(_lastActiveKey, DateTime.now().toIso8601String());
  }
  
  static bool isSessionExpired() {
    final lastActive = Hive.box('settings').get(_lastActiveKey);
    if (lastActive == null) return false;
    return DateTime.now().difference(DateTime.parse(lastActive)) > _sessionTimeout;
  }
}
```

**3. Input sanitization:**
```dart
// Already handled in Validators (Prompt 27)
// Additional: strip HTML/script tags from all text inputs
static String sanitize(String input) {
  return input.replaceAll(RegExp(r'<[^>]*>'), ''); // Strip HTML tags
}
```

---

### PART G: Security Audit Checklist

| Area | Check | Status |
|------|-------|--------|
| **Auth tokens** | Stored in FlutterSecureStorage (encrypted) | âœ… |
| **API keys** | Loaded via `--dart-define` (not in source) | âœ… |
| **SSL** | Certificate pinning enabled for production | âœ… |
| **Code** | Obfuscation + split debug info | âœ… |
| **Root detection** | Warning shown on compromised devices | âœ… |
| **Session** | Auto-logout after 30 days inactivity | âœ… |
| **Input** | All inputs validated + sanitized (P27) | âœ… |
| **API rules** | PocketBase collection rules restrict access (P4) | âœ… |
| **Passwords** | No passwords stored â€” Google OAuth only | âœ… |
| **PII** | Not logged in analytics/crashlytics (P30/P31) | âœ… |

---

ğŸ“¦ USE:
- `flutter_secure_storage` â€” encrypted key-value storage
- `flutter_jailbreak_detection` â€” root/jailbreak check
- `crypto` (dart) â€” SHA256 for cert fingerprint
- `--dart-define` â€” build-time environment variables
- `--obfuscate` â€” Dart code obfuscation

â›” DO NOT:
- Do NOT store auth tokens in SharedPreferences or plain Hive â€” use FlutterSecureStorage
- Do NOT hardcode API keys, URLs, or client IDs in source code
- Do NOT ship debug builds to production â€” always use `--release`
- Do NOT forget to upload obfuscation symbols to Crashlytics
- Do NOT block rooted users entirely â€” warn only (some legitimate users root phones)
- Do NOT pin leaf SSL certificate if using Let's Encrypt (rotates every 90 days) â€” pin intermediate CA
- Do NOT forget to update the pinned fingerprint when SSL certificate is renewed

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”§ EXECUTE:

**Step 1:** Add `flutter_secure_storage` + `flutter_jailbreak_detection` to `pubspec.yaml`
**Step 2:** Create `lib/services/secure_storage_service.dart`
**Step 3:** Migrate auth token storage from Hive to SecureStorage
**Step 4:** Create `lib/services/pinned_http_client.dart` with cert pinning
**Step 5:** Create `lib/config/app_config.dart` with `--dart-define` values
**Step 6:** Create `lib/services/device_security_service.dart`
**Step 7:** Add session timeout check on app resume
**Step 8:** Update build scripts with `--obfuscate --split-debug-info`
**Step 9:** Run `flutter analyze` â€” 0 issues
**Step 10:** Test: build release APK â†’ verify obfuscation â†’ verify secure storage works

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ… SELF-CHECK:
1. Auth tokens stored in `FlutterSecureStorage` with Android encrypted prefs
2. iOS keychain accessibility set to `first_unlock`
3. Token expiry checked on read â€” expired tokens auto-cleared
4. SSL pinning active in production, bypassed in debug
5. PocketBase client uses pinned HTTP client factory
6. All sensitive config via `--dart-define` â€” zero hardcoded secrets
7. `AppConfig.isProduction` flag controls debug/prod behavior
8. Build command includes `--obfuscate --split-debug-info`
9. Root/jailbreak detection shows warning dialog (not blocking)
10. Session timeout at 30 days inactivity
11. HTML tags stripped from all text inputs
12. Security audit checklist: all 10 items âœ…
13. `flutter analyze` returns 0 issues

ğŸ‘¤ USER MANUAL STEPS:
1. **SSL fingerprint:** Run `openssl s_client -connect api.jayganga.com:443` to get SHA256 fingerprint
2. **Replace** `<YOUR_SSL_SHA256_FINGERPRINT>` in `pinned_http_client.dart`
3. **Build command:** Add `--dart-define` values to CI/CD pipeline or local build script
4. **Crashlytics:** Upload `build/debug-info/` symbols after each release build
5. **Google Client ID:** Get from Google Cloud Console â†’ OAuth 2.0 credentials

ğŸ’¬ CONFIRM IN CHAT:
"Prompt 33 complete. Security: FlutterSecureStorage (encrypted auth tokens + auto-expiry), SSL cert pinning (prod only), AppConfig with --dart-define (0 hardcoded secrets), code obfuscation (--obfuscate + split-debug-info), root detection (warning dialog), session timeout (30d), input sanitization. Security audit: 10/10 items âœ…. flutter analyze: 0 issues. Zero errors."

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â­ï¸ NEXT: Prompt 34 â€” App Permissions Handler + Permission Flow
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ PROMPT 34 of 70
Phase: Platform Integration (PHASE_28)
Task: Permission Handler + Contextual Permission Requests + Rationale Dialogs
Type: ğŸ“± FRONTEND (Flutter) + ğŸ”§ CONFIG (Android/iOS)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ INSTRUCTION:
Build the **App Permissions Layer** â€” a unified `PermissionService` using `permission_handler`, contextual pre-ask dialogs that explain why each permission is needed before the OS prompt, graceful denial handling with redirect to Settings, and integration across all features that need permissions.

> **Permissions needed:** Camera (book photos), Photo Gallery (pick images), Location (nearby books), Notifications (FCM push).

---

### PART A: Dependencies & Platform Config

ğŸ“ MODIFY: `pubspec.yaml`

```yaml
dependencies:
  permission_handler: ^11.0.0
```

ğŸ“ MODIFY: `android/app/src/main/AndroidManifest.xml`

```xml
<!-- Camera -->
<uses-permission android:name="android.permission.CAMERA" />

<!-- Gallery / Photos -->
<uses-permission android:name="android.permission.READ_MEDIA_IMAGES" />
<uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"
  android:maxSdkVersion="32" />

<!-- Location -->
<uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
<uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />

<!-- Notifications (Android 13+) -->
<uses-permission android:name="android.permission.POST_NOTIFICATIONS" />
```

ğŸ“ MODIFY: `ios/Runner/Info.plist`

```xml
<key>NSCameraUsageDescription</key>
<string>JayGanga Books needs camera access to take photos of your books for listing.</string>

<key>NSPhotoLibraryUsageDescription</key>
<string>JayGanga Books needs photo access to select book images from your gallery.</string>

<key>NSLocationWhenInUseUsageDescription</key>
<string>JayGanga Books uses your location to show books available near you.</string>
```

---

### PART B: Permission Service

ğŸ“ CREATE: `lib/services/permission_service.dart`

```dart
class PermissionService {
  static final PermissionService _instance = PermissionService._();
  factory PermissionService() => _instance;
  PermissionService._();
  
  /// Request camera permission with pre-ask dialog
  Future<bool> requestCamera(BuildContext context) async {
    return _requestPermission(
      context: context,
      permission: Permission.camera,
      title: 'Camera Access',
      message: 'We need camera access to take photos of your books. '
               'Great photos help sell books faster!',
      icon: Icons.camera_alt_outlined,
      settingsKey: 'camera_asked',
    );
  }
  
  /// Request photo gallery permission
  Future<bool> requestGallery(BuildContext context) async {
    return _requestPermission(
      context: context,
      permission: Permission.photos,
      title: 'Photo Access',
      message: 'We need access to your photos to select book images '
               'from your gallery.',
      icon: Icons.photo_library_outlined,
      settingsKey: 'gallery_asked',
    );
  }
  
  /// Request location permission
  Future<bool> requestLocation(BuildContext context) async {
    return _requestPermission(
      context: context,
      permission: Permission.locationWhenInUse,
      title: 'Location Access',
      message: 'We use your location to show books available near you '
               'in Darbhanga and surrounding areas. Your exact location '
               'is never shared with other users.',
      icon: Icons.location_on_outlined,
      settingsKey: 'location_asked',
    );
  }
  
  /// Request notification permission
  Future<bool> requestNotification(BuildContext context) async {
    return _requestPermission(
      context: context,
      permission: Permission.notification,
      title: 'Notification Access',
      message: 'Get notified when someone wants to buy your book, '
               'sends you a message, or when new books are listed nearby.',
      icon: Icons.notifications_outlined,
      settingsKey: 'notification_asked',
    );
  }
  
  /// Check if permission is granted (no prompt)
  Future<bool> isGranted(Permission permission) async {
    return await permission.isGranted;
  }
  
  /// Core permission request flow
  Future<bool> _requestPermission({
    required BuildContext context,
    required Permission permission,
    required String title,
    required String message,
    required IconData icon,
    required String settingsKey,
  }) async {
    // Step 1: Check if already granted
    final status = await permission.status;
    if (status.isGranted) return true;
    
    // Step 2: If permanently denied, redirect to Settings
    if (status.isPermanentlyDenied) {
      final opened = await _showSettingsDialog(context, title, message, icon);
      if (opened) await openAppSettings();
      return false;
    }
    
    // Step 3: Show pre-ask rationale dialog
    final box = Hive.box('settings');
    final alreadyAsked = box.get(settingsKey, defaultValue: false);
    
    if (!alreadyAsked) {
      final shouldProceed = await _showRationaleDialog(
        context, title, message, icon,
      );
      box.put(settingsKey, true);
      if (!shouldProceed) return false;
    }
    
    // Step 4: Request actual OS permission
    final result = await permission.request();
    
    // Step 5: Log result
    AnalyticsService().logEvent('permission_${permission.toString().split('.').last}', {
      'granted': result.isGranted.toString(),
    });
    
    return result.isGranted;
  }
  
  /// Pre-ask rationale dialog (before OS prompt)
  Future<bool> _showRationaleDialog(
    BuildContext context,
    String title,
    String message,
    IconData icon,
  ) async {
    return await showDialog<bool>(
      context: context,
      builder: (ctx) => AlertDialog(
        icon: Icon(icon, size: 48, color: Theme.of(ctx).colorScheme.primary),
        title: Text(title),
        content: Text(message),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(ctx, false),
            child: Text('Not Now'),
          ),
          FilledButton(
            onPressed: () => Navigator.pop(ctx, true),
            child: Text('Allow'),
          ),
        ],
      ),
    ) ?? false;
  }
  
  /// Settings redirect dialog (after permanent denial)
  Future<bool> _showSettingsDialog(
    BuildContext context,
    String title,
    String message,
    IconData icon,
  ) async {
    return await showDialog<bool>(
      context: context,
      builder: (ctx) => AlertDialog(
        icon: Icon(icon, size: 48, color: Theme.of(ctx).colorScheme.error),
        title: Text('$title Required'),
        content: Text(
          '$message\n\nThis permission was denied. '
          'Please enable it in Settings to continue.',
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(ctx, false),
            child: Text('Cancel'),
          ),
          FilledButton(
            onPressed: () => Navigator.pop(ctx, true),
            child: Text('Open Settings'),
          ),
        ],
      ),
    ) ?? false;
  }
}
```

---

### PART C: Permission Integration Points

| Feature | Permission | When Requested | Fallback |
|---------|-----------|----------------|----------|
| **Sell Book â†’ Camera** | Camera | User taps "Take Photo" | Show gallery option only |
| **Sell Book â†’ Gallery** | Photos | User taps "Choose from Gallery" | Show camera option only |
| **Home â†’ Near You** | Location | First time "Near You" section loads | Hide "Near You", show all books |
| **Onboarding** | Notification | After profile complete | Skip, ask later in Settings |
| **Book Detail â†’ Distance** | Location | User taps "See distance" | Show "Enable location" chip |

```dart
// Example: Sell Book screen
Future<void> _takePhoto() async {
  final granted = await PermissionService().requestCamera(context);
  if (granted) {
    final image = await ImagePicker().pickImage(source: ImageSource.camera);
    if (image != null) _addPhoto(image);
  }
  // If not granted, do nothing â€” dialog already shown
}

// Example: Home screen Near You
Future<void> _loadNearbyBooks() async {
  final granted = await PermissionService().isGranted(Permission.locationWhenInUse);
  if (granted) {
    // Load nearby books
    final position = await Geolocator.getCurrentPosition();
    _fetchBooksNearby(position.latitude, position.longitude);
  } else {
    // Show "Enable Location" prompt card instead
    setState(() => _showLocationPrompt = true);
  }
}
```

---

### PART D: Location Permission Card (Home Screen)

ğŸ“ CREATE: `lib/widgets/location_prompt_card.dart`

```dart
class LocationPromptCard extends StatelessWidget {
  // Shown in Home screen when location is not granted
  // Design:
  // â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  // â”‚ ğŸ“ See books near you           â”‚
  // â”‚ Enable location to find books   â”‚
  // â”‚ available in your area.         â”‚
  // â”‚           [Enable Location]     â”‚
  // â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  
  @override
  Widget build(BuildContext context) {
    return Card(
      child: Padding(
        padding: const EdgeInsets.all(16),
        child: Column(
          children: [
            Icon(Icons.location_on_outlined, size: 40),
            SizedBox(height: 8),
            Text('See books near you', style: Theme.of(context).textTheme.titleMedium),
            SizedBox(height: 4),
            Text('Enable location to find books available in your area.'),
            SizedBox(height: 12),
            FilledButton.icon(
              onPressed: () async {
                final granted = await PermissionService().requestLocation(context);
                if (granted) {
                  // Refresh home to load nearby books
                  context.read<HomeProvider>().refreshNearby();
                }
              },
              icon: Icon(Icons.location_on),
              label: Text('Enable Location'),
            ),
          ],
        ),
      ),
    );
  }
}
```

---

### PART E: Notification Permission (Post-Onboarding)

ğŸ“ MODIFY: Onboarding flow (Prompt 7)

```dart
// After onboarding form is submitted successfully:
void _onOnboardingComplete() async {
  // ... save profile ...
  
  // Ask for notification permission (non-blocking)
  if (mounted) {
    await Future.delayed(Duration(milliseconds: 500));
    await PermissionService().requestNotification(context);
  }
  
  // Navigate to home regardless of permission result
  context.go('/home');
}
```

---

ğŸ“¦ USE:
- `permission_handler` â€” unified permission API for Android + iOS
- `hive_flutter` â€” track "already asked" per permission
- Existing â€” `AnalyticsService` for logging, `SettingsManager` for flags

â›” DO NOT:
- Do NOT request permissions on app startup â€” request contextually when needed
- Do NOT request multiple permissions at once â€” one at a time
- Do NOT show OS prompt without pre-ask rationale dialog first (bad UX)
- Do NOT block the entire screen if permission denied â€” show fallback UI
- Do NOT forget iOS `Info.plist` usage descriptions â€” App Store will reject
- Do NOT forget Android 13+ POST_NOTIFICATIONS permission
- Do NOT use `Permission.storage` for Android 13+ â€” use `Permission.photos`
- Do NOT forget to handle "permanently denied" â†’ redirect to app Settings

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”§ EXECUTE:

**Step 1:** Add `permission_handler` to `pubspec.yaml`
**Step 2:** Add all permission declarations to `AndroidManifest.xml`
**Step 3:** Add usage descriptions to `ios/Runner/Info.plist`
**Step 4:** Create `lib/services/permission_service.dart` with all 4 permission methods
**Step 5:** Create `lib/widgets/location_prompt_card.dart`
**Step 6:** Integrate camera/gallery permissions into Sell Book screen
**Step 7:** Integrate location permission into Home (Near You section)
**Step 8:** Integrate notification permission into post-onboarding flow
**Step 9:** Run `flutter analyze` â€” 0 issues
**Step 10:** Test: deny camera â†’ rationale shown â†’ deny again â†’ settings redirect â†’ allow in settings â†’ works

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ… SELF-CHECK:
1. `permission_handler` added to pubspec
2. Android manifest has CAMERA, READ_MEDIA_IMAGES, FINE_LOCATION, POST_NOTIFICATIONS
3. iOS Info.plist has NSCameraUsageDescription, NSPhotoLibraryUsageDescription, NSLocationWhenInUseUsageDescription
4. PermissionService handles 4 permissions: camera, gallery, location, notification
5. Pre-ask rationale dialog shown before first OS prompt
6. Permanently denied â†’ "Open Settings" dialog
7. "Already asked" tracked per permission in Hive
8. Location denied â†’ LocationPromptCard shown instead of "Near You"
9. Camera denied â†’ gallery option still available (fallback)
10. Notification asked post-onboarding, non-blocking
11. Permission results logged to analytics
12. No permissions requested on cold start
13. `flutter analyze` returns 0 issues

ğŸ‘¤ USER MANUAL STEPS:
- None â€” purely frontend code + config

ğŸ’¬ CONFIRM IN CHAT:
"Prompt 34 complete. Permissions: PermissionService (4 permissions â€” camera/gallery/location/notification), pre-ask rationale dialogs, permanently-denied â†’ Settings redirect, LocationPromptCard fallback, post-onboarding notification ask, analytics logging. flutter analyze: 0 issues. Zero errors."

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â­ï¸ NEXT: Prompt 35 â€” App Lifecycle + Background Handling
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ PROMPT 35 of 70
Phase: Platform Integration (PHASE_28)
Task: AppLifecycleObserver + Background/Foreground Handling + Subscription Management
Type: ğŸ“± FRONTEND (Flutter)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ INSTRUCTION:
Build the **App Lifecycle Management Layer** â€” a centralized `AppLifecycleService` using `WidgetsBindingObserver` to manage foreground/background transitions, pause/resume PocketBase realtime subscriptions, refresh stale cache on resume, update session activity timestamps, and handle connectivity re-sync when coming back online.

> **Goal:** Ensure the app behaves correctly when backgrounded/foregrounded â€” no wasted resources in background, instant data refresh on resume, and reliable realtime reconnection.

---

### PART A: App Lifecycle Service

ğŸ“ CREATE: `lib/services/app_lifecycle_service.dart`

```dart
class AppLifecycleService with WidgetsBindingObserver {
  static final AppLifecycleService _instance = AppLifecycleService._();
  factory AppLifecycleService() => _instance;
  AppLifecycleService._();
  
  DateTime? _backgroundedAt;
  static const _staleThreshold = Duration(minutes: 5);
  
  final _onResumeCallbacks = <String, VoidCallback>{};
  final _onPauseCallbacks = <String, VoidCallback>{};
  
  /// Initialize â€” call once in main.dart
  void init() {
    WidgetsBinding.instance.addObserver(this);
  }
  
  /// Dispose â€” call on app terminate
  void dispose() {
    WidgetsBinding.instance.removeObserver(this);
  }
  
  /// Register a callback for when app comes to foreground
  void onResume(String key, VoidCallback callback) {
    _onResumeCallbacks[key] = callback;
  }
  
  /// Register a callback for when app goes to background
  void onPause(String key, VoidCallback callback) {
    _onPauseCallbacks[key] = callback;
  }
  
  /// Remove callbacks when no longer needed
  void removeCallbacks(String key) {
    _onResumeCallbacks.remove(key);
    _onPauseCallbacks.remove(key);
  }
  
  @override
  void didChangeAppLifecycleState(AppLifecycleState state) {
    switch (state) {
      case AppLifecycleState.resumed:
        _onForeground();
        break;
      case AppLifecycleState.paused:
        _onBackground();
        break;
      case AppLifecycleState.inactive:
        // App is transitioning (e.g., phone call overlay)
        // Do nothing â€” wait for paused or resumed
        break;
      case AppLifecycleState.detached:
        _onTerminate();
        break;
      case AppLifecycleState.hidden:
        // App is hidden but not paused (desktop/web)
        break;
    }
  }
  
  /// App came to foreground
  void _onForeground() {
    final wasStale = _isDataStale();
    _backgroundedAt = null;
    
    // 1. Resume realtime subscriptions
    _resumeRealtimeSubscriptions();
    
    // 2. Refresh cache if data is stale
    if (wasStale) {
      _refreshStaleData();
    }
    
    // 3. Update session activity
    SessionManager.updateActivity();
    
    // 4. Check session expiry
    if (SessionManager.isSessionExpired()) {
      _handleSessionExpired();
      return;
    }
    
    // 5. Re-check connectivity
    ConnectivityMonitor().checkNow();
    
    // 6. Fire registered callbacks
    for (final callback in _onResumeCallbacks.values) {
      callback();
    }
    
    CrashService().log('App resumed');
  }
  
  /// App went to background
  void _onBackground() {
    _backgroundedAt = DateTime.now();
    
    // 1. Pause realtime subscriptions (save battery/data)
    _pauseRealtimeSubscriptions();
    
    // 2. Update session activity
    SessionManager.updateActivity();
    
    // 3. Fire registered callbacks
    for (final callback in _onPauseCallbacks.values) {
      callback();
    }
    
    CrashService().log('App backgrounded');
  }
  
  /// App is being terminated
  void _onTerminate() {
    SessionManager.updateActivity();
    CrashService().log('App terminated');
  }
  
  /// Check if data is stale (backgrounded for > 5 minutes)
  bool _isDataStale() {
    if (_backgroundedAt == null) return false;
    return DateTime.now().difference(_backgroundedAt!) > _staleThreshold;
  }
  
  /// Pause PocketBase realtime subscriptions
  void _pauseRealtimeSubscriptions() {
    // Unsubscribe from realtime events to save resources
    // Chat subscriptions, book updates, notification subscriptions
    try {
      PocketBaseService().pb.realtime.unsubscribe();
    } catch (_) {}
  }
  
  /// Resume PocketBase realtime subscriptions
  void _resumeRealtimeSubscriptions() {
    // Re-subscribe to active chat room if on chat screen
    // Re-subscribe to notification events
    // The individual screens handle their own re-subscription
    // via the onResume callback mechanism
  }
  
  /// Refresh data that might be stale
  void _refreshStaleData() {
    CrashService().log('Data stale â€” refreshing');
    // Home screen will auto-refresh via its onResume callback
    // Chat list will reload unread counts
    // Notification badge will update
  }
  
  /// Handle expired session
  void _handleSessionExpired() {
    CrashService().log('Session expired â€” logging out');
    // Clear auth and navigate to login
    SecureStorageService().clearAuth();
    // GoRouter redirect will handle navigation to login
  }
}
```

---

### PART B: Initialize in main.dart

ğŸ“ MODIFY: `lib/main.dart`

```dart
void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await Firebase.initializeApp();
  
  // ... existing setup ...
  
  // Initialize lifecycle observer
  AppLifecycleService().init();
  
  runApp(const JayGangaApp());
}
```

---

### PART C: Screen-Level Integration

ğŸ“ Usage in screens that need foreground refresh:

```dart
class _HomeScreenState extends State<HomeScreen> {
  @override
  void initState() {
    super.initState();
    
    // Register foreground callback
    AppLifecycleService().onResume('home_screen', () {
      // Refresh book feed when coming back
      context.read<HomeProvider>().refreshIfStale();
    });
  }
  
  @override
  void dispose() {
    AppLifecycleService().removeCallbacks('home_screen');
    super.dispose();
  }
}
```

```dart
class _ChatScreenState extends State<ChatScreen> {
  @override
  void initState() {
    super.initState();
    
    // Resume realtime chat subscription on foreground
    AppLifecycleService().onResume('chat_screen', () {
      _resubscribeToChat();
      _loadNewMessages(); // Fetch messages received while backgrounded
    });
    
    // Pause subscription on background
    AppLifecycleService().onPause('chat_screen', () {
      _unsubscribeFromChat();
    });
  }
  
  @override
  void dispose() {
    AppLifecycleService().removeCallbacks('chat_screen');
    super.dispose();
  }
}
```

```dart
class _NotificationBadgeState extends State<NotificationBadge> {
  @override
  void initState() {
    super.initState();
    
    // Refresh unread count on foreground
    AppLifecycleService().onResume('notification_badge', () {
      context.read<NotificationProvider>().refreshUnreadCount();
    });
  }
  
  @override
  void dispose() {
    AppLifecycleService().removeCallbacks('notification_badge');
    super.dispose();
  }
}
```

---

### PART D: Lifecycle State Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RESUMED â”‚â”€â”€â”€â”€â–¶â”‚ INACTIVE â”‚â”€â”€â”€â”€â–¶â”‚ PAUSED â”‚
â”‚(visible)â”‚     â”‚(overlay) â”‚     â”‚(hidden)â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                                â”‚
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Resume â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                                â”‚
     â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
     â”‚           â”‚ DETACHED â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚           â”‚(killed)  â”‚         â”‚
     â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
     â”‚                                â”‚
     â”‚  Actions on RESUME:            â”‚  Actions on PAUSE:
     â”‚  â€¢ Resume subscriptions        â”‚  â€¢ Pause subscriptions
     â”‚  â€¢ Refresh stale data (>5min)  â”‚  â€¢ Update last active
     â”‚  â€¢ Check session expiry        â”‚  â€¢ Log breadcrumb
     â”‚  â€¢ Re-check connectivity       â”‚
     â”‚  â€¢ Fire onResume callbacks     â”‚
     â”‚  â€¢ Update last active          â”‚
     â”‚  â€¢ Log breadcrumb              â”‚
```

---

ğŸ“¦ USE:
- `WidgetsBindingObserver` â€” built-in Flutter lifecycle observer
- Existing â€” `PocketBaseService`, `SessionManager`, `ConnectivityMonitor`, `CrashService`

â›” DO NOT:
- Do NOT keep realtime subscriptions active in background â€” wastes battery/data
- Do NOT refresh all data on every foreground â€” only if stale (> 5 minutes)
- Do NOT forget to remove callbacks in `dispose()` â€” causes memory leaks
- Do NOT log out immediately on inactive state â€” user might just be switching apps briefly
- Do NOT do heavy work in `inactive` â€” it's a transient state
- Do NOT forget to re-check connectivity on resume â€” Wi-Fi may have changed

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”§ EXECUTE:

**Step 1:** Create `lib/services/app_lifecycle_service.dart`
**Step 2:** Initialize in `main.dart` with `AppLifecycleService().init()`
**Step 3:** Register `onResume` callback in HomeScreen for feed refresh
**Step 4:** Register `onResume`/`onPause` in ChatScreen for realtime sub management
**Step 5:** Register `onResume` in NotificationBadge for unread count refresh
**Step 6:** Integrate session expiry check on resume
**Step 7:** Integrate connectivity re-check on resume
**Step 8:** Run `flutter analyze` â€” 0 issues
**Step 9:** Test: background app for 6 min â†’ foreground â†’ verify data refreshes + subs reconnect

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ… SELF-CHECK:
1. `AppLifecycleService` is singleton with `WidgetsBindingObserver`
2. `init()` called once in `main.dart`
3. Handles all 5 lifecycle states (resumed, inactive, paused, detached, hidden)
4. Realtime subscriptions paused on background, resumed on foreground
5. Stale data threshold set to 5 minutes
6. Session expiry checked on resume â€” auto-logout if expired
7. Connectivity re-checked on resume
8. Callback registration pattern: `onResume(key, callback)` / `onPause(key, callback)`
9. Callbacks properly removed in `dispose()` to prevent leaks
10. Breadcrumb logs for all state transitions
11. `SessionManager.updateActivity()` called on both pause and resume
12. HomeScreen, ChatScreen, NotificationBadge all integrated
13. `flutter analyze` returns 0 issues

ğŸ‘¤ USER MANUAL STEPS:
- None â€” purely frontend code

ğŸ’¬ CONFIRM IN CHAT:
"Prompt 35 complete. Lifecycle: AppLifecycleService (WidgetsBindingObserver), background pause (realtime unsub + session update), foreground resume (stale check 5min + resub + connectivity + session expiry), callback registry (key-based onResume/onPause), integrated in Home/Chat/NotificationBadge. flutter analyze: 0 issues. Zero errors."

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â­ï¸ NEXT: Prompt 36 â€” Responsive Layout + Tablet/Landscape Support
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ PROMPT 36 of 70
Phase: UI Polish (PHASE_29)
Task: Responsive Breakpoints + Adaptive Grids + Landscape + Tablet Master-Detail
Type: ğŸ“± FRONTEND (Flutter)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ INSTRUCTION:
Build the **Responsive Layout Layer** â€” breakpoint constants for phone/tablet/desktop, a `ResponsiveBuilder` widget for adaptive layouts, dynamic grid column counts, landscape-aware screen adjustments, tablet master-detail split views, and safe area handling for notches/punch-holes.

> **Goal:** App looks great on all Android screen sizes â€” small phones (360px), large phones (412px), tablets (600px+), and both portrait + landscape orientations.

---

### PART A: Breakpoints & Screen Utilities

ğŸ“ CREATE: `lib/utils/responsive.dart`

```dart
class Breakpoints {
  static const double mobile = 0;
  static const double mobileLarge = 400;
  static const double tablet = 600;
  static const double desktop = 1024;
}

class ScreenInfo {
  final double width;
  final double height;
  final bool isPortrait;
  
  ScreenInfo(this.width, this.height, this.isPortrait);
  
  bool get isMobile => width < Breakpoints.tablet;
  bool get isTablet => width >= Breakpoints.tablet && width < Breakpoints.desktop;
  bool get isDesktop => width >= Breakpoints.desktop;
  bool get isLandscape => !isPortrait;
  
  /// Grid columns based on screen width
  int get gridColumns {
    if (width < Breakpoints.mobileLarge) return 2;
    if (width < Breakpoints.tablet) return 2;
    if (width < Breakpoints.desktop) return 3;
    return 4;
  }
  
  /// Content max width (centered on large screens)
  double get contentMaxWidth {
    if (isMobile) return width;
    if (isTablet) return 720;
    return 960;
  }
  
  /// Horizontal padding
  double get horizontalPadding {
    if (isMobile) return 16;
    if (isTablet) return 24;
    return 32;
  }
}

/// Get screen info from context
ScreenInfo screenOf(BuildContext context) {
  final size = MediaQuery.sizeOf(context);
  final orientation = MediaQuery.orientationOf(context);
  return ScreenInfo(
    size.width,
    size.height,
    orientation == Orientation.portrait,
  );
}
```

---

### PART B: ResponsiveBuilder Widget

ğŸ“ CREATE: `lib/widgets/responsive_builder.dart`

```dart
class ResponsiveBuilder extends StatelessWidget {
  final Widget Function(BuildContext context, ScreenInfo screen) mobile;
  final Widget Function(BuildContext context, ScreenInfo screen)? tablet;
  final Widget Function(BuildContext context, ScreenInfo screen)? desktop;
  
  const ResponsiveBuilder({
    required this.mobile,
    this.tablet,
    this.desktop,
    super.key,
  });
  
  @override
  Widget build(BuildContext context) {
    final screen = screenOf(context);
    
    if (screen.isDesktop && desktop != null) {
      return desktop!(context, screen);
    }
    if (screen.isTablet && tablet != null) {
      return tablet!(context, screen);
    }
    return mobile(context, screen);
  }
}
```

---

### PART C: Responsive Content Wrapper

ğŸ“ CREATE: `lib/widgets/responsive_content.dart`

```dart
/// Centers content with max width on large screens
class ResponsiveContent extends StatelessWidget {
  final Widget child;
  final double? maxWidth;
  
  const ResponsiveContent({required this.child, this.maxWidth, super.key});
  
  @override
  Widget build(BuildContext context) {
    final screen = screenOf(context);
    final effectiveMaxWidth = maxWidth ?? screen.contentMaxWidth;
    
    if (screen.isMobile) return child;
    
    return Center(
      child: ConstrainedBox(
        constraints: BoxConstraints(maxWidth: effectiveMaxWidth),
        child: child,
      ),
    );
  }
}
```

---

### PART D: Adaptive Book Grid

ğŸ“ MODIFY: Home Screen book grid (Prompt 9)

```dart
// Replace fixed column count with responsive
Widget _buildBookGrid(List<Book> books) {
  final screen = screenOf(context);
  
  return SliverGrid(
    gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
      crossAxisCount: screen.gridColumns,
      mainAxisSpacing: 12,
      crossAxisSpacing: 12,
      childAspectRatio: 0.65,
    ),
    delegate: SliverChildBuilderDelegate(
      (context, index) => BookCard(book: books[index]),
      childCount: books.length,
    ),
  );
}
```

ğŸ“ MODIFY: Search results grid (Prompt 13)

```dart
// Same responsive grid columns
GridView.builder(
  gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
    crossAxisCount: screenOf(context).gridColumns,
    mainAxisSpacing: 12,
    crossAxisSpacing: 12,
    childAspectRatio: 0.65,
  ),
  // ...
)
```

---

### PART E: Landscape Adjustments

ğŸ“ MODIFY: Book Detail Screen (Prompt 10)

```dart
@override
Widget build(BuildContext context) {
  final screen = screenOf(context);
  
  // Landscape: side-by-side image + details
  if (screen.isLandscape || screen.isTablet) {
    return Scaffold(
      appBar: _buildAppBar(),
      body: Row(
        children: [
          // Left: Image gallery (40% width)
          Expanded(
            flex: 4,
            child: _buildImageGallery(book),
          ),
          // Right: Details (60% width)
          Expanded(
            flex: 6,
            child: SingleChildScrollView(
              child: _buildBookDetails(book),
            ),
          ),
        ],
      ),
    );
  }
  
  // Portrait: stacked layout (existing)
  return Scaffold(
    appBar: _buildAppBar(),
    body: SingleChildScrollView(
      child: Column(
        children: [
          _buildImageGallery(book),
          _buildBookDetails(book),
        ],
      ),
    ),
  );
}
```

---

### PART F: Tablet Master-Detail (Chat)

ğŸ“ MODIFY: Chat List Screen (Prompt 14) â€” tablet layout

```dart
class ChatListScreen extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    final screen = screenOf(context);
    
    // Tablet: master-detail split
    if (screen.isTablet || screen.isLandscape) {
      return Scaffold(
        appBar: AppBar(title: Text('Messages')),
        body: Row(
          children: [
            // Master: chat list (35% width)
            SizedBox(
              width: screen.width * 0.35,
              child: _buildChatList(
                onChatSelected: (chatId) {
                  // Update detail panel instead of navigating
                  context.read<ChatProvider>().selectChat(chatId);
                },
              ),
            ),
            VerticalDivider(width: 1),
            // Detail: active chat (65% width)
            Expanded(
              child: Consumer<ChatProvider>(
                builder: (ctx, provider, _) {
                  if (provider.selectedChatId == null) {
                    return Center(
                      child: Column(
                        mainAxisSize: MainAxisSize.min,
                        children: [
                          Icon(Icons.chat_bubble_outline, size: 64,
                            color: Colors.grey),
                          SizedBox(height: 16),
                          Text('Select a conversation'),
                        ],
                      ),
                    );
                  }
                  return ChatDetailScreen(
                    chatId: provider.selectedChatId!,
                    isEmbedded: true, // No separate AppBar
                  );
                },
              ),
            ),
          ],
        ),
      );
    }
    
    // Phone: standard list â†’ navigate to detail
    return Scaffold(
      appBar: AppBar(title: Text('Messages')),
      body: _buildChatList(
        onChatSelected: (chatId) => context.push('/chat/$chatId'),
      ),
    );
  }
}
```

---

### PART G: Safe Area Handling

ğŸ“ Ensure all screens use SafeArea properly:

```dart
// For screens with custom scroll views:
Widget build(BuildContext context) {
  return Scaffold(
    body: SafeArea(
      child: CustomScrollView(
        slivers: [
          // ... content ...
        ],
      ),
    ),
  );
}

// For screens with bottom buttons:
Widget build(BuildContext context) {
  final bottomPadding = MediaQuery.paddingOf(context).bottom;
  return Scaffold(
    body: Column(
      children: [
        Expanded(child: _content()),
        Padding(
          padding: EdgeInsets.only(bottom: bottomPadding + 16),
          child: _buildBottomButton(),
        ),
      ],
    ),
  );
}
```

---

### PART H: Responsive Text Scaling

```dart
// Respect system font size settings
Widget build(BuildContext context) {
  // MediaQuery.textScalerOf automatically handles this
  // but constrain max scale for layout stability
  return MediaQuery(
    data: MediaQuery.of(context).copyWith(
      textScaler: TextScaler.linear(
        MediaQuery.textScalerOf(context).scale(1.0).clamp(0.8, 1.3),
      ),
    ),
    child: child,
  );
}
```

---

ğŸ“¦ USE:
- `MediaQuery` â€” screen size, orientation, safe area, text scale
- `LayoutBuilder` â€” parent-constrained responsive layouts
- `SliverGrid` â€” adaptive grid columns
- `ConstrainedBox` â€” max width on large screens

â›” DO NOT:
- Do NOT use fixed pixel widths â€” use `Expanded`, `Flexible`, `FractionallySizedBox`
- Do NOT ignore landscape mode â€” Book Detail + Chat must adapt
- Do NOT hardcode column counts â€” use `screenOf(context).gridColumns`
- Do NOT forget safe area on phones with notches/punch-holes
- Do NOT wrap entire app in `MediaQuery` text scale override â€” only constrain max
- Do NOT forget to test with 360px wide devices (smallest common Android)
- Do NOT forget tablet master-detail for Chat

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”§ EXECUTE:

**Step 1:** Create `lib/utils/responsive.dart` with breakpoints + `ScreenInfo` + `screenOf()`
**Step 2:** Create `lib/widgets/responsive_builder.dart`
**Step 3:** Create `lib/widgets/responsive_content.dart`
**Step 4:** Update Home grid to use `screen.gridColumns`
**Step 5:** Update Search grid to use `screen.gridColumns`
**Step 6:** Update Book Detail for landscape side-by-side layout
**Step 7:** Update Chat for tablet master-detail split view
**Step 8:** Verify SafeArea on all screens
**Step 9:** Add text scale clamping in app root
**Step 10:** Run `flutter analyze` â€” 0 issues
**Step 11:** Test: rotate device â†’ landscape layout correct â†’ tablet emulator â†’ master-detail works

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ… SELF-CHECK:
1. Breakpoints defined: mobile (0), mobileLarge (400), tablet (600), desktop (1024)
2. `ScreenInfo` provides gridColumns, contentMaxWidth, horizontalPadding
3. `screenOf(context)` helper returns `ScreenInfo` from `MediaQuery`
4. `ResponsiveBuilder` renders different widgets per breakpoint
5. `ResponsiveContent` centers + constrains width on large screens
6. Home/Search grids use 2/3/4 columns based on width
7. Book Detail: portrait = stacked, landscape/tablet = side-by-side
8. Chat: phone = listâ†’detail, tablet = master-detail split
9. SafeArea used on all screens with custom layouts
10. Text scale clamped between 0.8x and 1.3x
11. Tested at 360px, 412px, 600px, 1024px widths
12. `flutter analyze` returns 0 issues

ğŸ‘¤ USER MANUAL STEPS:
- None â€” purely frontend code

ğŸ’¬ CONFIRM IN CHAT:
"Prompt 36 complete. Responsive: Breakpoints (mobile/tablet/desktop), ScreenInfo helper, ResponsiveBuilder/ResponsiveContent widgets, adaptive grids (2/3/4 cols), Book Detail landscape side-by-side, Chat tablet master-detail, SafeArea on all screens, text scale 0.8â€“1.3x clamp. flutter analyze: 0 issues. Zero errors."

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

> [!IMPORTANT]
> **PROMPTS 37 ONWARDS are located in:** [37 onwards.md](file:///c:/Users/lapto/OneDrive/FlutterAndPocketBaseManagerAI/37%20onwards.md)
>
> All future prompts strictly follow the upgraded Manager AI rules (Backend exact code, Frontend instructions only, Schema Bridge Rule).

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

